<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Sip - Professional Networking</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <script>
        // Apply saved theme before page renders to prevent flash
        (function() {
            var t = localStorage.getItem('app_theme') || 'light';
            var dark = t === 'dark' || (t === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* New design system */
            --cream: #F5F0E8;
            --warm-white: #FDFAF4;
            --espresso: #1C1208;
            --brown: #3D2B1A;
            --caramel: #C07C3A;
            --caramel-light: #D4964F;
            --latte: #EAD9B8;
            --latte-soft: #F2E9D6;
            --sage: #8A9E85;
            --muted: #7A6E62;
            --card: #FFFDF8;
            --border: rgba(192,124,58,0.14);
            --sidebar-w: 228px;

            /* Legacy aliases so existing JS-generated HTML still works */
            --primary: #C07C3A;
            --primary-light: #D4964F;
            --primary-dark: #1C1208;
            --accent: #EAD9B8;
            --accent-light: #F2E9D6;
            --success: #4CAF50;
            --danger: #FF6B6B;
            --bg-dark: #1C1208;
            --bg-light: #F5F0E8;
            --text-dark: #1C1208;
            --text-light: #FDFAF4;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-hover: 0 8px 24px rgba(192,124,58,0.15);
        }

        [data-theme="dark"] {
            --cream: #1e1914;
            --warm-white: #231e17;
            --espresso: #EDE4D4;
            --brown: #D4C4A8;
            --caramel: #D4964F;
            --caramel-light: #E0A85A;
            --latte: #3d3228;
            --latte-soft: #2d2820;
            --sage: #8A9E85;
            --muted: #9A8E82;
            --card: #251f18;
            --border: rgba(192,124,58,0.22);
            /* Legacy aliases */
            --primary: #D4964F;
            --primary-light: #E0A85A;
            --primary-dark: #EDE4D4;
            --accent: #3d3228;
            --accent-light: #2d2820;
            --bg-dark: #1e1914;
            --bg-light: #EDE4D4;
            --text-dark: #EDE4D4;
            --text-light: #1e1914;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-hover: 0 8px 24px rgba(192,124,58,0.3);
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--cream);
            color: var(--espresso);
            line-height: 1.6;
        }

        html { height: 100%; }

        /* ─── TOP BAR ─── */
        .topbar {
            height: 56px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: none; /* shown only when logged in */
            align-items: center;
            padding: 0 20px 0 0;
            flex-shrink: 0;
            z-index: 50;
            position: fixed;
            top: 0; left: 0; right: 0;
        }
        .topbar.visible { display: flex; }

        .topbar-logo {
            width: var(--sidebar-w);
            padding: 0 20px;
            font-family: 'Playfair Display', serif;
            font-size: 19px;
            font-weight: 900;
            color: var(--espresso);
            flex-shrink: 0;
            border-right: 1px solid var(--border);
            height: 100%;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .topbar-logo span { color: var(--caramel); }

        .topbar-search { flex: 1; padding: 0 20px; }

        .topbar-search-input {
            width: 280px;
            height: 34px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: var(--cream);
            padding: 0 14px 0 34px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            color: var(--espresso);
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%237A6E62' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
            transition: border-color 0.2s;
        }
        .topbar-search-input:focus { border-color: var(--caramel); }
        .topbar-search-input::placeholder { color: var(--muted); }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .icon-btn {
            width: 34px; height: 34px;
            border-radius: 8px;
            border: none;
            background: none;
            color: var(--muted);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            transition: background 0.15s, color 0.15s;
            position: relative;
        }
        .icon-btn:hover { background: var(--latte-soft); color: var(--espresso); }

        .notif-dot {
            position: absolute;
            top: 6px; right: 6px;
            width: 7px; height: 7px;
            background: var(--caramel);
            border-radius: 50%;
            border: 1.5px solid var(--card);
        }

        .user-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px 4px 4px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
            margin-left: 4px;
            background: var(--warm-white);
        }
        .user-chip:hover { background: var(--latte-soft); }

        .user-chip-av {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--caramel), var(--caramel-light));
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700; color: white;
        }
        .user-chip-name { font-size: 13px; font-weight: 500; color: var(--espresso); }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* App body shifts down when topbar is visible */
        body.app-mode { overflow: hidden; }
        body.app-mode .app-container { padding-top: 56px; height: 100vh; box-sizing: border-box; }

        /* ─── SIDEBAR ─── */
        .sidebar {
            background: var(--card);
            border-right: 1px solid var(--border);
            position: fixed;
            left: 0;
            top: 56px;
            height: calc(100vh - 56px);
            width: var(--sidebar-w);
            overflow-y: auto;
            z-index: 90;
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
        }

        /* Sidebar hidden on landing/login/signup */
        body:not(.app-mode) .sidebar { display: none; }

        .sidebar-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--muted);
            padding: 0 8px;
            margin-bottom: 4px;
            margin-top: 16px;
        }
        .sidebar-label:first-child { margin-top: 0; }

        .sidebar-divider {
            height: 1px;
            background: var(--border);
            margin: 10px 0;
        }

        .sidebar-bottom {
            margin-top: auto;
            padding-top: 12px;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            font-size: 19px;
            color: var(--espresso);
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 9px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted);
            transition: all 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'DM Sans', sans-serif;
            position: relative;
        }

        .nav-item:hover { background: var(--latte-soft); color: var(--espresso); }

        .nav-item.active {
            background: var(--latte);
            color: var(--brown);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--caramel);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .sidebar-spacer { flex: 1; }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 9px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted);
            transition: all 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'DM Sans', sans-serif;
            flex-shrink: 0;
        }

        .logout-btn:hover { background: var(--latte-soft); color: var(--espresso); }

        /* ── Sidebar user info ── */
        .sidebar-user-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 8px 14px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }
        .sidebar-user-av {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--caramel), var(--caramel-light));
            color: white;
            font-weight: 700;
            font-size: 13px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .sidebar-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--espresso);
            line-height: 1.2;
        }
        .sidebar-user-status {
            font-size: 11px;
            color: var(--muted);
            margin-top: 1px;
        }

        /* ─── MAIN CONTENT ─── */
        .main-content {
            margin-left: var(--sidebar-w);
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            min-width: 0;
            height: calc(100vh - 56px);
        }

        /* Landing page — no sidebar offset */
        body:not(.app-mode) .main-content {
            margin-left: 0;
            height: 100vh;
            padding: 0;
        }

        .content-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-view.active {
            display: block;
        }

        #dashboardView.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Headers */
        h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 1rem;
            color: var(--espresso);
        }

        h2 {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--espresso);
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--espresso);
            margin-bottom: 0.5rem;
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(28,18,8,0.08);
        }

        .card.compact {
            padding: 1rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--warm-white);
            color: var(--espresso);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--caramel);
            box-shadow: 0 0 0 3px rgba(192,124,58,0.1);
            background: var(--warm-white);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--espresso);
            color: var(--cream);
        }

        .btn-primary:hover {
            background: var(--brown);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(28,18,8,0.2);
        }

        .btn-secondary {
            background: var(--latte-soft);
            color: var(--espresso);
            border: 1.5px solid var(--latte);
        }

        .btn-secondary:hover {
            background: var(--latte);
        }

        .btn-accent {
            background: var(--caramel);
            color: white;
        }

        .btn-accent:hover {
            background: var(--caramel-light);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e55555;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 10px 12px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Auth Screens */
        /* ===== AUTH PAGES ===== */
        .auth-page {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 100vh;
        }

        /* Left panel */
        .auth-left {
            background: #1a0e07;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 48px 56px;
        }

        .auth-left::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 60% at 20% 80%, rgba(181,101,29,0.25) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 80% 20%, rgba(212,137,74,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .auth-grain {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            opacity: 0.5;
        }

        .auth-left-logo {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-logo-mark {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #d4894a, #b5651d);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .auth-logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 600;
            color: #f5ede3;
            letter-spacing: -0.3px;
        }

        .auth-left-hero {
            position: relative;
            z-index: 2;
        }

        .auth-eyebrow {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            color: #d4894a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-eyebrow::before {
            content: '';
            display: block;
            width: 24px;
            height: 1px;
            background: #d4894a;
        }

        .auth-hero-headline {
            font-family: 'Playfair Display', serif;
            font-size: 42px;
            line-height: 1.1;
            color: #f5ede3;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .auth-hero-headline em {
            font-style: italic;
            color: #d4894a;
        }

        .auth-hero-body {
            font-size: 14px;
            line-height: 1.65;
            color: rgba(245,237,227,0.6);
            max-width: 320px;
            margin-bottom: 36px;
        }

        .auth-testimonial {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(181,101,29,0.2);
            border-radius: 16px;
            padding: 22px;
            backdrop-filter: blur(10px);
            max-width: 360px;
        }

        .auth-testimonial-quote {
            font-family: 'Playfair Display', serif;
            font-size: 14px;
            font-style: italic;
            color: #f5ede3;
            line-height: 1.6;
            margin-bottom: 14px;
        }

        .auth-testimonial-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-author-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: linear-gradient(135deg, #b5651d, #d4894a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .auth-author-name {
            font-size: 13px;
            font-weight: 500;
            color: #f5ede3;
        }

        .auth-author-role {
            font-size: 11px;
            color: #c9a98a;
        }

        .auth-decor-circles {
            position: absolute;
            bottom: 60px;
            right: -20px;
            z-index: 1;
        }

        .auth-decor-circle {
            border-radius: 50%;
            border: 1px solid rgba(181,101,29,0.2);
            position: absolute;
        }

        .auth-decor-circle:nth-child(1) { width: 120px; height: 120px; bottom: 0; right: 30px; }
        .auth-decor-circle:nth-child(2) { width: 70px; height: 70px; bottom: 40px; right: 0; }
        .auth-decor-circle:nth-child(3) { width: 40px; height: 40px; bottom: 80px; right: 60px; border-color: rgba(212,137,74,0.3); }

        /* Right panel */
        .auth-right {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 72px;
            background: #faf6f1;
            position: relative;
        }

        .auth-right::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #b5651d, #d4894a, transparent);
        }

        .auth-form-container {
            width: 100%;
            max-width: 380px;
            animation: authFadeUp 0.5s ease both;
        }

        @keyframes authFadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .auth-form-header { margin-bottom: 36px; }

        .auth-form-title {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 600;
            color: #1a0e07;
            margin-bottom: 6px;
            line-height: 1.15;
        }

        .auth-form-subtitle {
            font-size: 14px;
            color: #8b6a52;
            line-height: 1.5;
        }

        .auth-form-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: #8b6a52;
            margin-bottom: 8px;
        }

        .auth-input-wrapper { position: relative; }

        .auth-input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #c9a98a;
            font-size: 14px;
            pointer-events: none;
        }

        .auth-form-input {
            width: 100%;
            padding: 13px 14px 13px 40px;
            border: 1.5px solid #e8d5c0;
            border-radius: 12px;
            background: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            color: #1a0e07;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .auth-form-input::placeholder { color: #c9a98a; }

        .auth-form-input:focus {
            border-color: #b5651d;
            box-shadow: 0 0 0 3px rgba(181,101,29,0.1);
        }

        .auth-btn-primary {
            width: 100%;
            margin-top: 8px;
            padding: 15px;
            background: #1a0e07;
            color: #f5ede3;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 0.2px;
        }

        .auth-btn-primary:hover {
            background: #2c1a0e;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(26,14,7,0.25);
        }

        .auth-btn-primary:active { transform: translateY(0); }

        .auth-toggle {
            text-align: center;
            margin-top: 22px;
            font-size: 13.5px;
            color: #8b6a52;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #b5651d;
            font-weight: 500;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 13.5px;
            transition: color 0.2s;
        }

        .auth-toggle button:hover { color: #5c3317; }

        .auth-stat-row {
            display: flex;
            gap: 20px;
            margin-top: 32px;
            padding-top: 28px;
            border-top: 1px solid #e8d5c0;
        }

        .auth-stat-item { text-align: center; flex: 1; }

        .auth-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: #1a0e07;
        }

        .auth-stat-label {
            font-size: 11px;
            color: #8b6a52;
            margin-top: 2px;
        }

        @media (max-width: 860px) {
            .auth-page { grid-template-columns: 1fr; }
            .auth-left { display: none; }
            .auth-right { padding: 48px 28px; background: #faf6f1; min-height: 100vh; }
        }

        /* Legacy signup container (still used for signupView) */
        .auth-container {
            max-width: 500px;
            margin: 4rem auto;
            background: var(--card);
            padding: 3rem;
            border-radius: 18px;
            border: 1px solid var(--border);
        }

        .auth-container h1 {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 2rem;
            font-size: 14px;
        }

        .toggle-auth {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 14px;
        }

        .toggle-auth button {
            background: none;
            border: none;
            color: var(--caramel);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }

        /* ===== SIGNUP PAGE ===== */
        .su-page {
            display: grid;
            grid-template-columns: 400px 1fr;
            min-height: 100vh;
        }

        .su-left {
            position: sticky;
            top: 0;
            height: 100vh;
            background: #2c1a0e;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 44px 44px;
            z-index: 2;
        }

        .su-left::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 100% 70% at -10% 100%, rgba(181,101,29,0.3) 0%, transparent 55%),
                radial-gradient(ellipse 60% 50% at 110% 0%, rgba(212,137,74,0.12) 0%, transparent 50%);
            pointer-events: none;
        }

        .su-logo {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .su-logo-mark {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #d4894a, #b5651d);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .su-logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: #f5ede3;
        }

        .su-steps-area {
            position: relative;
            z-index: 1;
            margin-top: auto;
            margin-bottom: auto;
        }

        .su-steps-headline {
            font-family: 'Playfair Display', serif;
            font-size: 33px;
            line-height: 1.15;
            color: #f5ede3;
            margin-bottom: 10px;
            font-weight: 400;
        }

        .su-steps-headline em {
            font-style: italic;
            color: #d4894a;
        }

        .su-steps-tagline {
            font-size: 13px;
            color: rgba(245,237,227,0.5);
            margin-bottom: 32px;
            line-height: 1.55;
        }

        .su-step-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .su-step-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid transparent;
        }

        .su-step-item.su-active {
            background: rgba(255,255,255,0.06);
            border-color: rgba(181,101,29,0.2);
        }

        .su-step-num {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1.5px solid rgba(181,101,29,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: #c9a98a;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .su-step-item.su-active .su-step-num {
            background: linear-gradient(135deg, #b5651d, #d4894a);
            border-color: transparent;
            color: white;
        }

        .su-step-title {
            font-size: 13.5px;
            font-weight: 500;
            color: #f5ede3;
            margin-bottom: 2px;
        }

        .su-step-desc {
            font-size: 11.5px;
            color: rgba(245,237,227,0.42);
        }

        .su-bottom-pill {
            position: relative;
            z-index: 1;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(181,101,29,0.2);
            border-radius: 100px;
            padding: 9px 15px;
            font-size: 12px;
            color: rgba(245,237,227,0.65);
            align-self: flex-start;
        }

        .su-pulse-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4caf50;
            animation: suPulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes suPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.55; transform: scale(0.8); }
        }

        /* Right panel */
        .su-right {
            padding: 56px 72px 72px;
            background: #faf6f1;
            position: relative;
        }

        .su-right::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #b5651d, #d4894a, transparent 65%);
        }

        .su-form-wrapper {
            max-width: 520px;
            animation: authFadeUp 0.5s ease both;
        }

        .su-form-header { margin-bottom: 32px; }

        .su-form-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(181,101,29,0.1);
            border: 1px solid rgba(181,101,29,0.2);
            border-radius: 100px;
            padding: 5px 12px;
            font-size: 11.5px;
            font-weight: 500;
            color: #b5651d;
            margin-bottom: 14px;
        }

        .su-form-title {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            font-weight: 600;
            color: #1a0e07;
            line-height: 1.12;
            margin-bottom: 8px;
        }

        .su-form-subtitle {
            font-size: 14px;
            color: #8b6a52;
            line-height: 1.5;
        }

        .su-section-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 28px 0 18px;
        }

        .su-section-label {
            font-size: 10.5px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #c9a98a;
            white-space: nowrap;
        }

        .su-section-line {
            flex: 1;
            height: 1px;
            background: #e8d5c0;
        }

        .su-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .su-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: #8b6a52;
            margin-bottom: 7px;
        }

        .su-input-wrap { position: relative; }

        .su-icon {
            position: absolute;
            left: 13px;
            top: 50%;
            transform: translateY(-50%);
            color: #c9a98a;
            font-size: 14px;
            pointer-events: none;
        }

        .su-input {
            width: 100%;
            padding: 12px 13px 12px 40px;
            border: 1.5px solid #e8d5c0;
            border-radius: 11px;
            background: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 13.5px;
            color: #1a0e07;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .su-input.su-no-icon { padding-left: 13px; }

        .su-input::placeholder { color: #c9a98a; }

        .su-input:focus {
            border-color: #b5651d;
            box-shadow: 0 0 0 3px rgba(181,101,29,0.1);
        }

        select.su-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7' viewBox='0 0 12 7'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23c9a98a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 13px center;
        }

        textarea.su-input {
            resize: vertical;
            min-height: 82px;
            padding-top: 11px;
            line-height: 1.5;
        }

        .su-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .su-chip {
            padding: 7px 13px;
            border-radius: 100px;
            border: 1.5px solid #e8d5c0;
            background: white;
            font-size: 12.5px;
            font-family: 'DM Sans', sans-serif;
            color: #8b6a52;
            cursor: pointer;
            transition: all 0.18s;
            user-select: none;
        }

        .su-chip:hover { border-color: #b5651d; color: #b5651d; }

        .su-chip.su-chip-sel {
            background: #1a0e07;
            border-color: #1a0e07;
            color: #f5ede3;
        }

        .su-strength-bars {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .su-bar {
            flex: 1;
            height: 3px;
            border-radius: 2px;
            background: #e8d5c0;
            transition: background 0.3s;
        }

        .su-bar.su-s1 { background: #e74c3c; }
        .su-bar.su-s2 { background: #e67e22; }
        .su-bar.su-s3 { background: #f1c40f; }
        .su-bar.su-s4 { background: #2ecc71; }

        .su-btn {
            width: 100%;
            margin-top: 4px;
            padding: 15px;
            background: #1a0e07;
            color: #f5ede3;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 0.2px;
        }

        .su-btn:hover {
            background: #2c1a0e;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(26,14,7,0.25);
        }

        .su-btn:active { transform: translateY(0); }

        .su-benefits {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 32px;
            padding-top: 28px;
            border-top: 1px solid #e8d5c0;
        }

        .su-benefit-card {
            background: white;
            border: 1px solid #e8d5c0;
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }

        .su-benefit-icon { font-size: 20px; margin-bottom: 5px; }
        .su-benefit-title { font-size: 11.5px; font-weight: 500; color: #1a0e07; margin-bottom: 2px; }
        .su-benefit-desc { font-size: 10.5px; color: #8b6a52; line-height: 1.4; }

        @media (max-width: 1000px) {
            .su-right { padding: 44px 44px 56px; }
        }

        @media (max-width: 820px) {
            .su-page { grid-template-columns: 1fr; }
            .su-left { position: static; height: auto; }
            .su-steps-area { margin: 24px 0; }
            .su-right { padding: 32px 22px 48px; }
            .su-grid-2 { grid-template-columns: 1fr; }
            .su-benefits { grid-template-columns: 1fr 1fr; }
        }

        /* === LANDING PAGE === */
        .sidebar-hidden .sidebar { display: none; }
        .sidebar-hidden .main-content { margin-left: 0; padding: 0; width: 100%; }

        .landing-page {
            min-height: 100vh;
            overflow-x: hidden;
            background: var(--warm-white);
            color: var(--espresso);
            font-family: 'DM Sans', sans-serif;
            font-weight: 400;
        }

        /* ── NAV ── */
        .landing-page nav {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 48px;
            background: rgba(253, 250, 244, 0.88);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(192, 124, 58, 0.12);
        }

        .lp-nav-logo {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 900;
            color: var(--espresso);
            letter-spacing: -0.5px;
        }
        .lp-nav-logo span { color: var(--caramel); }

        .lp-nav-links { display: flex; gap: 36px; list-style: none; }
        .lp-nav-links a {
            text-decoration: none;
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.3px;
            transition: color 0.2s;
            cursor: pointer;
        }
        .lp-nav-links a:hover { color: var(--espresso); }

        .lp-nav-actions { display: flex; gap: 12px; align-items: center; }

        .lp-btn-ghost {
            background: none;
            border: none;
            color: var(--brown);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .lp-btn-ghost:hover { background: var(--latte); }

        .lp-btn-primary {
            background: var(--espresso);
            color: var(--cream);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 22px;
            border-radius: 8px;
            border: none;
            transition: background 0.2s, transform 0.15s;
            letter-spacing: 0.2px;
        }
        .lp-btn-primary:hover { background: var(--brown); transform: translateY(-1px); }

        /* ── HERO ── */
        .lp-hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 120px 48px 80px;
            position: relative;
            overflow: hidden;
        }

        .lp-hero-bg {
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 60% 50% at 70% 40%, rgba(192, 124, 58, 0.10) 0%, transparent 70%),
                radial-gradient(ellipse 40% 60% at 20% 80%, rgba(138, 158, 133, 0.10) 0%, transparent 60%);
        }

        .lp-coffee-ring {
            position: absolute;
            right: 6%; top: 18%;
            width: 480px; height: 480px;
            border-radius: 50%;
            border: 1.5px solid rgba(192, 124, 58, 0.15);
            animation: lpSlowSpin 40s linear infinite;
        }
        .lp-coffee-ring::before {
            content: '';
            position: absolute; inset: 24px;
            border-radius: 50%;
            border: 1px solid rgba(192, 124, 58, 0.10);
        }
        .lp-coffee-ring::after {
            content: '';
            position: absolute; inset: 48px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(192, 124, 58, 0.06) 0%, transparent 70%);
        }
        @keyframes lpSlowSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .lp-float-card {
            position: absolute;
            background: var(--card);
            border: 1px solid rgba(192, 124, 58, 0.18);
            border-radius: 16px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(28, 18, 8, 0.08);
            animation: lpFloatUp 6s ease-in-out infinite;
        }
        .lp-float-card:nth-child(2) { animation-delay: -2s; }
        .lp-float-card:nth-child(3) { animation-delay: -4s; }
        @keyframes lpFloatUp {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        .lp-card-1 { right: 14%; top: 28%; }
        .lp-card-2 { right: 28%; top: 55%; }
        .lp-card-3 { right: 8%; top: 64%; }

        .lp-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
            color: white; flex-shrink: 0;
        }
        .lp-avatar.a { background: linear-gradient(135deg, #C07C3A, #D4964F); }
        .lp-avatar.b { background: linear-gradient(135deg, #8A9E85, #6B8566); }
        .lp-avatar.c { background: linear-gradient(135deg, #3D2B1A, #6B4A2E); }

        .lp-float-name { font-size: 13px; font-weight: 600; color: var(--espresso); line-height: 1; margin-bottom: 3px; }
        .lp-float-meta { font-size: 11px; color: var(--muted); }

        .lp-match-badge {
            margin-left: auto;
            background: var(--cream);
            color: var(--caramel);
            font-size: 11px; font-weight: 600;
            padding: 4px 8px;
            border-radius: 20px;
            border: 1px solid var(--latte);
        }

        .lp-hero-content {
            max-width: 580px;
            position: relative; z-index: 1;
            animation: lpFadeUp 0.8s ease both;
        }
        @keyframes lpFadeUp {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lp-hero-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--latte);
            color: var(--brown);
            font-size: 12px; font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            padding: 6px 14px;
            border-radius: 20px;
            margin-bottom: 28px;
        }
        .lp-hero-tag::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--caramel);
        }

        .landing-page h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(44px, 5.5vw, 72px);
            font-weight: 900;
            line-height: 1.05;
            letter-spacing: -1.5px;
            color: var(--espresso);
            margin-bottom: 24px;
        }
        .landing-page h1 em { font-style: italic; color: var(--caramel); }

        .lp-hero-sub {
            font-size: 17px;
            line-height: 1.7;
            color: var(--muted);
            max-width: 460px;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .lp-hero-cta { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }

        .lp-btn-cta {
            background: var(--caramel);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px; font-weight: 600;
            padding: 16px 32px;
            border-radius: 10px; border: none;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.2px;
            box-shadow: 0 4px 24px rgba(192, 124, 58, 0.35);
        }
        .lp-btn-cta:hover {
            background: var(--caramel-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(192, 124, 58, 0.40);
        }

        .lp-btn-outline {
            background: transparent;
            color: var(--brown);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px; font-weight: 500;
            padding: 15px 28px;
            border-radius: 10px;
            border: 1.5px solid rgba(61, 43, 26, 0.25);
            cursor: pointer;
            transition: all 0.2s;
        }
        .lp-btn-outline:hover { border-color: var(--caramel); color: var(--caramel); }

        .lp-social-proof {
            margin-top: 52px;
            display: flex; align-items: center; gap: 16px;
        }
        .lp-avatars-row { display: flex; }
        .lp-mini-av {
            width: 34px; height: 34px;
            border-radius: 50%;
            border: 2.5px solid var(--warm-white);
            margin-left: -10px;
            font-size: 12px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            color: white;
        }
        .lp-mini-av:first-child { margin-left: 0; }
        .lp-mini-av.m1 { background: var(--caramel); }
        .lp-mini-av.m2 { background: var(--sage); }
        .lp-mini-av.m3 { background: var(--brown); }
        .lp-mini-av.m4 { background: #C4956A; }
        .lp-proof-text { font-size: 13px; color: var(--muted); line-height: 1.4; }
        .lp-proof-text strong { color: var(--espresso); font-weight: 600; }

        /* ── STATS BAR ── */
        .lp-stats-bar {
            background: var(--espresso);
            padding: 28px 48px;
            display: flex;
            justify-content: center;
            gap: 80px;
            flex-wrap: wrap;
        }
        .lp-stat-item { text-align: center; }
        .lp-stat-num {
            font-family: 'Playfair Display', serif;
            font-size: 32px; font-weight: 700;
            color: var(--caramel-light);
            line-height: 1; margin-bottom: 4px;
        }
        .lp-stat-label { font-size: 13px; color: rgba(245, 240, 232, 0.6); letter-spacing: 0.3px; }

        /* ── SECTION BASE ── */
        .lp-section { padding: 96px 48px; }
        .lp-section-tag {
            font-size: 11px; font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--caramel);
            margin-bottom: 16px;
        }
        .landing-page h2 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(32px, 4vw, 52px);
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -1px;
            color: var(--espresso);
            margin-bottom: 16px;
        }
        .landing-page h2 em { font-style: italic; color: var(--caramel); }
        .lp-section-sub {
            font-size: 16px;
            color: var(--muted);
            line-height: 1.7;
            font-weight: 300;
            max-width: 520px;
        }

        /* ── HOW IT WORKS ── */
        .lp-how { background: var(--cream); }
        .lp-how-inner { max-width: 1100px; margin: 0 auto; }
        .lp-how-header { margin-bottom: 64px; }
        .lp-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
        }
        .lp-step {
            background: var(--card);
            border: 1px solid rgba(192, 124, 58, 0.15);
            border-radius: 20px;
            padding: 36px 32px;
            position: relative;
            transition: transform 0.25s, box-shadow 0.25s;
        }
        .lp-step:hover { transform: translateY(-4px); box-shadow: 0 16px 48px rgba(28, 18, 8, 0.10); }
        .lp-step-num {
            font-family: 'Playfair Display', serif;
            font-size: 64px; font-weight: 900;
            color: rgba(192, 124, 58, 0.45);
            line-height: 1;
            position: absolute; top: 20px; right: 24px;
            text-shadow: 0 2px 12px rgba(192, 124, 58, 0.15);
        }
        .lp-step-icon {
            width: 48px; height: 48px;
            background: var(--latte);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            margin-bottom: 20px;
        }
        .lp-step h3 {
            font-family: 'Playfair Display', serif;
            font-size: 20px; font-weight: 700;
            color: var(--espresso);
            margin-bottom: 12px;
        }
        .lp-step p { font-size: 14px; line-height: 1.7; color: var(--muted); font-weight: 300; }

        /* ── FEATURES ── */
        .lp-features-inner {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 80px;
            align-items: center;
        }
        .lp-feature-list { display: flex; flex-direction: column; gap: 28px; }
        .lp-feature-item {
            display: flex; gap: 20px;
            align-items: flex-start;
            padding: 24px; border-radius: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .lp-feature-item:hover, .lp-feature-item.active { background: var(--cream); }
        .lp-feature-icon {
            width: 44px; height: 44px; flex-shrink: 0;
            background: var(--latte);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .lp-feature-item.active .lp-feature-icon { background: var(--espresso); }
        .lp-feature-item h3 { font-size: 16px; font-weight: 600; color: var(--espresso); margin-bottom: 6px; }
        .lp-feature-item p { font-size: 14px; color: var(--muted); line-height: 1.6; font-weight: 300; }

        /* App mockup */
        .lp-app-mockup {
            background: var(--espresso);
            border-radius: 28px;
            padding: 24px;
            box-shadow: 0 32px 80px rgba(28, 18, 8, 0.20);
            position: relative; overflow: hidden;
        }
        .lp-app-mockup::before {
            content: '';
            position: absolute; top: -60px; right: -60px;
            width: 200px; height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(192, 124, 58, 0.15) 0%, transparent 70%);
        }
        .lp-mockup-bar { display: flex; gap: 6px; margin-bottom: 20px; }
        .lp-mockup-dot { width: 8px; height: 8px; border-radius: 50%; }
        .lp-mockup-dot.r { background: #FF5F57; }
        .lp-mockup-dot.y { background: #FEBC2E; }
        .lp-mockup-dot.g { background: #28C840; }
        .lp-mockup-tabs {
            display: flex; gap: 4px;
            background: rgba(255,255,255,0.07);
            border-radius: 10px; padding: 4px;
            margin-bottom: 20px;
        }
        .lp-mockup-tab {
            flex: 1; text-align: center;
            padding: 8px; border-radius: 8px;
            font-size: 12px; font-weight: 500;
            color: rgba(245, 240, 232, 0.45);
        }
        .lp-mockup-tab.active { background: var(--caramel); color: white; }
        .lp-mockup-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px; padding: 16px;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 14px;
        }
        .lp-mc-av {
            width: 42px; height: 42px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
            color: white; flex-shrink: 0;
        }
        .lp-mc-av.a1 { background: linear-gradient(135deg, var(--caramel), #D4964F); }
        .lp-mc-av.a2 { background: linear-gradient(135deg, var(--sage), #6B8566); }
        .lp-mc-av.a3 { background: linear-gradient(135deg, #C4956A, #9E6B3A); }
        .lp-mc-info { flex: 1; }
        .lp-mc-name { font-size: 13px; font-weight: 600; color: rgba(245,240,232,0.9); margin-bottom: 3px; }
        .lp-mc-meta { font-size: 11px; color: rgba(245,240,232,0.45); }
        .lp-mc-btn {
            background: rgba(192, 124, 58, 0.25);
            color: var(--caramel-light);
            font-size: 11px; font-weight: 600;
            padding: 6px 12px; border-radius: 20px;
            border: 1px solid rgba(192, 124, 58, 0.3);
            cursor: pointer; white-space: nowrap;
        }

        /* ── MOCKUP PANELS ── */
        .lp-mockup-panel {
            display: none;
            animation: lpPanelIn 0.3s ease both;
        }
        .lp-mockup-panel.active { display: block; }
        @keyframes lpPanelIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Match bar */
        .lp-match-bar-wrap {
            display: flex; align-items: center; gap: 6px;
            margin-top: 5px;
        }
        .lp-match-bar {
            height: 4px; border-radius: 4px;
            background: linear-gradient(90deg, var(--caramel), var(--caramel-light));
            flex-shrink: 0;
        }
        .lp-match-pct {
            font-size: 10px; font-weight: 700;
            color: var(--caramel-light); white-space: nowrap;
        }

        /* Icebreaker panel */
        .lp-ice-header {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            margin-bottom: 14px;
        }
        .lp-ice-label {
            font-size: 10px; font-weight: 700;
            letter-spacing: 0.8px; text-transform: uppercase;
            color: rgba(245,240,232,0.4);
            margin-bottom: 10px;
        }
        .lp-ice-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 11px 14px;
            font-size: 12px; line-height: 1.5;
            color: rgba(245,240,232,0.82);
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .lp-ice-card:hover {
            background: rgba(192,124,58,0.18);
            border-color: rgba(192,124,58,0.35);
        }

        /* Groups panel */
        .lp-group-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px; padding: 14px;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px;
        }
        .lp-group-icon {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0;
        }
        .lp-group-badge {
            font-size: 10px; font-weight: 700;
            color: var(--sage);
            background: rgba(138,158,133,0.15);
            border: 1px solid rgba(138,158,133,0.3);
            padding: 4px 8px; border-radius: 20px;
            white-space: nowrap;
        }

        /* Schedule panel */
        .lp-sched-header {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            margin-bottom: 14px;
        }
        .lp-sched-pill {
            margin-left: auto;
            font-size: 10px; font-weight: 700;
            color: var(--caramel-light);
            background: rgba(192,124,58,0.2);
            border: 1px solid rgba(192,124,58,0.3);
            padding: 4px 9px; border-radius: 20px;
        }
        .lp-sched-slot {
            display: flex; align-items: center; gap: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 12px; padding: 12px 14px;
            margin-bottom: 8px;
            transition: background 0.2s, border-color 0.2s;
        }
        .lp-sched-slot--active {
            background: rgba(192,124,58,0.12);
            border-color: rgba(192,124,58,0.3);
        }
        .lp-sched-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--caramel); flex-shrink: 0;
        }

        /* ── FOUNDER ── */
        .lp-founder { background: var(--cream); }
        .lp-founder-inner {
            max-width: 900px; margin: 0 auto;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 64px;
            align-items: center;
        }
        .lp-founder-portrait {
            width: 220px; height: 220px;
            border-radius: 50%;
            background: var(--latte);
            display: flex; align-items: center; justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 72px; font-weight: 900;
            color: var(--caramel);
            flex-shrink: 0;
            position: relative; overflow: hidden;
            border: 4px solid rgba(192, 124, 58, 0.2);
        }
        .lp-founder-portrait img { width: 100%; height: 100%; object-fit: cover; }
        .lp-founder-quote {
            font-family: 'Playfair Display', serif;
            font-size: clamp(20px, 2.5vw, 28px);
            font-style: italic; font-weight: 700;
            line-height: 1.4;
            color: var(--espresso);
            margin-bottom: 24px;
        }
        .lp-founder-attr {
            font-size: 14px; color: var(--muted);
            display: flex; align-items: center; gap: 12px;
        }
        .lp-founder-attr::before {
            content: '';
            width: 32px; height: 1.5px;
            background: var(--caramel);
        }

        /* ── CTA SECTION ── */
        .lp-cta-section {
            background: var(--espresso);
            text-align: center;
            padding: 100px 48px;
            position: relative; overflow: hidden;
        }
        .lp-cta-section::before {
            content: '';
            position: absolute;
            top: -100px; left: 50%;
            transform: translateX(-50%);
            width: 600px; height: 600px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(192, 124, 58, 0.12) 0%, transparent 70%);
        }
        .lp-cta-section h2 { color: var(--cream); max-width: 600px; margin: 0 auto 16px; }
        .lp-cta-section .lp-section-sub { color: rgba(245, 240, 232, 0.55); margin: 0 auto 40px; }

        /* ── FOOTER ── */
        .lp-footer {
            background: var(--espresso);
            border-top: 1px solid rgba(245, 240, 232, 0.08);
            padding: 32px 48px;
            display: flex; align-items: center;
            justify-content: space-between;
        }
        .lp-footer-logo {
            font-family: 'Playfair Display', serif;
            font-size: 18px; font-weight: 900;
            color: var(--cream);
        }
        .lp-footer-logo span { color: var(--caramel); }
        .lp-footer-text { font-size: 13px; color: rgba(245, 240, 232, 0.35); }
        .lp-footer-links { display: flex; gap: 24px; list-style: none; }
        .lp-footer-links a {
            font-size: 13px; color: rgba(245, 240, 232, 0.45);
            text-decoration: none; transition: color 0.2s;
        }
        .lp-footer-links a:hover { color: var(--caramel-light); }

        /* ── SCROLL ANIMATIONS ── */
        .reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .reveal.visible { opacity: 1; transform: translateY(0); }

        /* ── HAMBURGER (mobile) ── */
        .lp-hamburger {
            display: none;
            background: none; border: none;
            cursor: pointer; padding: 8px;
            z-index: 101;
        }
        .lp-hamburger span {
            display: block;
            width: 22px; height: 2px;
            background: var(--espresso);
            margin: 5px 0; border-radius: 2px;
            transition: all 0.3s ease;
        }
        .lp-hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .lp-hamburger.active span:nth-child(2) { opacity: 0; }
        .lp-hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        .lp-mobile-menu {
            display: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(253, 250, 244, 0.97);
            backdrop-filter: blur(20px);
            z-index: 99;
            flex-direction: column;
            justify-content: center; align-items: center;
            gap: 1.5rem;
        }
        .lp-mobile-menu.active { display: flex; }
        .lp-mobile-menu a {
            font-size: 18px; color: var(--muted);
            text-decoration: none; padding: 12px 24px;
            cursor: pointer; transition: color 0.2s;
        }
        .lp-mobile-menu a:hover { color: var(--espresso); }
        .lp-mobile-buttons {
            display: flex; flex-direction: column;
            gap: 0.75rem; margin-top: 1rem;
            width: 100%; max-width: 280px;
        }
        .lp-mobile-buttons .lp-btn-ghost,
        .lp-mobile-buttons .lp-btn-primary {
            width: 100%; min-height: 48px;
            font-size: 15px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
        }

        /* ── RESPONSIVE ── */
        @media (max-width: 900px) {
            .landing-page nav { padding: 16px 24px; }
            .lp-nav-links { display: none; }
            .lp-nav-actions { display: none; }
            .lp-hamburger { display: block; }
            .lp-hero { padding: 100px 24px 60px; }
            .lp-float-card { display: none; }
            .lp-coffee-ring { display: none; }
            .lp-section { padding: 64px 24px; }
            .lp-steps { grid-template-columns: 1fr; }
            .lp-features-inner { grid-template-columns: 1fr; gap: 40px; }
            .lp-founder-inner { grid-template-columns: 1fr; text-align: center; }
            .lp-founder-portrait { margin: 0 auto; }
            .lp-footer { flex-direction: column; gap: 16px; text-align: center; }
            .lp-stats-bar { gap: 40px; padding: 28px 24px; }
            .lp-cta-section { padding: 64px 24px; }
        }
        @media (max-width: 600px) {
            .lp-hero { padding: 90px 20px 48px; }
            .lp-section { padding: 48px 20px; }
            .landing-page h1 { font-size: 36px; }
            .landing-page h2 { font-size: 28px; }
            .lp-stats-bar { gap: 24px; }
            .lp-cta-section { padding: 48px 20px; }
            .lp-footer { padding: 24px 20px; }
        }


        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .grid.two-col {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 28px;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Zero-state CTA Cards */
        .cta-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            margin-bottom: 24px;
        }

        .cta-card {
            background: var(--card);
            border: 1.5px dashed rgba(192,124,58,0.25);
            border-radius: 16px;
            padding: 24px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cta-card:hover {
            border-color: var(--caramel);
            transform: translateY(-3px);
            box-shadow: 0 10px 28px rgba(192,124,58,0.12);
        }

        .cta-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .cta-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--espresso);
            margin-bottom: 0.4rem;
        }

        .cta-card p {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.5;
            font-weight: 300;
        }

        /* Hub Tab Bar */
        .hub-tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: var(--card);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .hub-tab {
            flex: 1;
            padding: 9px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: 13.5px;
            cursor: pointer;
            color: var(--muted);
            transition: all 0.15s ease;
        }

        .hub-tab.active {
            background: var(--espresso);
            color: var(--cream);
            font-weight: 600;
        }

        .hub-tab:hover:not(.active) {
            background: var(--latte-soft);
            color: var(--espresso);
        }

        .hub-panel-content {
            display: none;
        }

        .hub-panel-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* My Chats Hub */
        .chats-hub-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            gap: 1rem;
        }

        .chats-hub-search {
            flex: 1;
            position: relative;
        }

        .chats-hub-search input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .chats-hub-search input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chats-hub-search::before {
            content: '🔍';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            pointer-events: none;
        }

        .chats-section-label {
            font-weight: 700;
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 0.75rem;
            margin-top: 1.25rem;
        }

        .chat-inbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid transparent;
            margin-bottom: 0.25rem;
        }

        .chat-inbox-item:hover {
            background: var(--bg-light);
            border-color: var(--border);
        }

        .chat-inbox-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 15px;
            flex-shrink: 0;
        }

        .chat-inbox-info {
            flex: 1;
            min-width: 0;
        }

        .chat-inbox-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .chat-inbox-preview {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scheduled-chat-item {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            background: var(--accent-light);
            border: 1px solid var(--border);
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .scheduled-chat-item:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(139,90,60,0.1);
        }

        .scheduled-chat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--accent);
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .btn-schedule-chat {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-schedule-chat:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139,90,60,0.25);
        }

        /* Connection card in My Network tab */
        .connection-card {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            background: white;
            border: 1px solid var(--border);
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .connection-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(139,90,60,0.08);
        }

        .connection-card-avatar {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .connection-card-info {
            flex: 1;
            min-width: 0;
        }

        .connection-card-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .connection-card-role {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .connection-card-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        /* Group list card in My Groups tab */
        .group-list-card {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            background: white;
            border: 1px solid var(--border);
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .group-list-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(139,90,60,0.08);
        }

        .group-list-icon {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            background: var(--accent-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        /* Find More banner */
        .find-more-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--accent-light), #fff8f0);
            border: 1.5px dashed var(--accent);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-top: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 1rem;
        }

        .find-more-banner:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139,90,60,0.1);
        }

        /* Feed sub-tabs */
        .feed-subtab-bar {
            display: inline-flex;
            gap: 0.25rem;
            background: white;
            border-radius: 10px;
            padding: 0.3rem;
            border: 1px solid var(--border);
        }

        .feed-subtab {
            padding: 7px 18px;
            border: none;
            background: transparent;
            border-radius: 7px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            color: #888;
            transition: all 0.2s ease;
        }

        .feed-subtab.active {
            background: var(--primary);
            color: white;
        }

        .feed-subtab:hover:not(.active) {
            background: var(--bg-light);
            color: var(--primary);
        }

        /* Schedule chat modal person picker */
        .schedule-modal-person {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            border: 1.5px solid transparent;
            transition: all 0.2s;
            background: var(--bg-light);
            margin-bottom: 0.35rem;
        }

        .schedule-modal-person:hover {
            border-color: var(--primary);
            background: white;
        }

        /* Availability slots display */
        .avail-slot-btn {
            padding: 6px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dark);
        }

        .avail-slot-btn:hover, .avail-slot-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        @media (max-width: 600px) {
            .connection-card-actions {
                flex-direction: column;
            }
            .find-more-banner {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Person Card */
        .person-card {
            text-align: center;
        }

        .person-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            margin: 0 auto 1rem;
        }

        .person-card h3 {
            text-align: center;
            margin-bottom: 0.25rem;
        }

        .person-card .role {
            font-size: 12px;
            color: #999;
            margin-bottom: 0.5rem;
        }

        .person-card .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .tag {
            background: var(--bg-light);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Calendar */
        .calendar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-header button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
            padding: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-light);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-day.today {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .calendar-day.has-event {
            border: 2px solid var(--accent);
            font-weight: 600;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* Time Slots */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .time-slot {
            padding: 0.75rem;
            background: var(--bg-light);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .time-slot:hover {
            border-color: var(--primary);
            background: white;
        }

        .time-slot.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Video Call */
        .call-container {
            background: black;
            border-radius: 16px;
            padding: 2rem;
            color: white;
            text-align: center;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .video-box {
            background: #333;
            border-radius: 12px;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .video-box.local {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            aspect-ratio: 9 / 16;
        }

        .video-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .avatar-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
        }

        .call-info {
            margin-bottom: 2rem;
        }

        .call-info h2 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .call-duration {
            font-size: 14px;
            color: #aaa;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn.mic {
            background: var(--primary);
            color: white;
        }

        .control-btn.mic:hover {
            background: var(--primary-dark);
        }

        .control-btn.video {
            background: var(--primary);
            color: white;
        }

        .control-btn.video:hover {
            background: var(--primary-dark);
        }

        .control-btn.end {
            background: var(--danger);
            color: white;
        }

        .control-btn.end:hover {
            background: #e55555;
        }

        .control-btn.muted {
            background: #555;
            color: #aaa;
        }

        /* Messages */
        .messages-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: 600px;
        }

        .conversation-list {
            background: white;
            border-radius: 12px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .conversation-item:hover {
            background: var(--bg-light);
        }

        .conversation-item.active {
            background: linear-gradient(135deg, rgba(111, 78, 55, 0.1), rgba(212, 165, 116, 0.1));
        }

        .conversation-name-link {
            color: inherit;
            cursor: pointer;
        }

        .conversation-name-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .chat-window {
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* === STEAM ANIMATION === */
        .steam-container {
            position: relative;
            display: inline-block;
        }
        .steam {
            position: absolute;
            top: -8px;
            width: 4px;
            height: 10px;
            background: transparent;
            border-radius: 50%;
            opacity: 0;
        }
        .steam::before, .steam::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 10px;
            background: rgba(212, 165, 116, 0.5);
            border-radius: 50%;
            animation: steamRise 2s ease-out infinite;
        }
        .steam:nth-child(2)::before { animation-delay: 0.4s; left: 4px; }
        .steam:nth-child(3)::before { animation-delay: 0.8s; left: 8px; }

        @keyframes steamRise {
            0% { opacity: 0; transform: translateY(0) scaleX(1); }
            15% { opacity: 0.7; }
            50% { opacity: 0.3; transform: translateY(-12px) scaleX(1.5); }
            100% { opacity: 0; transform: translateY(-24px) scaleX(0.5); }
        }

        /* === ENHANCED CARD HOVER === */
        .card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            box-shadow: 0 12px 32px rgba(62, 39, 35, 0.15);
            transform: translateY(-4px);
        }

        /* === ENHANCED BUTTON HOVER === */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(111, 78, 55, 0.25);
        }
        .btn:active {
            transform: scale(0.98);
        }

        /* === NAV ITEM HOVER INDICATOR === */
        .nav-item {
            position: relative;
            overflow: hidden;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%) scaleY(0);
            width: 3px;
            height: 60%;
            background: var(--accent);
            border-radius: 0 3px 3px 0;
            transition: transform 0.2s ease;
        }
        .nav-item:hover::before {
            transform: translateY(-50%) scaleY(1);
        }
        .nav-item.active::before {
            transform: translateY(-50%) scaleY(1);
            background: var(--primary-dark);
        }

        /* === COFFEE DIVIDER === */
        .coffee-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
            color: var(--accent);
            font-size: 14px;
        }
        .coffee-divider::before, .coffee-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border), transparent);
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1), toastOut 0.4s ease 2.6s forwards;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 360px;
        }
        .toast.success { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .toast.info { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .toast.warning { background: linear-gradient(135deg, #FF9800, #E65100); }
        .toast.error { background: linear-gradient(135deg, #FF6B6B, #D32F2F); }
        .toast.celebration { background: linear-gradient(135deg, var(--accent), #C68B59); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        /* === CONFETTI === */
        .confetti-piece {
            position: fixed;
            width: 8px;
            height: 8px;
            z-index: 10002;
            pointer-events: none;
            animation: confettiFall 1.5s ease forwards;
        }
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
            100% { opacity: 0; transform: translateY(400px) rotate(720deg) scale(0.3); }
        }

        /* === PULSE ANIMATION === */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* === GROUP CARD ENHANCEMENTS === */
        .group-card {
            background: linear-gradient(135deg, white 0%, #FFF8F0 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .group-card:hover {
            box-shadow: 0 12px 32px rgba(62, 39, 35, 0.15);
            transform: translateY(-4px);
        }
        .group-card .group-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .activity-dot.active {
            background: #4CAF50;
            box-shadow: 0 0 6px rgba(76, 175, 80, 0.5);
            animation: dotPulse 2s ease infinite;
        }
        .activity-dot.inactive {
            background: #ccc;
        }
        @keyframes dotPulse {
            0%, 100% { box-shadow: 0 0 4px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 0 10px rgba(76, 175, 80, 0.6); }
        }
        .member-avatars {
            display: flex;
            margin: 0.75rem 0;
        }
        .member-avatars .mini-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            margin-left: -8px;
        }
        .member-avatars .mini-avatar:first-child {
            margin-left: 0;
        }
        .member-avatars .mini-avatar.more {
            background: var(--accent);
            color: var(--text-dark);
            font-size: 9px;
        }
        .group-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 12px;
            color: #999;
            margin: 0.5rem 0;
        }
        .industry-pill {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            background: rgba(111, 78, 55, 0.1);
            color: var(--primary);
            font-size: 11px;
            font-weight: 600;
        }

        /* === PROFILE COMPLETION === */
        .completion-card {
            background: linear-gradient(135deg, #FFF8F0 0%, #F5E6D3 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .completion-card:hover {
            box-shadow: 0 8px 24px rgba(62, 39, 35, 0.12);
        }
        .progress-ring-container {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }
        .progress-ring-container svg {
            transform: rotate(-90deg);
        }
        .progress-ring-bg {
            fill: none;
            stroke: var(--latte-soft);
            stroke-width: 6;
        }
        .progress-ring-fill {
            fill: none;
            stroke: var(--caramel);
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 700;
            color: var(--espresso);
        }
        .completion-info h3 {
            margin-bottom: 0.25rem;
        }
        .completion-info p {
            font-size: 13px;
            color: #999;
            margin-bottom: 0.5rem;
        }

        /* === GETTING STARTED CHECKLIST === */
        .getting-started {
            /* The dark card style is applied inline in the HTML */
            border-radius: 18px;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .getting-started-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .getting-started-header h3 {
            margin-bottom: 0;
        }
        .dismiss-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }
        .dismiss-btn:hover {
            color: var(--primary);
        }
        .checklist {
            list-style: none;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-radius: 10px;
            padding: 10px 14px;
            transition: background 0.15s;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.08);
            flex: 1;
            min-width: 150px;
        }
        .checklist-item:hover {
            background: rgba(255,255,255,0.11);
        }
        .checklist-item.done {
            opacity: 0.45;
        }
        .checklist-item .check-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            flex-shrink: 0;
            color: rgba(255,255,255,0.4);
            transition: all 0.2s;
        }
        .checklist-item.done .check-icon {
            background: var(--caramel);
            border-color: var(--caramel);
            color: white;
        }
        .check-label {
            font-size: 12px;
            font-weight: 500;
            color: rgba(245,240,232,0.8);
            line-height: 1.3;
        }
        .checklist-item.done .check-label {
            text-decoration: line-through;
            color: rgba(245,240,232,0.4);
        }

        /* === NOTIFICATION BELL === */
        .notification-bell {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .notification-bell .bell-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            font-size: 9px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-bell .bell-badge.hidden {
            display: none;
        }
        @keyframes bellShake {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(10deg); }
        }
        .notification-bell.has-new {
            animation: bellShake 0.6s ease;
        }

        /* === NOTIFICATION PANEL === */
        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
            z-index: 9998;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        .notification-panel.open {
            right: 0;
        }
        .notification-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 9997;
            display: none;
        }
        .notification-panel-overlay.open {
            display: block;
        }
        .notification-panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-panel-header h3 {
            margin-bottom: 0;
        }
        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .notification-item:hover {
            background: #FFF8F0;
        }
        .notification-item.unread {
            background: rgba(212, 165, 116, 0.08);
        }
        .notification-item.notif-clickable:hover {
            background: #FFF3E0;
        }
        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .notification-icon.meeting { background: rgba(111, 78, 55, 0.1); }
        .notification-icon.connection { background: rgba(76, 175, 80, 0.1); }
        .notification-icon.message { background: rgba(33, 150, 243, 0.1); }
        .notification-icon.event { background: rgba(255, 152, 0, 0.1); }
        .notification-icon.badge { background: rgba(212, 165, 116, 0.15); }
        .notification-text {
            flex: 1;
        }
        .notification-text p {
            font-size: 13px;
            margin-bottom: 2px;
            line-height: 1.4;
        }
        .notification-text .notif-time {
            font-size: 11px;
            color: #999;
        }
        .notification-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        /* === BADGES & GAMIFICATION === */
        .badge-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            width: 72px;
            text-align: center;
            position: relative;
        }
        .badge-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: linear-gradient(135deg, #FFF8F0, #F5E6D3);
            border: 2px solid var(--accent);
            transition: all 0.3s;
        }
        .badge-item.locked .badge-icon {
            filter: grayscale(1);
            opacity: 0.4;
            border-color: #ddd;
        }
        .badge-item:not(.locked) .badge-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(212, 165, 116, 0.4);
        }
        .badge-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--primary);
            line-height: 1.2;
        }
        .badge-item.locked .badge-name {
            color: #ccc;
        }
        .badge-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-dark);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .badge-item:hover .badge-tooltip {
            opacity: 1;
        }
        .streak-counter {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FF9800, #E65100);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .badge-toast-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            background: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease;
        }
        .badge-toast-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: badgePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 300px;
        }
        .badge-toast-card .big-badge {
            font-size: 64px;
            margin-bottom: 1rem;
        }
        @keyframes badgePop {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: var(--bg-light);
            color: var(--text-dark);
            font-size: 14px;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: var(--primary);
            color: white;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        .chat-input input {
            flex: 1;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .search-bar input {
            flex: 1;
        }

        .search-bar select {
            min-width: 180px;
        }

        /* Meeting Card */
        .meeting-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            margin-bottom: 1rem;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .meeting-time {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
        }

        .meeting-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .meeting-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .meeting-status.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .meeting-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }

        /* Profile Detail */
        .profile-detail {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .profile-header .person-avatar {
            width: 120px;
            height: 120px;
            font-size: 48px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .profile-header .person-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-header .edit-profile-btn {
            position: absolute;
            top: 0;
            right: 0;
        }

        .profile-info {
            margin-bottom: 1.5rem;
        }

        .profile-info-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 14px;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .profile-actions button {
            flex: 1;
        }

        .profile-posts {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .post-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .post-meta {
            font-size: 12px;
            color: #999;
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .post-action-btn:hover {
            background: rgba(111, 78, 55, 0.1);
        }

        .resume-section {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .resume-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-decoration: none;
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .resume-link:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .resume-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-light);
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: white;
        }

        .file-upload-area.drag-over {
            border-color: var(--accent);
            background: rgba(212, 165, 116, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .avatar-upload-preview {
            width: 150px;
            height: 150px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 60px;
            font-weight: 700;
        }

        .avatar-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .messages-wrapper {
                grid-template-columns: 250px 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .cta-cards-grid {
                grid-template-columns: 1fr;
            }

            .hub-tab {
                font-size: 12px;
                padding: 8px 10px;
            }

            .grid.two-col {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .sidebar nav {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }

            body.app-mode #settingsView.active { margin-left: 0; width: 100%; }

            .messages-wrapper {
                grid-template-columns: 1fr;
                height: auto;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-bar select {
                min-width: unset;
            }

            .auth-container {
                margin: 1.5rem auto;
                padding: 1.5rem;
                max-width: 100%;
                box-sizing: border-box;
            }

            .auth-container h1 {
                font-size: 24px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--latte); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--caramel); }

        /* Floating schedule chat button */
        .btn-schedule-chat {
            background: var(--caramel) !important;
            color: white !important;
            border: none !important;
            border-radius: 20px !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 16px rgba(192,124,58,0.3) !important;
        }
        .btn-schedule-chat:hover {
            background: var(--caramel-light) !important;
            transform: translateY(-2px) !important;
        }

        /* ══════════════════════════════════
           MY CHATS — Redesigned View
        ══════════════════════════════════ */

        /* Extra tokens used in this view */
        #messagesView {
            --mc-steam:       #faf6f1;
            --mc-latte-light: #f0e4d4;
            --mc-honey:       #d4894a;
            --mc-dark-roast:  #2c1a0e;
            --mc-medium-roast:#5c3317;
            --mc-green:       #2d7a4f;
            --mc-green-bg:    #eaf6ef;
            --mc-red:         #c0392b;
            --mc-red-bg:      #fdecea;
            --mc-blue:        #2563eb;
            --mc-blue-bg:     #eff4ff;
            --mc-text-muted:  #8b6a52;
            --mc-text-light:  #c9a98a;
        }

        /* Page header */
        .mc-page-header {
            padding: 28px 36px 0;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }
        .mc-page-eyebrow {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--caramel);
            margin-bottom: 5px;
        }
        .mc-page-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--espresso);
            line-height: 1.1;
        }
        .mc-page-title em { font-style: italic; color: var(--caramel); }
        .mc-btn-schedule {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--espresso);
            color: var(--cream);
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .mc-btn-schedule:hover { background: var(--mc-dark-roast); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(26,14,7,0.2); }

        /* Stats row */
        .mc-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            padding: 20px 36px 0;
        }
        .mc-stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            gap: 13px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .mc-stat-card:hover { border-color: var(--caramel); box-shadow: 0 4px 16px rgba(192,124,58,0.09); }
        .mc-stat-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; flex-shrink: 0;
        }
        .mc-stat-icon.orange { background: rgba(192,124,58,0.1); }
        .mc-stat-icon.green  { background: var(--mc-green-bg); }
        .mc-stat-icon.cream  { background: var(--latte-soft); }
        .mc-stat-icon.blue   { background: var(--mc-blue-bg); }
        .mc-stat-val {
            font-family: 'Playfair Display', serif;
            font-size: 24px; font-weight: 700;
            color: var(--espresso); line-height: 1;
        }
        .mc-stat-lbl { font-size: 11.5px; color: var(--mc-text-muted); margin-top: 2px; }

        /* Content grid */
        .mc-content-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 22px;
            padding: 20px 36px 48px;
            align-items: start;
        }

        /* Tabs */
        .mc-tabs-bar {
            display: flex;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 18px;
            width: fit-content;
            gap: 0;
        }
        .mc-tab-btn {
            padding: 7px 16px;
            border: none;
            border-radius: 9px;
            background: transparent;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--mc-text-muted);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .mc-tab-btn.active {
            background: var(--espresso);
            color: var(--cream);
            box-shadow: 0 2px 8px rgba(26,14,7,0.15);
        }
        .mc-tab-btn:hover:not(.active) { color: var(--espresso); }

        /* Chat cards */
        .mc-chat-list { display: flex; flex-direction: column; gap: 13px; }
        .mc-chat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px 20px;
            display: flex;
            flex-direction: column;
            gap: 0;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .mc-chat-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            border-radius: 3px 0 0 3px;
            background: transparent;
            transition: background 0.2s;
        }
        .mc-chat-card:hover { border-color: var(--caramel); box-shadow: 0 4px 20px rgba(192,124,58,0.1); transform: translateY(-1px); }
        .mc-chat-card:hover::before { background: var(--caramel); }
        .mc-chat-card.upcoming::before { background: var(--caramel); }
        .mc-chat-card.completed::before { background: var(--mc-green); }
        .mc-chat-card.pending::before { background: var(--mc-honey); }

        .mc-card-top { display: grid; grid-template-columns: auto 1fr auto; gap: 14px; align-items: center; }

        .mc-avatar-wrap { position: relative; flex-shrink: 0; }
        .mc-avatar {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; font-weight: 700; color: white;
        }
        .mc-avatar-status {
            position: absolute;
            bottom: 1px; right: 1px;
            width: 11px; height: 11px;
            border-radius: 50%;
            border: 2px solid var(--card);
        }
        .mc-avatar-status.online  { background: var(--mc-green); }
        .mc-avatar-status.offline { background: var(--latte); }

        .mc-chat-name { font-size: 14.5px; font-weight: 600; color: var(--espresso); margin-bottom: 3px; }
        .mc-chat-meta {
            font-size: 12px; color: var(--mc-text-muted);
            display: flex; align-items: center; gap: 7px; flex-wrap: wrap;
        }
        .mc-meta-dot { width: 3px; height: 3px; border-radius: 50%; background: var(--mc-text-light); }
        .mc-chat-topic { font-size: 12.5px; color: var(--mc-text-muted); margin-top: 5px; }

        .mc-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 7px; }
        .mc-status-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-size: 10.5px; font-weight: 500;
            border-radius: 100px;
            padding: 3px 10px;
        }
        .mc-status-badge.upcoming  { background: rgba(192,124,58,0.1); color: var(--caramel); }
        .mc-status-badge.completed { background: var(--mc-green-bg); color: var(--mc-green); }
        .mc-status-badge.pending   { background: rgba(212,150,74,0.12); color: #b37a00; }
        .mc-status-badge.cancelled { background: var(--mc-red-bg); color: var(--mc-red); }

        .mc-chat-date  { font-size: 11.5px; color: var(--mc-text-muted); text-align: right; }
        .mc-chat-time  { font-size: 12.5px; font-weight: 600; color: var(--espresso); }

        /* Card actions */
        .mc-card-actions {
            display: flex; gap: 7px;
            margin-top: 14px;
            padding-top: 13px;
            border-top: 1px solid var(--mc-latte-light);
            flex-wrap: wrap;
        }
        .mc-btn-sm {
            padding: 6px 13px;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px; font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.18s;
        }
        .mc-btn-sm.primary { background: var(--espresso); color: var(--cream); }
        .mc-btn-sm.primary:hover { background: var(--mc-dark-roast); }
        .mc-btn-sm.secondary { background: var(--mc-steam); color: var(--mc-text-muted); border: 1px solid var(--border); }
        .mc-btn-sm.secondary:hover { border-color: var(--caramel); color: var(--caramel); }
        .mc-btn-sm.danger { background: transparent; color: var(--mc-red); border: 1px solid var(--border); margin-left: auto; }
        .mc-btn-sm.danger:hover { border-color: var(--mc-red); background: var(--mc-red-bg); }

        /* Icebreakers block */
        .mc-icebreakers {
            background: var(--mc-steam);
            border-radius: 10px;
            padding: 11px 13px;
            margin-top: 13px;
        }
        .mc-icebr-label {
            font-size: 10px; font-weight: 600;
            letter-spacing: 1.5px; text-transform: uppercase;
            color: var(--caramel); margin-bottom: 7px;
        }
        .mc-icebr-item {
            font-size: 12px; color: var(--mc-text-muted);
            padding: 5px 10px;
            background: var(--card);
            border-radius: 7px;
            border: 1px solid var(--border);
            margin-bottom: 5px;
            cursor: pointer;
            transition: border-color 0.15s, color 0.15s;
        }
        .mc-icebr-item:last-child { margin-bottom: 0; }
        .mc-icebr-item:hover { border-color: var(--caramel); color: var(--espresso); }

        /* Right column widgets */
        .mc-right-col { display: flex; flex-direction: column; gap: 18px; }
        .mc-widget {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        .mc-widget-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--mc-latte-light);
            display: flex; align-items: center; justify-content: space-between;
        }
        .mc-widget-title {
            font-family: 'Playfair Display', serif;
            font-size: 15px; font-weight: 700; color: var(--espresso);
        }
        .mc-widget-action {
            font-size: 11.5px; color: var(--caramel);
            cursor: pointer; font-weight: 500;
            background: none; border: none; font-family: 'DM Sans', sans-serif;
        }
        .mc-widget-action:hover { color: var(--mc-medium-roast); }

        /* Mini calendar */
        .mc-cal-wrap { padding: 14px 18px 18px; }
        .mc-cal-nav {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .mc-cal-nav-btn {
            width: 26px; height: 26px;
            border-radius: 7px;
            border: 1px solid var(--border);
            background: transparent;
            cursor: pointer;
            font-size: 12px; color: var(--mc-text-muted);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .mc-cal-nav-btn:hover { border-color: var(--caramel); color: var(--caramel); }
        .mc-cal-month { font-size: 13px; font-weight: 600; color: var(--espresso); }
        .mc-cal-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            gap: 1px;
        }
        .mc-cal-day-name {
            font-size: 9.5px; font-weight: 600;
            letter-spacing: 0.5px; text-transform: uppercase;
            color: var(--mc-text-light);
            padding: 4px 0 6px;
        }
        .mc-cal-day {
            aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 11.5px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--mc-text-muted);
            transition: background 0.15s, color 0.15s;
            position: relative;
        }
        .mc-cal-day:hover { background: var(--latte-soft); color: var(--espresso); }
        .mc-cal-day.today {
            background: var(--espresso);
            color: var(--cream);
            font-weight: 600;
        }
        .mc-cal-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 2px; left: 50%; transform: translateX(-50%);
            width: 3px; height: 3px;
            border-radius: 50%;
            background: var(--caramel);
        }
        .mc-cal-day.today.has-event::after { background: var(--mc-honey); }
        .mc-cal-day.other-month { color: var(--mc-text-light); opacity: 0.5; }

        /* Upcoming quick list */
        .mc-upcoming-list { padding: 4px 18px 18px; display: flex; flex-direction: column; gap: 10px; }
        .mc-upcoming-item {
            display: flex; align-items: center; gap: 11px;
            padding: 11px 13px;
            background: var(--latte-soft);
            border-radius: 11px;
            border: 1px solid var(--mc-latte-light);
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .mc-upcoming-item:hover { border-color: var(--caramel); }
        .mc-udb {
            min-width: 38px;
            text-align: center;
            padding: 5px 7px;
            background: var(--cream);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .mc-udb-month { font-size: 8.5px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--caramel); }
        .mc-udb-day { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--espresso); line-height: 1; }
        .mc-upcoming-info { flex: 1; min-width: 0; }
        .mc-upcoming-name { font-size: 13px; font-weight: 600; color: var(--espresso); margin-bottom: 1px; }
        .mc-upcoming-time { font-size: 11px; color: var(--mc-text-muted); }
        .mc-upcoming-mode {
            font-size: 10px; font-weight: 500;
            background: var(--cream); color: var(--caramel);
            border-radius: 100px;
            padding: 2px 8px; white-space: nowrap;
            border: 1px solid var(--border);
        }

        /* Tips widget */
        .mc-tips-widget {
            background: linear-gradient(135deg, var(--espresso) 0%, var(--mc-dark-roast) 100%);
            border: none;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .mc-tips-widget::before {
            content: '';
            position: absolute; inset: 0;
            background: radial-gradient(ellipse 80% 80% at 100% 0%, rgba(212,137,74,0.18) 0%, transparent 60%);
            pointer-events: none;
        }
        .mc-tips-body {
            padding: 20px;
            position: relative; z-index: 1;
        }
        .mc-tips-icon { font-size: 26px; margin-bottom: 9px; }
        .mc-tips-title {
            font-family: 'Playfair Display', serif;
            font-size: 14px; font-weight: 700;
            color: var(--cream); margin-bottom: 6px;
        }
        .mc-tips-text { font-size: 12px; line-height: 1.5; color: rgba(245,237,227,0.6); margin-bottom: 13px; }
        .mc-tips-tip {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(192,124,58,0.25);
            border-radius: 9px;
            padding: 10px 12px;
            font-size: 12px; color: rgba(245,237,227,0.8);
            line-height: 1.5; font-style: italic;
        }

        /* Empty state within My Chats */
        .mc-empty {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center;
            padding: 48px 20px;
            background: var(--card);
            border: 1.5px dashed var(--border);
            border-radius: 16px;
        }
        .mc-empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
        .mc-empty-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px; color: var(--espresso); margin-bottom: 7px;
        }
        .mc-empty-desc { font-size: 13px; color: var(--mc-text-muted); max-width: 240px; line-height: 1.5; margin-bottom: 18px; }

        /* Direct messages tab (inside My Chats) */
        .mc-messages-wrapper {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            min-height: 420px;
        }
        .mc-conv-list {
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }
        .mc-conv-list-header {
            padding: 14px 16px 10px;
            font-size: 11px; font-weight: 600;
            letter-spacing: 1.5px; text-transform: uppercase;
            color: var(--mc-text-muted);
            border-bottom: 1px solid var(--mc-latte-light);
        }
        .mc-chat-win {
            display: flex; flex-direction: column;
        }

        @media (max-width: 1100px) {
            .mc-content-grid { grid-template-columns: 1fr; }
            .mc-right-col { display: grid; grid-template-columns: 1fr 1fr; }
            .mc-stats-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 760px) {
            .mc-page-header, .mc-stats-row, .mc-content-grid { padding-left: 16px; padding-right: 16px; }
            .mc-right-col { grid-template-columns: 1fr; }
            .mc-stats-row { grid-template-columns: repeat(2, 1fr); }
            .mc-messages-wrapper { grid-template-columns: 1fr; }
            .mc-conv-list { border-right: none; border-bottom: 1px solid var(--border); max-height: 200px; }
        }

        /* ══════════════════════════════════
           DASHBOARD — Redesigned View
        ══════════════════════════════════ */

        /* extra tokens for dashboard */
        #dashboardView {
            --db-steam:       #faf6f1;
            --db-latte-light: #f0e4d4;
            --db-honey:       #d4894a;
            --db-dark-roast:  #2c1a0e;
            --db-medium-roast:#5c3317;
            --db-green:       #2d7a4f;
            --db-green-bg:    #eaf6ef;
            --db-blue:        #2563eb;
            --db-blue-bg:     #eff4ff;
            --db-text-muted:  #8b6a52;
            --db-text-light:  #c9a98a;
        }

        /* ── Hero Banner ── */
        .db-hero {
            background: var(--espresso);
            position: relative; overflow: hidden;
            padding: 36px 44px;
            flex-shrink: 0;
        }
        .db-hero::before {
            content: ''; position: absolute; inset: 0;
            background:
                radial-gradient(ellipse 70% 100% at -5% 100%, rgba(192,124,58,.35) 0%, transparent 55%),
                radial-gradient(ellipse 50% 80% at 105% -10%, rgba(212,137,74,.12) 0%, transparent 50%);
            pointer-events: none;
        }
        .db-grain {
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
            pointer-events: none; opacity: .5;
        }
        .db-hero-inner {
            position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: space-between;
            gap: 24px; flex-wrap: wrap;
        }
        .db-greeting {
            font-size: 11px; font-weight: 500; letter-spacing: 2.5px; text-transform: uppercase;
            color: var(--db-honey); margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px;
        }
        .db-greeting::before { content: ''; display: block; width: 20px; height: 1px; background: var(--db-honey); }
        .db-hero-title {
            font-family: 'Playfair Display', serif; font-size: 34px; font-weight: 700;
            color: var(--cream); line-height: 1.15; margin-bottom: 10px;
        }
        .db-hero-title em { font-style: italic; color: var(--db-honey); }
        .db-hero-sub { font-size: 13.5px; color: rgba(245,237,227,.55); max-width: 380px; line-height: 1.55; }
        .db-hero-stats { display: flex; gap: 12px; flex-wrap: wrap; }
        .db-hero-stat {
            background: rgba(255,255,255,.06); border: 1px solid rgba(192,124,58,.2);
            border-radius: 14px; padding: 16px 20px; text-align: center; min-width: 90px;
            backdrop-filter: blur(8px);
        }
        .db-stat-val {
            font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700;
            color: var(--cream); line-height: 1;
        }
        .db-stat-lbl { font-size: 11px; color: rgba(245,237,227,.5); margin-top: 4px; }

        /* ── Setup Bar ── */
        .db-setup-bar {
            background: var(--card); border-bottom: 1px solid var(--border);
            padding: 12px 44px;
            display: flex; align-items: center; gap: 18px; flex-wrap: wrap;
            flex-shrink: 0;
        }
        .db-setup-label { font-size: 12.5px; font-weight: 600; color: var(--espresso); white-space: nowrap; }
        .db-setup-steps { display: flex; gap: 6px; flex: 1; flex-wrap: wrap; }
        .db-setup-step {
            display: flex; align-items: center; gap: 7px;
            padding: 6px 12px; border-radius: 100px;
            font-size: 11.5px; font-weight: 500;
            border: 1.5px solid var(--border); background: var(--latte-soft); color: var(--muted);
            cursor: pointer; transition: all .2s; white-space: nowrap;
        }
        .db-setup-step.done { background: var(--db-green-bg); border-color: var(--db-green); color: var(--db-green); }
        .db-setup-step.active { background: var(--cream); border-color: var(--caramel); color: var(--caramel); }
        .db-step-num {
            width: 17px; height: 17px; border-radius: 50%;
            background: var(--latte); color: var(--muted);
            display: flex; align-items: center; justify-content: center;
            font-size: 9.5px; font-weight: 700; flex-shrink: 0;
        }
        .db-setup-step.done .db-step-num { background: var(--db-green); color: white; }
        .db-setup-step.active .db-step-num { background: var(--caramel); color: white; }
        .db-setup-cta {
            padding: 8px 16px; background: var(--espresso); color: var(--cream);
            border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif;
            font-size: 12px; font-weight: 500; cursor: pointer;
            white-space: nowrap; transition: background .2s;
        }
        .db-setup-cta:hover { background: var(--db-dark-roast); }

        /* ── Content ── */
        .db-content { padding: 26px 44px 60px; display: flex; flex-direction: column; gap: 26px; }

        /* Section heading */
        .db-sec-head { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 14px; }
        .db-sec-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--espresso); }
        .db-sec-title em { font-style: italic; color: var(--caramel); }
        .db-sec-link {
            font-size: 12.5px; color: var(--caramel); font-weight: 500;
            cursor: pointer; text-decoration: none; background: none; border: none;
            font-family: 'DM Sans', sans-serif;
        }
        .db-sec-link:hover { color: var(--db-medium-roast); }

        /* Grid layouts */
        .db-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
        .db-grid-main { display: grid; grid-template-columns: 1fr 330px; gap: 22px; align-items: start; }
        .db-left-col { display: flex; flex-direction: column; gap: 22px; }
        .db-right-col { display: flex; flex-direction: column; gap: 18px; }

        /* Card base */
        .db-card {
            background: var(--card); border: 1px solid var(--border); border-radius: 16px;
            transition: border-color .2s, box-shadow .2s;
        }
        .db-card:hover { border-color: var(--caramel); box-shadow: 0 4px 20px rgba(192,124,58,.08); }

        /* Quick action cards */
        .db-quick-card {
            padding: 18px; display: flex; flex-direction: column; gap: 9px; cursor: pointer;
        }
        .db-qc-icon {
            width: 42px; height: 42px; border-radius: 11px;
            display: flex; align-items: center; justify-content: center; font-size: 19px;
        }
        .db-qc-icon.orange { background: rgba(192,124,58,.1); }
        .db-qc-icon.green  { background: var(--db-green-bg); }
        .db-qc-icon.cream  { background: var(--latte-soft); }
        .db-qc-icon.blue   { background: var(--db-blue-bg); }
        .db-qc-title { font-size: 14px; font-weight: 600; color: var(--espresso); }
        .db-qc-desc  { font-size: 12px; color: var(--db-text-muted); line-height: 1.45; }
        .db-qc-arrow { font-size: 12.5px; color: var(--caramel); margin-top: auto; font-weight: 500; }

        /* ── Upcoming Chat Card (dark) ── */
        .db-upcoming-card {
            background: var(--espresso); border-radius: 16px; padding: 22px 24px;
            position: relative; overflow: hidden; cursor: pointer;
            transition: transform .2s, box-shadow .2s;
        }
        .db-upcoming-card:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(26,14,7,.25); }
        .db-upcoming-card::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(ellipse 80% 80% at 100% 0%, rgba(212,137,74,.18) 0%, transparent 55%);
            pointer-events: none;
        }
        .db-ucc-inner { position: relative; z-index: 1; }
        .db-ucc-eyebrow {
            font-size: 9.5px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase;
            color: var(--db-honey); margin-bottom: 12px;
            display: flex; align-items: center; gap: 7px;
        }
        .db-ucc-eyebrow::before { content: ''; display: block; width: 14px; height: 1px; background: var(--db-honey); }
        .db-countdown-pill {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(212,137,74,.15); border: 1px solid rgba(212,137,74,.3);
            border-radius: 100px; padding: 4px 12px; font-size: 12px;
            color: var(--db-honey); font-weight: 500; margin-bottom: 14px;
        }
        .db-pulse { width: 6px; height: 6px; border-radius: 50%; background: var(--db-honey); animation: dbPulse 2s ease-in-out infinite; }
        @keyframes dbPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.85)} }
        .db-ucc-person { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
        .db-ucc-avatar {
            width: 46px; height: 46px; border-radius: 50%;
            background: linear-gradient(135deg, var(--caramel), var(--db-honey));
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; font-weight: 700; color: white;
            border: 2px solid rgba(255,255,255,.15); flex-shrink: 0;
        }
        .db-ucc-name { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--cream); }
        .db-ucc-role { font-size: 12px; color: rgba(245,237,227,.55); }
        .db-ucc-details { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
        .db-ucc-detail {
            display: flex; align-items: center; gap: 5px;
            font-size: 12px; color: rgba(245,237,227,.7);
            background: rgba(255,255,255,.06); border: 1px solid rgba(192,124,58,.2);
            padding: 4px 11px; border-radius: 100px;
        }
        .db-ucc-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .db-ucc-btn-primary {
            flex: 1; padding: 10px; min-width: 120px;
            background: linear-gradient(135deg, var(--caramel), var(--db-honey));
            color: white; border: none; border-radius: 9px;
            font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: opacity .2s, transform .2s;
        }
        .db-ucc-btn-primary:hover { opacity: .9; transform: translateY(-1px); }
        .db-ucc-btn-secondary {
            padding: 10px 16px;
            background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.12);
            color: rgba(245,237,227,.7); border-radius: 9px;
            font-family: 'DM Sans', sans-serif; font-size: 13px;
            cursor: pointer; transition: background .2s;
        }
        .db-ucc-btn-secondary:hover { background: rgba(255,255,255,.12); }

        /* No upcoming chat empty */
        .db-no-sip {
            background: var(--card); border: 1.5px dashed var(--border);
            border-radius: 16px; padding: 36px 24px;
            text-align: center;
        }
        .db-no-sip-icon { font-size: 36px; margin-bottom: 10px; opacity: .6; }
        .db-no-sip-title { font-family: 'Playfair Display', serif; font-size: 17px; color: var(--espresso); margin-bottom: 6px; }
        .db-no-sip-desc { font-size: 12.5px; color: var(--db-text-muted); margin-bottom: 16px; }
        .db-no-sip-btn {
            padding: 9px 18px; background: var(--espresso); color: var(--cream);
            border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 500; cursor: pointer; transition: all .2s;
        }
        .db-no-sip-btn:hover { background: var(--db-dark-roast); transform: translateY(-1px); }

        /* ── Suggested Match cards ── */
        .db-match-row {
            display: flex; align-items: center; gap: 13px;
            padding: 14px 18px; cursor: pointer;
            border-bottom: 1px solid var(--db-latte-light);
            position: relative; overflow: hidden;
            transition: background .15s;
        }
        .db-match-row:last-child { border-bottom: none; }
        .db-match-row:hover { background: var(--db-steam); }
        .db-match-row::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 3px; background: transparent; transition: background .2s;
        }
        .db-match-row:hover::before { background: var(--caramel); }
        .db-match-av {
            width: 46px; height: 46px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; font-weight: 700; color: white;
            position: relative;
        }
        .db-match-online {
            position: absolute; bottom: 1px; right: 1px;
            width: 11px; height: 11px; border-radius: 50%;
            background: var(--db-green); border: 2px solid var(--card);
        }
        .db-match-info { flex: 1; min-width: 0; }
        .db-match-name { font-size: 14px; font-weight: 600; color: var(--espresso); margin-bottom: 2px; }
        .db-match-meta { font-size: 11.5px; color: var(--db-text-muted); margin-bottom: 5px; }
        .db-match-tags { display: flex; gap: 5px; flex-wrap: wrap; }
        .db-tag { font-size: 10.5px; padding: 2px 8px; border-radius: 100px; background: var(--cream); color: var(--caramel); font-weight: 500; }
        .db-match-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        .db-pct-ring { width: 40px; height: 40px; position: relative; }
        .db-pct-ring svg { transform: rotate(-90deg); }
        .db-pct-ring circle.bg { fill: none; stroke: var(--latte); stroke-width: 3; }
        .db-pct-ring circle.fill { fill: none; stroke: var(--caramel); stroke-width: 3; stroke-linecap: round; }
        .db-pct-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: var(--caramel); }
        .db-btn-chat {
            padding: 6px 13px; background: var(--espresso); color: var(--cream);
            border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif;
            font-size: 12px; font-weight: 500; cursor: pointer; transition: all .2s;
            white-space: nowrap;
        }
        .db-btn-chat:hover { background: var(--db-dark-roast); transform: translateY(-1px); }

        /* ── Activity feed ── */
        .db-activity-item {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 13px 18px; border-bottom: 1px solid var(--db-latte-light);
            transition: background .15s; cursor: pointer;
        }
        .db-activity-item:last-child { border-bottom: none; }
        .db-activity-item:hover { background: var(--db-steam); }
        .db-act-icon {
            width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; font-size: 13px;
        }
        .db-act-icon.orange { background: rgba(192,124,58,.1); }
        .db-act-icon.green  { background: var(--db-green-bg); }
        .db-act-icon.blue   { background: var(--db-blue-bg); }
        .db-act-icon.cream  { background: var(--latte-soft); }
        .db-act-main { font-size: 13px; color: var(--espresso); line-height: 1.4; }
        .db-act-main strong { font-weight: 600; }
        .db-act-time { font-size: 11px; color: var(--db-text-light); margin-top: 3px; }
        .db-act-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--caramel); flex-shrink: 0; margin-top: 5px; }

        /* ── Widget header ── */
        .db-widget-header {
            padding: 14px 18px; border-bottom: 1px solid var(--db-latte-light);
            display: flex; align-items: center; justify-content: space-between;
        }
        .db-widget-title { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; color: var(--espresso); }
        .db-widget-action {
            font-size: 11.5px; color: var(--caramel); font-weight: 500;
            background: none; border: none; font-family: 'DM Sans', sans-serif; cursor: pointer;
        }
        .db-widget-action:hover { color: var(--db-medium-roast); }

        /* ── Groups widget ── */
        .db-group-item {
            display: flex; align-items: center; gap: 11px;
            padding: 11px 18px; border-bottom: 1px solid var(--db-latte-light);
            cursor: pointer; transition: background .15s;
        }
        .db-group-item:last-child { border-bottom: none; }
        .db-group-item:hover { background: var(--db-steam); }
        .db-group-icon {
            width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; font-size: 17px;
            background: var(--cream); border: 1px solid var(--border);
        }
        .db-group-name { font-size: 13px; font-weight: 600; color: var(--espresso); margin-bottom: 1px; }
        .db-group-meta { font-size: 11px; color: var(--db-text-muted); }
        .db-group-badge {
            margin-left: auto; background: var(--cream); border: 1px solid var(--border);
            color: var(--caramel); font-size: 10px; font-weight: 600;
            border-radius: 100px; padding: 2px 9px; white-space: nowrap;
        }
        .db-group-badge.new { background: rgba(192,124,58,.1); border-color: rgba(192,124,58,.2); }

        /* ── Badges grid ── */
        .db-badges-grid {
            display: flex; gap: 8px; flex-wrap: wrap; padding: 14px 18px 18px;
        }

        /* ── Tip card ── */
        .db-tip-card {
            background: var(--espresso); border-radius: 16px;
            padding: 20px; position: relative; overflow: hidden;
        }
        .db-tip-card::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(ellipse 80% 80% at 100% 0%, rgba(212,137,74,.18) 0%, transparent 55%);
            pointer-events: none;
        }
        .db-tip-inner { position: relative; z-index: 1; }
        .db-tip-icon { font-size: 26px; margin-bottom: 9px; }
        .db-tip-title { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; color: var(--cream); margin-bottom: 8px; }
        .db-tip-text { font-size: 12.5px; line-height: 1.55; color: rgba(245,237,227,.6); font-style: italic; }

        /* Responsive */
        @media (max-width: 1100px) { .db-grid-main { grid-template-columns: 1fr; } }
        @media (max-width: 900px)  { .db-grid-3 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 760px)  {
            .db-hero, .db-content { padding-left: 20px; padding-right: 20px; }
            .db-setup-bar { padding-left: 20px; padding-right: 20px; }
            .db-grid-3 { grid-template-columns: 1fr; }
        }

        /* ── Redesigned Dashboard Layout ── */
        .db-header {
            padding: 28px 36px 0;
            flex-shrink: 0;
        }
        .db-greeting-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }
        .db-greeting-h1 {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            color: var(--espresso);
            line-height: 1.2;
            margin-bottom: 6px;
        }
        .db-greeting-h1 em { font-style: italic; color: var(--caramel); }
        .db-greeting-sub {
            font-size: 14px;
            color: var(--muted);
        }
        .db-alert-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            flex-shrink: 0;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.15s;
        }
        .db-alert-pill:hover { border-color: var(--caramel); box-shadow: var(--shadow-hover); }
        .db-alert-dot {
            width: 8px; height: 8px;
            background: var(--caramel);
            border-radius: 50%;
            flex-shrink: 0;
            animation: dbAlertPulse 2s infinite;
        }
        @keyframes dbAlertPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        .db-alert-text { font-size: 13px; font-weight: 600; color: var(--espresso); }
        .db-alert-sub { font-size: 11.5px; color: var(--muted); margin-top: 1px; }
        .db-alert-arrow { font-size: 14px; color: var(--caramel); margin-left: 4px; }

        /* Sections */
        .db-section { padding: 20px 36px; }
        .db-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .db-section-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.9px;
            color: var(--muted);
        }
        .db-see-all {
            font-size: 12.5px;
            color: var(--caramel);
            font-weight: 600;
            cursor: pointer;
            background: none;
            border: none;
            font-family: 'DM Sans', sans-serif;
            transition: opacity 0.15s;
        }
        .db-see-all:hover { opacity: 0.7; }

        /* Light Next Chat Card */
        .db-next-chat-card {
            background: var(--card);
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow);
            transition: box-shadow 0.15s;
        }
        .db-next-chat-card:hover { box-shadow: var(--shadow-hover); }
        .db-ncc-avatar {
            width: 56px; height: 56px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700; color: white;
            flex-shrink: 0;
            border: 2.5px solid var(--caramel);
        }
        .db-ncc-info { flex: 1; min-width: 0; }
        .db-ncc-name { font-size: 16px; font-weight: 600; color: var(--espresso); margin-bottom: 3px; }
        .db-ncc-role { font-size: 13px; color: var(--muted); margin-bottom: 10px; }
        .db-ncc-meta { display: flex; flex-wrap: wrap; gap: 8px; }
        .db-meta-chip {
            display: flex; align-items: center; gap: 5px;
            background: var(--latte-soft);
            border-radius: 99px;
            padding: 4px 10px;
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
            border: 1px solid var(--border);
        }
        .db-ncc-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            flex-shrink: 0;
        }
        .db-countdown-badge {
            background: var(--db-green-bg);
            color: var(--db-green);
            font-size: 11.5px;
            font-weight: 700;
            border-radius: 99px;
            padding: 4px 10px;
            white-space: nowrap;
        }
        .db-ncc-btn-primary {
            background: var(--espresso);
            color: var(--cream);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 13.5px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .db-ncc-btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }
        .db-ncc-btn-secondary {
            background: transparent;
            color: var(--muted);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 12.5px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .db-ncc-btn-secondary:hover { border-color: var(--caramel); color: var(--caramel); }

        /* People grid */
        .db-people-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
        }
        .db-person-card {
            background: var(--card);
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 20px 16px 16px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.15s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .db-person-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
            border-color: var(--caramel);
        }
        .db-person-card-av {
            width: 52px; height: 52px;
            border-radius: 50%;
            margin: 0 auto 10px;
            font-size: 18px; font-weight: 700; color: white;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--border);
        }
        .db-person-card-name { font-size: 14px; font-weight: 600; color: var(--espresso); margin-bottom: 2px; }
        .db-person-card-role { font-size: 11.5px; color: var(--muted); margin-bottom: 12px; line-height: 1.4; }
        .db-person-pct-badge {
            position: absolute;
            top: 10px; right: 10px;
            background: var(--latte-soft);
            color: var(--caramel);
            font-size: 10.5px;
            font-weight: 700;
            border-radius: 99px;
            padding: 2px 7px;
            border: 1px solid var(--border);
        }
        .db-person-card-btn {
            width: 100%;
            background: var(--latte-soft);
            color: var(--brown);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 7px 12px;
            font-size: 12.5px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
        }
        .db-person-card-btn:hover { background: var(--espresso); color: var(--cream); border-color: var(--espresso); }

        @media (max-width: 900px) { .db-people-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .db-people-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 760px) {
            .db-header { padding: 20px 16px 0; }
            .db-section { padding: 16px; }
            .db-next-chat-card { flex-wrap: wrap; }
            .db-ncc-actions { flex-direction: row; width: 100%; }
        }

        /* ===================================================
           SHARED VIEW HEADER  (reused across new view shells)
           =================================================== */
        .view-header {
            margin-bottom: 28px;
        }
        .view-eyebrow {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: var(--caramel);
            margin-bottom: 4px;
        }
        .view-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(22px, 3vw, 30px);
            font-weight: 700;
            color: var(--espresso);
            line-height: 1.18;
            margin: 0 0 5px;
        }
        .view-title em { font-style: italic; color: var(--caramel); }
        .view-subtitle {
            font-size: 13.5px;
            color: var(--muted);
            margin: 0;
        }
        .view-header-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        /* Shared back button */
        .pv-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 0;
            margin-bottom: 20px;
            font-family: 'DM Sans', sans-serif;
            transition: color .15s;
        }
        .pv-back:hover { color: var(--caramel); }

        /* ===================================================
           DISCOVER VIEW  (dv-*)
           =================================================== */
        #discoverView { padding-bottom: 2rem; }

        .dv-filter-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px 22px;
            margin-bottom: 28px;
            box-shadow: var(--shadow);
        }
        .dv-filter-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: .08em;
            text-transform: uppercase;
            color: var(--muted);
            margin: 0 0 14px;
        }
        .dv-search-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .dv-filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .dv-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 13.5px;
            font-family: 'DM Sans', sans-serif;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--warm-white);
            color: var(--espresso);
            box-sizing: border-box;
            transition: border-color .15s;
            outline: none;
        }
        .dv-input:focus { border-color: var(--caramel); }
        .dv-input::placeholder { color: var(--muted); opacity: .7; }
        .dv-filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }
        .dv-btn-primary {
            padding: 9px 22px;
            background: var(--caramel);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background .15s;
        }
        .dv-btn-primary:hover { background: var(--caramel-light); }
        .dv-btn-secondary {
            padding: 9px 22px;
            background: var(--latte-soft);
            color: var(--espresso);
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background .15s;
        }
        .dv-btn-secondary:hover { background: var(--latte); }

        /* ===================================================
           FEED VIEW  (fv-*)
           =================================================== */
        #feedView { padding-bottom: 2rem; }

        .fv-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 22px;
        }
        .fv-tabs {
            display: flex;
            background: var(--latte-soft);
            border-radius: 100px;
            padding: 3px;
            gap: 2px;
        }
        .fv-tab {
            padding: 7px 18px;
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            background: transparent;
            color: var(--muted);
            transition: all .15s;
        }
        .fv-tab.active, .fv-tab:focus {
            background: var(--espresso);
            color: #fff;
            outline: none;
        }
        .fv-tab:hover:not(.active) { color: var(--espresso); }
        .fv-create-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 20px;
            background: var(--caramel);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background .15s;
        }
        .fv-create-btn:hover { background: var(--caramel-light); }

        /* ===================================================
           GROUPS VIEW  (gv-*)
           =================================================== */
        #groupsView { padding-bottom: 2rem; }

        .gv-header-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 28px;
        }
        .gv-create-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            background: var(--caramel);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            white-space: nowrap;
            transition: background .15s;
            flex-shrink: 0;
        }
        .gv-create-btn:hover { background: var(--caramel-light); }
        .gv-section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 28px 0 14px;
            padding-bottom: 10px;
            border-bottom: 1.5px solid var(--border);
        }
        .gv-section-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--espresso);
            margin: 0;
        }
        .gv-section-title:first-child { margin-top: 0; }

        /* ===================================================
           AVAILABILITY VIEW  (av-*)
           =================================================== */
        #availabilityView { padding-bottom: 2rem; }

        .av-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 28px;
            max-width: 820px;
            box-shadow: var(--shadow);
        }
        .av-slots-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--espresso);
            margin: 0 0 16px;
        }
        .av-divider {
            border: none;
            border-top: 1.5px solid var(--border);
            margin: 24px 0;
        }
        .av-add-title {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--espresso);
            margin: 0 0 16px;
        }
        .av-form-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: .06em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 6px;
        }
        .av-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 13.5px;
            font-family: 'DM Sans', sans-serif;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--warm-white);
            color: var(--espresso);
            box-sizing: border-box;
            outline: none;
            transition: border-color .15s;
            appearance: none;
        }
        .av-input:focus { border-color: var(--caramel); }
        .av-time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 18px;
        }
        .av-btn {
            padding: 10px 26px;
            background: var(--caramel);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13.5px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background .15s;
        }
        .av-btn:hover { background: var(--caramel-light); }

        /* ===================================================
           SCHEDULE VIEW  (sv-*)
           =================================================== */
        #scheduleView { padding-bottom: 2rem; }

        .sv-shell {
            max-width: 600px;
            margin: 0 auto;
        }
        .sv-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .sv-card-header {
            background: var(--espresso);
            padding: 26px 28px 22px;
            position: relative;
        }
        .sv-card-eyebrow {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: var(--caramel);
            margin-bottom: 4px;
        }
        .sv-card-title {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--cream);
            margin: 0;
        }
        .sv-card-with {
            font-size: 13px;
            color: rgba(245,237,227,.55);
            margin-top: 6px;
        }
        .sv-card-with strong {
            color: var(--latte);
            font-weight: 600;
        }
        .sv-card-body {
            padding: 24px 28px 28px;
        }
        .sv-form-label {
            display: block;
            font-size: 11.5px;
            font-weight: 700;
            letter-spacing: .07em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 7px;
        }
        .sv-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 13.5px;
            font-family: 'DM Sans', sans-serif;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--warm-white);
            color: var(--espresso);
            box-sizing: border-box;
            outline: none;
            transition: border-color .15s;
            appearance: none;
        }
        .sv-input:focus { border-color: var(--caramel); }
        .sv-form-group { margin-bottom: 18px; }
        .sv-form-hint {
            font-size: 11.5px;
            color: var(--muted);
            margin-top: 4px;
        }
        .sv-btn {
            width: 100%;
            padding: 13px;
            background: var(--caramel);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            margin-top: 8px;
            transition: background .15s;
        }
        .sv-btn:hover { background: var(--caramel-light); }

        /* ===================================================
           CALL VIEW  (cv-*)
           =================================================== */
        #callView {
            padding: 0;
            flex-direction: column;
            height: 100%;
            background: #0e0a06;
        }
        #callView.active {
            display: flex;
        }
        .cv-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: rgba(255,255,255,.04);
            border-bottom: 1px solid rgba(255,255,255,.06);
            flex-shrink: 0;
        }
        .cv-logo {
            font-size: 14px;
            font-weight: 700;
            color: var(--caramel);
            font-family: 'DM Sans', sans-serif;
            letter-spacing: .02em;
        }
        .cv-end-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 18px;
            background: rgba(192,60,60,.85);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background .15s;
        }
        .cv-end-btn:hover { background: rgba(220,60,60,1); }
        .cv-stage {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
        }
        .cv-video-main {
            background: #1a1008;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,.08);
            width: 100%;
            max-width: 680px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .cv-video-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--caramel), var(--brown));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            color: #fff;
            flex-direction: column;
        }
        .cv-video-local {
            position: absolute;
            bottom: 14px;
            right: 14px;
            width: 110px;
            aspect-ratio: 9/16;
            background: #2a1c10;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .cv-info {
            text-align: center;
        }
        .cv-person-name {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--cream);
            margin: 0 0 4px;
        }
        .cv-timer {
            font-size: 13px;
            color: rgba(245,237,227,.45);
            font-family: 'DM Sans', sans-serif;
            letter-spacing: .05em;
        }
        .cv-controls {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-shrink: 0;
            padding-bottom: 28px;
        }
        .cv-ctrl {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s;
        }
        .cv-ctrl-mic  { background: rgba(192,124,58,.2); color: var(--caramel); }
        .cv-ctrl-mic:hover  { background: rgba(192,124,58,.35); }
        .cv-ctrl-vid  { background: rgba(192,124,58,.2); color: var(--caramel); }
        .cv-ctrl-vid:hover  { background: rgba(192,124,58,.35); }
        .cv-ctrl-end  { background: rgba(192,60,60,.8); color: #fff; width: 64px; height: 64px; font-size: 26px; }
        .cv-ctrl-end:hover  { background: rgba(220,60,60,1); }
        .cv-ctrl.muted { background: rgba(255,255,255,.08); color: rgba(245,237,227,.35); }

        /* ===================================================
           PROFILE / GROUP DETAIL SHELLS
           =================================================== */
        .pv-shell { padding-bottom: 2rem; }

        /* ===================================================
           SETTINGS VIEW  (st-*)
           =================================================== */
        /* Strip main-content padding so settings fills the full panel */
        .main-content:has(#settingsView.active) {
            padding: 0;
            overflow: hidden;
        }

        #settingsView { padding: 0; overflow: hidden; }
        #settingsView.active { display: flex; flex-direction: column; height: 100%; width: 100%; }

        .st-layout {
            display: grid;
            grid-template-columns: 230px 1fr;
            flex: 1;
            height: 100%;
            min-height: 0;
        }

        /* Inner settings nav */
        .st-nav {
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            height: 100%;
            overflow-y: auto;
        }
        .st-nav-header {
            padding: 0 18px 18px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 6px;
        }
        .st-nav-title {
            font-family: 'Playfair Display', serif;
            font-size: 17px;
            font-weight: 700;
            color: var(--espresso);
        }
        .st-nav-sub { font-size: 11.5px; color: var(--muted); margin-top: 2px; }
        .st-nav-item {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 10px 18px;
            font-size: 13.5px;
            color: var(--muted);
            background: none;
            border: none;
            border-left: 3px solid transparent;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-family: 'DM Sans', sans-serif;
            transition: background .15s, color .15s;
        }
        .st-nav-item:hover { background: var(--latte-soft); color: var(--espresso); }
        .st-nav-item.active { background: var(--latte-soft); color: var(--caramel); font-weight: 600; border-left-color: var(--caramel); }
        .st-nav-icon { font-size: 15px; width: 20px; text-align: center; flex-shrink: 0; }
        .st-nav-divider { height: 1px; background: var(--border); margin: 8px 14px; }
        .st-nav-danger { color: var(--danger) !important; }
        .st-nav-danger:hover { background: #fdecea !important; }
        .st-nav-danger.active { background: #fdecea !important; border-left-color: var(--danger) !important; }

        /* Content area */
        .st-content {
            padding: 36px 48px 80px;
            overflow-y: auto;
            height: 100%;
            min-width: 0;
        }

        /* Section panels */
        .st-section { display: none; flex-direction: column; gap: 26px; animation: fadeIn .25s ease; }
        .st-section.active { display: flex; }

        .st-eyebrow {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: var(--caramel);
            margin-bottom: 5px;
        }
        .st-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(22px, 3vw, 28px);
            font-weight: 700;
            color: var(--espresso);
            line-height: 1.1;
            margin: 0 0 6px;
        }
        .st-title em { font-style: italic; color: var(--caramel); }
        .st-title.danger { color: var(--danger); }
        .st-title.danger em { color: var(--danger); }
        .st-desc { font-size: 13.5px; color: var(--muted); line-height: 1.5; }

        /* Cards */
        .st-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        .st-card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .st-card-title { font-size: 14.5px; font-weight: 600; color: var(--espresso); }
        .st-card-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
        .st-card-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .st-card-body.no-gap { gap: 0; }
        .st-card-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            background: var(--latte-soft);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Form elements */
        .st-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .st-form-group { display: flex; flex-direction: column; gap: 5px; }
        .st-form-group.full { grid-column: 1 / -1; }
        .st-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: .07em;
            text-transform: uppercase;
            color: var(--muted);
        }
        .st-hint { font-size: 11.5px; color: var(--muted); opacity: .8; }
        .st-input {
            width: 100%;
            padding: 10px 13px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--warm-white);
            font-family: 'DM Sans', sans-serif;
            font-size: 13.5px;
            color: var(--espresso);
            outline: none;
            box-sizing: border-box;
            transition: border-color .15s;
            appearance: none;
        }
        .st-input:focus { border-color: var(--caramel); }
        .st-input::placeholder { color: var(--muted); opacity: .6; }
        textarea.st-input { resize: vertical; min-height: 85px; line-height: 1.5; }
        select.st-input {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23c9a98a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }

        /* Avatar upload */
        .st-avatar-wrap { display: flex; align-items: center; gap: 18px; }
        .st-avatar {
            width: 72px; height: 72px; border-radius: 50%;
            background: linear-gradient(135deg, var(--caramel), var(--caramel-light));
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700; color: #fff;
            border: 3px solid var(--latte); position: relative; cursor: pointer; flex-shrink: 0;
            overflow: hidden;
        }
        .st-avatar-overlay {
            position: absolute; inset: 0; border-radius: 50%;
            background: rgba(28,18,8,.5); display: flex; align-items: center;
            justify-content: center; opacity: 0; transition: opacity .2s; font-size: 18px;
        }
        .st-avatar:hover .st-avatar-overlay { opacity: 1; }
        .st-avatar-info-name { font-size: 14px; font-weight: 600; color: var(--espresso); margin-bottom: 2px; }
        .st-avatar-info-sub { font-size: 12.5px; color: var(--muted); margin-bottom: 10px; }
        .st-btn-upload {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 7px 14px; background: var(--latte-soft);
            border: 1.5px solid var(--border); border-radius: 8px;
            font-family: 'DM Sans', sans-serif; font-size: 12.5px;
            color: var(--muted); cursor: pointer; transition: all .15s;
        }
        .st-btn-upload:hover { border-color: var(--caramel); color: var(--caramel); }

        /* Tags input */
        .st-tags-wrap {
            display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
            padding: 8px 11px; border: 1.5px solid var(--border); border-radius: 10px;
            background: var(--warm-white); min-height: 44px; cursor: text;
            transition: border-color .15s;
        }
        .st-tags-wrap:focus-within { border-color: var(--caramel); }
        .st-tag-chip {
            display: inline-flex; align-items: center; gap: 4px;
            background: var(--latte-soft); border: 1px solid var(--border);
            color: var(--caramel); font-size: 12px; font-weight: 500;
            border-radius: 100px; padding: 3px 9px;
        }
        .st-tag-chip button {
            background: none; border: none; cursor: pointer;
            color: var(--muted); font-size: 12px; line-height: 1; padding: 0;
            transition: color .15s;
        }
        .st-tag-chip button:hover { color: var(--danger); }
        .st-tags-input {
            border: none; background: transparent;
            font-family: 'DM Sans', sans-serif; font-size: 13px;
            color: var(--espresso); outline: none; min-width: 80px; flex: 1;
        }
        .st-tags-input::placeholder { color: var(--muted); opacity: .6; }

        /* Toggle switch */
        .st-toggle-row {
            display: flex; align-items: flex-start; justify-content: space-between;
            gap: 16px; padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }
        .st-toggle-row:last-child { border-bottom: none; padding-bottom: 0; }
        .st-toggle-row:first-child { padding-top: 0; }
        .st-toggle-label { font-size: 13.5px; font-weight: 500; color: var(--espresso); margin-bottom: 2px; }
        .st-toggle-desc { font-size: 12px; color: var(--muted); line-height: 1.45; max-width: 380px; }
        .st-toggle { position: relative; width: 42px; height: 23px; flex-shrink: 0; margin-top: 2px; }
        .st-toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
        .st-toggle-track {
            position: absolute; inset: 0; border-radius: 100px;
            background: var(--latte); cursor: pointer; transition: background .2s;
        }
        .st-toggle input:checked ~ .st-toggle-track { background: var(--caramel); }
        .st-toggle-thumb {
            position: absolute; top: 3px; left: 3px;
            width: 17px; height: 17px; border-radius: 50%;
            background: white; box-shadow: 0 1px 4px rgba(0,0,0,.15);
            transition: transform .2s; pointer-events: none;
        }
        .st-toggle input:checked ~ .st-toggle-track .st-toggle-thumb { transform: translateX(19px); }

        /* Privacy select rows */
        .st-priv-row {
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 10px 16px; padding: 13px 0; border-bottom: 1px solid var(--border);
        }
        .st-priv-row:last-child { border-bottom: none; padding-bottom: 0; }
        .st-priv-row:first-child { padding-top: 0; }
        .st-priv-row > div:first-child { flex: 1; min-width: 0; }
        .st-priv-label { font-size: 13.5px; font-weight: 500; color: var(--espresso); margin-bottom: 2px; }
        .st-priv-desc { font-size: 12px; color: var(--muted); }
        .st-priv-select {
            padding: 7px 28px 7px 11px; border: 1.5px solid var(--border); border-radius: 8px;
            background: var(--warm-white); font-family: 'DM Sans', sans-serif; font-size: 12.5px;
            color: var(--espresso); cursor: pointer; outline: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23c9a98a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 9px center;
            flex-shrink: 0; min-width: 130px; transition: border-color .15s;
        }
        .st-priv-select:focus { border-color: var(--caramel); }

        /* Security items */
        .st-sec-item {
            display: flex; align-items: center; gap: 13px;
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .st-sec-item:last-child { border-bottom: none; padding-bottom: 0; }
        .st-sec-item:first-child { padding-top: 0; }
        .st-sec-icon {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; flex-shrink: 0;
        }
        .st-sec-icon.green { background: #eaf6ef; }
        .st-sec-icon.orange { background: rgba(192,124,58,.12); }
        .st-sec-icon.blue { background: #eff4ff; }
        .st-sec-info { flex: 1; }
        .st-sec-title { font-size: 13.5px; font-weight: 600; color: var(--espresso); margin-bottom: 2px; }
        .st-sec-desc { font-size: 12px; color: var(--muted); }
        .st-sec-badge {
            font-size: 11px; font-weight: 600; border-radius: 100px; padding: 3px 10px; flex-shrink: 0;
        }
        .st-sec-badge.ok { background: #eaf6ef; color: #2d7a4f; }
        .st-sec-badge.off { background: var(--latte-soft); color: var(--muted); }

        /* Availability slots list */
        .st-avail-slot {
            display: flex; align-items: center; justify-content: space-between;
            padding: 11px 14px; background: var(--latte-soft);
            border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px;
        }
        .st-avail-slot-day { font-size: 13.5px; font-weight: 600; color: var(--espresso); }
        .st-avail-slot-time { font-size: 12.5px; color: var(--muted); margin-top: 2px; }
        .st-avail-add {
            background: var(--latte-soft); border: 1.5px dashed var(--border);
            border-radius: 12px; padding: 16px 18px; margin-top: 4px;
        }
        .st-avail-add-title { font-size: 12px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
        .st-avail-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: flex-end; }

        /* Danger zone */
        .st-danger-card {
            background: var(--card);
            border: 1.5px solid #f5c6c2;
            border-radius: 16px;
            overflow: hidden;
        }
        .st-danger-header {
            padding: 14px 20px;
            background: #fdecea;
            border-bottom: 1px solid #f5c6c2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .st-danger-header-title { font-size: 14.5px; font-weight: 600; color: var(--danger); }
        .st-danger-header-desc { font-size: 12px; color: #a93226; margin-top: 1px; }
        .st-danger-body { padding: 0 20px; }
        .st-danger-item {
            display: flex; align-items: flex-start; justify-content: space-between;
            gap: 16px; padding: 16px 0; border-bottom: 1px solid #f5c6c2;
        }
        .st-danger-item:last-child { border-bottom: none; }
        .st-danger-label { font-size: 13.5px; font-weight: 600; color: var(--espresso); margin-bottom: 3px; }
        .st-danger-desc { font-size: 12px; color: var(--muted); max-width: 360px; line-height: 1.45; }

        /* Theme option cards */
        .st-theme-option {
            border: 1.5px solid var(--border); border-radius: 12px;
            padding: 14px 20px; background: var(--latte-soft);
            text-align: center; min-width: 110px;
            transition: border-color .2s, background .2s; cursor: pointer;
        }
        .st-theme-option:hover { border-color: var(--caramel); }
        .st-theme-option.active { border-color: var(--caramel); background: var(--cream); }

        /* Buttons */
        .st-btn-primary {
            padding: 9px 20px; background: var(--espresso); color: var(--cream);
            border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s;
        }
        .st-btn-primary:hover { background: var(--brown); }
        .st-btn-secondary {
            padding: 9px 18px; background: var(--card); border: 1.5px solid var(--border);
            border-radius: 9px; font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 500; color: var(--muted); cursor: pointer; transition: all .15s;
        }
        .st-btn-secondary:hover { border-color: var(--caramel); color: var(--caramel); }
        .st-btn-danger {
            padding: 8px 15px; background: white; border: 1.5px solid #f5c6c2;
            border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: 12.5px;
            font-weight: 500; color: var(--danger); cursor: pointer; transition: all .15s;
            white-space: nowrap; flex-shrink: 0;
        }
        .st-btn-danger:hover { background: #fdecea; border-color: var(--danger); }

        /* Saved toast */
        .st-toast {
            position: fixed; bottom: 28px; right: 28px;
            background: var(--espresso); color: var(--cream);
            padding: 12px 20px; border-radius: 12px;
            font-size: 13.5px; font-weight: 500;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 8px 24px rgba(28,18,8,.25);
            transform: translateY(80px); opacity: 0;
            transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .3s;
            z-index: 9999; pointer-events: none;
        }
        .st-toast.show { transform: translateY(0); opacity: 1; }

        /* Appearance theme cards */
        .st-theme-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .st-theme-option {
            border: 1.5px solid var(--border); border-radius: 12px;
            padding: 14px 18px; background: var(--latte-soft);
            text-align: center; min-width: 105px; cursor: pointer;
            transition: border-color .15s;
        }
        .st-theme-option.selected { border-color: var(--caramel); }
        .st-theme-icon { font-size: 22px; margin-bottom: 6px; }
        .st-theme-label { font-size: 13px; font-weight: 600; color: var(--muted); }
        .st-theme-label.active-theme { color: var(--caramel); }
        .st-theme-note { font-size: 11px; color: var(--muted); margin-top: 2px; }

        /* Mobile tab bar for settings (replaces sidebar nav) */
        .st-mobile-tabs {
            display: none;
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            gap: 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            flex-shrink: 0;
        }
        .st-mobile-tabs::-webkit-scrollbar { display: none; }
        .st-mobile-tab {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            font-size: 12.5px;
            font-weight: 500;
            color: var(--muted);
            background: var(--latte-soft);
            border: 1.5px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-family: 'DM Sans', sans-serif;
            transition: background .15s, color .15s, border-color .15s;
        }
        .st-mobile-tab.active {
            background: var(--caramel);
            color: white;
            border-color: var(--caramel);
            font-weight: 600;
        }
        .st-mobile-tab.danger { color: var(--danger); }
        .st-mobile-tab.danger.active { background: var(--danger); border-color: var(--danger); color: white; }

        @media (max-width: 900px) {
            .st-layout { display: flex; flex-direction: column; flex: 1; min-height: 0; }
            .st-nav { display: none; }
            .st-mobile-tabs { display: flex; }
            #settingsView.active { display: flex; flex-direction: column; height: 100%; }
            .main-content:has(#settingsView.active) { overflow-y: hidden; }
            .st-content { flex: 1; overflow-y: auto; height: auto; min-height: 0; }
        }
        @media (max-width: 640px) {
            .st-content { padding: 20px 16px 60px; }
            .st-form-row { grid-template-columns: 1fr; }
            .st-avail-row { grid-template-columns: 1fr 1fr; }
        }

        /* Availability 7-day grid */
        .st-avail-day-grid { display: flex; flex-direction: column; }
        .st-avail-day-row {
            display: grid;
            grid-template-columns: 100px 48px 1fr 18px 1fr;
            gap: 10px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .st-avail-day-row:last-child { border-bottom: none; }
        .st-avail-day-name { font-size: 13.5px; font-weight: 500; color: var(--espresso); }
        .st-avail-day-sep { font-size: 12px; color: var(--muted); text-align: center; }
        .st-avail-day-row input[type="time"].st-input { padding: 8px 10px; }
        .st-avail-day-row input[type="time"]:disabled { opacity: 0.35; cursor: not-allowed; }
        @media (max-width: 640px) {
            .st-avail-day-row { grid-template-columns: 75px 40px 1fr 12px 1fr; gap: 6px; }
            .st-avail-day-name { font-size: 12px; }
        }

        /* Button loading state */
        .st-btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Error toast variant */
        .st-toast.error { background: var(--danger); }

        /* ══════════════════════════════
           MY NETWORK VIEW
        ══════════════════════════════ */
        #networkView { padding: 0; }
        #networkView.active { display: flex; flex-direction: column; }

        /* Hero strip */
        .nw-hero {
            background: var(--espresso);
            padding: 32px 40px 0;
            position: relative; overflow: hidden; flex-shrink: 0;
        }
        .nw-hero::before {
            content: ''; position: absolute; inset: 0; pointer-events: none;
            background: radial-gradient(ellipse 55% 120% at -5% 110%, rgba(192,124,58,.28) 0%, transparent 55%),
                        radial-gradient(ellipse 40% 70% at 105% -10%, rgba(212,137,74,.08) 0%, transparent 50%);
        }
        .nw-hero-inner {
            position: relative; z-index: 1;
            display: flex; align-items: flex-end; justify-content: space-between;
            gap: 24px; flex-wrap: wrap; padding-bottom: 26px;
        }
        .nw-eyebrow {
            font-size: 11px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase;
            color: var(--caramel-light); margin-bottom: 7px;
            display: flex; align-items: center; gap: 8px;
        }
        .nw-eyebrow::before { content: ''; width: 18px; height: 1px; background: var(--caramel-light); display: block; }
        .nw-hero-title { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; color: var(--cream); line-height: 1.1; }
        .nw-hero-title em { font-style: italic; color: var(--caramel-light); }
        .nw-hero-sub { font-size: 14px; color: rgba(245,240,232,.45); margin-top: 6px; max-width: 380px; }
        .nw-stats { display: flex; gap: 10px; flex-wrap: wrap; }
        .nw-stat { background: rgba(255,255,255,.06); border: 1px solid rgba(192,124,58,.2); border-radius: 12px; padding: 13px 18px; text-align: center; min-width: 78px; }
        .nw-stat-val { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 700; color: var(--cream); line-height: 1; }
        .nw-stat-lbl { font-size: 11px; color: rgba(245,240,232,.42); margin-top: 3px; }

        /* Hero tabs */
        .nw-tabs { position: relative; z-index: 1; display: flex; border-top: 1px solid rgba(255,255,255,.08); }
        .nw-tab {
            padding: 13px 22px; font-size: 13.5px; font-weight: 500;
            color: rgba(245,240,232,.45); background: none; border: none;
            border-bottom: 2px solid transparent; cursor: pointer;
            transition: color .18s, border-color .18s; font-family: 'DM Sans', sans-serif;
            display: flex; align-items: center; gap: 7px; white-space: nowrap;
        }
        .nw-tab:hover { color: var(--cream); }
        .nw-tab.active { color: var(--caramel-light); border-bottom-color: var(--caramel-light); }
        .nw-tab-count {
            background: rgba(192,124,58,.18); color: var(--caramel-light);
            font-size: 10.5px; font-weight: 700; border-radius: 100px; padding: 1px 7px;
        }
        .nw-tab.active .nw-tab-count { background: var(--caramel-light); color: var(--espresso); }

        /* Content area */
        .nw-content { padding: 28px 40px 60px; overflow-y: auto; flex: 1; }
        .nw-panel { display: none; animation: nwFadeUp .22s ease; }
        .nw-panel.active { display: block; }
        @keyframes nwFadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

        /* ── Filter bar ── */
        .nw-filter-bar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .nw-search-box {
            display: flex; align-items: center; gap: 8px;
            background: var(--card); border: 1.5px solid var(--latte); border-radius: 10px;
            padding: 0 14px; height: 40px; flex: 1; max-width: 320px; transition: border-color .2s;
        }
        .nw-search-box:focus-within { border-color: var(--caramel); }
        .nw-search-box input { border: none; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 13.5px; color: var(--espresso); outline: none; flex: 1; }
        .nw-search-box input::placeholder { color: var(--muted); }

        /* ── Connection cards grid ── */
        .nw-conn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap: 14px; }

        .nw-conn-card {
            background: var(--card); border: 1px solid var(--latte); border-radius: 16px;
            overflow: hidden; cursor: pointer; display: flex; flex-direction: column;
            position: relative; transition: border-color .2s, box-shadow .2s, transform .2s;
        }
        .nw-conn-card:hover { border-color: var(--caramel); box-shadow: 0 6px 24px rgba(192,124,58,.1); transform: translateY(-2px); }
        .nw-conn-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--caramel); opacity: 0; transition: opacity .2s; border-radius: 16px 0 0 16px; }
        .nw-conn-card:hover::before { opacity: 1; }

        .nw-cc-top { padding: 18px 18px 10px; display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
        .nw-cc-avatar-wrap { position: relative; }
        .nw-cc-avatar { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: #fff; border: 2.5px solid var(--warm-white); flex-shrink: 0; overflow: hidden; }
        .nw-cc-online { position: absolute; bottom: 1px; right: 1px; width: 12px; height: 12px; border-radius: 50%; background: #4caf50; border: 2.5px solid var(--card); }

        .nw-cc-body { padding: 0 18px 12px; flex: 1; }
        .nw-cc-name { font-size: 15px; font-weight: 700; color: var(--espresso); margin-bottom: 2px; }
        .nw-cc-role { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
        .nw-cc-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 6px; }
        .nw-cc-tag { font-size: 11px; padding: 2px 9px; border-radius: 100px; background: var(--latte-soft); border: 1px solid var(--latte); color: var(--muted); }
        .nw-cc-tag.hi { background: var(--cream); color: var(--caramel); border-color: rgba(192,124,58,.22); }

        .nw-cc-footer { padding: 10px 18px 14px; display: flex; gap: 8px; border-top: 1px solid var(--latte); }
        .nw-btn-chat { flex: 1; padding: 8px; background: var(--espresso); color: var(--cream); border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 12.5px; font-weight: 500; cursor: pointer; transition: opacity .18s; }
        .nw-btn-chat:hover { opacity: .85; }
        .nw-btn-msg { padding: 8px 12px; background: var(--latte-soft); border: 1.5px solid var(--latte); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 12.5px; color: var(--muted); cursor: pointer; transition: border-color .18s, color .18s; }
        .nw-btn-msg:hover { border-color: var(--caramel); color: var(--caramel); }

        .nw-alumni-pill { display: inline-flex; align-items: center; gap: 4px; background: rgba(126,63,242,.1); color: #7e3ff2; border-radius: 100px; padding: 2px 9px; font-size: 10.5px; font-weight: 600; margin-bottom: 4px; }

        .nw-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; background: var(--card); border: 1.5px dashed var(--latte); border-radius: 16px; }
        .nw-empty-icon { font-size: 40px; margin-bottom: 14px; opacity: .45; }
        .nw-empty-title { font-size: 16px; font-weight: 600; color: var(--espresso); margin-bottom: 6px; }
        .nw-empty-desc { font-size: 13.5px; color: var(--muted); max-width: 260px; line-height: 1.55; }

        /* ── Requests panel ── */
        .nw-req-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; align-items: start; }
        .nw-req-section-title { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--espresso); margin-bottom: 14px; }
        .nw-req-section-title em { font-style: italic; color: var(--caramel); }
        .nw-req-count { font-size: 12px; color: var(--muted); margin-left: 8px; font-family: 'DM Sans', sans-serif; font-weight: 400; font-style: normal; }

        .nw-req-card {
            background: var(--card); border: 1px solid var(--latte); border-radius: 14px;
            padding: 16px 18px; display: flex; align-items: flex-start; gap: 12px;
            margin-bottom: 10px; transition: border-color .2s, box-shadow .2s;
        }
        .nw-req-card:hover { border-color: var(--caramel); box-shadow: 0 3px 14px rgba(192,124,58,.08); }
        .nw-req-avatar { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; color: white; flex-shrink: 0; overflow: hidden; }
        .nw-req-info { flex: 1; min-width: 0; }
        .nw-req-name { font-size: 14px; font-weight: 700; color: var(--espresso); margin-bottom: 1px; }
        .nw-req-role { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
        .nw-req-note { font-size: 12.5px; color: var(--muted); font-style: italic; line-height: 1.4; margin-bottom: 8px; padding: 7px 10px; background: var(--latte-soft); border-radius: 7px; border-left: 2px solid var(--latte); }
        .nw-req-actions { display: flex; gap: 7px; }
        .nw-btn-accept { padding: 7px 14px; background: var(--espresso); color: var(--cream); border: none; border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 12.5px; font-weight: 500; cursor: pointer; transition: opacity .18s; }
        .nw-btn-accept:hover { opacity: .85; }
        .nw-btn-decline { padding: 7px 12px; background: var(--latte-soft); border: 1.5px solid var(--latte); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 12.5px; color: var(--muted); cursor: pointer; transition: all .18s; }
        .nw-btn-decline:hover { border-color: var(--danger); color: var(--danger); }
        .nw-req-time { font-size: 11px; color: var(--muted); margin-top: 5px; }

        /* ── Suggestions panel ── */
        .nw-suggest-section { margin-bottom: 28px; }
        .nw-suggest-title { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--espresso); margin-bottom: 16px; }
        .nw-suggest-title em { font-style: italic; color: var(--caramel); }
        .nw-suggest-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(258px,1fr)); gap: 14px; }

        .nw-sug-card { background: var(--card); border: 1px solid var(--latte); border-radius: 16px; overflow: hidden; transition: border-color .2s, box-shadow .2s, transform .2s; }
        .nw-sug-card:hover { border-color: var(--caramel); box-shadow: 0 6px 22px rgba(192,124,58,.1); transform: translateY(-2px); }
        .nw-sug-banner { height: 54px; background: linear-gradient(135deg, var(--espresso), var(--brown)); position: relative; overflow: hidden; }
        .nw-sug-banner::after { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse 80% 80% at 100% 0%, rgba(192,124,58,.18) 0%, transparent 60%); }
        .nw-sug-avatar { position: absolute; bottom: -22px; left: 16px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: white; border: 3px solid var(--card); z-index: 1; overflow: hidden; }
        .nw-sug-body { padding: 30px 16px 12px; }
        .nw-sug-name { font-size: 14.5px; font-weight: 700; color: var(--espresso); margin-bottom: 2px; }
        .nw-sug-role { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
        .nw-sug-reason { font-size: 12px; color: var(--muted); line-height: 1.45; margin-bottom: 10px; padding: 7px 10px; background: var(--latte-soft); border-radius: 8px; display: flex; gap: 6px; align-items: flex-start; }
        .nw-sug-tags { display: flex; gap: 5px; flex-wrap: wrap; }
        .nw-sug-tag { font-size: 11px; padding: 2px 9px; border-radius: 100px; background: var(--latte-soft); border: 1px solid var(--latte); color: var(--muted); }
        .nw-sug-footer { padding: 10px 16px 14px; display: flex; gap: 8px; border-top: 1px solid var(--latte); }
        .nw-btn-connect { flex: 1; padding: 8px; background: var(--espresso); color: var(--cream); border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 12.5px; font-weight: 500; cursor: pointer; transition: opacity .18s; }
        .nw-btn-connect:hover { opacity: .85; }
        .nw-btn-view { padding: 8px 11px; background: var(--latte-soft); border: 1px solid var(--latte); border-radius: 8px; font-size: 12.5px; color: var(--muted); cursor: pointer; font-family: 'DM Sans', sans-serif; transition: border-color .18s, color .18s; }
        .nw-btn-view:hover { border-color: var(--caramel); color: var(--caramel); }

        /* Responsive */
        @media (max-width: 900px) { .nw-req-layout { grid-template-columns: 1fr; } }
        @media (max-width: 700px) { .nw-content { padding: 20px 18px 48px; } .nw-hero { padding: 24px 18px 0; } .nw-conn-grid { grid-template-columns: 1fr; } .nw-suggest-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- Top Bar (shown only when logged in via app-mode class on body) -->
    <div class="topbar" id="appTopbar">
        <div class="topbar-logo">
            <svg width="22" height="24" viewBox="0 0 72 80" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24 18 Q27 12 24 6" stroke="#e8944a" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M36 18 Q39 12 36 6" stroke="#e8944a" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M48 18 Q51 12 48 6" stroke="#e8944a" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M14 22 L20 66 H52 L58 22 Z" fill="#c17d3c"/><path d="M18 22 L23 58 H28 L23.5 22 Z" fill="rgba(255,255,255,0.07)"/><ellipse cx="36" cy="27" rx="20" ry="4" fill="#9a5f28"/><ellipse cx="36" cy="68" rx="24" ry="5" fill="#9a5f28"/><ellipse cx="36" cy="68" rx="20" ry="3.5" fill="#c17d3c"/><path d="M58 30 Q72 30 72 44 Q72 58 58 58" stroke="#c17d3c" stroke-width="4.5" stroke-linecap="round" fill="none"/><path d="M58 30 Q68 30 68 44 Q68 58 58 58" stroke="#9a5f28" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
            <span>First</span><span style="color:var(--caramel)">Sip</span>
        </div>
        <div class="topbar-search">
            <input class="topbar-search-input" placeholder="Search people, groups..." />
        </div>
        <div class="topbar-right">
            <div id="notifBellContainer" style="display:none;">
                <button class="icon-btn" onclick="toggleNotifications()" id="notifBell" title="Notifications">
                    🔔
                    <div class="notif-dot" id="notifDot" style="display:none;"></div>
                </button>
            </div>
            <div class="user-chip" onclick="switchView('myProfileView')" id="topbarUserChip" style="display:none;">
                <div class="user-chip-av" id="topbarUserAv">?</div>
                <div class="user-chip-name" id="topbarUserName">You</div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="appSidebar">
            <div class="sidebar-user-section" id="sidebarUserSection" style="display:none;">
                <div class="sidebar-user-av" id="sidebarUserAv">?</div>
                <div>
                    <div class="sidebar-user-name" id="sidebarUserName">—</div>
                    <div class="sidebar-user-status" id="sidebarUserStatus"></div>
                </div>
            </div>
            <div class="sidebar-label" style="margin-top:0;">Main</div>
            <nav id="navMenu"></nav>
            <div class="sidebar-bottom">
                <div class="sidebar-divider"></div>
                <button class="logout-btn" onclick="handleLogout()">
                    <span class="nav-icon">🚪</span> Sign Out
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">

            <!-- Landing Page -->
            <div id="landingView" class="content-view">
                <div class="landing-page">

                    <!-- Nav -->
                    <nav>
                        <div class="lp-nav-logo">First<span>Sip</span></div>
                        <ul class="lp-nav-links">
                            <li><a onclick="document.getElementById('lpHow').scrollIntoView({behavior:'smooth'})">How It Works</a></li>
                            <li><a onclick="document.getElementById('lpFeatures').scrollIntoView({behavior:'smooth'})">Features</a></li>
                            <li><a onclick="document.getElementById('lpFounder').scrollIntoView({behavior:'smooth'})">Our Story</a></li>
                            <li><a onclick="document.getElementById('lpContact').scrollIntoView({behavior:'smooth'})">Contact</a></li>
                        </ul>
                        <div class="lp-nav-actions">
                            <button class="lp-btn-ghost" onclick="showLandingLogin()">Sign In</button>
                            <button class="lp-btn-primary" onclick="showLandingSignup()">Join Rowan&#39;s Cohort &rarr;</button>
                        </div>
                        <button class="lp-hamburger" id="lpHamburger" onclick="toggleLpMenu()" aria-label="Menu">
                            <span></span><span></span><span></span>
                        </button>
                    </nav>

                    <!-- Mobile Menu -->
                    <div class="lp-mobile-menu" id="lpMobileMenu">
                        <a onclick="closeLpMenu(); document.getElementById('lpHow').scrollIntoView({behavior:'smooth'})">How It Works</a>
                        <a onclick="closeLpMenu(); document.getElementById('lpFeatures').scrollIntoView({behavior:'smooth'})">Features</a>
                        <a onclick="closeLpMenu(); document.getElementById('lpFounder').scrollIntoView({behavior:'smooth'})">Our Story</a>
                        <a onclick="closeLpMenu(); document.getElementById('lpContact').scrollIntoView({behavior:'smooth'})">Contact</a>
                        <div class="lp-mobile-buttons">
                            <button class="lp-btn-ghost" onclick="closeLpMenu(); showLandingLogin()">Sign In</button>
                            <button class="lp-btn-primary" onclick="closeLpMenu(); showLandingSignup()">Join Rowan&#39;s Cohort</button>
                        </div>
                    </div>

                    <!-- Hero -->
                    <section class="lp-hero">
                        <div class="lp-hero-bg"></div>
                        <div class="lp-coffee-ring"></div>

                        <div class="lp-float-card lp-card-1">
                            <div class="lp-avatar a">JT</div>
                            <div>
                                <div class="lp-float-name">Jordan Torres</div>
                                <div class="lp-float-meta">Finance Junior &middot; Rowan</div>
                            </div>
                            <div class="lp-match-badge">92% match</div>
                        </div>
                        <div class="lp-float-card lp-card-2">
                            <div class="lp-avatar b">AP</div>
                            <div>
                                <div class="lp-float-name">Anika Patel</div>
                                <div class="lp-float-meta">CS Senior &middot; Rowan</div>
                            </div>
                            <div class="lp-match-badge">Same goals</div>
                        </div>
                        <div class="lp-float-card lp-card-3">
                            <div class="lp-avatar c">MR</div>
                            <div>
                                <div class="lp-float-name">Mike Reyes</div>
                                <div class="lp-float-meta">Engineering &middot; Rowan</div>
                            </div>
                            <div class="lp-match-badge">Wants to chat</div>
                        </div>

                        <div class="lp-hero-content">
                            <div class="lp-hero-tag">Now at Rowan University</div>
                            <h1>Networking that<br/>feels <em>human</em><br/>for once.</h1>
                            <p class="lp-hero-sub">Meet fellow Profs and Rowan alumni who actually want to help. Skip the LinkedIn grind &mdash; book a real 30-minute conversation instead.</p>
                            <div class="lp-hero-cta">
                                <button class="lp-btn-cta" onclick="showLandingSignup()">&#9749; Join the Founding Cohort</button>
                                <button class="lp-btn-outline" onclick="document.getElementById('lpHow').scrollIntoView({behavior:'smooth'})">See How It Works &darr;</button>
                            </div>
                            <div class="lp-social-proof">
                                <div class="lp-avatars-row">
                                    <div class="lp-mini-av m1">S</div>
                                    <div class="lp-mini-av m2">J</div>
                                    <div class="lp-mini-av m3">A</div>
                                    <div class="lp-mini-av m4">M</div>
                                </div>
                                <div class="lp-proof-text">
                                    <strong>Rowan students</strong> are already connecting.<br>
                                    Be part of the founding cohort &mdash; it&apos;s free.
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Stats Bar -->
                    <div class="lp-stats-bar">
                        <div class="lp-stat-item">
                            <div class="lp-stat-num">30 min</div>
                            <div class="lp-stat-label">Average chat length</div>
                        </div>
                        <div class="lp-stat-item">
                            <div class="lp-stat-num">100%</div>
                            <div class="lp-stat-label">Rowan-only community</div>
                        </div>
                        <div class="lp-stat-item">
                            <div class="lp-stat-num">Free</div>
                            <div class="lp-stat-label">Always, for students</div>
                        </div>
                        <div class="lp-stat-item">
                            <div class="lp-stat-num">Real</div>
                            <div class="lp-stat-label">Conversations, not cold messages</div>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <section class="lp-section lp-how" id="lpHow">
                        <div class="lp-how-inner">
                            <div class="lp-how-header reveal">
                                <div class="lp-section-tag">How It Works</div>
                                <h2>Three steps to a<br/><em>real</em> connection.</h2>
                                <p class="lp-section-sub">No algorithm feeding you strangers. No cold messages disappearing into the void. Just a simple path to a genuine conversation.</p>
                            </div>
                            <div class="lp-steps">
                                <div class="lp-step reveal">
                                    <div class="lp-step-num">01</div>
                                    <div class="lp-step-icon">&#128100;</div>
                                    <h3>Build Your Profile</h3>
                                    <p>Tell us what you&apos;re studying, where you&apos;re headed, and what you&apos;re curious about. The more real you are, the better your matches.</p>
                                </div>
                                <div class="lp-step reveal">
                                    <div class="lp-step-num">02</div>
                                    <div class="lp-step-icon">&#128269;</div>
                                    <h3>Discover &amp; Connect</h3>
                                    <p>Browse students and Rowan alumni who recently broke into your target field. Send a connection request when someone catches your eye.</p>
                                </div>
                                <div class="lp-step reveal">
                                    <div class="lp-step-num">03</div>
                                    <div class="lp-step-icon">&#9749;</div>
                                    <h3>Schedule a First Sip</h3>
                                    <p>Book a 15&ndash;30 minute chat, virtual or in-person. We give you conversation starters so it never feels awkward.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Features -->
                    <section class="lp-section" id="lpFeatures" style="background: var(--warm-white);">
                        <div class="lp-features-inner">
                            <div class="lp-feature-list reveal">
                                <div class="lp-section-tag">What Makes Us Different</div>
                                <h2>Built for students,<br/>not recruiters.</h2>
                                <div class="lp-feature-item active" data-feature="matching">
                                    <div class="lp-feature-icon">&#127919;</div>
                                    <div>
                                        <h3>Smart Matching</h3>
                                        <p>Matched by major, career goals, and genuine interests &mdash; not just who you already know.</p>
                                    </div>
                                </div>
                                <div class="lp-feature-item" data-feature="icebreakers">
                                    <div class="lp-feature-icon">&#128172;</div>
                                    <div>
                                        <h3>Built-In Icebreakers</h3>
                                        <p>Every chat comes with conversation starters based on your shared interests. No awkward silences.</p>
                                    </div>
                                </div>
                                <div class="lp-feature-item" data-feature="groups">
                                    <div class="lp-feature-icon">&#128101;</div>
                                    <div>
                                        <h3>Community Groups</h3>
                                        <p>Join groups for your major or career interest. Share advice, ask questions, find your people.</p>
                                    </div>
                                </div>
                                <div class="lp-feature-item" data-feature="schedule">
                                    <div class="lp-feature-icon">&#9201;&#65039;</div>
                                    <div>
                                        <h3>Fits Your Schedule</h3>
                                        <p>15&ndash;30 minute chats that fit between classes. Virtual or at the campus caf&eacute;.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mockup shell — panels swap inside -->
                            <div class="lp-app-mockup reveal">
                                <div class="lp-mockup-bar">
                                    <div class="lp-mockup-dot r"></div>
                                    <div class="lp-mockup-dot y"></div>
                                    <div class="lp-mockup-dot g"></div>
                                </div>

                                <!-- PANEL 1: Smart Matching -->
                                <div class="lp-mockup-panel active" id="lp-panel-matching">
                                    <div class="lp-mockup-tabs">
                                        <div class="lp-mockup-tab active">My Network</div>
                                        <div class="lp-mockup-tab">Discover</div>
                                        <div class="lp-mockup-tab">Requests</div>
                                    </div>
                                    <div class="lp-mockup-card">
                                        <div class="lp-mc-av a1">JT</div>
                                        <div class="lp-mc-info">
                                            <div class="lp-mc-name">Jordan Torres</div>
                                            <div class="lp-mc-meta">Finance Junior</div>
                                            <div class="lp-match-bar-wrap">
                                                <div class="lp-match-bar" style="width:92%"></div>
                                                <span class="lp-match-pct">92%</span>
                                            </div>
                                        </div>
                                        <div class="lp-mc-btn">&#9749; Chat</div>
                                    </div>
                                    <div class="lp-mockup-card">
                                        <div class="lp-mc-av a2">AP</div>
                                        <div class="lp-mc-info">
                                            <div class="lp-mc-name">Anika Patel</div>
                                            <div class="lp-mc-meta">CS Senior</div>
                                            <div class="lp-match-bar-wrap">
                                                <div class="lp-match-bar" style="width:88%"></div>
                                                <span class="lp-match-pct">88%</span>
                                            </div>
                                        </div>
                                        <div class="lp-mc-btn">&#9749; Chat</div>
                                    </div>
                                    <div class="lp-mockup-card">
                                        <div class="lp-mc-av a3">MR</div>
                                        <div class="lp-mc-info">
                                            <div class="lp-mc-name">Mike Reyes</div>
                                            <div class="lp-mc-meta">Engineering Soph.</div>
                                            <div class="lp-match-bar-wrap">
                                                <div class="lp-match-bar" style="width:76%"></div>
                                                <span class="lp-match-pct">76%</span>
                                            </div>
                                        </div>
                                        <div class="lp-mc-btn">&#9749; Chat</div>
                                    </div>
                                </div>

                                <!-- PANEL 2: Icebreakers -->
                                <div class="lp-mockup-panel" id="lp-panel-icebreakers">
                                    <div class="lp-ice-header">
                                        <div class="lp-mc-av a1" style="width:32px;height:32px;font-size:12px;">JT</div>
                                        <div>
                                            <div style="font-size:12px;font-weight:600;color:rgba(245,240,232,0.9);">Chat with Jordan T.</div>
                                            <div style="font-size:10px;color:rgba(245,240,232,0.4);">Conversation starters ready</div>
                                        </div>
                                    </div>
                                    <div class="lp-ice-label">&#127775; Try one of these</div>
                                    <div class="lp-ice-card">&#128188; &ldquo;What was your very first internship like — and what surprised you most?&rdquo;</div>
                                    <div class="lp-ice-card">&#127919; &ldquo;What&apos;s your biggest career goal before you graduate?&rdquo;</div>
                                    <div class="lp-ice-card">&#127979; &ldquo;Which Rowan class actually changed how you think?&rdquo;</div>
                                    <div class="lp-ice-card">&#9749; &ldquo;Virtual or grab coffee on campus — your pick!&rdquo;</div>
                                </div>

                                <!-- PANEL 3: Community Groups -->
                                <div class="lp-mockup-panel" id="lp-panel-groups">
                                    <div class="lp-mockup-tabs">
                                        <div class="lp-mockup-tab active">My Groups</div>
                                        <div class="lp-mockup-tab">Explore</div>
                                    </div>
                                    <div class="lp-group-card">
                                        <div class="lp-group-icon" style="background:linear-gradient(135deg,#C07C3A,#D4964F);">&#128200;</div>
                                        <div class="lp-mc-info">
                                            <div class="lp-mc-name">Rowan Finance Society</div>
                                            <div class="lp-mc-meta">48 members &middot; Active now</div>
                                        </div>
                                        <div class="lp-group-badge">Joined</div>
                                    </div>
                                    <div class="lp-group-card">
                                        <div class="lp-group-icon" style="background:linear-gradient(135deg,#8A9E85,#6B8566);">&#128187;</div>
                                        <div class="lp-mc-info">
                                            <div class="lp-mc-name">CS Entrepreneurs</div>
                                            <div class="lp-mc-meta">112 members &middot; 3 new posts</div>
                                        </div>
                                        <div class="lp-group-badge">Joined</div>
                                    </div>
                                    <div class="lp-group-card">
                                        <div class="lp-group-icon" style="background:linear-gradient(135deg,#3D2B1A,#6B4A2E);">&#9878;&#65039;</div>
                                        <div class="lp-mc-info">
                                            <div class="lp-mc-name">Pre-Law Network</div>
                                            <div class="lp-mc-meta">67 members &middot; Join to see posts</div>
                                        </div>
                                        <div class="lp-mc-btn" style="font-size:10px;padding:5px 10px;">+ Join</div>
                                    </div>
                                </div>

                                <!-- PANEL 4: Schedule -->
                                <div class="lp-mockup-panel" id="lp-panel-schedule">
                                    <div class="lp-sched-header">
                                        <div class="lp-mc-av a1" style="width:32px;height:32px;font-size:12px;">JT</div>
                                        <div>
                                            <div style="font-size:12px;font-weight:600;color:rgba(245,240,232,0.9);">Chat with Jordan T.</div>
                                            <div style="font-size:10px;color:rgba(245,240,232,0.4);">30 min &middot; Virtual</div>
                                        </div>
                                        <div class="lp-sched-pill">30 min</div>
                                    </div>
                                    <div class="lp-ice-label">&#128197; Pick a time that works</div>
                                    <div class="lp-sched-slot lp-sched-slot--active">
                                        <div class="lp-sched-dot"></div>
                                        <div>
                                            <div style="font-size:12px;font-weight:600;color:rgba(245,240,232,0.9);">Tomorrow &mdash; 2:00 PM</div>
                                            <div style="font-size:10px;color:rgba(245,240,232,0.45);">30 min &middot; Virtual</div>
                                        </div>
                                        <div class="lp-mc-btn" style="font-size:10px;padding:5px 10px;">Select</div>
                                    </div>
                                    <div class="lp-sched-slot">
                                        <div class="lp-sched-dot"></div>
                                        <div>
                                            <div style="font-size:12px;font-weight:600;color:rgba(245,240,232,0.9);">Friday &mdash; 11:30 AM</div>
                                            <div style="font-size:10px;color:rgba(245,240,232,0.45);">30 min &middot; Campus Caf&eacute;</div>
                                        </div>
                                        <div class="lp-mc-btn" style="font-size:10px;padding:5px 10px;">Select</div>
                                    </div>
                                    <div class="lp-sched-slot">
                                        <div class="lp-sched-dot"></div>
                                        <div>
                                            <div style="font-size:12px;font-weight:600;color:rgba(245,240,232,0.9);">Monday &mdash; 4:00 PM</div>
                                            <div style="font-size:10px;color:rgba(245,240,232,0.45);">30 min &middot; Virtual</div>
                                        </div>
                                        <div class="lp-mc-btn" style="font-size:10px;padding:5px 10px;">Select</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Founder -->
                    <section class="lp-section lp-founder" id="lpFounder">
                        <div class="lp-founder-inner reveal">
                            <div class="lp-founder-portrait">
                                <img src="images/sal.jpg" alt="Sal Altadonna" onerror="this.style.display='none'" />
                                S
                            </div>
                            <div>
                                <div class="lp-section-tag">Our Story</div>
                                <p class="lp-founder-quote">&ldquo;I wanted a way to build genuine relationships with people who share my curiosity &mdash; not just my industry.&rdquo;</p>
                                <div class="lp-founder-attr">Sal Altadonna, Founder &middot; Rowan University Junior</div>
                                <p style="margin-top:20px; font-size:15px; color:var(--muted); line-height:1.7; font-weight:300;">First Sip was born out of frustration with stiff career fairs, cold LinkedIn messages, and events where everyone just exchanges business cards they&apos;ll never look at again. It&apos;s a more human, more efficient way to network.</p>
                            </div>
                        </div>
                    </section>

                    <!-- CTA -->
                    <section class="lp-cta-section" id="lpContact">
                        <div class="lp-section-tag" style="color:var(--caramel-light);">Join Now</div>
                        <h2>Ready to build your<br/><em>real</em> network?</h2>
                        <p class="lp-section-sub" style="margin: 0 auto 40px;">Be part of Rowan&apos;s founding cohort. No fluff, no cold messages. Just real conversations with people who actually want to connect.</p>
                        <button class="lp-btn-cta" onclick="showLandingSignup()">&#9749; Join Rowan&apos;s Founding Cohort &mdash; It&apos;s Free</button>
                        <p style="margin-top:24px; font-size:13px; color:rgba(245,240,232,0.35);">Questions? <a href="mailto:Sal.FirstSip@Outlook.com" style="color:var(--caramel-light);text-decoration:none;">Sal.FirstSip@Outlook.com</a></p>
                    </section>

                    <!-- Footer -->
                    <footer class="lp-footer">
                        <div class="lp-footer-logo">First<span>Sip</span></div>
                        <div class="lp-footer-text">&copy; 2026 First Sip. Starting at Rowan University.</div>
                        <ul class="lp-footer-links">
                            <li><a onclick="document.getElementById('lpFounder').scrollIntoView({behavior:'smooth'})">About</a></li>
                            <li><a onclick="document.getElementById('lpHow').scrollIntoView({behavior:'smooth'})">How It Works</a></li>
                            <li><a href="mailto:Sal.FirstSip@Outlook.com">Contact</a></li>
                        </ul>
                    </footer>

                </div>
            </div>

            <!-- Auth Screens -->
            <div id="loginView" class="content-view">
                <div class="auth-page">
                    <!-- Left panel -->
                    <div class="auth-left">
                        <div class="auth-grain"></div>
                        <div class="auth-left-logo">
                            <div class="auth-logo-mark">☕</div>
                            <span class="auth-logo-text">First Sip</span>
                        </div>
                        <div class="auth-left-hero">
                            <div class="auth-eyebrow">Rowan University Network</div>
                            <h1 class="auth-hero-headline">Networking that feels<br><em>human</em> for once.</h1>
                            <p class="auth-hero-body">Meet fellow Profs and Rowan alumni over a real 30-minute conversation. No cold messages. No awkward events. Just authentic connection over coffee.</p>
                            <div class="auth-testimonial">
                                <p class="auth-testimonial-quote">"I landed my internship through a First Sip chat. It felt less like networking and more like making a real friend."</p>
                                <div class="auth-testimonial-author">
                                    <div class="auth-author-avatar">A</div>
                                    <div>
                                        <div class="auth-author-name">Anika P.</div>
                                        <div class="auth-author-role">CS Senior · Rowan University</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="auth-decor-circles">
                            <div class="auth-decor-circle"></div>
                            <div class="auth-decor-circle"></div>
                            <div class="auth-decor-circle"></div>
                        </div>
                    </div>
                    <!-- Right panel -->
                    <div class="auth-right">
                        <div class="auth-form-container">
                            <div class="auth-form-header">
                                <h2 class="auth-form-title">Welcome back</h2>
                                <p class="auth-form-subtitle">Sign in to continue building your real network at Rowan.</p>
                            </div>
                            <div class="form-group">
                                <label class="auth-form-label">Email Address</label>
                                <div class="auth-input-wrapper">
                                    <span class="auth-input-icon">✉</span>
                                    <input type="email" id="loginEmail" class="auth-form-input" placeholder="you@rowan.edu">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="auth-form-label">Password</label>
                                <div class="auth-input-wrapper">
                                    <span class="auth-input-icon">🔒</span>
                                    <input type="password" id="loginPassword" class="auth-form-input" placeholder="Enter your password">
                                </div>
                            </div>
                            <button class="auth-btn-primary" onclick="handleLogin()">Sign In to First Sip ☕</button>
                            <div class="auth-toggle">
                                New to First Sip? <button onclick="switchView('signupView')">Create your account →</button>
                            </div>
                            <div class="auth-stat-row">
                                <div class="auth-stat-item">
                                    <div class="auth-stat-value">30m</div>
                                    <div class="auth-stat-label">Avg chat length</div>
                                </div>
                                <div class="auth-stat-item">
                                    <div class="auth-stat-value">100%</div>
                                    <div class="auth-stat-label">Rowan-only</div>
                                </div>
                                <div class="auth-stat-item">
                                    <div class="auth-stat-value">Free</div>
                                    <div class="auth-stat-label">Always</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signupView" class="content-view">
                <div class="su-page">

                    <!-- Left sticky panel -->
                    <div class="su-left">
                        <div class="auth-grain"></div>
                        <div class="su-logo">
                            <div class="su-logo-mark">☕</div>
                            <span class="su-logo-text">First Sip</span>
                        </div>
                        <div class="su-steps-area">
                            <h2 class="su-steps-headline">Your real<br><em>network</em> starts<br>with one sip.</h2>
                            <p class="su-steps-tagline">Join Rowan's founding cohort and connect with students and alumni who actually want to help.</p>
                            <div class="su-step-list">
                                <div class="su-step-item su-active">
                                    <div class="su-step-num">1</div>
                                    <div>
                                        <div class="su-step-title">Create your profile</div>
                                        <div class="su-step-desc">Tell us who you are and where you're headed</div>
                                    </div>
                                </div>
                                <div class="su-step-item">
                                    <div class="su-step-num">2</div>
                                    <div>
                                        <div class="su-step-title">Discover connections</div>
                                        <div class="su-step-desc">Browse people who share your goals</div>
                                    </div>
                                </div>
                                <div class="su-step-item">
                                    <div class="su-step-num">3</div>
                                    <div>
                                        <div class="su-step-title">Schedule your first sip</div>
                                        <div class="su-step-desc">Book a 30-min chat — virtual or on campus</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="su-bottom-pill">
                            <div class="su-pulse-dot"></div>
                            Rowan students joining now
                        </div>
                    </div>

                    <!-- Right form panel -->
                    <div class="su-right">
                        <div class="su-form-wrapper">

                            <div class="su-form-header">
                                <div class="su-form-badge">🎓 Rowan University · Founding Cohort</div>
                                <h1 class="su-form-title">Create your<br>account</h1>
                                <p class="su-form-subtitle">Join for free. No spam, no recruiters — just real Rowan connections.</p>
                            </div>

                            <!-- The basics -->
                            <div class="su-section-divider">
                                <span class="su-section-label">The basics</span>
                                <div class="su-section-line"></div>
                            </div>

                            <div class="su-grid-2">
                                <div class="form-group">
                                    <label class="su-label">First Name</label>
                                    <div class="su-input-wrap">
                                        <span class="su-icon">👤</span>
                                        <input type="text" id="signupFirstName" class="su-input" placeholder="Jane">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="su-label">Last Name</label>
                                    <div class="su-input-wrap">
                                        <span class="su-icon">👤</span>
                                        <input type="text" id="signupLastName" class="su-input" placeholder="Smith">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="su-label">Rowan Email</label>
                                <div class="su-input-wrap">
                                    <span class="su-icon">✉</span>
                                    <input type="email" id="signupEmail" class="su-input" placeholder="you@rowan.edu">
                                </div>
                            </div>

                            <!-- Rowan journey -->
                            <div class="su-section-divider">
                                <span class="su-section-label">Your Rowan journey</span>
                                <div class="su-section-line"></div>
                            </div>

                            <div class="su-grid-2">
                                <div class="form-group">
                                    <label class="su-label">Current Status</label>
                                    <select id="signupStatus" class="su-input su-no-icon">
                                        <option value="">Select year</option>
                                        <option value="Freshman">Freshman</option>
                                        <option value="Sophomore">Sophomore</option>
                                        <option value="Junior">Junior</option>
                                        <option value="Senior">Senior</option>
                                        <option value="Recent Grad">Recent Grad</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="su-label">Grad Year</label>
                                    <select id="signupGradYear" class="su-input su-no-icon">
                                        <option value="">Select year</option>
                                        <option value="2030">2030</option>
                                        <option value="2029">2029</option>
                                        <option value="2028">2028</option>
                                        <option value="2027">2027</option>
                                        <option value="2026">2026</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="su-label">Area of Study</label>
                                <div class="su-chips">
                                    <div class="su-chip" onclick="suSelectChip(this,'Business/Finance')">💼 Business / Finance</div>
                                    <div class="su-chip" onclick="suSelectChip(this,'Computer Science/Tech')">💻 Computer Science</div>
                                    <div class="su-chip" onclick="suSelectChip(this,'Engineering')">⚙️ Engineering</div>
                                    <div class="su-chip" onclick="suSelectChip(this,'Pre-Med/Healthcare')">🩺 Pre-Med</div>
                                    <div class="su-chip" onclick="suSelectChip(this,'Liberal Arts/Humanities')">📚 Liberal Arts</div>
                                    <div class="su-chip" onclick="suSelectChip(this,'Undecided/Exploring')">🔍 Exploring</div>
                                </div>
                                <!-- Hidden select keeps handleSignup() working unchanged -->
                                <select id="signupIndustry" style="display:none;">
                                    <option value="">Select your major or interest</option>
                                    <option value="Business/Finance">Business / Finance</option>
                                    <option value="Computer Science/Tech">Computer Science / Tech</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Pre-Med/Healthcare">Pre-Med / Healthcare</option>
                                    <option value="Liberal Arts/Humanities">Liberal Arts / Humanities</option>
                                    <option value="Undecided/Exploring">Undecided / Exploring</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="su-label">Interests &amp; Passions</label>
                                <textarea id="signupInterests" class="su-input su-no-icon" placeholder="e.g., investment banking, product management, startups, pre-law..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="su-label">Career Goals</label>
                                <textarea id="signupGoals" class="su-input su-no-icon" placeholder="e.g., break into consulting, land a tech internship, get into med school..."></textarea>
                            </div>

                            <!-- Account -->
                            <div class="su-section-divider">
                                <span class="su-section-label">Secure your account</span>
                                <div class="su-section-line"></div>
                            </div>

                            <div class="form-group">
                                <label class="su-label">Password</label>
                                <div class="su-input-wrap">
                                    <span class="su-icon">🔒</span>
                                    <input type="password" id="signupPassword" class="su-input" placeholder="Create a strong password" oninput="suUpdateStrength(this.value)">
                                </div>
                                <div class="su-strength-bars">
                                    <div class="su-bar" id="suBar1"></div>
                                    <div class="su-bar" id="suBar2"></div>
                                    <div class="su-bar" id="suBar3"></div>
                                    <div class="su-bar" id="suBar4"></div>
                                </div>
                            </div>

                            <button class="su-btn" onclick="handleSignup()">Join Rowan's Founding Cohort ☕</button>

                            <div class="auth-toggle" style="margin-top: 20px;">
                                Already have an account? <button onclick="switchView('loginView')">Sign in →</button>
                            </div>

                            <div class="su-benefits">
                                <div class="su-benefit-card">
                                    <div class="su-benefit-icon">☕</div>
                                    <div class="su-benefit-title">Real Conversations</div>
                                    <div class="su-benefit-desc">No cold DMs. Book actual 30-min chats.</div>
                                </div>
                                <div class="su-benefit-card">
                                    <div class="su-benefit-icon">🎯</div>
                                    <div class="su-benefit-title">Smart Matching</div>
                                    <div class="su-benefit-desc">Matched by goals, not just connections.</div>
                                </div>
                                <div class="su-benefit-card">
                                    <div class="su-benefit-icon">🏫</div>
                                    <div class="su-benefit-title">Rowan Only</div>
                                    <div class="su-benefit-desc">Students and alumni who get your journey.</div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardView" class="content-view" style="padding:0; overflow-y:auto;">

                <!-- HEADER: Greeting + Alert Pill -->
                <div class="db-header">
                    <div class="db-greeting-row">
                        <div class="db-greeting-text">
                            <h1 class="db-greeting-h1"><span id="dbGreeting">Good morning</span>, <em id="userName">there</em> ☕</h1>
                            <p class="db-greeting-sub">Here's what needs your attention today.</p>
                        </div>
                        <div class="db-alert-pill" id="dbAlertPill" onclick="toggleNotifications()">
                            <div class="db-alert-dot"></div>
                            <div>
                                <div class="db-alert-text" id="dbAlertText">Loading...</div>
                                <div class="db-alert-sub" id="dbAlertSub"></div>
                            </div>
                            <span class="db-alert-arrow">→</span>
                        </div>
                    </div>
                </div>

                <!-- YOUR NEXT SIP -->
                <div class="db-section">
                    <div class="db-section-header">
                        <div class="db-section-label">Your next sip</div>
                        <button class="db-see-all" onclick="switchView('messagesView')">All chats →</button>
                    </div>
                    <div id="dbNextSipCard"></div>
                </div>

                <!-- PEOPLE YOU SHOULD MEET -->
                <div class="db-section">
                    <div class="db-section-header">
                        <div class="db-section-label">People you should meet</div>
                        <button class="db-see-all" onclick="switchView('discoverView')">See all →</button>
                    </div>
                    <div class="db-people-grid" id="dbMatchesList"></div>
                </div>

                <!-- Hidden legacy elements kept for JS compatibility -->
                <div style="display:none;" aria-hidden="true">
                    <div id="dbStatConnections"></div>
                    <div id="dbStatUpcoming"></div>
                    <div id="dbStatCompleted"></div>
                    <div id="dbSetupBar"><div id="dbSetupSteps"></div><button id="dbSetupCta"></button></div>
                    <div id="dbActivityFeed"></div>
                    <div id="dbGroupsList"></div>
                    <div id="dbBadgesCount"></div>
                    <div id="dashboardBadges"></div>
                    <div id="streakBadge"><span id="streakDisplay"></span></div>
                    <div id="gettingStarted"><ul id="checklistItems"></ul></div>
                    <div id="welcomeEmptyState"></div>
                    <div id="zeroCTAs"></div>
                    <div id="hubPanel">
                        <button id="tabNetwork"></button><button id="tabGroups"></button><button id="tabChats"></button>
                        <div id="hubNetworkPanel"><div id="hubNetworkFeed"></div></div>
                        <div id="hubGroupsPanel"><div id="hubGroupsFeed"></div></div>
                        <div id="hubChatsPanel"><div id="hubChatsContent"></div></div>
                    </div>
                    <div id="statConnections"></div>
                    <div id="statChats"></div>
                    <div id="statGroups"></div>
                    <div id="dashboardStats"></div>
                    <div id="onboardStep1"></div><div id="onboardStep2"></div>
                    <div id="onboardStep3"></div><div id="onboardStep4"></div>
                    <div id="completionCard">
                        <svg width="56" height="56" viewBox="0 0 80 80">
                            <circle class="progress-ring-bg" cx="40" cy="40" r="34"></circle>
                            <circle class="progress-ring-fill" id="progressRing" cx="40" cy="40" r="34" stroke-dasharray="213.6" stroke-dashoffset="213.6"></circle>
                        </svg>
                        <span id="progressPercent"></span>
                        <div id="completionMsg"></div>
                    </div>
                </div>

            </div>

            <!-- Discover View -->
            <div id="discoverView" class="content-view">
                <div class="view-header">
                    <div class="view-eyebrow">Rowan University</div>
                    <h1 class="view-title">Find Your <em>People</em></h1>
                    <p class="view-subtitle">Browse students and alumni who share your interests and goals</p>
                </div>

                <div class="dv-filter-card">
                    <div class="dv-filter-title">Search &amp; Filter</div>
                    <div class="dv-search-row">
                        <input type="text" id="searchName" class="dv-input" placeholder="Search by name…" onkeyup="filterDiscovery()">
                    </div>
                    <div class="dv-filter-row">
                        <select id="filterIndustry" class="dv-input" onchange="filterDiscovery()">
                            <option value="">All Majors</option>
                            <option value="Business/Finance">Business / Finance</option>
                            <option value="Computer Science/Tech">Computer Science / Tech</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Pre-Med/Healthcare">Pre-Med / Healthcare</option>
                            <option value="Liberal Arts/Humanities">Liberal Arts / Humanities</option>
                            <option value="Undecided/Exploring">Undecided / Exploring</option>
                        </select>
                        <input type="text" id="searchLocation" class="dv-input" placeholder="Grad year…" onkeyup="filterDiscovery()">
                    </div>
                    <div class="dv-filter-row">
                        <input type="text" id="searchInterests" class="dv-input" placeholder="Interests (e.g. AI, Startups)…" onkeyup="filterDiscovery()">
                        <input type="text" id="searchCompany" class="dv-input" placeholder="School or company…" onkeyup="filterDiscovery()">
                    </div>
                    <div class="dv-filter-actions">
                        <button class="dv-btn-primary" onclick="filterDiscovery()">Search</button>
                        <button class="dv-btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>

                <div id="recommendationsSection"></div>
                <div id="discoverGrid" class="grid"></div>
            </div>

            <!-- Profile Detail View -->
            <div id="profileDetailView" class="content-view pv-shell">
                <button class="pv-back" onclick="goBack()">← Back</button>
                <div id="profileDetailContent" class="profile-detail"></div>
            </div>

            <!-- My Profile View (LinkedIn-style) -->
            <div id="myProfileView" class="content-view pv-shell">
                <div id="myProfileContent"></div>
            </div>

            <!-- My Network View -->
            <div id="networkView" class="content-view">
                <!-- Hero strip -->
                <div class="nw-hero">
                    <div class="nw-hero-inner">
                        <div>
                            <div class="nw-eyebrow">Rowan University</div>
                            <h1 class="nw-hero-title">My <em>Network</em></h1>
                            <p class="nw-hero-sub">The people in your corner — students, alumni, and future collaborators.</p>
                        </div>
                        <div class="nw-stats" id="nwHeroStats"></div>
                    </div>
                    <div class="nw-tabs">
                        <button class="nw-tab active" onclick="switchNwTab(this,'nw-connections')">Connections <span class="nw-tab-count" id="nwTabCountConn">0</span></button>
                        <button class="nw-tab" onclick="switchNwTab(this,'nw-requests')">Requests <span class="nw-tab-count" id="nwTabCountReq">0</span></button>
                        <button class="nw-tab" onclick="switchNwTab(this,'nw-suggestions')">Suggested <span class="nw-tab-count" id="nwTabCountSug">0</span></button>
                    </div>
                </div>

                <!-- Tab content -->
                <div class="nw-content">
                    <!-- Connections -->
                    <div class="nw-panel active" id="nw-connections">
                        <div class="nw-filter-bar">
                            <div class="nw-search-box">
                                <span style="color:var(--muted);font-size:14px;">🔍</span>
                                <input type="text" id="nwSearchInput" placeholder="Search connections…" oninput="filterNwConnections()">
                            </div>
                        </div>
                        <div class="nw-conn-grid" id="nwConnectionsGrid"></div>
                    </div>

                    <!-- Requests -->
                    <div class="nw-panel" id="nw-requests">
                        <div class="nw-req-layout">
                            <div>
                                <h2 class="nw-req-section-title"><em>Incoming</em> <span class="nw-req-count" id="nwIncomingCount"></span></h2>
                                <div id="nwIncomingList"></div>
                            </div>
                            <div>
                                <h2 class="nw-req-section-title"><em>Sent</em> <span class="nw-req-count" id="nwSentCount"></span></h2>
                                <div id="nwSentList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions -->
                    <div class="nw-panel" id="nw-suggestions">
                        <div id="nwSuggestionsContent"></div>
                    </div>
                </div>
            </div>

            <!-- Modals moved to end of body -->

            <!-- Groups View -->
            <div id="groupsView" class="content-view">
                <div class="gv-header-row">
                    <div>
                        <div class="view-eyebrow">First Sip</div>
                        <h1 class="view-title" style="margin-bottom:4px;">Communities &amp; <em>Groups</em></h1>
                        <p class="view-subtitle">Join groups aligned with your industry and interests</p>
                    </div>
                    <button class="gv-create-btn" onclick="openModal('createGroupModal')">+ Create Group</button>
                </div>

                <div class="gv-section-head">
                    <h2 class="gv-section-title">Featured Groups</h2>
                </div>
                <div id="groupsList" class="grid"></div>

                <div class="gv-section-head" style="margin-top:32px;">
                    <h2 class="gv-section-title">Your Groups</h2>
                </div>
                <div id="myGroupsList"></div>
            </div>

            <!-- Group Detail View -->
            <div id="groupDetailView" class="content-view pv-shell">
                <button class="pv-back" onclick="switchView('groupsView')">← Back to Groups</button>
                <div id="groupDetailContent"></div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="content-view">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2rem; gap:1rem; flex-wrap:wrap;">
                    <div>
                        <h1 style="margin-bottom:0.25rem;">Your Schedule</h1>
                        <p style="color:#999;">View and manage your coffee chats</p>
                    </div>
                    <button class="btn btn-secondary" onclick="switchView('availabilityView')" style="flex-shrink:0;">🕒 Set Availability</button>
                </div>

                <div class="grid two-col">
                    <div>
                        <h2 style="margin-bottom: 1rem;">Calendar</h2>
                        <div class="calendar">
                            <div class="calendar-header">
                                <button onclick="previousMonth()">←</button>
                                <h3 style="margin: 0;" id="currentMonth"></h3>
                                <button onclick="nextMonth()">→</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                    </div>

                    <div>
                        <h2 style="margin-bottom: 1rem;">Upcoming Meetings</h2>
                        <div id="meetingsList"></div>
                    </div>
                </div>
            </div>

            <!-- My Chats View (redesigned) -->
            <div id="messagesView" class="content-view">

                <!-- Page Header -->
                <div class="mc-page-header">
                    <div>
                        <div class="mc-page-eyebrow">Your Connections</div>
                        <h1 class="mc-page-title">My <em>Coffee Chats</em></h1>
                    </div>
                    <button class="mc-btn-schedule" onclick="openScheduleChatModal()">☕ Schedule a Sip</button>
                </div>

                <!-- Stats Row -->
                <div class="mc-stats-row" id="mcStatsRow">
                    <div class="mc-stat-card">
                        <div class="mc-stat-icon orange">☕</div>
                        <div><div class="mc-stat-val" id="mcStatTotal">0</div><div class="mc-stat-lbl">Total Chats</div></div>
                    </div>
                    <div class="mc-stat-card">
                        <div class="mc-stat-icon green">✅</div>
                        <div><div class="mc-stat-val" id="mcStatCompleted">0</div><div class="mc-stat-lbl">Completed</div></div>
                    </div>
                    <div class="mc-stat-card">
                        <div class="mc-stat-icon cream">📅</div>
                        <div><div class="mc-stat-val" id="mcStatUpcoming">0</div><div class="mc-stat-lbl">Upcoming</div></div>
                    </div>
                </div>

                <!-- Content grid: left (tabs+cards) / right (widgets) -->
                <div class="mc-content-grid">

                    <!-- LEFT -->
                    <div>
                        <!-- Tabs -->
                        <div class="mc-tabs-bar">
                            <button class="mc-tab-btn active" onclick="switchChatTab(this,'mc-tab-upcoming')">Upcoming</button>
                            <button class="mc-tab-btn" onclick="switchChatTab(this,'mc-tab-past')">Past Chats</button>
                            <button class="mc-tab-btn" onclick="switchChatTab(this,'mc-tab-pending')">Pending</button>
                            <button class="mc-tab-btn" onclick="switchChatTab(this,'mc-tab-messages')">💬 Messages</button>
                        </div>

                        <!-- Tab: Upcoming -->
                        <div id="mc-tab-upcoming" class="mc-chat-list"></div>

                        <!-- Tab: Past Chats -->
                        <div id="mc-tab-past" class="mc-chat-list" style="display:none;"></div>

                        <!-- Tab: Pending -->
                        <div id="mc-tab-pending" style="display:none;"></div>

                        <!-- Tab: Messages (direct messages) -->
                        <div id="mc-tab-messages" style="display:none;">
                            <div class="mc-messages-wrapper">
                                <div class="mc-conv-list">
                                    <div class="mc-conv-list-header">Conversations</div>
                                    <div id="conversationList" class="conversation-list" style="padding: 8px;"></div>
                                </div>
                                <div id="chatWindow" class="chat-window mc-chat-win">
                                    <div class="chat-header">
                                        <h3>Select a conversation</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="mc-right-col">

                        <!-- Mini Calendar -->
                        <div class="mc-widget">
                            <div class="mc-widget-header">
                                <span class="mc-widget-title">Calendar</span>
                            </div>
                            <div class="mc-cal-wrap">
                                <div class="mc-cal-nav">
                                    <button class="mc-cal-nav-btn" onclick="miniCalPrev()">‹</button>
                                    <span class="mc-cal-month" id="miniCalMonth"></span>
                                    <button class="mc-cal-nav-btn" onclick="miniCalNext()">›</button>
                                </div>
                                <div class="mc-cal-days-grid" id="miniCalGrid"></div>
                            </div>
                        </div>

                        <!-- Next Up -->
                        <div class="mc-widget">
                            <div class="mc-widget-header">
                                <span class="mc-widget-title">Next Up</span>
                            </div>
                            <div class="mc-upcoming-list" id="mcNextUpList"></div>
                        </div>

                        <!-- Tips -->
                        <div class="mc-tips-widget">
                            <div class="mc-tips-body">
                                <div class="mc-tips-icon">💡</div>
                                <div class="mc-tips-title">Make the most of your sip</div>
                                <div class="mc-tips-text">Quick tips to turn a 30-minute chat into a lasting connection.</div>
                                <div class="mc-tips-tip">"Do your homework first — check their profile and have one specific question ready. People love talking about their own journey."</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Video Call View -->
            <div id="callView" class="content-view">
                <div class="cv-topbar">
                    <span class="cv-logo">☕ First Sip</span>
                    <button class="cv-end-btn" onclick="endCall()">✕ End Call</button>
                </div>
                <div class="cv-stage">
                    <div class="cv-video-main">
                        <div class="cv-video-avatar">
                            <div id="remoteName" style="font-size:40px;line-height:1;"></div>
                            <div id="remotePerson" style="font-size:13px;color:rgba(245,237,227,.5);margin-top:6px;font-family:'DM Sans',sans-serif;"></div>
                        </div>
                        <div class="cv-video-local">👤</div>
                    </div>
                    <div class="cv-info">
                        <h2 class="cv-person-name" id="callPersonName"></h2>
                        <div class="cv-timer"><span id="callTimer">00:00</span></div>
                    </div>
                </div>
                <div class="cv-controls">
                    <button class="cv-ctrl cv-ctrl-mic" id="micBtn" onclick="toggleMic()">🎤</button>
                    <button class="cv-ctrl cv-ctrl-end" onclick="endCall()">☎</button>
                    <button class="cv-ctrl cv-ctrl-vid" id="videoBtn" onclick="toggleVideo()">📹</button>
                </div>
            </div>

            <!-- Schedule Meeting View -->
            <div id="scheduleView" class="content-view">
                <button class="pv-back" onclick="goBack()">← Back</button>
                <div class="sv-shell">
                    <div class="sv-card">
                        <div class="sv-card-header">
                            <div class="sv-card-eyebrow">☕ First Sip</div>
                            <h1 class="sv-card-title">Schedule a Chat</h1>
                            <div class="sv-card-with">With <strong id="scheduleName">—</strong></div>
                        </div>
                        <div class="sv-card-body">

                            <div class="sv-form-group">
                                <label class="sv-form-label">Select Date</label>
                                <input type="date" id="scheduleDate" class="sv-input">
                            </div>

                            <div class="sv-form-group">
                                <label class="sv-form-label">Select Time</label>
                                <div class="time-slots" id="timeSlots"></div>
                            </div>

                            <div class="sv-form-group">
                                <label class="sv-form-label">Duration</label>
                                <select id="scheduleDuration" class="sv-input">
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>

                            <div class="sv-form-group">
                                <label class="sv-form-label">Topic / Purpose</label>
                                <textarea id="scheduleTopic" class="sv-input" style="resize:vertical; min-height:80px;" placeholder="What would you like to discuss?"></textarea>
                            </div>

                            <div class="sv-form-group">
                                <label class="sv-form-label">Meeting Type</label>
                                <select id="scheduleType" class="sv-input" onchange="updateMeetingDetails()">
                                    <option value="video">Video Call</option>
                                    <option value="zoom">Zoom Meeting</option>
                                    <option value="facetime">FaceTime</option>
                                    <option value="phone">Phone Call</option>
                                    <option value="coffee">First Sip (In-person)</option>
                                </select>
                            </div>

                            <div id="meetingDetailsSection">
                                <div class="sv-form-group" id="meetingLinkGroup">
                                    <label class="sv-form-label" id="meetingDetailLabel">Video Call Link</label>
                                    <input type="text" id="meetingDetailInput" class="sv-input" placeholder="Paste your video call link here">
                                    <p class="sv-form-hint" id="meetingDetailHint">e.g., Google Meet, Teams, or other video call link</p>
                                </div>
                            </div>

                            <button class="sv-btn" onclick="sendMeetingRequest()">Send Meeting Request ☕</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed View -->
            <div id="feedView" class="content-view">
                <div class="view-header-row" style="margin-bottom:22px;">
                    <div>
                        <div class="view-eyebrow">Your Network</div>
                        <h1 class="view-title" style="margin-bottom:0;">The <em>Feed</em></h1>
                    </div>
                </div>

                <div class="fv-toolbar">
                    <div class="fv-tabs">
                        <button id="feedTabConnections" class="fv-tab active" onclick="switchFeedTab('connections')">Connections</button>
                        <button id="feedTabGroups" class="fv-tab" onclick="switchFeedTab('groups')">Groups</button>
                    </div>
                    <button class="fv-create-btn" onclick="createPost()">✍️ Create Post</button>
                </div>

                <div id="feedPosts"></div>
            </div>

            <!-- Availability View -->
            <div id="availabilityView" class="content-view">
                <div class="view-header">
                    <div class="view-eyebrow">Settings</div>
                    <h1 class="view-title">Your <em>Availability</em></h1>
                    <p class="view-subtitle">Let people know when you're free for a coffee chat</p>
                </div>

                <div class="av-card">
                    <h3 class="av-slots-title">Weekly Schedule</h3>
                    <div id="availabilitySlots"></div>

                    <hr class="av-divider">

                    <h3 class="av-add-title">Add a Time Slot</h3>

                    <div style="margin-bottom:16px;">
                        <label class="av-form-label">Day of Week</label>
                        <select id="availabilityDay" class="av-input">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>

                    <div class="av-time-grid">
                        <div>
                            <label class="av-form-label">Start Time</label>
                            <input type="time" id="availabilityStartTime" class="av-input" value="09:00">
                        </div>
                        <div>
                            <label class="av-form-label">End Time</label>
                            <input type="time" id="availabilityEndTime" class="av-input" value="17:00">
                        </div>
                    </div>

                    <button class="av-btn" onclick="addAvailabilitySlot()">Add Availability</button>
                </div>
            </div>
        </div>

    <!-- Settings View -->
    <div id="settingsView" class="content-view">

        <!-- Mobile horizontal tab bar (visible on screens < 900px) -->
        <div class="st-mobile-tabs" id="stMobileTabs">
            <button class="st-mobile-tab active" onclick="switchStSection(this,'st-profile','stMobileTabs')">👤 Profile</button>
            <button class="st-mobile-tab" onclick="switchStSection(this,'st-account','stMobileTabs')">🔑 Account</button>
            <button class="st-mobile-tab" onclick="switchStSection(this,'st-notifications','stMobileTabs')">🔔 Notifications</button>
            <button class="st-mobile-tab" onclick="switchStSection(this,'st-privacy','stMobileTabs')">🛡️ Privacy</button>
            <button class="st-mobile-tab" onclick="switchStSection(this,'st-availability','stMobileTabs')">📅 Availability</button>
            <button class="st-mobile-tab" onclick="switchStSection(this,'st-appearance','stMobileTabs')">🎨 Appearance</button>
            <button class="st-mobile-tab danger" onclick="switchStSection(this,'st-danger','stMobileTabs')">⚠️ Danger</button>
        </div>

        <div class="st-layout">

            <!-- Inner Settings Nav -->
            <nav class="st-nav">
                <div class="st-nav-header">
                    <div class="st-nav-title">Settings</div>
                    <div class="st-nav-sub">Manage your account</div>
                </div>
                <button class="st-nav-item active" onclick="switchStSection(this,'st-profile')">
                    <span class="st-nav-icon">👤</span> Profile
                </button>
                <button class="st-nav-item" onclick="switchStSection(this,'st-account')">
                    <span class="st-nav-icon">🔑</span> Account &amp; Security
                </button>
                <button class="st-nav-item" onclick="switchStSection(this,'st-notifications')">
                    <span class="st-nav-icon">🔔</span> Notifications
                </button>
                <button class="st-nav-item" onclick="switchStSection(this,'st-privacy')">
                    <span class="st-nav-icon">🛡️</span> Privacy
                </button>
                <button class="st-nav-item" onclick="switchStSection(this,'st-availability')">
                    <span class="st-nav-icon">📅</span> Availability
                </button>
                <button class="st-nav-item" onclick="switchStSection(this,'st-appearance')">
                    <span class="st-nav-icon">🎨</span> Appearance
                </button>
                <div class="st-nav-divider"></div>
                <button class="st-nav-item st-nav-danger" onclick="switchStSection(this,'st-danger')">
                    <span class="st-nav-icon">⚠️</span> Danger Zone
                </button>
            </nav>

            <!-- Settings Content -->
            <div class="st-content">

                <!-- ── PROFILE ── -->
                <div class="st-section active" id="st-profile">
                    <div>
                        <div class="st-eyebrow">Who you are</div>
                        <h1 class="st-title">Your <em>Profile</em></h1>
                        <p class="st-desc">This is how other Rowan students and alumni see you. A complete profile gets 3× more connection requests.</p>
                    </div>

                    <!-- Avatar -->
                    <div class="st-card">
                        <div class="st-card-header">
                            <div>
                                <div class="st-card-title">Profile Photo</div>
                                <div class="st-card-sub">JPG or PNG, max 5 MB</div>
                            </div>
                        </div>
                        <div class="st-card-body">
                            <div class="st-avatar-wrap">
                                <div class="st-avatar" id="stAvatarPreview" onclick="document.getElementById('stAvatarFile').click()">
                                    <span id="stAvatarInitials">?</span>
                                    <div class="st-avatar-overlay">📷</div>
                                    <input type="file" id="stAvatarFile" accept="image/*" style="display:none;" onchange="uploadStAvatar(this)">
                                </div>
                                <div>
                                    <div class="st-avatar-info-name" id="stAvatarName">—</div>
                                    <div class="st-avatar-info-sub" id="stAvatarSub">—</div>
                                    <button class="st-btn-upload" onclick="document.getElementById('stAvatarFile').click()">📁 Upload new photo</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Info -->
                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Basic Info</div></div>
                        <div class="st-card-body">
                            <div class="st-form-row">
                                <div class="st-form-group">
                                    <label class="st-label">First Name</label>
                                    <input type="text" id="stFirstName" class="st-input" placeholder="First name">
                                </div>
                                <div class="st-form-group">
                                    <label class="st-label">Last Name</label>
                                    <input type="text" id="stLastName" class="st-input" placeholder="Last name">
                                </div>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Headline</label>
                                <input type="text" id="stHeadline" class="st-input" placeholder='e.g. "Finance Junior @ Rowan | SIE Certified"'>
                                <div class="st-hint">A tagline that appears under your name on your profile card.</div>
                            </div>
                            <div class="st-form-row">
                                <div class="st-form-group">
                                    <label class="st-label">Current Status</label>
                                    <select id="stStatus" class="st-input">
                                        <option value="Freshman">Freshman</option>
                                        <option value="Sophomore">Sophomore</option>
                                        <option value="Junior">Junior</option>
                                        <option value="Senior">Senior</option>
                                        <option value="Recent Grad">Recent Grad</option>
                                        <option value="Alumni">Alumni</option>
                                        <option value="Graduate Student">Graduate Student</option>
                                    </select>
                                </div>
                                <div class="st-form-group">
                                    <label class="st-label">Graduation Year</label>
                                    <select id="stGradYear" class="st-input">
                                        <option>2025</option><option>2026</option><option>2027</option>
                                        <option>2028</option><option>2029</option><option>2030</option>
                                    </select>
                                </div>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Bio</label>
                                <textarea id="stBio" class="st-input" placeholder="Tell people a little about yourself…"></textarea>
                                <div class="st-hint">A genuine bio gets more chats than a resume bullet.</div>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-secondary" onclick="loadStProfile()">Discard</button>
                            <button class="st-btn-primary" id="stSaveBasicBtn" onclick="saveStProfile()">Save Changes</button>
                        </div>
                    </div>

                    <!-- Academic & Career -->
                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Academic &amp; Career</div></div>
                        <div class="st-card-body">
                            <div class="st-form-row">
                                <div class="st-form-group">
                                    <label class="st-label">Major</label>
                                    <input type="text" id="stMajor" class="st-input" placeholder="e.g. Finance, Computer Science">
                                </div>
                                <div class="st-form-group">
                                    <label class="st-label">Industry / Field</label>
                                    <select id="stIndustry" class="st-input">
                                        <option value="">— Select industry —</option>
                                        <option value="Business/Finance">Business / Finance</option>
                                        <option value="Computer Science/Tech">Computer Science / Tech</option>
                                        <option value="Engineering">Engineering</option>
                                        <option value="Pre-Med/Healthcare">Pre-Med / Healthcare</option>
                                        <option value="Liberal Arts/Humanities">Liberal Arts / Humanities</option>
                                        <option value="Undecided/Exploring">Undecided / Exploring</option>
                                    </select>
                                </div>
                            </div>
                            <div class="st-form-row">
                                <div class="st-form-group">
                                    <label class="st-label">Role / Title</label>
                                    <input type="text" id="stRole" class="st-input" placeholder="e.g. Finance Intern">
                                </div>
                                <div class="st-form-group">
                                    <label class="st-label">Company / Organization</label>
                                    <input type="text" id="stCompany" class="st-input" placeholder="e.g. Rowan University">
                                </div>
                            </div>
                            <div class="st-form-row">
                                <div class="st-form-group">
                                    <label class="st-label">Location</label>
                                    <input type="text" id="stLocation" class="st-input" placeholder="e.g. Glassboro, NJ">
                                </div>
                                <div class="st-form-group">
                                    <label class="st-label">LinkedIn URL</label>
                                    <input type="url" id="stLinkedin" class="st-input" placeholder="https://linkedin.com/in/yourname">
                                </div>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Career Goals</label>
                                <textarea id="stGoals" class="st-input" style="min-height:70px;" placeholder="Where do you want to go?"></textarea>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Interests &amp; Passions</label>
                                <div class="st-tags-wrap" id="stInterestTags" onclick="document.getElementById('stInterestInput').focus()">
                                    <input id="stInterestInput" class="st-tags-input" placeholder="Type and press Enter…" onkeydown="handleStTag(event,'stInterestTags','stInterestInput')">
                                </div>
                                <div class="st-hint">Press Enter or comma to add a tag.</div>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Hobbies</label>
                                <div class="st-tags-wrap" id="stHobbyTags" onclick="document.getElementById('stHobbyInput').focus()">
                                    <input id="stHobbyInput" class="st-tags-input" placeholder="Type and press Enter…" onkeydown="handleStTag(event,'stHobbyTags','stHobbyInput')">
                                </div>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Resume</label>
                                <button class="st-btn-upload" onclick="document.getElementById('stResumeFile').click()">📄 Upload Resume (PDF, max 10 MB)</button>
                                <input type="file" id="stResumeFile" accept=".pdf" style="display:none;" onchange="uploadStResume(this)">
                                <div class="st-hint" id="stResumeHint"></div>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-secondary" onclick="loadStProfile()">Discard</button>
                            <button class="st-btn-primary" id="stSaveCareerBtn" onclick="saveStCareer()">Save Changes</button>
                        </div>
                    </div>
                </div>

                <!-- ── ACCOUNT & SECURITY ── -->
                <div class="st-section" id="st-account">
                    <div>
                        <div class="st-eyebrow">Your credentials</div>
                        <h1 class="st-title">Account &amp; <em>Security</em></h1>
                        <p class="st-desc">Keep your account secure and up to date.</p>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Email Address</div></div>
                        <div class="st-card-body">
                            <div class="st-form-group">
                                <label class="st-label">Current Email</label>
                                <input type="email" id="stCurrentEmail" class="st-input" readonly style="opacity:.65; cursor:default;">
                                <div class="st-hint">Must be a Rowan email address.</div>
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">New Email</label>
                                <input type="email" id="stNewEmail" class="st-input" placeholder="new@rowan.edu">
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-secondary" onclick="document.getElementById('stNewEmail').value=''">Cancel</button>
                            <button class="st-btn-primary" onclick="saveStEmail()">Update Email</button>
                        </div>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Change Password</div></div>
                        <div class="st-card-body">
                            <div class="st-form-group">
                                <label class="st-label">New Password</label>
                                <input type="password" id="stNewPassword" class="st-input" placeholder="Min 8 characters">
                            </div>
                            <div class="st-form-group">
                                <label class="st-label">Confirm New Password</label>
                                <input type="password" id="stConfirmPassword" class="st-input" placeholder="Repeat new password">
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-secondary" onclick="document.getElementById('stNewPassword').value='';document.getElementById('stConfirmPassword').value=''">Cancel</button>
                            <button class="st-btn-primary" onclick="saveStPassword()">Update Password</button>
                        </div>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Security Overview</div></div>
                        <div class="st-card-body no-gap" style="padding-bottom:6px;">
                            <div class="st-sec-item">
                                <div class="st-sec-icon green">✉️</div>
                                <div class="st-sec-info">
                                    <div class="st-sec-title">Email Verified</div>
                                    <div class="st-sec-desc" id="stVerifiedEmail">—</div>
                                </div>
                                <span class="st-sec-badge ok">Verified</span>
                            </div>
                            <div class="st-sec-item">
                                <div class="st-sec-icon orange">📱</div>
                                <div class="st-sec-info">
                                    <div class="st-sec-title">Two-Factor Authentication</div>
                                    <div class="st-sec-desc">Add an extra layer of security to your account.</div>
                                </div>
                                <span class="st-sec-badge off">Coming soon</span>
                            </div>
                            <div class="st-sec-item">
                                <div class="st-sec-icon blue">🖥️</div>
                                <div class="st-sec-info">
                                    <div class="st-sec-title">Active Sessions</div>
                                    <div class="st-sec-desc">1 active session on this device.</div>
                                </div>
                                <button class="st-btn-danger" onclick="handleLogout()">Sign out</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ── NOTIFICATIONS ── -->
                <div class="st-section" id="st-notifications">
                    <div>
                        <div class="st-eyebrow">Stay in the loop</div>
                        <h1 class="st-title">Notification <em>Preferences</em></h1>
                        <p class="st-desc">Choose when and how First Sip reaches out to you.</p>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header">
                            <div>
                                <div class="st-card-title">Email Notifications</div>
                                <div class="st-card-sub">Emails sent to your Rowan address</div>
                            </div>
                        </div>
                        <div class="st-card-body no-gap" style="padding-bottom:6px;">
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">New connection requests</div><div class="st-toggle-desc">When someone sends you a connection request.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_email_connections"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Chat requests</div><div class="st-toggle-desc">When someone wants to schedule a coffee chat with you.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_email_chat_requests"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Chat reminders</div><div class="st-toggle-desc">A reminder 1 hour before your scheduled coffee chat.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_email_reminders"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">New messages</div><div class="st-toggle-desc">When you receive a direct message from a connection.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_email_messages"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Group activity</div><div class="st-toggle-desc">New posts and announcements in groups you've joined.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_email_group_activity"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Weekly digest</div><div class="st-toggle-desc">A Sunday summary of who's active and who you should meet.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_email_weekly_digest"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-primary" id="stSaveNotifBtn" onclick="saveStNotifications()">Save Preferences</button>
                        </div>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">In-App Notifications</div></div>
                        <div class="st-card-body no-gap" style="padding-bottom:6px;">
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Connection accepted</div><div class="st-toggle-desc">When someone accepts your connection request.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_app_connection_accepted"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">New match suggestions</div><div class="st-toggle-desc">When new people matching your profile join First Sip.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_app_match_suggestions"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Chat reviews received</div><div class="st-toggle-desc">When someone leaves a review after your coffee chat.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="notif_app_chat_reviews"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-primary" id="stSaveInAppBtn" onclick="saveStNotifications()">Save Preferences</button>
                        </div>
                    </div>
                </div>

                <!-- ── PRIVACY ── -->
                <div class="st-section" id="st-privacy">
                    <div>
                        <div class="st-eyebrow">Your control</div>
                        <h1 class="st-title">Privacy <em>Settings</em></h1>
                        <p class="st-desc">Control who can see your profile and how people can connect with you.</p>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Profile Visibility</div></div>
                        <div class="st-card-body no-gap" style="padding-bottom:6px;">
                            <div class="st-priv-row">
                                <div><div class="st-priv-label">Who can see your full profile</div><div class="st-priv-desc">Name, bio, interests, and career goals</div></div>
                                <select id="privacy_profile_visibility" class="st-priv-select">
                                    <option value="everyone">All Rowan members</option>
                                    <option value="connections">Connections only</option>
                                    <option value="nobody">Nobody</option>
                                </select>
                            </div>
                            <div class="st-priv-row">
                                <div><div class="st-priv-label">Who can send you connection requests</div><div class="st-priv-desc">Control who can initiate a connection</div></div>
                                <select id="privacy_who_can_connect" class="st-priv-select">
                                    <option value="everyone">Everyone</option>
                                    <option value="mutual">Mutual connections</option>
                                    <option value="nobody">Nobody</option>
                                </select>
                            </div>
                            <div class="st-priv-row">
                                <div><div class="st-priv-label">Who can request a coffee chat</div><div class="st-priv-desc">Direct chat requests without connecting first</div></div>
                                <select id="privacy_who_can_chat" class="st-priv-select">
                                    <option value="everyone">Everyone</option>
                                    <option value="connections">Connections only</option>
                                    <option value="nobody">Nobody</option>
                                </select>
                            </div>
                            <div class="st-priv-row">
                                <div><div class="st-priv-label">Show online status</div><div class="st-priv-desc">Let others see when you're active on First Sip</div></div>
                                <select id="privacy_show_online_status" class="st-priv-select">
                                    <option value="connections">Connections only</option>
                                    <option value="everyone">Everyone</option>
                                    <option value="nobody">Nobody</option>
                                </select>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-primary" id="stSavePrivVisBtn" onclick="saveStPrivacy()">Save Privacy Settings</button>
                        </div>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Discovery &amp; Matching</div></div>
                        <div class="st-card-body no-gap" style="padding-bottom:6px;">
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Appear in Discover</div><div class="st-toggle-desc">Allow other Rowan members to find you on the Discover page.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="privacy_appear_in_discover"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Show match percentage</div><div class="st-toggle-desc">Display your compatibility score on your profile card.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="privacy_show_match_percent"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Include in alumni recommendations</div><div class="st-toggle-desc">Let alumni find you when they filter by your major or career goals.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="privacy_alumni_recommendations"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-primary" id="stSavePrivDiscBtn" onclick="saveStPrivacy()">Save Settings</button>
                        </div>
                    </div>
                </div>

                <!-- ── AVAILABILITY ── -->
                <div class="st-section" id="st-availability">
                    <div>
                        <div class="st-eyebrow">Your schedule</div>
                        <h1 class="st-title">Chat <em>Availability</em></h1>
                        <p class="st-desc">Let people know when you're open for coffee chats.</p>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header">
                            <div>
                                <div class="st-card-title">Weekly Availability</div>
                                <div class="st-card-sub">Toggle days on and set your hours</div>
                            </div>
                        </div>
                        <div class="st-card-body">
                            <div class="st-avail-day-grid" id="stAvailDayGrid">
                                <!-- Rendered by loadStAvailability() -->
                                <div class="st-avail-day-row" id="avail-row-0">
                                    <span class="st-avail-day-name">Sunday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-0" onchange="toggleAvailDay(0)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-0" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-0" class="st-input" value="17:00" disabled>
                                </div>
                                <div class="st-avail-day-row" id="avail-row-1">
                                    <span class="st-avail-day-name">Monday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-1" onchange="toggleAvailDay(1)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-1" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-1" class="st-input" value="17:00" disabled>
                                </div>
                                <div class="st-avail-day-row" id="avail-row-2">
                                    <span class="st-avail-day-name">Tuesday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-2" onchange="toggleAvailDay(2)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-2" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-2" class="st-input" value="17:00" disabled>
                                </div>
                                <div class="st-avail-day-row" id="avail-row-3">
                                    <span class="st-avail-day-name">Wednesday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-3" onchange="toggleAvailDay(3)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-3" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-3" class="st-input" value="17:00" disabled>
                                </div>
                                <div class="st-avail-day-row" id="avail-row-4">
                                    <span class="st-avail-day-name">Thursday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-4" onchange="toggleAvailDay(4)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-4" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-4" class="st-input" value="17:00" disabled>
                                </div>
                                <div class="st-avail-day-row" id="avail-row-5">
                                    <span class="st-avail-day-name">Friday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-5" onchange="toggleAvailDay(5)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-5" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-5" class="st-input" value="17:00" disabled>
                                </div>
                                <div class="st-avail-day-row" id="avail-row-6">
                                    <span class="st-avail-day-name">Saturday</span>
                                    <label class="st-toggle"><input type="checkbox" id="avail-on-6" onchange="toggleAvailDay(6)"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                                    <input type="time" id="avail-start-6" class="st-input" value="09:00" disabled>
                                    <span style="color:var(--muted);font-size:12px;">to</span>
                                    <input type="time" id="avail-end-6" class="st-input" value="17:00" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-secondary" onclick="loadStAvailability()">Discard</button>
                            <button class="st-btn-primary" id="stSaveAvailBtn" onclick="saveStAvailability()">Save Availability</button>
                        </div>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header"><div class="st-card-title">Chat Preferences</div></div>
                        <div class="st-card-body no-gap" style="padding-bottom:6px;">
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Open to virtual chats</div><div class="st-toggle-desc">Video calls, Zoom, or phone.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="pref_open_virtual"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Open to in-person chats</div><div class="st-toggle-desc">Campus café or other Rowan locations.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="pref_open_inperson"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                            <div class="st-toggle-row">
                                <div><div class="st-toggle-label">Limit to 2 chats per week</div><div class="st-toggle-desc">Automatically pause new requests once you hit your weekly limit.</div></div>
                                <label class="st-toggle"><input type="checkbox" id="pref_weekly_chat_limit"><div class="st-toggle-track"><div class="st-toggle-thumb"></div></div></label>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-primary" id="stSaveChatPrefsBtn" onclick="saveStChatPrefs()">Save Preferences</button>
                        </div>
                    </div>
                </div>

                <!-- ── APPEARANCE ── -->
                <div class="st-section" id="st-appearance">
                    <div>
                        <div class="st-eyebrow">Make it yours</div>
                        <h1 class="st-title">Appearance & <em>Display</em></h1>
                        <p class="st-desc">Customize how First Sip looks and feels for you.</p>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header">
                            <div class="st-card-title">Theme</div>
                        </div>
                        <div class="st-card-body">
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                <div style="font-size:11px; font-weight:600; letter-spacing:.8px; text-transform:uppercase; color:var(--muted);">Color Mode</div>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <label style="cursor:pointer;">
                                        <input type="radio" name="st_theme" value="light" checked style="display:none;">
                                        <div class="st-theme-option active" onclick="selectThemeOption(this,'light')">
                                            <div style="font-size:22px; margin-bottom:6px;">☀️</div>
                                            <div style="font-size:13px; font-weight:600; color:var(--caramel);">Light</div>
                                            <div style="font-size:11px; color:var(--muted);">Default</div>
                                        </div>
                                    </label>
                                    <label style="cursor:pointer;">
                                        <input type="radio" name="st_theme" value="dark" style="display:none;">
                                        <div class="st-theme-option" onclick="selectThemeOption(this,'dark')">
                                            <div style="font-size:22px; margin-bottom:6px;">🌙</div>
                                            <div style="font-size:13px; font-weight:600; color:var(--muted);">Dark</div>
                                            <div style="font-size:11px; color:var(--muted);">Easy on the eyes</div>
                                        </div>
                                    </label>
                                    <label style="cursor:pointer;">
                                        <input type="radio" name="st_theme" value="system" style="display:none;">
                                        <div class="st-theme-option" onclick="selectThemeOption(this,'system')">
                                            <div style="font-size:22px; margin-bottom:6px;">💻</div>
                                            <div style="font-size:13px; font-weight:600; color:var(--muted);">System</div>
                                            <div style="font-size:11px; color:var(--muted);">Matches your OS</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="st-card">
                        <div class="st-card-header">
                            <div class="st-card-title">Language &amp; Region</div>
                        </div>
                        <div class="st-card-body">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                <div style="display:flex; flex-direction:column; gap:6px;">
                                    <label style="font-size:11px; font-weight:600; letter-spacing:.8px; text-transform:uppercase; color:var(--muted);">Language</label>
                                    <select class="st-input">
                                        <option selected>English (US)</option>
                                        <option>Español</option>
                                        <option>Português</option>
                                    </select>
                                </div>
                                <div style="display:flex; flex-direction:column; gap:6px;">
                                    <label style="font-size:11px; font-weight:600; letter-spacing:.8px; text-transform:uppercase; color:var(--muted);">Time Zone</label>
                                    <select class="st-input">
                                        <option selected>Eastern Time (ET)</option>
                                        <option>Central Time (CT)</option>
                                        <option>Pacific Time (PT)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="st-card-footer">
                            <button class="st-btn-primary" onclick="showStToast('Preferences saved')">Save</button>
                        </div>
                    </div>
                </div>

                <!-- ── DANGER ZONE ── -->
                <div class="st-section" id="st-danger">
                    <div>
                        <div class="st-eyebrow">Permanent actions</div>
                        <h1 class="st-title danger">Danger <em>Zone</em></h1>
                        <p class="st-desc">These actions are irreversible. Please read carefully before proceeding.</p>
                    </div>

                    <div class="st-danger-card">
                        <div class="st-danger-header">
                            <span style="font-size:18px;">⚠️</span>
                            <div>
                                <div class="st-danger-header-title">Account Actions</div>
                                <div class="st-danger-header-desc">Take a breath before you proceed.</div>
                            </div>
                        </div>
                        <div class="st-danger-body">
                            <div class="st-danger-item">
                                <div>
                                    <div class="st-danger-label">Export Your Data</div>
                                    <div class="st-danger-desc">Download a copy of your profile, connections, and meeting history.</div>
                                </div>
                                <button class="st-btn-secondary" onclick="exportStData()">Export Data</button>
                            </div>
                            <div class="st-danger-item">
                                <div>
                                    <div class="st-danger-label">Clear All Notifications</div>
                                    <div class="st-danger-desc">Permanently delete all your notifications from First Sip. This cannot be undone.</div>
                                </div>
                                <button class="st-btn-secondary" onclick="clearAllNotifsDanger()">Clear Notifications</button>
                            </div>
                            <div class="st-danger-item">
                                <div>
                                    <div class="st-danger-label">Pause Account</div>
                                    <div class="st-danger-desc">Hide your profile from Discover so no new chat requests come in. You can re-enable this anytime.</div>
                                </div>
                                <button class="st-btn-secondary" id="stPauseBtn" onclick="pauseStAccount()">Pause Account</button>
                            </div>
                            <div class="st-danger-item">
                                <div>
                                    <div class="st-danger-label">Sign Out Other Devices</div>
                                    <div class="st-danger-desc">End sessions on all other devices while staying signed in here.</div>
                                </div>
                                <button class="st-btn-danger" onclick="signOutOtherDevices()">Sign Out Others</button>
                            </div>
                            <div class="st-danger-item">
                                <div>
                                    <div class="st-danger-label">Sign Out of All Devices</div>
                                    <div class="st-danger-desc">End all active sessions including this one. You'll need to sign in again.</div>
                                </div>
                                <button class="st-btn-danger" onclick="signOutAllDevices()">Sign Out All</button>
                            </div>
                            <div class="st-danger-item" style="flex-direction:column;align-items:flex-start;gap:12px;">
                                <div>
                                    <div class="st-danger-label" style="color:var(--danger);">Delete Your Account</div>
                                    <div class="st-danger-desc">Permanently remove your profile, connections, and all data from First Sip. This cannot be undone.</div>
                                </div>
                                <div style="display:flex;gap:10px;align-items:center;width:100%;">
                                    <input type="text" id="stDeleteConfirmInput" class="st-input" placeholder='Type "DELETE" to confirm' oninput="checkDeleteInput()" style="max-width:240px;">
                                    <button class="st-btn-danger" id="stDeleteAccountBtn" disabled onclick="confirmDeleteAccount()" style="opacity:0.4;">Delete Account</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /st-content -->
        </div><!-- /st-layout -->

        <!-- Saved Toast -->
        <div class="st-toast" id="stToast">✓ Changes saved</div>
    </div>
    </div><!-- /main-content -->

    <!-- Schedule Chat Modal -->
    <div id="scheduleChatModal" class="modal">
        <div class="modal-content" style="max-width:560px;">
            <div class="modal-header">
                <h2 style="margin:0;">☕ Schedule a Coffee Chat</h2>
                <button class="modal-close" onclick="closeModal('scheduleChatModal')">×</button>
            </div>

            <!-- Step 1: Pick a person -->
            <div id="scheduleStep1">
                <p style="color:#888;margin-bottom:1rem;font-size:14px;">Who do you want to have a coffee chat with?</p>
                <div id="schedulePersonList" style="max-height:320px;overflow-y:auto;"></div>
            </div>

            <!-- Step 2: Pick date / time / details -->
            <div id="scheduleStep2" style="display:none;">
                <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.25rem;padding:0.875rem;background:var(--bg-light);border-radius:10px;">
                    <div class="chat-inbox-avatar" id="schedulePickedAvatar" style="font-size:16px;"></div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:14px;" id="schedulePickedName"></div>
                        <button style="background:none;border:none;color:var(--primary);font-size:12px;cursor:pointer;padding:0;margin-top:2px;" onclick="resetScheduleStep()">← Change person</button>
                    </div>
                </div>

                <!-- Availability display -->
                <div id="schedulePickedAvailability" style="margin-bottom:1.25rem;"></div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="modalScheduleDate" onchange="renderModalTimeSlots()">
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <div class="time-slots" id="modalTimeSlots"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    <div class="form-group">
                        <label>Duration</label>
                        <select id="modalScheduleDuration">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Meeting Type</label>
                        <select id="modalScheduleType">
                            <option value="video">Video Call</option>
                            <option value="zoom">Zoom</option>
                            <option value="phone">Phone Call</option>
                            <option value="coffee">In-Person ☕</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>What would you like to talk about?</label>
                    <textarea id="modalScheduleTopic" placeholder="Share a topic, ask for advice, or just say you'd love to connect!" style="min-height:80px;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="sendModalMeetingRequest()" style="width:100%;padding:13px;">Send Chat Request ☕</button>
            </div>
        </div>
    </div>

    <!-- Modals (outside main-content to avoid overflow clipping) -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Edit Profile</h2>
                <button class="modal-close" onclick="closeModal('editProfileModal')">×</button>
            </div>

            <div class="avatar-upload-preview" id="avatarPreview">
                <span id="avatarInitials"></span>
            </div>

            <div class="form-group">
                <label>Profile Picture</label>
                <div class="file-upload-area" onclick="document.getElementById('avatarInput').click()">
                    <p>Click or drag to upload profile picture</p>
                    <p style="font-size: 12px; color: #999;">JPG, PNG (Max 5MB)</p>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
            </div>

            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="editFirstName">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="editLastName">
            </div>
            <div class="form-group">
                <label>Current Status</label>
                <input type="text" id="editRole" placeholder="e.g., Junior, Senior, Recent Grad">
            </div>
            <div class="form-group">
                <label>School</label>
                <input type="text" id="editCompany" placeholder="e.g., Rowan University">
            </div>
            <div class="form-group">
                <label>Graduation Year</label>
                <input type="text" id="editLocation" placeholder="e.g., 2027">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <textarea id="editBio" placeholder="Tell others about yourself..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>What are you studying / interested in?</label>
                <select id="editIndustry">
                    <option value="Business/Finance">Business / Finance</option>
                    <option value="Computer Science/Tech">Computer Science / Tech</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Pre-Med/Healthcare">Pre-Med / Healthcare</option>
                    <option value="Liberal Arts/Humanities">Liberal Arts / Humanities</option>
                    <option value="Undecided/Exploring">Undecided / Exploring</option>
                </select>
            </div>
            <div class="form-group">
                <label>Interests & Passions (comma-separated)</label>
                <input type="text" id="editInterests" placeholder="AI, Product Management, Startups">
            </div>
            <div class="form-group">
                <label>Hobbies (comma-separated)</label>
                <input type="text" id="editHobbies" placeholder="Working out, Reading, Hiking, Photography">
            </div>
            <div class="form-group">
                <label>Career Goals</label>
                <textarea id="editGoals" placeholder="What are you looking to achieve?" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Resume</label>
                <div class="file-upload-area" onclick="document.getElementById('resumeInput').click()">
                    <p>Click or drag to upload resume</p>
                    <p style="font-size: 12px; color: #999;">PDF (Max 10MB)</p>
                </div>
                <input type="file" id="resumeInput" accept=".pdf" style="display: none;" onchange="handleResumeUpload(event)">
                <div id="resumePreview"></div>
            </div>

            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('editProfileModal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()" style="flex: 1;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Create Post</h2>
                <button class="modal-close" onclick="closeModal('createPostModal')">×</button>
            </div>
            <div class="form-group">
                <label>What's on your mind?</label>
                <textarea id="postContent" placeholder="Share your thoughts, insights, or experiences..." rows="6"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('createPostModal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="publishPost()" style="flex: 1;">Publish</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Create a Group</h2>
                <button class="modal-close" onclick="closeModal('createGroupModal')">×</button>
            </div>
            <div class="form-group">
                <label>Group Name <span style="color: var(--accent);">*</span></label>
                <input type="text" id="newGroupName" placeholder="e.g. Product Managers at Big Tech" maxlength="80">
            </div>
            <div class="form-group">
                <label>Industry / Focus Area <span style="color: var(--accent);">*</span></label>
                <select id="newGroupIndustry">
                    <option value="" disabled selected>Select a category…</option>
                    <option>Technology</option>
                    <option>Business/Finance</option>
                    <option>Engineering</option>
                    <option>Product Management</option>
                    <option>Design/Creative</option>
                    <option>Marketing</option>
                    <option>Healthcare</option>
                    <option>Law/Legal</option>
                    <option>Education</option>
                    <option>Research/Academia</option>
                    <option>Entrepreneurship/Startups</option>
                    <option>Data Science/AI</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description <span style="color: var(--accent);">*</span></label>
                <textarea id="newGroupDescription" placeholder="What is this group about? Who should join?" rows="4" maxlength="300" oninput="document.getElementById('newGroupDescCount').textContent = this.value.length + ' / 300'"></textarea>
                <div id="newGroupDescCount" style="font-size: 11px; color: #aaa; text-align: right; margin-top: 4px;">0 / 300</div>
            </div>
            <div id="createGroupError" style="display: none; color: #e53935; font-size: 13px; margin-bottom: 0.75rem;"></div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('createGroupModal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="createGroup()" style="flex: 1;" id="createGroupBtn">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Profile Preview Modal -->
    <div id="profilePreviewModal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:700px;width:92%;background:var(--warm-white);border-radius:18px;padding:0;overflow:hidden;">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid var(--latte);background:var(--card);">
                <div style="font-family:'Playfair Display',serif;font-size:18px;color:var(--espresso);">👁 Profile Preview</div>
                <button onclick="document.getElementById('profilePreviewModal').classList.remove('active')" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);line-height:1;padding:0 4px;">&times;</button>
            </div>
            <div id="profilePreviewBody" style="padding:20px 24px;max-height:80vh;overflow-y:auto;"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vmrmkkngjlicuvrpejxx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_UZ6aNCU1qZ5TfGCHXdPz4w_ferczbVL';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentUser = null;
        let _myProfilePreviewData = null;
        let users = [];
        let groups = [];
        let myGroupIds = new Set();
        let sentMessageCount = 0;
        let messages = [];
        let meetings = [];
        let connections = [];
        let pendingRequests = []; // incoming connection requests (from pending_requests view)
        let sentRequests = [];    // outgoing: user_id === currentUser.id, status === 'pending'
        let chatInvites = [];     // incoming coffee chat invites (from pending_requests view, type === 'chat_invite')
        let realtimeChannels = [];
        let pollingTimer = null;
        let posts = [];
        let selectedConversation = null;
        let selectedConversationId = null; // conversation_id from conversations table
        let selectedPerson = null;
        let previousView = 'dashboardView';
        let callDuration = 0;
        let callInterval = null;
        let currentMonth = new Date();
        let selectedTime = null;

        const mockUsers = [
            {
                id: '00000000-0000-0000-0000-000000000002',
                firstName: 'Jordan',
                lastName: 'Torres',
                industry: 'Business/Finance',
                interests: ['Fintech', 'Investing', 'Entrepreneurship'],
                hobbies: ['Working out', 'Basketball', 'Traveling'],
                goals: 'Land an investment banking internship and eventually start a fintech company',
                email: 'torresj@rowan.edu',
                bio: 'Finance major in the Rohrer College of Business and president of the Investing Club. Interned at a boutique advisory firm last summer. Always down to talk markets over coffee.',
                role: 'Junior',
                company: 'Rowan University',
                location: '2027',
                profilePicture: null,
                resume: null,
                posts: [
                    { id: 'mock-post-001', content: 'Just got my summer internship offer! Happy to share tips on the recruiting process with anyone at Rowan who\'s going through it.', date: '2 days ago', likes_count: 24 }
                ]
            },
            {
                id: '00000000-0000-0000-0000-000000000003',
                firstName: 'Anika',
                lastName: 'Patel',
                industry: 'Computer Science/Tech',
                interests: ['AI', 'Product Management', 'Startups'],
                hobbies: ['Reading', 'Hiking', 'Photography'],
                goals: 'Break into product management at a top tech company',
                email: 'patela@rowan.edu',
                bio: 'CS major with a passion for AI and product design. Working on a campus app for Rowan students to find study groups. Looking for mentors in PM and anyone building cool side projects.',
                role: 'Senior',
                company: 'Rowan University',
                location: '2026',
                profilePicture: null,
                resume: null,
                posts: [
                    { id: 'mock-post-002', content: 'Just finished my first ML project for class and it actually works! Anyone else at Rowan diving into AI this semester?', date: '1 week ago', likes_count: 42 }
                ]
            },
            {
                id: '00000000-0000-0000-0000-000000000004',
                firstName: 'Mike',
                lastName: 'Reyes',
                industry: 'Engineering',
                interests: ['Mechanical Engineering', 'Research', 'Robotics'],
                goals: 'Get into a top engineering grad program or land a role at a defense contractor',
                email: 'reyesm@rowan.edu',
                bio: 'Mechanical Engineering sophomore in the Henry M. Rowan College of Engineering. Doing research in the robotics lab and looking for other engineering students to connect with.',
                role: 'Sophomore',
                company: 'Rowan University',
                location: '2028',
                profilePicture: null,
                resume: null,
                posts: []
            },
            {
                id: '00000000-0000-0000-0000-000000000005',
                firstName: 'Taylor',
                lastName: 'Brooks',
                industry: 'Computer Science/Tech',
                interests: ['Backend Engineering', 'Open Source', 'Web Dev'],
                goals: 'Land a software engineering role at a startup or big tech',
                email: 'brookst@rowan.edu',
                bio: 'CS sophomore who loves building things. Contributing to open source projects and working on a campus events app. Looking for hackathon teammates and study buddies at Rowan.',
                role: 'Sophomore',
                company: 'Rowan University',
                location: '2028',
                profilePicture: null,
                resume: null,
                posts: [
                    { id: 'mock-post-003', content: 'Our ProfHacks team just won first place! Here\'s what we built in 36 hours and what I learned about working under pressure.', date: '3 days ago', likes_count: 67 }
                ]
            },
            {
                id: '00000000-0000-0000-0000-000000000006',
                firstName: 'Brianna',
                lastName: 'Mitchell',
                industry: 'Business/Finance',
                interests: ['Marketing', 'Content Creation', 'Brand Strategy'],
                goals: 'Break into marketing at a tech startup after graduation',
                email: 'mitchellb@rowan.edu',
                bio: 'Marketing major in Rohrer College of Business and social media manager for three campus orgs. Ran a freelance content business since freshman year. Always excited to talk branding and side hustles.',
                role: 'Recent Grad',
                company: 'Rowan University',
                location: '2025',
                profilePicture: null,
                resume: null,
                posts: []
            }
        ];

        const mockGroups = [
            {
                id: 1,
                name: 'Rowan University CS & Tech',
                industry: 'Computer Science/Tech',
                description: 'For Rowan University CS students, aspiring engineers, and anyone building cool stuff',
                members: 87,
                lastActivity: new Date(Date.now() - 2 * 60 * 60 * 1000),
                memberList: ['AP', 'TB', 'JT', 'MR', 'BM'],
                posts: [
                    { author: 'Anika Patel', content: 'Anyone working on AI projects this semester? Would love to connect and share notes!', time: new Date(Date.now() - 2 * 60 * 60 * 1000) },
                    { author: 'Taylor Brooks', content: 'Just won ProfHacks! Here are the resources that helped us build in 36 hours.', time: new Date(Date.now() - 8 * 60 * 60 * 1000) }
                ]
            },
            {
                id: 2,
                name: 'Rohrer Business & Finance',
                industry: 'Business/Finance',
                description: 'Rohrer College of Business students — recruiting tips, prep, and support',
                members: 64,
                lastActivity: new Date(Date.now() - 18 * 60 * 60 * 1000),
                memberList: ['JT', 'AP', 'BM'],
                posts: [
                    { author: 'Jordan Torres', content: 'Just finished recruiting season \u2014 happy to share what worked for me and what I\'d do differently!', time: new Date(Date.now() - 18 * 60 * 60 * 1000) }
                ]
            },
            {
                id: 3,
                name: 'Rowan University Engineering',
                industry: 'Engineering',
                description: 'Henry M. Rowan College of Engineering students and alumni',
                members: 72,
                lastActivity: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                memberList: ['MR', 'TB'],
                posts: [
                    { author: 'Mike Reyes', content: 'Anyone else doing undergrad research in the robotics lab? Looking for partners for the spring showcase.', time: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000) }
                ]
            },
            {
                id: 4,
                name: 'Rowan University Side Hustles & Startups',
                industry: 'Business/Finance',
                description: 'Rowan University student entrepreneurs, freelancers, and side project builders',
                members: 53,
                lastActivity: new Date(Date.now() - 6 * 60 * 60 * 1000),
                memberList: ['BM', 'JT', 'AP', 'TB'],
                posts: [
                    { author: 'Brianna Mitchell', content: 'Started freelancing as a content creator freshman year \u2014 here\'s how I landed my first 5 clients on campus.', time: new Date(Date.now() - 6 * 60 * 60 * 1000) }
                ]
            }
        ];

        // Map initials to mock user IDs for group member display
        const initialsToUserId = {
            'JT': '00000000-0000-0000-0000-000000000002',
            'AP': '00000000-0000-0000-0000-000000000003',
            'MR': '00000000-0000-0000-0000-000000000004',
            'TB': '00000000-0000-0000-0000-000000000005',
            'BM': '00000000-0000-0000-0000-000000000006'
        };

        // Group post interactions (local storage)
        const groupPostLikes = {};
        const groupPostComments = {};

        // Initialize
        async function init() {

            // Check for existing Supabase session
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                // User is logged in, load their profile
                await loadUserProfile(session.user.id);
                recordLogin();
                renderNav();
                switchView('dashboardView');
                await updateDashboard();
                checkBadgesWithCelebration();
            } else {
                // No session, show landing page
                document.querySelector('.app-container').classList.add('sidebar-hidden');
                switchView('landingView');
            }

            renderCalendar();

            // Re-apply theme when OS dark/light preference changes (for 'system' mode)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const saved = localStorage.getItem('app_theme') || 'light';
                if (saved === 'system') applyTheme('system');
            });

            // Detect auth changes from other tabs (e.g. a different user logs in,
            // replacing the localStorage token — which would cause sender_id ≠ auth.uid() on writes)
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT' && currentUser) {
                    // Another tab signed out — sync this tab
                    currentUser = null;
                    connections = []; meetings = []; posts = []; notifications = [];
                    realtimeChannels.forEach(ch => { try { supabaseClient.removeChannel(ch); } catch(e){} });
                    realtimeChannels = [];
                    if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
                    document.querySelector('.app-container').classList.add('sidebar-hidden');
                    switchView('loginView');
                    showToast('You have been signed out.', 'info');
                } else if (event === 'SIGNED_IN' && session && currentUser && session.user.id !== currentUser.id) {
                    // A different user signed in (another tab replaced the auth token)
                    currentUser = null;
                    connections = []; meetings = []; posts = []; notifications = [];
                    realtimeChannels.forEach(ch => { try { supabaseClient.removeChannel(ch); } catch(e){} });
                    realtimeChannels = [];
                    if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
                    document.querySelector('.app-container').classList.add('sidebar-hidden');
                    switchView('loginView');
                    showToast('Another account signed in. Please log in again.', 'info');
                }
            });
        }

        function suSelectChip(el, value) {
            // Single-select: deselect all chips, then select clicked one
            el.closest('.su-chips').querySelectorAll('.su-chip').forEach(c => c.classList.remove('su-chip-sel'));
            el.classList.add('su-chip-sel');
            document.getElementById('signupIndustry').value = value;
        }

        function suUpdateStrength(val) {
            const bars = [1, 2, 3, 4].map(i => document.getElementById('suBar' + i));
            bars.forEach(b => { b.className = 'su-bar'; });
            let score = 0;
            if (val.length >= 8) score++;
            if (/[A-Z]/.test(val)) score++;
            if (/[0-9]/.test(val)) score++;
            if (/[^A-Za-z0-9]/.test(val)) score++;
            const cls = ['su-s1', 'su-s2', 'su-s3', 'su-s4'];
            for (let i = 0; i < score; i++) bars[i].classList.add(cls[score - 1]);
        }

        function showLandingSignup() {
            switchView('signupView');
        }

        function showLandingLogin() {
            switchView('loginView');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            if (menu) { menu.classList.toggle('active'); hamburger && hamburger.classList.toggle('active'); document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : ''; }
        }
        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            if (menu) { menu.classList.remove('active'); hamburger && hamburger.classList.remove('active'); document.body.style.overflow = ''; }
        }

        // New landing page mobile menu
        function toggleLpMenu() {
            const menu = document.getElementById('lpMobileMenu');
            const btn = document.getElementById('lpHamburger');
            if (!menu) return;
            menu.classList.toggle('active');
            btn && btn.classList.toggle('active');
            document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : '';
        }
        function closeLpMenu() {
            const menu = document.getElementById('lpMobileMenu');
            const btn = document.getElementById('lpHamburger');
            if (!menu) return;
            menu.classList.remove('active');
            btn && btn.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Scroll reveal for landing page
        function initLandingReveal() {
            const reveals = document.querySelectorAll('#landingView .reveal');
            if (!reveals.length) return;
            const obs = new IntersectionObserver((entries) => {
                entries.forEach((entry, i) => {
                    if (entry.isIntersecting) {
                        setTimeout(() => entry.target.classList.add('visible'), i * 80);
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            reveals.forEach(el => { el.classList.remove('visible'); obs.observe(el); });

            // Feature item toggle + panel swap
            document.querySelectorAll('#landingView .lp-feature-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('#landingView .lp-feature-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const feature = item.dataset.feature;
                    document.querySelectorAll('#landingView .lp-mockup-panel').forEach(p => p.classList.remove('active'));
                    const panel = document.getElementById('lp-panel-' + feature);
                    if (panel) panel.classList.add('active');
                });
            });
        }

        async function loadUserProfile(userId) {
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                currentUser = {
                    id: profile.id,
                    firstName: profile.first_name,
                    lastName: profile.last_name,
                    email: profile.email,
                    industry: profile.industry,
                    interests: profile.interests || [],
                    hobbies: profile.hobbies || [],
                    goals: profile.goals,
                    bio: profile.bio,
                    role: profile.role,
                    company: profile.company,
                    location: profile.location,
                    profilePicture: profile.profile_picture || null,
                    resume: profile.resume_url || null,
                    status: profile.status || '',
                    gradYear: profile.grad_year || ''
                };

                // Load user's data
                await loadUserData();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadUserData() {
            if (!currentUser) return;

            // Each section is independent — a failure in one never blocks the others

            // Load accepted connections and sent requests
            try {
                const { data: connectionsData } = await supabaseClient
                    .from('connections')
                    .select('*')
                    .or(`user_id.eq.${currentUser.id},connected_user_id.eq.${currentUser.id}`);
                const allConns = connectionsData || [];
                connections = allConns.filter(c => c.status === 'accepted');
                sentRequests = allConns.filter(c => c.status === 'pending' && c.user_id === currentUser.id);
            } catch (e) { console.error('loadUserData connections:', e); }

            // Load incoming pending requests (connections + chat invites) via the pending_requests view
            try {
                const { data: pendingData } = await supabaseClient
                    .from('pending_requests')
                    .select('*');
                const allPending = pendingData || [];
                pendingRequests = allPending.filter(p => p.type === 'connection');
                chatInvites = allPending.filter(p => p.type === 'chat_invite');
            } catch (e) { console.error('loadUserData pending_requests:', e); }

            // Load posts for feed
            try {
                const { data: postsData } = await supabaseClient
                    .from('posts')
                    .select('*')
                    .is('group_id', null)
                    .order('created_at', { ascending: false });
                posts = postsData || [];
            } catch (e) { console.error('loadUserData posts:', e); }

            // Load meetings
            try {
                const { data: meetingsData } = await supabaseClient
                    .from('meetings')
                    .select('*')
                    .or(`organizer_id.eq.${currentUser.id},participant_id.eq.${currentUser.id}`)
                    .order('start_time', { ascending: true });
                meetings = meetingsData || [];
            } catch (e) { console.error('loadUserData meetings:', e); }

            // Load persisted notifications from DB
            try {
                const { data: notifsData } = await supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(30);
                if (notifsData && notifsData.length > 0) {
                    const typeIcon = { connection_request: '🤝', connection_accepted: '🎉', meeting_request: '📅', meeting_response: '☕' };
                    notifsData.forEach(n => {
                        const mapped = {
                            id: 'db-' + n.id,
                            dbId: n.id,
                            type: n.type || 'info',
                            icon: typeIcon[n.type] || '🔔',
                            text: n.title || '',
                            time: new Date(n.created_at),
                            unread: !n.read
                        };
                        if (!notifications.find(existing => existing.id === mapped.id)) {
                            notifications.push(mapped);
                        }
                    });
                    notifications.sort((a, b) => new Date(b.time) - new Date(a.time));
                }
                refreshBellBadge();
            } catch (e) { console.error('loadUserData notifications:', e); }

            // Load all other profiles for discovery — most critical
            try {
                const { data: profilesData, error: profilesError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .neq('id', currentUser.id);
                if (profilesError) console.error('Profiles query error:', profilesError);
                users = (profilesData || []).map(p => ({
                    id: p.id,
                    firstName: p.first_name || '',
                    lastName: p.last_name || '',
                    email: p.email || '',
                    industry: p.industry || '',
                    interests: Array.isArray(p.interests) ? p.interests : [],
                    hobbies: Array.isArray(p.hobbies) ? p.hobbies : [],
                    goals: p.goals || '',
                    bio: p.bio || '',
                    role: p.role || '',
                    company: p.company || '',
                    location: p.location || '',
                    profilePicture: p.profile_picture || null,
                    resume: p.resume_url || null,
                    posts: []
                }));
                console.log(`Loaded ${users.length} profiles for discovery`);
            } catch (e) { console.error('loadUserData profiles:', e); }

            // Load groups
            try {
                const { data: groupsData } = await supabaseClient
                    .from('groups')
                    .select('*')
                    .order('member_count', { ascending: false });
                groups = groupsData || [];
            } catch (e) { console.error('loadUserData groups:', e); }

            // Load user's group memberships
            try {
                const { data: membershipsData } = await supabaseClient
                    .from('group_members')
                    .select('group_id')
                    .eq('user_id', currentUser.id);
                myGroupIds = new Set((membershipsData || []).map(m => m.group_id));
            } catch (e) { console.error('loadUserData memberships:', e); }

            // Count sent messages for checklist / badges
            try {
                const { count } = await supabaseClient
                    .from('messages')
                    .select('id', { count: 'exact', head: true })
                    .eq('sender_id', currentUser.id);
                sentMessageCount = count || 0;
            } catch (e) { console.error('loadUserData messages:', e); }

            // Start real-time subscriptions and polling after all data is loaded
            setupRealtime();
            startPolling();
        }

        function saveToStorage() {
            // Deprecated - keeping for backwards compatibility
            // Data is now saved directly to Supabase
        }

        // Auth
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                // Sign in with Supabase
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                // Fetch user profile from database
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .maybeSingle();

                if (profileError) throw profileError;

                if (!profile) {
                    alert('No profile found for this account. Please sign up first.');
                    await supabaseClient.auth.signOut();
                    return;
                }

                currentUser = {
                    id: profile.id,
                    firstName: profile.first_name,
                    lastName: profile.last_name,
                    email: profile.email,
                    industry: profile.industry,
                    interests: profile.interests || [],
                    hobbies: profile.hobbies || [],
                    goals: profile.goals,
                    bio: profile.bio,
                    role: profile.role,
                    company: profile.company,
                    location: profile.location,
                    profilePicture: profile.profile_picture || null,
                    resume: profile.resume_url || null,
                    status: profile.status || '',
                    gradYear: profile.grad_year || ''
                };

                // Load all user data and wire up real-time subscriptions
                await loadUserData();
                setupRealtime();
                startPolling();

                document.querySelector('.app-container').classList.remove('sidebar-hidden');
                recordLogin();
                renderNav();
                switchView('dashboardView');
                await updateDashboard();
                checkBadgesWithCelebration();
                showToast('Welcome back!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        async function handleSignup() {
            const firstName = document.getElementById('signupFirstName').value;
            const lastName = document.getElementById('signupLastName').value;
            const school = 'Rowan University';
            const industry = document.getElementById('signupIndustry').value;
            const status = document.getElementById('signupStatus').value;
            const gradYear = document.getElementById('signupGradYear').value;
            const interests = document.getElementById('signupInterests').value.split(',').map(i => i.trim()).filter(Boolean);
            const goals = document.getElementById('signupGoals').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!firstName || !lastName || !industry || !email || !password || !goals) {
                alert('Please fill in all required fields');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            try {
                // Sign up with Supabase (profile is auto-created by database trigger)
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            industry: industry,
                            interests: interests,
                            hobbies: [],
                            goals: goals,
                            company: school,
                            role: status,
                            location: gradYear
                        }
                    }
                });

                if (error) throw error;

                currentUser = {
                    id: data.user.id,
                    firstName,
                    lastName,
                    email,
                    industry,
                    interests,
                    hobbies: [],
                    goals,
                    bio: '',
                    role: status,
                    company: school,
                    location: gradYear,
                    profilePicture: null,
                    resume: null,
                    status: status,
                    gradYear: gradYear
                };

                // Write status and grad_year to dedicated columns (trigger only sets role/location)
                try {
                    await supabaseClient.from('profiles')
                        .update({ status, grad_year: gradYear })
                        .eq('id', data.user.id);
                } catch(e) { console.warn('Could not set status/grad_year on signup:', e); }

                document.querySelector('.app-container').classList.remove('sidebar-hidden');
                recordLogin();
                renderNav();
                switchView('dashboardView');
                await updateDashboard();
                showToast('Account created! Check your email to verify.', 'success');
            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed: ' + error.message);
            }
        }

        // ===== REAL-TIME & POLLING =====

        function pushLiveNotification(notif) {
            if (notifications.find(n => n.id === notif.id)) return; // dedupe
            notifications.unshift(notif);
            renderNotifications();
        }

        function setupRealtime() {
            if (!currentUser) return;
            // Remove any existing channels first
            realtimeChannels.forEach(ch => { try { supabaseClient.removeChannel(ch); } catch(e){} });
            realtimeChannels = [];

            // 1. Incoming connection requests
            const chConnIn = supabaseClient
                .channel('conn-in-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'connections',
                    filter: `connected_user_id=eq.${currentUser.id}`
                }, async (payload) => {
                    const req = payload.new;
                    if (req.status !== 'pending' || pendingRequests.find(r => r.id === req.id)) return;
                    pendingRequests.push(req);
                    let name = 'Someone';
                    const cached = users.find(u => u.id === req.user_id);
                    if (cached) { name = `${cached.firstName} ${cached.lastName}`; }
                    else {
                        try {
                            const { data: p } = await supabaseClient.from('profiles').select('first_name,last_name').eq('id', req.user_id).single();
                            if (p) name = `${p.first_name} ${p.last_name}`;
                        } catch(e) {}
                    }
                    pushLiveNotification({ id: 'pending-' + req.id, type: 'connection', icon: '🤝',
                        text: `${name} wants to connect with you`, time: new Date(), unread: true,
                        action: () => switchView('dashboardView') });
                    showToast(`${name} sent you a connection request!`, 'info');
                    if (document.getElementById('dashboardView').classList.contains('active')) updateDashboard();
                })
                .subscribe();
            realtimeChannels.push(chConnIn);

            // 2. My outgoing request accepted
            const chConnAccepted = supabaseClient
                .channel('conn-accepted-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'UPDATE', schema: 'public', table: 'connections',
                    filter: `user_id=eq.${currentUser.id}`
                }, (payload) => {
                    const updated = payload.new;
                    if (updated.status !== 'accepted') return;
                    sentRequests = sentRequests.filter(r => r.id !== updated.id);
                    if (!connections.find(c => c.id === updated.id)) connections.push(updated);
                    const partner = users.find(u => u.id === updated.connected_user_id);
                    const name = partner ? `${partner.firstName} ${partner.lastName}` : 'Someone';
                    pushLiveNotification({ id: 'accepted-' + updated.id, type: 'connection', icon: '🎉',
                        text: `${name} accepted your connection request!`, time: new Date(), unread: true });
                    showToast(`${name} accepted your connection request! 🎉`, 'success');
                    if (document.getElementById('dashboardView').classList.contains('active')) updateDashboard();
                    renderDiscovery();
                })
                .subscribe();
            realtimeChannels.push(chConnAccepted);

            // 3. Incoming meeting invites
            const chMeetingIn = supabaseClient
                .channel('meeting-in-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'meetings',
                    filter: `participant_id=eq.${currentUser.id}`
                }, async (payload) => {
                    const meeting = payload.new;
                    if (meetings.find(m => m.id === meeting.id)) return;
                    meetings.push(meeting);
                    let name = 'Someone';
                    const organizer = users.find(u => u.id === meeting.organizer_id);
                    if (organizer) { name = `${organizer.firstName} ${organizer.lastName}`; }
                    else {
                        try {
                            const { data: p } = await supabaseClient.from('profiles').select('first_name,last_name').eq('id', meeting.organizer_id).single();
                            if (p) name = `${p.first_name} ${p.last_name}`;
                        } catch(e) {}
                    }
                    pushLiveNotification({ id: 'meeting-invite-' + meeting.id, type: 'meeting', icon: '📅',
                        text: `${name} invited you to a coffee chat!`, time: new Date(), unread: true,
                        action: () => switchView('dashboardView') });
                    showToast(`${name} invited you to a coffee chat! ☕`, 'info');
                    if (document.getElementById('dashboardView').classList.contains('active')) updateDashboard();
                })
                .subscribe();
            realtimeChannels.push(chMeetingIn);

            // 4. Notifications table — persist and show DB-generated notifications
            const chNotifs = supabaseClient
                .channel('notifs-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'notifications',
                    filter: `user_id=eq.${currentUser.id}`
                }, (payload) => {
                    const n = payload.new;
                    const typeIcon = { connection_request: '🤝', connection_accepted: '🎉', meeting_request: '📅', meeting_response: '☕' };
                    pushLiveNotification({
                        id: 'db-' + n.id,
                        dbId: n.id,
                        type: n.type || 'info',
                        icon: typeIcon[n.type] || '🔔',
                        text: n.title || '',
                        time: new Date(n.created_at),
                        unread: true
                    });
                })
                .subscribe();
            realtimeChannels.push(chNotifs);

            // 5. Meeting updates — organizer learns when their invite is accepted/declined
            const chMeetingUpdate = supabaseClient
                .channel('meeting-update-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'UPDATE', schema: 'public', table: 'meetings',
                    filter: `organizer_id=eq.${currentUser.id}`
                }, (payload) => {
                    const updated = payload.new;
                    const idx = meetings.findIndex(m => m.id === updated.id);
                    if (idx >= 0) meetings[idx] = updated; else meetings.push(updated);
                    const partner = users.find(u => u.id === updated.participant_id);
                    const name = partner ? `${partner.firstName} ${partner.lastName}` : 'Someone';
                    if (updated.status === 'accepted') {
                        pushLiveNotification({ id: 'mtg-acc-' + updated.id, type: 'meeting', icon: '🎉',
                            text: `${name} accepted your coffee chat invite!`, time: new Date(), unread: true });
                        showToast(`${name} accepted your chat invite! ☕🎉`, 'success');
                    } else if (updated.status === 'declined') {
                        pushLiveNotification({ id: 'mtg-dec-' + updated.id, type: 'meeting', icon: '😔',
                            text: `${name} declined your coffee chat invite.`, time: new Date(), unread: true });
                        showToast(`${name} declined your chat invite.`, 'info');
                    }
                    if (document.getElementById('dashboardView')?.classList.contains('active')) updateDashboard();
                    renderMeetingCards();
                })
                .subscribe();
            realtimeChannels.push(chMeetingUpdate);

            // 6. Incoming chat invites
            const chChatInvite = supabaseClient
                .channel('chat-invite-in-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'chat_invites',
                    filter: `receiver_id=eq.${currentUser.id}`
                }, async (payload) => {
                    const invite = payload.new;
                    if (invite.status !== 'pending' || chatInvites.find(i => i.id === invite.id)) return;
                    chatInvites.push(invite);
                    let name = 'Someone';
                    const cached = users.find(u => u.id === invite.sender_id);
                    if (cached) { name = `${cached.firstName} ${cached.lastName}`; }
                    else {
                        try {
                            const { data: p } = await supabaseClient.from('profiles').select('first_name,last_name').eq('id', invite.sender_id).single();
                            if (p) name = `${p.first_name} ${p.last_name}`;
                        } catch(e) {}
                    }
                    pushLiveNotification({ id: 'cinvite-' + invite.id, type: 'chat_invite', icon: '☕',
                        text: `${name} wants to have a coffee chat!`, time: new Date(), unread: true,
                        action: () => switchView('dashboardView') });
                    showToast(`${name} sent you a coffee chat request! ☕`, 'info');
                    renderHubNetworkFeed();
                    generateNotifications();
                })
                .subscribe();
            realtimeChannels.push(chChatInvite);

            // 7. Incoming messages — live delivery when receiver
            const chMsgsIn = supabaseClient
                .channel('msgs-in-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'messages',
                    filter: `receiver_id=eq.${currentUser.id}`
                }, async (payload) => {
                    const msg = payload.new;
                    // If the chat window for this sender is open, refresh the conversation
                    if (selectedConversation === msg.sender_id) {
                        await selectConversation(msg.sender_id, msg.conversation_id);
                    } else {
                        let name = 'Someone';
                        const cached = users.find(u => u.id === msg.sender_id);
                        if (cached) name = `${cached.firstName} ${cached.lastName}`;
                        showToast(`New message from ${name}`, 'info');
                    }
                    // Refresh the inbox list to update unread counts
                    if (document.getElementById('messagesView')?.classList.contains('active')) {
                        renderMessages();
                    }
                })
                .subscribe();
            realtimeChannels.push(chMsgsIn);

            // 8. Conversation updates — when participant_b receives a new thread
            const chConvA = supabaseClient
                .channel('conv-as-a-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'conversations',
                    filter: `participant_a=eq.${currentUser.id}`
                }, () => {
                    if (document.getElementById('messagesView')?.classList.contains('active')) renderMessages();
                })
                .subscribe();
            realtimeChannels.push(chConvA);

            const chConvB = supabaseClient
                .channel('conv-as-b-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'conversations',
                    filter: `participant_b=eq.${currentUser.id}`
                }, () => {
                    if (document.getElementById('messagesView')?.classList.contains('active')) renderMessages();
                })
                .subscribe();
            realtimeChannels.push(chConvB);
        }

        function startPolling() {
            if (pollingTimer) clearInterval(pollingTimer);
            pollingTimer = setInterval(async () => {
                if (!currentUser) return;

                try {
                    const { data: connsData } = await supabaseClient
                        .from('connections').select('*')
                        .or(`user_id.eq.${currentUser.id},connected_user_id.eq.${currentUser.id}`);
                    if (connsData) {
                        const newAccepted = connsData.filter(c => c.status === 'accepted');

                        // Surface newly accepted connections
                        newAccepted.forEach(conn => {
                            if (conn.user_id === currentUser.id && !connections.find(c => c.id === conn.id)) {
                                const partner = users.find(u => u.id === conn.connected_user_id);
                                const name = partner ? `${partner.firstName} ${partner.lastName}` : 'Someone';
                                pushLiveNotification({ id: 'accepted-' + conn.id, type: 'connection', icon: '🎉',
                                    text: `${name} accepted your connection request!`, time: new Date(conn.updated_at || conn.created_at), unread: true });
                            }
                        });

                        connections = newAccepted;
                        sentRequests = connsData.filter(c => c.status === 'pending' && c.user_id === currentUser.id);
                    }
                } catch(e) {}

                // Refresh incoming pending requests (connections + chat invites) via view
                try {
                    const { data: pendingData } = await supabaseClient
                        .from('pending_requests').select('*');
                    if (pendingData) {
                        const newConnReqs = pendingData.filter(p => p.type === 'connection');
                        const newChatInvites = pendingData.filter(p => p.type === 'chat_invite');

                        // Surface newly arrived connection requests
                        newConnReqs.forEach(req => {
                            if (!pendingRequests.find(r => r.id === req.id)) {
                                const senderId = req.sender_id || req.user_id;
                                const cached = users.find(u => u.id === senderId);
                                const name = cached ? `${cached.firstName} ${cached.lastName}` : 'Someone';
                                pushLiveNotification({ id: 'pending-' + req.id, type: 'connection', icon: '🤝',
                                    text: `${name} wants to connect with you`, time: new Date(req.created_at), unread: true,
                                    action: () => switchView('dashboardView') });
                            }
                        });

                        // Surface newly arrived chat invites
                        newChatInvites.forEach(invite => {
                            if (!chatInvites.find(i => i.id === invite.id)) {
                                const cached = users.find(u => u.id === invite.sender_id);
                                const name = cached ? `${cached.firstName} ${cached.lastName}` : 'Someone';
                                pushLiveNotification({ id: 'cinvite-' + invite.id, type: 'chat_invite', icon: '☕',
                                    text: `${name} wants to have a coffee chat!`, time: new Date(invite.created_at), unread: true,
                                    action: () => switchView('dashboardView') });
                            }
                        });

                        pendingRequests = newConnReqs;
                        chatInvites = newChatInvites;
                    }
                } catch(e) {}

                try {
                    const { data: meetingsData } = await supabaseClient
                        .from('meetings').select('*')
                        .or(`organizer_id.eq.${currentUser.id},participant_id.eq.${currentUser.id}`)
                        .order('start_time', { ascending: true });
                    if (meetingsData) {
                        meetingsData.forEach(m => {
                            if (m.participant_id === currentUser.id && !meetings.find(ex => ex.id === m.id)) {
                                const organizer = users.find(u => u.id === m.organizer_id);
                                const name = organizer ? `${organizer.firstName} ${organizer.lastName}` : 'Someone';
                                pushLiveNotification({ id: 'meeting-invite-' + m.id, type: 'meeting', icon: '📅',
                                    text: `${name} invited you to a coffee chat!`, time: new Date(m.created_at), unread: true,
                                    action: () => switchView('dashboardView') });
                            }
                        });
                        meetings = meetingsData;
                    }
                } catch(e) {}

                if (document.getElementById('dashboardView').classList.contains('active')) updateDashboard();
            }, 30000);
        }

        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;

                // Tear down real-time channels and polling
                realtimeChannels.forEach(ch => { try { supabaseClient.removeChannel(ch); } catch(e){} });
                realtimeChannels = [];
                if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }

                currentUser = null;
                connections = [];
                messages = [];
                meetings = [];
                posts = [];
                pendingRequests = [];
                sentRequests = [];
                chatInvites = [];
                selectedConversation = null;
                selectedConversationId = null;
                document.querySelector('.app-container').classList.add('sidebar-hidden');
                switchView('landingView');
                renderNav();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }

        // Navigation
        function renderNav() {
            const navMenu = document.getElementById('navMenu');
            navMenu.innerHTML = '';

            // Topbar + sidebar visibility
            const topbar = document.getElementById('appTopbar');
            const bellContainer = document.getElementById('notifBellContainer');
            const userChip = document.getElementById('topbarUserChip');

            if (currentUser) {
                // Show topbar, sidebar, bell, user chip
                document.body.classList.add('app-mode');
                if (topbar) topbar.classList.add('visible');
                if (bellContainer) bellContainer.style.display = 'flex';
                if (userChip) {
                    userChip.style.display = 'flex';
                    const initials = (currentUser.firstName[0] || '') + (currentUser.lastName ? currentUser.lastName[0] : '');
                    document.getElementById('topbarUserAv').textContent = initials.toUpperCase();
                    document.getElementById('topbarUserName').textContent = currentUser.firstName + ' ' + (currentUser.lastName ? currentUser.lastName[0] + '.' : '');
                }

                // Populate sidebar user section
                const sidebarUserSection = document.getElementById('sidebarUserSection');
                if (sidebarUserSection) {
                    sidebarUserSection.style.display = 'flex';
                    const initials = ((currentUser.firstName||'')[0]||'') + ((currentUser.lastName||'')[0]||'');
                    const avEl = document.getElementById('sidebarUserAv');
                    if (avEl) avEl.textContent = initials.toUpperCase() || '?';
                    const nameEl = document.getElementById('sidebarUserName');
                    if (nameEl) nameEl.textContent = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim();
                    const statusEl = document.getElementById('sidebarUserStatus');
                    if (statusEl) {
                        const parts = [currentUser.industry, currentUser.status].filter(Boolean);
                        statusEl.textContent = parts.join(' · ');
                    }
                }

                // Build nav items with icons and labels
                const mainItems = [
                    { id: 'dashboardView', icon: '🏠', label: 'Dashboard' },
                    { id: 'discoverView', icon: '🔍', label: 'Discover' },
                    { id: 'networkView', icon: '🤝', label: 'My Network' },
                ];
                const communityItems = [
                    { id: 'feedView', icon: '📰', label: 'Feed' },
                    { id: 'groupsView', icon: '👥', label: 'Communities' },
                    { id: 'messagesView', icon: '☕', label: 'My Chats' },
                ];

                // Label: Main
                mainItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'nav-item';
                    btn.innerHTML = `<span class="nav-icon">${item.icon}</span>${item.label}`;
                    btn.onclick = () => switchView(item.id);
                    navMenu.appendChild(btn);
                });

                // Label: Community
                const communityLabel = document.createElement('div');
                communityLabel.className = 'sidebar-label';
                communityLabel.textContent = 'Community';
                navMenu.appendChild(communityLabel);

                communityItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'nav-item';
                    btn.innerHTML = `<span class="nav-icon">${item.icon}</span>${item.label}`;
                    btn.onclick = () => switchView(item.id);
                    navMenu.appendChild(btn);
                });

                // Divider + My Profile
                const divider = document.createElement('div');
                divider.className = 'sidebar-divider';
                navMenu.appendChild(divider);

                const profileBtn = document.createElement('button');
                profileBtn.className = 'nav-item';
                profileBtn.innerHTML = `<span class="nav-icon">👤</span>My Profile`;
                profileBtn.onclick = () => switchView('myProfileView');
                navMenu.appendChild(profileBtn);

                const settingsBtn = document.createElement('button');
                settingsBtn.className = 'nav-item';
                settingsBtn.innerHTML = `<span class="nav-icon">⚙️</span>Settings`;
                settingsBtn.onclick = () => switchView('settingsView');
                navMenu.appendChild(settingsBtn);
            } else {
                // Hide topbar, sidebar, bell
                document.body.classList.remove('app-mode');
                if (topbar) topbar.classList.remove('visible');
                if (bellContainer) bellContainer.style.display = 'none';
                if (userChip) userChip.style.display = 'none';
                const sidebarUserSection = document.getElementById('sidebarUserSection');
                if (sidebarUserSection) sidebarUserSection.style.display = 'none';
            }
        }

        function updateNavActive(viewId) {
            document.querySelectorAll('#navMenu .nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            // Match by onclick reference
            document.querySelectorAll('#navMenu .nav-item').forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(viewId)) {
                    btn.classList.add('active');
                }
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            if (viewId === 'discoverView') {
                // Always re-fetch profiles so newly created accounts appear immediately
                renderDiscovery(); // render with current data right away
                if (currentUser) {
                    supabaseClient.from('profiles').select('*').neq('id', currentUser.id)
                        .then(({ data, error }) => {
                            if (error) { console.error('Discover profile refresh:', error); return; }
                            if (data) {
                                users = data.map(p => ({
                                    id: p.id,
                                    firstName: p.first_name || '',
                                    lastName: p.last_name || '',
                                    email: p.email || '',
                                    industry: p.industry || '',
                                    interests: Array.isArray(p.interests) ? p.interests : [],
                                    hobbies: Array.isArray(p.hobbies) ? p.hobbies : [],
                                    goals: p.goals || '',
                                    bio: p.bio || '',
                                    role: p.role || '',
                                    company: p.company || '',
                                    location: p.location || '',
                                    profilePicture: p.profile_picture || null,
                                    resume: p.resume_url || null,
                                    posts: []
                                }));
                                renderDiscovery(); // re-render with fresh data
                            }
                        });
                }
            }
            if (viewId === 'feedView') renderFeed();
            if (viewId === 'groupsView') renderGroups();
            if (viewId === 'messagesView') renderMyChatView();
            if (viewId === 'dashboardView') updateDashboard();
            if (viewId === 'calendarView') renderCalendarView();
            if (viewId === 'availabilityView') renderAvailability();
            if (viewId === 'myProfileView') renderMyProfile();
            if (viewId === 'settingsView') renderSettingsView();
            if (viewId === 'networkView') renderNetworkView();
            if (viewId === 'landingView') setTimeout(initLandingReveal, 50);

            updateNavActive(viewId);

            if (viewId !== 'scheduleView' && viewId !== 'profileDetailView' && viewId !== 'callView' && viewId !== 'groupDetailView') {
                previousView = viewId;
            }
        }

        function goBack() {
            switchView(previousView);
        }

        // Dashboard
        function updateDashboard() {
            if (!currentUser) return;

            // ── Greeting ──
            const hour = new Date().getHours();
            const greetingEl = document.getElementById('dbGreeting');
            if (greetingEl) greetingEl.textContent = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';

            // ── Name ──
            const userNameEl = document.getElementById('userName');
            if (userNameEl) userNameEl.textContent = currentUser.firstName;

            // ── Alert pill ──
            const totalPending = (pendingRequests ? pendingRequests.length : 0) + (chatInvites ? chatInvites.length : 0);
            const alertTextEl = document.getElementById('dbAlertText');
            const alertSubEl  = document.getElementById('dbAlertSub');
            if (alertTextEl) alertTextEl.textContent = totalPending > 0
                ? `${totalPending} pending request${totalPending > 1 ? 's' : ''}`
                : 'No pending requests';
            if (alertSubEl) {
                const parts = [];
                if (pendingRequests && pendingRequests.length > 0) parts.push(`${pendingRequests.length} connection${pendingRequests.length > 1 ? 's' : ''}`);
                if (chatInvites && chatInvites.length > 0) parts.push(`${chatInvites.length} chat invite${chatInvites.length > 1 ? 's' : ''}`);
                alertSubEl.textContent = parts.length > 0 ? parts.join(' + ') : 'You\'re all caught up';
            }

            // ── Next Sip card ──
            renderDbNextSip();

            // ── Suggested matches ──
            renderDbMatches();

            // Keep legacy helpers running (hidden elements)
            renderProfileCompletion();
            renderGettingStarted();
            generateNotifications();
        }

        function renderDbSetupBar() {
            const { percentage } = getProfileCompletion();
            const hasConnection = connections.length > 0;
            const hasGroup      = myGroupIds.size > 0;
            const hasMeeting    = meetings.length > 0;

            const steps = [
                { label: 'Create account', done: true, action: null },
                { label: 'Complete profile', done: percentage >= 80, action: 'editMyProfile()' },
                { label: 'First connection', done: hasConnection, action: "switchView('discoverView')" },
                { label: 'Schedule a sip',  done: hasMeeting, action: 'openScheduleChatModal()' },
            ];

            const stepsEl = document.getElementById('dbSetupSteps');
            const ctaEl   = document.getElementById('dbSetupCta');
            const bar     = document.getElementById('dbSetupBar');
            if (!stepsEl) return;

            const allDone = steps.every(s => s.done);
            if (bar) bar.style.display = allDone ? 'none' : 'flex';

            // Determine which step is next active
            let activeIdx = steps.findIndex(s => !s.done);
            stepsEl.innerHTML = steps.map((s, i) => {
                const cls = s.done ? 'done' : i === activeIdx ? 'active' : '';
                const num = s.done ? '✓' : i + 1;
                const action = s.action ? `onclick="${s.action}"` : '';
                return `<div class="db-setup-step ${cls}" ${action}><div class="db-step-num">${num}</div>${s.label}</div>`;
            }).join('');

            // Update CTA
            if (ctaEl) {
                if (!hasConnection && activeIdx === 2) { ctaEl.textContent = 'Find People →'; ctaEl.onclick = () => switchView('discoverView'); }
                else if (!hasMeeting && activeIdx === 3) { ctaEl.textContent = 'Schedule a Sip →'; ctaEl.onclick = () => openScheduleChatModal(); }
                else { ctaEl.textContent = 'Finish Profile →'; ctaEl.onclick = () => editMyProfile(); }
            }
        }

        function renderDbNextSip() {
            const container = document.getElementById('dbNextSipCard');
            if (!container) return;

            const next = meetings
                .filter(m => m.status !== 'completed' && new Date(m.start_time || m.date) >= new Date())
                .sort((a, b) => new Date(a.start_time || a.date) - new Date(b.start_time || b.date))[0];

            if (!next) {
                container.innerHTML = `
                    <div class="db-no-sip">
                        <div class="db-no-sip-icon">☕</div>
                        <div class="db-no-sip-title">No chats scheduled yet</div>
                        <div class="db-no-sip-desc">Schedule your first coffee sip with someone in your network.</div>
                        <button class="db-no-sip-btn" onclick="openScheduleChatModal()">Schedule a Sip ↗</button>
                    </div>`;
                return;
            }

            const isOrganizer = next.organizer_id === currentUser.id;
            const partnerId   = isOrganizer ? next.participant_id : next.organizer_id;
            const partner     = users.find(u => u.id === partnerId);
            const pFirst      = partner?.firstName || 'Someone';
            const pLast       = partner?.lastName  || '';
            const initials    = (pFirst[0]||'') + (pLast[0]||'');
            const role        = partner?.role    || '';
            const company     = partner?.company || '';

            const dtRaw = next.start_time || next.date;
            let countdownStr = '';
            let dateTimeStr  = '';
            if (dtRaw) {
                const dt   = new Date(dtRaw);
                const now  = new Date();
                const diff = dt - now;
                const hoursAway = Math.round(diff / 3600000);
                const today = new Date(); today.setHours(0,0,0,0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
                const dayLabel = dt.toDateString() === today.toDateString() ? 'Today' : dt.toDateString() === tomorrow.toDateString() ? 'Tomorrow' : dt.toLocaleDateString('en-US',{weekday:'long'});
                const timeStr  = next.time || dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
                dateTimeStr  = `${dayLabel} at ${timeStr}`;
                countdownStr = diff > 0 ? ` · ${hoursAway < 1 ? 'very soon' : hoursAway + 'h away'}` : '';
            }

            const meetType = next.meeting_type || next.type || 'Video Call';
            const duration = next.duration ? `${next.duration} min` : '30 min';
            const topic    = next.topic || 'Coffee Chat';
            const metaLine = [role, company].filter(Boolean).join(' · ');

            const avatarColors = ['#6b3f2a','#8b5040','#2d6a4f','#1e4d8c','#7e3ff2'];
            const avatarBg = avatarColors[Math.floor(Math.random() * avatarColors.length)];
            container.innerHTML = `
                <div class="db-next-chat-card">
                    <div class="db-ncc-avatar" style="background:${avatarBg}">${initials || '?'}</div>
                    <div class="db-ncc-info">
                        <div class="db-ncc-name">${pFirst} ${pLast}</div>
                        <div class="db-ncc-role">${metaLine || 'Rowan University'}</div>
                        <div class="db-ncc-meta">
                            ${dateTimeStr ? `<span class="db-meta-chip">📅 ${dateTimeStr}</span>` : ''}
                            <span class="db-meta-chip">⏱ ${duration}</span>
                            <span class="db-meta-chip">💻 ${meetType}</span>
                        </div>
                    </div>
                    <div class="db-ncc-actions">
                        ${countdownStr ? `<span class="db-countdown-badge">In${countdownStr.replace('·','').trim()}</span>` : ''}
                        <button class="db-ncc-btn-primary" onclick="startCall('${pFirst} ${pLast}','${initials}')">Join / Prepare ☕</button>
                        <button class="db-ncc-btn-secondary" onclick="openChatWith('${partnerId}')">Message</button>
                    </div>
                </div>`;
        }

        function renderDbMatches() {
            const container = document.getElementById('dbMatchesList');
            if (!container) return;

            // Get IDs of already-connected / pending users
            const connectedIds = new Set();
            connections.forEach(c => {
                connectedIds.add(c.user_id);
                connectedIds.add(c.connected_user_id);
            });
            sentRequests.forEach(r => connectedIds.add(r.connected_user_id));

            const suggestions = users
                .filter(u => u.id !== currentUser.id && !connectedIds.has(u.id))
                .slice(0, 3);

            if (suggestions.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1;padding:32px;text-align:center;font-size:13px;color:var(--muted);">You've connected with everyone so far!<br><button class="db-ncc-btn-primary" onclick="switchView('discoverView')" style="margin-top:12px;">Find More People</button></div>`;
                return;
            }

            const avatarColors = ['#6b3f2a','#2d6a4f','#1e4d8c','#7e3ff2','#be185d'];

            container.innerHTML = suggestions.map((u, i) => {
                const fn       = u.firstName || '?';
                const ln       = u.lastName  || '?';
                const initials = (fn[0] || '') + (ln[0] || '');
                const bgColor  = avatarColors[i % avatarColors.length];
                const roleLine = [u.role, u.company].filter(Boolean).join(' · ') || u.industry || 'Rowan University';
                const sharedInterests = (u.interests||[]).filter(interest => (currentUser.interests||[]).includes(interest)).length;
                const pct = Math.min(99, 60 + sharedInterests * 10 + (u.industry === currentUser.industry ? 12 : 0));

                return `
                    <div class="db-person-card" onclick="viewProfile('${u.id}')">
                        <span class="db-person-pct-badge">${pct}% match</span>
                        <div class="db-person-card-av" style="background:${bgColor}">${initials}</div>
                        <div class="db-person-card-name">${fn} ${ln}</div>
                        <div class="db-person-card-role">${roleLine}</div>
                        <button class="db-person-card-btn" onclick="event.stopPropagation();openScheduleForUser('${u.id}')">☕ Chat</button>
                    </div>`;
            }).join('');
        }

        function renderDbActivity() {
            const container = document.getElementById('dbActivityFeed');
            if (!container) return;

            const items = [];

            // Upcoming meetings
            meetings
                .filter(m => m.status !== 'completed')
                .sort((a,b) => new Date(a.start_time||a.date) - new Date(b.start_time||b.date))
                .slice(0,2)
                .forEach(m => {
                    const isOrg = m.organizer_id === currentUser.id;
                    const pid   = isOrg ? m.participant_id : m.organizer_id;
                    const p     = users.find(u => u.id === pid);
                    const name  = p ? `${p.firstName} ${p.lastName}` : 'Someone';
                    const dtRaw = m.start_time || m.date;
                    const dateStr = dtRaw ? new Date(dtRaw).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}) : 'soon';
                    items.push({ icon: '☕', cls: 'orange', main: `<strong>${name}</strong> – coffee chat confirmed for ${dateStr}.`, time: 'Upcoming', unread: true });
                });

            // Recent connections
            connections.slice(0, 2).forEach(c => {
                const pid = c.user_id === currentUser.id ? c.connected_user_id : c.user_id;
                const p   = users.find(u => u.id === pid);
                const name = p ? `${p.firstName} ${p.lastName}` : 'Someone';
                items.push({ icon: '🤝', cls: 'green', main: `<strong>${name}</strong> is now in your network.`, time: 'Recent', unread: false });
            });

            // Groups
            const joinedGroups = groups.filter(g => myGroupIds.has(g.id)).slice(0, 1);
            joinedGroups.forEach(g => {
                items.push({ icon: '👥', cls: 'blue', main: `You joined <strong>${g.name}</strong>.`, time: 'Recent', unread: false });
            });

            // Completed chats
            meetings.filter(m => m.status === 'completed').slice(0,1).forEach(m => {
                const pid = m.organizer_id === currentUser.id ? m.participant_id : m.organizer_id;
                const p   = users.find(u => u.id === pid);
                const name = p ? `${p.firstName} ${p.lastName}` : 'Someone';
                items.push({ icon: '⭐', cls: 'cream', main: `Coffee chat with <strong>${name}</strong> completed! ☕`, time: 'Past', unread: false });
            });

            if (items.length === 0) {
                container.innerHTML = `<div class="db-activity-item"><div style="padding:12px 0;font-size:13px;color:var(--muted);">No activity yet. Start by discovering people or joining a group!</div></div>`;
                return;
            }

            container.innerHTML = items.slice(0, 4).map((it, i) => `
                <div class="db-activity-item">
                    <div class="db-act-icon ${it.cls}">${it.icon}</div>
                    <div style="flex:1;">
                        <div class="db-act-main">${it.main}</div>
                        <div class="db-act-time">${it.time}</div>
                    </div>
                    ${it.unread ? '<div class="db-act-dot"></div>' : ''}
                </div>`).join('');
        }

        function renderDbGroups() {
            const container = document.getElementById('dbGroupsList');
            if (!container) return;

            const joinedGroups = groups.filter(g => myGroupIds.has(g.id));

            if (joinedGroups.length === 0) {
                const allGroups = groups.slice(0, 3);
                if (allGroups.length === 0) {
                    container.innerHTML = `<div style="padding:16px 18px;font-size:13px;color:var(--muted);">No groups yet. <button style="background:none;border:none;color:var(--caramel);font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;" onclick="switchView('groupsView')">Browse communities →</button></div>`;
                    return;
                }
                // Show suggestable groups
                container.innerHTML = allGroups.map((g, i) => {
                    const isLast = i === allGroups.length - 1;
                    return `
                        <div class="db-group-item" onclick="switchView('groupsView')" style="${!isLast?'':''}">
                            <div class="db-group-icon">👥</div>
                            <div>
                                <div class="db-group-name">${g.name}</div>
                                <div class="db-group-meta">${g.member_count||0} members</div>
                            </div>
                            <span class="db-group-badge">+ Join</span>
                        </div>`;
                }).join('');
                return;
            }

            container.innerHTML = joinedGroups.slice(0, 3).map((g, i) => {
                const isLast = i === Math.min(joinedGroups.length, 3) - 1;
                const icon = g.icon || '👥';
                return `
                    <div class="db-group-item" onclick="viewGroup('${g.id}')" style="${!isLast ? 'border-bottom:1px solid var(--border)' : ''}">
                        <div class="db-group-icon">${icon}</div>
                        <div>
                            <div class="db-group-name">${g.name}</div>
                            <div class="db-group-meta">${g.member_count||0} members</div>
                        </div>
                        <span class="db-group-badge new">Active</span>
                    </div>`;
            }).join('');
        }

        // ===== HUB TABS =====
        let activeHubTab = 'network';

        function switchHubTab(tab) {
            activeHubTab = tab;
            ['network', 'groups', 'chats'].forEach(t => {
                const btn = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                const panel = document.getElementById(`hub${t.charAt(0).toUpperCase() + t.slice(1)}Panel`);
                if (btn) btn.classList.toggle('active', t === tab);
                if (panel) panel.classList.toggle('active', t === tab);
            });
            renderActiveHubTab();
        }

        function renderActiveHubTab() {
            if (activeHubTab === 'network') renderHubNetworkFeed();
            if (activeHubTab === 'groups') renderHubGroupsFeed();
            if (activeHubTab === 'chats') renderHubChats();
        }

        function renderHubNetworkFeed() {
            const container = document.getElementById('hubNetworkFeed');
            if (!container) return;

            // Pending incoming requests section
            const pendingHTML = pendingRequests.length > 0 ? `
                <div style="background: #FFF8F0; border: 1px solid var(--accent); border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <p style="font-weight: 700; font-size: 14px; color: var(--primary); margin-bottom: 0.75rem;">
                        🤝 ${pendingRequests.length} Connection Request${pendingRequests.length > 1 ? 's' : ''}
                    </p>
                    ${pendingRequests.map(req => {
                        const senderId = req.sender_id || req.user_id;
                        const requester = users.find(u => u.id === senderId);
                        if (!requester) return '';
                        const fn = requester.firstName || '?';
                        const ln = requester.lastName || '?';
                        return `
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div class="person-avatar" style="width: 40px; height: 40px; font-size: 15px; flex-shrink: 0; cursor:pointer;" onclick="viewProfile('${requester.id}')">${fn[0]}${ln[0]}</div>
                                <div style="flex: 1; min-width: 0;">
                                    <strong style="font-size: 13px;">${fn} ${ln}</strong>
                                    <p style="font-size: 11px; color: #888; margin: 0;">${requester.role || requester.industry || ''}</p>
                                    ${req.note ? `<p style="font-size: 11px; color: #666; margin: 2px 0 0; font-style: italic;">"${req.note}"</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.4rem; flex-shrink: 0;">
                                    <button class="btn btn-primary btn-sm" onclick="acceptConnection('${req.id}')" style="font-size: 11px; padding: 4px 10px;">Accept</button>
                                    <button class="btn btn-secondary btn-sm" onclick="rejectConnection('${req.id}')" style="font-size: 11px; padding: 4px 10px;">Decline</button>
                                </div>
                            </div>`;
                    }).join('')}
                </div>` : '';

            const chatInviteHTML = chatInvites.length > 0 ? `
                <div style="background: #F0F8FF; border: 1px solid #A8D0E8; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <p style="font-weight: 700; font-size: 14px; color: #3A7CA5; margin-bottom: 0.75rem;">
                        ☕ ${chatInvites.length} Coffee Chat Request${chatInvites.length > 1 ? 's' : ''}
                    </p>
                    ${chatInvites.map(invite => {
                        const requester = users.find(u => u.id === invite.sender_id);
                        if (!requester) return '';
                        const fn = requester.firstName || '?';
                        const ln = requester.lastName || '?';
                        return `
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div class="person-avatar" style="width: 40px; height: 40px; font-size: 15px; flex-shrink: 0; cursor:pointer;" onclick="viewProfile('${requester.id}')">${fn[0]}${ln[0]}</div>
                                <div style="flex: 1; min-width: 0;">
                                    <strong style="font-size: 13px;">${fn} ${ln}</strong>
                                    ${invite.topic ? `<p style="font-size: 11px; color: #555; margin: 2px 0 0;">Topic: ${invite.topic}</p>` : ''}
                                    ${invite.note ? `<p style="font-size: 11px; color: #888; margin: 2px 0 0; font-style: italic;">"${invite.note}"</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.4rem; flex-shrink: 0;">
                                    <button class="btn btn-primary btn-sm" onclick="acceptChatInvite('${invite.id}')" style="font-size: 11px; padding: 4px 10px;">Accept</button>
                                    <button class="btn btn-secondary btn-sm" onclick="declineChatInvite('${invite.id}')" style="font-size: 11px; padding: 4px 10px;">Decline</button>
                                </div>
                            </div>`;
                    }).join('')}
                </div>` : '';

            const connectedIds = new Set();
            connections.forEach(c => {
                if (c.user_id === currentUser.id) connectedIds.add(c.connected_user_id);
                if (c.connected_user_id === currentUser.id) connectedIds.add(c.user_id);
            });

            const connectedUsers = users.filter(u => connectedIds.has(u.id));
            const count = connectedUsers.length;

            if (count === 0 && pendingRequests.length === 0 && chatInvites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🤝</div>
                        <p>You haven't connected with anyone yet.</p>
                        <button class="btn btn-primary" onclick="switchView('discoverView')" style="margin-top:1rem;">Find Your People</button>
                    </div>`;
                return;
            }

            container.innerHTML = pendingHTML + chatInviteHTML + (count > 0 ? `
                <p style="font-weight:600;font-size:15px;color:var(--text-dark);margin-bottom:1rem;">
                    ${count} connection${count !== 1 ? 's' : ''}
                </p>
                ${connectedUsers.map(u => {
                    const fn = u.firstName || '?';
                    const ln = u.lastName || '?';
                    const initials = `${fn[0]}${ln[0]}`;
                    const roleLine = [u.role, u.industry].filter(Boolean).join(' · ');
                    return `
                        <div class="connection-card">
                            <div class="connection-card-avatar" onclick="viewProfile('${u.id}')" style="cursor:pointer;" title="View profile">${initials}</div>
                            <div class="connection-card-info">
                                <div class="connection-card-name" onclick="viewProfile('${u.id}')" style="cursor:pointer;">${fn} ${ln}</div>
                                ${roleLine ? `<div class="connection-card-role">${roleLine}</div>` : ''}
                            </div>
                            <div class="connection-card-actions">
                                <button class="btn btn-secondary btn-sm" onclick="openChatWith('${u.id}')">💬 Message</button>
                                <button class="btn btn-accent btn-sm" onclick="openScheduleForUser('${u.id}')">☕ Schedule Chat</button>
                            </div>
                        </div>`;
                }).join('')}
                <div class="find-more-banner" onclick="switchView('discoverView')">
                    <div>
                        <div style="font-weight:700;font-size:14px;color:var(--primary);">Looking to expand your network?</div>
                        <div style="font-size:13px;color:#888;margin-top:3px;">Discover Rowan students who share your interests ✨</div>
                    </div>
                    <button class="btn btn-primary btn-sm" style="pointer-events:none;">Find Students →</button>
                </div>` : '');
        }

        function renderHubGroupsFeed() {
            const container = document.getElementById('hubGroupsFeed');
            if (!container) return;

            const joinedGroups = groups.filter(g => myGroupIds.has(g.id));
            const count = joinedGroups.length;

            if (count === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <p>You haven't joined any groups yet.</p>
                        <button class="btn btn-primary" onclick="switchView('groupsView')" style="margin-top:1rem;">Browse Communities</button>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <p style="font-weight:600;font-size:15px;color:var(--text-dark);margin-bottom:1rem;">
                    ${count} group${count !== 1 ? 's' : ''}
                </p>
                ${joinedGroups.map(g => `
                    <div class="group-list-card">
                        <div class="group-list-icon">👥</div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;font-size:14px;color:var(--text-dark);">${g.name}</div>
                            <div style="font-size:12px;color:#888;margin-top:2px;">${g.member_count || 0} members${g.description ? ' · ' + g.description.substring(0, 60) + '…' : ''}</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="viewGroup('${g.id}')">View Group</button>
                    </div>`).join('')}
                <div class="find-more-banner" onclick="switchView('groupsView')">
                    <div>
                        <div style="font-weight:700;font-size:14px;color:var(--primary);">Find more communities to join!</div>
                        <div style="font-size:13px;color:#888;margin-top:3px;">There are groups for every major, interest, and goal 🎓</div>
                    </div>
                    <button class="btn btn-primary btn-sm" style="pointer-events:none;">Browse Groups →</button>
                </div>`;
        }

        async function renderHubChats() {
            const container = document.getElementById('hubChatsContent');
            if (!container) return;

            // Build connections list for search
            const connectedIds = new Set();
            connections.forEach(c => {
                if (c.user_id === currentUser.id) connectedIds.add(c.connected_user_id);
                if (c.connected_user_id === currentUser.id) connectedIds.add(c.user_id);
            });

            // Get upcoming scheduled meetings
            const upcomingMeetings = meetings
                .filter(m => m.status !== 'completed' && new Date(m.start_time || m.date) >= new Date())
                .sort((a, b) => new Date(a.start_time || a.date) - new Date(b.start_time || b.date))
                .slice(0, 5);

            const meetingsHTML = upcomingMeetings.length > 0
                ? upcomingMeetings.map(m => {
                    const partnerUser = users.find(u => u.id === m.organizer_id || u.id === m.participant_id);
                    const partnerName = partnerUser ? `${partnerUser.firstName} ${partnerUser.lastName}` : (m.participant_name || m.organizer_name || 'Someone');
                    const dateStr = m.start_time ? new Date(m.start_time).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : (m.date || 'TBD');
                    return `
                        <div class="scheduled-chat-item">
                            <div class="scheduled-chat-icon">☕</div>
                            <div style="flex:1;min-width:0;">
                                <div style="font-weight:600;font-size:14px;color:var(--text-dark);">${partnerName}</div>
                                <div style="font-size:12px;color:#888;">${dateStr}${m.duration ? ` · ${m.duration} min` : ''}</div>
                            </div>
                        </div>`;
                }).join('')
                : `<div style="color:#888;font-size:13px;padding:1rem 0;">No upcoming chats scheduled.</div>`;

            // Get conversation list from connected mock users (and real messages via supabase)
            const connectedUsers = users.filter(u => connectedIds.has(u.id));

            let conversationsHTML = '';
            if (connectedUsers.length > 0) {
                conversationsHTML = connectedUsers.map(u => {
                    const initials = `${u.firstName[0]}${u.lastName[0]}`;
                    return `
                        <div class="chat-inbox-item" onclick="openChatWith('${u.id}')">
                            <div class="chat-inbox-avatar">${initials}</div>
                            <div class="chat-inbox-info">
                                <div class="chat-inbox-name">${u.firstName} ${u.lastName}</div>
                                <div class="chat-inbox-preview">Say hello! ☕</div>
                            </div>
                        </div>`;
                }).join('');
            } else {
                // Try to load real conversations from Supabase via inbox view
                try {
                    const { data: inboxData } = await supabaseClient
                        .from('inbox')
                        .select('*, other_profile:profiles!inner(first_name, last_name, profile_picture)');

                    if (inboxData && inboxData.length > 0) {
                        conversationsHTML = inboxData.map(conv => {
                            const p = conv.other_profile;
                            const preview = (conv.last_message || 'Start a conversation').substring(0, 45);
                            const fn = p?.first_name?.[0] || '?';
                            const ln = p?.last_name?.[0] || '?';
                            return `
                                <div class="chat-inbox-item" onclick="openChatWith('${conv.other_user_id}')">
                                    <div class="chat-inbox-avatar">${fn}${ln}</div>
                                    <div class="chat-inbox-info">
                                        <div class="chat-inbox-name">${p ? `${p.first_name} ${p.last_name}` : 'User'}</div>
                                        <div class="chat-inbox-preview">${preview}${preview.length >= 45 ? '…' : ''}</div>
                                    </div>
                                </div>`;
                        }).join('');
                    }
                } catch (e) { /* silent */ }
            }

            if (!conversationsHTML) {
                conversationsHTML = `<div style="color:#888;font-size:13px;padding:1rem 0;">No conversations yet. Connect with someone and start chatting!</div>`;
            }

            container.innerHTML = `
                <div style="background:white;border-radius:12px;padding:1.5rem;border:1px solid var(--border);">
                    <div class="chats-hub-header">
                        <div class="chats-hub-search">
                            <input type="text" id="chatsSearchInput" placeholder="Search your connections…" oninput="filterChatsSearch(this.value)">
                        </div>
                        <button class="btn-schedule-chat" onclick="openScheduleModal()">
                            ☕ Schedule a Chat
                        </button>
                    </div>

                    <div class="chats-section-label">Upcoming Chats</div>
                    <div id="upcomingChatsList">${meetingsHTML}</div>

                    <div class="chats-section-label">Messages</div>
                    <div id="chatsInboxList">${conversationsHTML}</div>
                </div>`;
        }

        function filterChatsSearch(query) {
            const q = query.toLowerCase().trim();
            const items = document.querySelectorAll('#chatsInboxList .chat-inbox-item');
            items.forEach(item => {
                const name = item.querySelector('.chat-inbox-name')?.textContent.toLowerCase() || '';
                item.style.display = !q || name.includes(q) ? '' : 'none';
            });
        }

        function openChatWith(userId) {
            switchView('messagesView');
            const msgTabBtn = document.querySelector('.mc-tabs-bar .mc-tab-btn:last-child');
            if (msgTabBtn) switchChatTab(msgTabBtn, 'mc-tab-messages');
            selectConversation(userId);
        }

        // ===== SCHEDULE CHAT MODAL =====
        let scheduleModalUserId = null;
        let selectedModalTime = null;

        // Mock availability for demo users
        const mockUserAvailability = {
            '00000000-0000-0000-0000-000000000002': [
                { day: 1, start: '10:00', end: '12:00' },
                { day: 3, start: '14:00', end: '17:00' },
                { day: 5, start: '09:00', end: '11:00' }
            ],
            '00000000-0000-0000-0000-000000000003': [
                { day: 2, start: '11:00', end: '13:00' },
                { day: 4, start: '15:00', end: '18:00' }
            ],
            '00000000-0000-0000-0000-000000000004': [
                { day: 1, start: '09:00', end: '11:00' },
                { day: 2, start: '14:00', end: '16:00' },
                { day: 5, start: '13:00', end: '15:00' }
            ],
            '00000000-0000-0000-0000-000000000005': [
                { day: 3, start: '10:00', end: '12:00' },
                { day: 4, start: '13:00', end: '15:00' }
            ],
            '00000000-0000-0000-0000-000000000006': [
                { day: 1, start: '14:00', end: '16:00' },
                { day: 5, start: '10:00', end: '12:00' }
            ]
        };
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function openScheduleModal() {
            const connectedIds = new Set();
            connections.forEach(c => {
                if (c.user_id === currentUser.id) connectedIds.add(c.connected_user_id);
                if (c.connected_user_id === currentUser.id) connectedIds.add(c.user_id);
            });
            const connectedUsers = users.filter(u => connectedIds.has(u.id));

            if (connectedUsers.length === 0) {
                alert("Connect with someone first before scheduling a chat!");
                closeModal('scheduleChatModal');
                switchView('discoverView');
                return;
            }

            const list = document.getElementById('schedulePersonList');
            list.innerHTML = connectedUsers.map(u => `
                <div class="schedule-modal-person" onclick="selectSchedulePerson('${u.id}')">
                    <div class="chat-inbox-avatar" style="font-size:15px;">${u.firstName[0]}${u.lastName[0]}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:14px;">${u.firstName} ${u.lastName}</div>
                        <div style="font-size:12px;color:#888;">${[u.role, u.industry].filter(Boolean).join(' · ')}</div>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                </div>`).join('');

            document.getElementById('scheduleStep1').style.display = 'block';
            document.getElementById('scheduleStep2').style.display = 'none';
            selectedModalTime = null;
            openModal('scheduleChatModal');
        }

        function openScheduleForUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            // Show modal directly at step 2
            document.getElementById('scheduleStep1').style.display = 'none';
            document.getElementById('scheduleStep2').style.display = 'block';
            selectedModalTime = null;
            openModal('scheduleChatModal');
            _populateScheduleStep2(user);
        }

        function selectSchedulePerson(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            document.getElementById('scheduleStep1').style.display = 'none';
            document.getElementById('scheduleStep2').style.display = 'block';
            selectedModalTime = null;
            _populateScheduleStep2(user);
        }

        function _populateScheduleStep2(user) {
            scheduleModalUserId = user.id;
            selectedPerson = user;

            document.getElementById('schedulePickedAvatar').textContent = `${user.firstName[0]}${user.lastName[0]}`;
            document.getElementById('schedulePickedName').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('modalScheduleTopic').value = '';

            // Show availability
            const avail = mockUserAvailability[user.id] || [];
            const availContainer = document.getElementById('schedulePickedAvailability');
            if (avail.length > 0) {
                availContainer.innerHTML = `
                    <div style="background:var(--accent-light);border-radius:10px;padding:0.875rem 1rem;border:1px solid var(--border);">
                        <div style="font-weight:600;font-size:13px;color:var(--primary);margin-bottom:0.5rem;">
                            ☕ ${user.firstName}'s typical availability
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                            ${avail.map(a => `
                                <span style="background:white;border:1px solid var(--border);border-radius:8px;padding:4px 10px;font-size:12px;font-weight:600;color:var(--text-dark);">
                                    ${dayNames[a.day]} ${a.start}–${a.end}
                                </span>`).join('')}
                        </div>
                        <p style="font-size:11px;color:#aaa;margin-top:0.5rem;">Pick a date and time that works for both of you — they'll confirm the request.</p>
                    </div>`;
            } else {
                availContainer.innerHTML = `
                    <div style="font-size:13px;color:#888;padding:0.5rem 0;">
                        No set availability yet — feel free to request any time that works for you!
                    </div>`;
            }

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('modalScheduleDate').value = tomorrow.toISOString().split('T')[0];
            renderModalTimeSlots();
        }

        function resetScheduleStep() {
            document.getElementById('scheduleStep1').style.display = 'block';
            document.getElementById('scheduleStep2').style.display = 'none';
            scheduleModalUserId = null;
            selectedModalTime = null;
        }

        function renderModalTimeSlots() {
            const times = [];
            for (let hour = 8; hour < 20; hour++) {
                for (let min of [0, 30]) {
                    times.push(`${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`);
                }
            }
            selectedModalTime = null;
            document.getElementById('modalTimeSlots').innerHTML = times.map(t =>
                `<div class="time-slot" onclick="selectModalTime('${t}', this)">${t}</div>`
            ).join('');
        }

        function selectModalTime(time, el) {
            document.querySelectorAll('#modalTimeSlots .time-slot').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedModalTime = time;
        }

        async function sendModalMeetingRequest() {
            const date = document.getElementById('modalScheduleDate').value;
            const duration = document.getElementById('modalScheduleDuration').value;
            const topic = document.getElementById('modalScheduleTopic').value.trim();
            const type = document.getElementById('modalScheduleType').value;

            if (!date) { alert('Please select a date'); return; }
            if (!selectedModalTime) { alert('Please select a time slot'); return; }
            if (!topic) { alert('Please add a note about what you\'d like to discuss'); return; }
            if (!selectedPerson) { alert('Please select a person to chat with'); return; }

            const startTime = new Date(`${date}T${selectedModalTime}:00`);
            const endTime = new Date(startTime.getTime() + parseInt(duration) * 60000);

            try {
                const { data, error } = await supabaseClient
                    .from('meetings')
                    .insert([{
                        organizer_id: currentUser.id,
                        participant_id: selectedPerson.id,
                        title: `Coffee Chat with ${selectedPerson.firstName} ${selectedPerson.lastName}`,
                        description: topic,
                        note: topic,
                        meeting_type: type,
                        start_time: startTime.toISOString(),
                        end_time: endTime.toISOString(),
                        status: 'pending'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                meetings.push(data);
                closeModal('scheduleChatModal');
                selectedModalTime = null;
                showToast(`Chat request sent to ${selectedPerson.firstName}! ☕`, 'success');
                updateDashboard();
            } catch (err) {
                console.error('Error sending meeting request:', err);
                alert('Failed to send chat request: ' + err.message);
            }
        }

        function formatTimeAgo(date) {
            const diff = Date.now() - date.getTime();
            const hours = Math.floor(diff / 3600000);
            if (hours < 1) return 'Just now';
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days === 1) return 'Yesterday';
            return `${days}d ago`;
        }

        // Discovery
        function renderDiscovery() {
            // Render smart recommendations (isolated — never blocks main grid)
            const searchName = document.getElementById('searchName')?.value.toLowerCase() || '';
            const filterIndustry = document.getElementById('filterIndustry')?.value || '';
            const searchLocation = document.getElementById('searchLocation')?.value.toLowerCase() || '';
            const searchInterests = document.getElementById('searchInterests')?.value.toLowerCase() || '';
            const searchCompany = document.getElementById('searchCompany')?.value.toLowerCase() || '';

            const filtersActive = searchName || filterIndustry || searchLocation || searchInterests || searchCompany;

            // Render recommendations (only when no filters active)
            const recSection = document.getElementById('recommendationsSection');
            if (recSection) {
                try {
                    recSection.innerHTML = filtersActive ? '' : renderRecommendations();
                } catch (e) {
                    console.warn('Recommendations render error:', e);
                    recSection.innerHTML = '';
                }
            }

            // Collect recommended user IDs so we don't show them again in the main grid
            let recommendedIds = new Set();
            if (!filtersActive) {
                try {
                    getSmartRecommendations().slice(0, 3).forEach(item => recommendedIds.add(item.user.id));
                } catch (e) { /* ignore */ }
            }

            // Build set of IDs to hide: self, connected, sent-pending, recommendations
            const connectedOrPendingIds = new Set();
            connections.forEach(c => {
                connectedOrPendingIds.add(c.user_id);
                connectedOrPendingIds.add(c.connected_user_id);
            });
            sentRequests.forEach(r => connectedOrPendingIds.add(r.connected_user_id));

            let filtered = users.filter(u => {
                // Never show self
                if (u.id === currentUser.id) return false;

                // Hide already-connected or pending-sent users
                if (connectedOrPendingIds.has(u.id)) return false;

                // Hide users already shown in the recommendations section
                if (recommendedIds.has(u.id)) return false;

                // Name match
                const matchName = !searchName ||
                    (u.firstName || '').toLowerCase().includes(searchName) ||
                    (u.lastName || '').toLowerCase().includes(searchName);

                // Industry match
                const matchIndustry = !filterIndustry || u.industry === filterIndustry;

                // Location match
                const matchLocation = !searchLocation ||
                    (u.location && u.location.toLowerCase().includes(searchLocation));

                // Interests match
                const matchInterests = !searchInterests ||
                    (u.interests && u.interests.some(interest =>
                        interest.toLowerCase().includes(searchInterests)
                    )) ||
                    (u.hobbies && u.hobbies.some(hobby =>
                        hobby.toLowerCase().includes(searchInterests)
                    ));

                // Company match
                const matchCompany = !searchCompany ||
                    (u.company && u.company.toLowerCase().includes(searchCompany));

                return matchName && matchIndustry && matchLocation && matchInterests && matchCompany;
            });

            const grid = document.getElementById('discoverGrid');
            try {
            grid.innerHTML = filtered.map(user => {
                const fn = user.firstName || '?';
                const ln = user.lastName || '?';
                const isConnected = connections.find(c =>
                    (c.user_id === currentUser.id && c.connected_user_id === user.id) ||
                    (c.connected_user_id === currentUser.id && c.user_id === user.id));
                const isPending = sentRequests.find(c => c.connected_user_id === user.id);
                const hasRequestedMe = pendingRequests.find(c => (c.sender_id || c.user_id) === user.id);
                const avatarHTML = user.profilePicture ?
                    `<div class="person-avatar" style="width: 70px; height: 70px; font-size: 28px; margin: 0 auto 1rem;"><img src="${user.profilePicture}" alt="${fn}"></div>` :
                    `<div class="person-avatar" style="width: 70px; height: 70px; font-size: 28px; margin: 0 auto 1rem;">${fn[0]}${ln[0]}</div>`;

                let actionBtn;
                if (isConnected) {
                    actionBtn = `<button class="btn btn-secondary btn-sm" onclick="startMessage('${user.id}')" style="flex: 1; justify-content: center;">Message</button>`;
                } else if (hasRequestedMe) {
                    actionBtn = `<button class="btn btn-accent btn-sm" onclick="acceptConnection('${hasRequestedMe.id}')" style="flex: 1; justify-content: center;">Accept Request</button>`;
                } else if (isPending) {
                    actionBtn = `<button class="btn btn-secondary btn-sm" disabled style="flex: 1; justify-content: center; opacity: 0.6;">Request Sent</button>`;
                } else {
                    actionBtn = `<button class="btn btn-accent btn-sm" onclick="connectUser('${user.id}')" style="flex: 1; justify-content: center;">Connect</button>`;
                }

                return `
                    <div class="card person-card">
                        ${avatarHTML}
                        <h3>${fn} ${ln}</h3>
                        ${user.role ? `<p class="role">${user.role}</p>` : `<p class="role">${user.industry || ''}</p>`}
                        ${user.company ? `<p style="font-size: 12px; color: #999; margin-top: -0.25rem;">${user.company}</p>` : ''}
                        <div class="tags">
                            ${(user.interests || []).slice(0, 3).map(i => `<span class="tag">${i}</span>`).join('')}
                        </div>
                        <div class="profile-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewProfile('${user.id}')" style="flex: 1; justify-content: center;">View Profile</button>
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('') || '<div class="empty-state"><p>No people found matching your filters.</p></div>';
            } catch (e) {
                console.error('Discover grid render error:', e);
                grid.innerHTML = '<div class="empty-state"><p>Could not load profiles. Please refresh.</p></div>';
            }
        }

        function filterDiscovery() {
            renderDiscovery();
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('filterIndustry').value = '';
            document.getElementById('searchLocation').value = '';
            document.getElementById('searchInterests').value = '';
            document.getElementById('searchCompany').value = '';
            renderDiscovery();
        }

        function viewProfile(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            selectedPerson = user;

            const isConnected = connections.find(c => c.user_id === currentUser.id && c.connected_user_id === userId || c.connected_user_id === currentUser.id && c.user_id === userId);
            const isOwnProfile = currentUser && currentUser.id === userId;

            const avatarHTML = user.profilePicture ? 
                `<div class="person-avatar" style="width: 120px; height: 120px; font-size: 48px;"><img src="${user.profilePicture}" alt="${user.firstName}"></div>` :
                `<div class="person-avatar" style="width: 120px; height: 120px; font-size: 48px;">${user.firstName[0]}${user.lastName[0]}</div>`;

            const content = document.getElementById('profileDetailContent');
            content.innerHTML = `
                <div class="profile-header">
                    ${avatarHTML}
                    ${isOwnProfile ? '<button class="btn btn-secondary btn-sm edit-profile-btn" onclick="editMyProfile()">✏️ Edit Profile</button>' : ''}
                    <h1 style="margin-bottom: 0.5rem;">${user.firstName} ${user.lastName}</h1>
                    ${user.role ? `<p style="font-weight: 600; color: var(--primary); margin-bottom: 0.25rem;">${user.role}${user.company ? ` at ${user.company}` : ''}</p>` : (user.company ? `<p style="color: #666; font-size: 14px; margin-bottom: 0.25rem;">${user.company}</p>` : '')}
                    ${user.location ? `<p style="color: #999; font-size: 13px;">🎓 Class of ${user.location}</p>` : ''}
                    <p class="role" style="margin-top: 0.5rem;">${user.industry}</p>
                </div>

                ${user.bio ? `
                    <div class="profile-info">
                        <h3>About</h3>
                        <p style="line-height: 1.6;">${user.bio}</p>
                    </div>
                ` : ''}

                ${user.resume ? `
                    <div class="resume-section">
                        <h3 style="margin-bottom: 1rem;">Resume</h3>
                        <div class="resume-link" onclick="openResume('${user.resume}')" style="cursor: pointer;">
                            <div class="resume-icon">📄</div>
                            <div>
                                <p style="font-weight: 600; margin: 0;">${user.firstName}'s Resume</p>
                                <p style="font-size: 12px; color: #999; margin: 0;">Click to view PDF</p>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div class="profile-info">
                    <h3>Career Goals</h3>
                    <p>${user.goals}</p>
                </div>

                <div class="profile-info">
                    <h3>Interests & Passions</h3>
                    <div class="profile-tags">
                        ${user.interests.map(i => `<span class="tag">${i}</span>`).join('')}
                    </div>
                </div>

                ${!isOwnProfile ? `
                    <div class="profile-actions">
                        ${isConnected ? `
                            <button class="btn btn-primary" onclick="startMessage('${user.id}')">💬 Send Message</button>
                            <button class="btn btn-accent" onclick="scheduleWith('${user.id}')">📅 Schedule Chat</button>
                        ` : `
                            <button class="btn btn-primary" onclick="connectUser('${user.id}')">Add Connection</button>
                            <button class="btn btn-secondary" onclick="switchView('discoverView')">Back</button>
                        `}
                    </div>
                ` : ''}

                ${isOwnProfile ? `
                    <div class="profile-info">
                        <h3>Your Badges</h3>
                        <div class="badge-grid" id="profileBadges"></div>
                    </div>
                ` : ''}

                ${user.posts && user.posts.length > 0 ? `
                    <div class="profile-posts">
                        <h3 style="margin-bottom: 1rem;">Recent Posts</h3>
                        ${user.posts.map(post => `
                            <div class="post-card">
                                <div class="post-header">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        ${user.profilePicture ? 
                                            `<div class="person-avatar" style="width: 40px; height: 40px; font-size: 16px;"><img src="${user.profilePicture}"></div>` :
                                            `<div class="person-avatar" style="width: 40px; height: 40px; font-size: 16px;">${user.firstName[0]}${user.lastName[0]}</div>`
                                        }
                                        <div>
                                            <h4 style="margin: 0; font-size: 14px;">${user.firstName} ${user.lastName}</h4>
                                            <p class="post-meta">${post.date}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="post-content">${post.content}</div>
                                <div class="post-actions">
                                    <button class="post-action-btn" onclick="likePost(${post.id})">👍 ${post.likes} Likes</button>
                                    <button class="post-action-btn">💬 Comment</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            switchView('profileDetailView');

            // Render badges on own profile
            if (isOwnProfile) {
                setTimeout(() => renderBadges('profileBadges'), 50);
            }
        }

        async function connectUser(userId) {
            if (!currentUser) return;
            if (userId === currentUser.id) return; // never connect with self

            const user = users.find(u => u.id === userId);

            // Already connected?
            const alreadyConnected = connections.find(c =>
                (c.user_id === currentUser.id && c.connected_user_id === userId) ||
                (c.user_id === userId && c.connected_user_id === currentUser.id)
            );
            if (alreadyConnected) { showToast('Already connected!', 'info'); return; }

            // Already sent a request?
            const alreadySent = sentRequests.find(c => c.connected_user_id === userId);
            if (alreadySent) { showToast('Request already sent!', 'info'); return; }

            const noteText = prompt(`Add a personal note to ${user ? user.firstName : 'this person'} (optional):`, '') ?? '';

            try {
                const { data, error } = await supabaseClient
                    .from('connections')
                    .insert([{
                        user_id: currentUser.id,
                        connected_user_id: userId,
                        status: 'pending',
                        note: noteText
                    }])
                    .select()
                    .single();

                if (error) throw error;

                sentRequests.push(data);
                showToast(`Request sent to ${user ? user.firstName : 'user'}!`, 'success');

                if (document.getElementById('profileDetailView').classList.contains('active')) {
                    viewProfile(userId);
                } else {
                    renderDiscovery();
                }
            } catch (err) {
                // Duplicate key = request already exists in DB but local state was stale
                if (err.code === '23505' || (err.message && err.message.includes('duplicate key'))) {
                    // Re-sync connection state from DB so UI reflects reality
                    try {
                        const { data: connsData } = await supabaseClient
                            .from('connections')
                            .select('*')
                            .or(`user_id.eq.${currentUser.id},connected_user_id.eq.${currentUser.id}`);
                        const allConns = connsData || [];
                        connections = allConns.filter(c => c.status === 'accepted');
                        sentRequests = allConns.filter(c => c.status === 'pending' && c.user_id === currentUser.id);
                    } catch (e) { /* ignore refresh error */ }
                    showToast('Request already sent!', 'info');
                    renderDiscovery();
                } else {
                    console.error('Error sending request:', err);
                    showToast('Failed to send request: ' + err.message, 'error');
                }
            }
        }

        async function acceptConnection(connectionId) {
            try {
                const { error } = await supabaseClient
                    .from('connections')
                    .update({ status: 'accepted' })
                    .eq('id', connectionId);

                if (error) throw error;

                pendingRequests = pendingRequests.filter(r => r.id !== connectionId);
                // Re-fetch accepted connections to ensure correct structure
                try {
                    const { data: connsData } = await supabaseClient
                        .from('connections').select('*')
                        .or(`user_id.eq.${currentUser.id},connected_user_id.eq.${currentUser.id}`);
                    if (connsData) connections = connsData.filter(c => c.status === 'accepted');
                } catch(e) {}
                showToast('Connection accepted!', 'success');
                checkBadgesWithCelebration();
                renderHubNetworkFeed();
                generateNotifications();
                renderDiscovery();
            } catch (err) {
                console.error('Error accepting connection:', err);
                showToast('Failed to accept: ' + err.message, 'error');
            }
        }

        async function rejectConnection(connectionId) {
            try {
                const { error } = await supabaseClient
                    .from('connections')
                    .delete()
                    .eq('id', connectionId);

                if (error) throw error;

                pendingRequests = pendingRequests.filter(r => r.id !== connectionId);
                showToast('Request declined.', 'info');
                renderHubNetworkFeed();
                generateNotifications();
            } catch (err) {
                console.error('Error rejecting connection:', err);
                showToast('Failed to decline: ' + err.message, 'error');
            }
        }

        // ── Meeting invite actions ──

        async function acceptMeetingInvite(meetingId) {
            try {
                const { error } = await supabaseClient
                    .from('meetings')
                    .update({ status: 'accepted' })
                    .eq('id', meetingId);
                if (error) throw error;
                const idx = meetings.findIndex(m => m.id === meetingId);
                if (idx >= 0) meetings[idx] = { ...meetings[idx], status: 'accepted' };
                showToast('Chat accepted! ☕', 'success');
                renderMeetingCards();
                updateDashboard();
            } catch (err) {
                console.error('acceptMeetingInvite:', err);
                showToast('Failed to accept: ' + err.message, 'error');
            }
        }

        async function declineMeetingInvite(meetingId) {
            try {
                const { error } = await supabaseClient
                    .from('meetings')
                    .update({ status: 'declined' })
                    .eq('id', meetingId);
                if (error) throw error;
                meetings = meetings.filter(m => m.id !== meetingId);
                showToast('Invite declined.', 'info');
                renderMeetingCards();
            } catch (err) {
                console.error('declineMeetingInvite:', err);
                showToast('Failed to decline: ' + err.message, 'error');
            }
        }

        // ── Chat Invite actions (chat_invites table) ──

        async function sendChatInvite(userId, note = '', topic = '') {
            if (!currentUser) return;
            try {
                const { error } = await supabaseClient
                    .from('chat_invites')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: userId,
                        note: note,
                        topic: topic,
                        status: 'pending'
                    }]);
                if (error) throw error;
                const partner = users.find(u => u.id === userId);
                showToast(`Chat invite sent to ${partner ? partner.firstName : 'user'}! ☕`, 'success');
            } catch (err) {
                console.error('sendChatInvite:', err);
                showToast('Failed to send chat invite: ' + err.message, 'error');
            }
        }

        async function acceptChatInvite(inviteId) {
            try {
                const { error } = await supabaseClient
                    .from('chat_invites')
                    .update({ status: 'accepted' })
                    .eq('id', inviteId);
                if (error) throw error;
                const invite = chatInvites.find(i => i.id === inviteId);
                chatInvites = chatInvites.filter(i => i.id !== inviteId);
                showToast('Coffee chat invite accepted! ☕', 'success');
                renderHubNetworkFeed();
                generateNotifications();
                // Open a chat thread with the sender
                if (invite) openChatWith(invite.sender_id);
            } catch (err) {
                console.error('acceptChatInvite:', err);
                showToast('Failed to accept: ' + err.message, 'error');
            }
        }

        async function declineChatInvite(inviteId) {
            try {
                const { error } = await supabaseClient
                    .from('chat_invites')
                    .update({ status: 'declined' })
                    .eq('id', inviteId);
                if (error) throw error;
                chatInvites = chatInvites.filter(i => i.id !== inviteId);
                showToast('Invite declined.', 'info');
                renderHubNetworkFeed();
                generateNotifications();
            } catch (err) {
                console.error('declineChatInvite:', err);
                showToast('Failed to decline: ' + err.message, 'error');
            }
        }

        async function cancelMeetingRequest(meetingId) {
            if (!confirm('Cancel this chat request?')) return;
            try {
                const { error } = await supabaseClient
                    .from('meetings')
                    .delete()
                    .eq('id', meetingId);
                if (error) throw error;
                meetings = meetings.filter(m => m.id !== meetingId);
                showToast('Chat request cancelled.', 'info');
                renderMeetingCards();
            } catch (err) {
                console.error('cancelMeetingRequest:', err);
                showToast('Failed to cancel: ' + err.message, 'error');
            }
        }

        // Messages
        async function startMessage(userId) {
            switchView('messagesView');
            // Switch to the Messages tab within My Chats
            const msgTabBtn = document.querySelector('.mc-tabs-bar .mc-tab-btn:last-child');
            if (msgTabBtn) switchChatTab(msgTabBtn, 'mc-tab-messages');
            await selectConversation(userId);
        }

        // ─── My Chats redesigned view ───────────────────────────────────

        let miniCalDate = new Date();

        function switchChatTab(btn, tabId) {
            document.querySelectorAll('.mc-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const panels = ['mc-tab-upcoming','mc-tab-past','mc-tab-pending','mc-tab-messages'];
            panels.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const target = document.getElementById(tabId);
            if (target) target.style.display = tabId === 'mc-tab-upcoming' || tabId === 'mc-tab-past' ? 'flex' : 'block';
            // Load messages pane lazily
            if (tabId === 'mc-tab-messages') renderMessages();
        }

        async function renderMyChatView() {
            if (!currentUser) return;

            // ── Stats ──
            const total     = meetings.length;
            const completed = meetings.filter(m => m.status === 'completed').length;
            const upcoming  = meetings.filter(m => m.status !== 'completed').length;
            const durations = meetings.map(m => Number(m.duration) || 0).filter(d => d > 0);
            const avgDur    = durations.length ? Math.round(durations.reduce((a,b)=>a+b,0)/durations.length) : 0;

            document.getElementById('mcStatTotal').textContent     = total;
            document.getElementById('mcStatCompleted').textContent = completed;
            document.getElementById('mcStatUpcoming').textContent  = upcoming;
            document.getElementById('mcStatAvg').textContent       = avgDur ? avgDur + 'm' : '—';

            // ── Card lists ──
            await renderMeetingCards();

            // ── Mini calendar ──
            renderMiniCal();

            // ── Next Up sidebar ──
            renderNextUp();
        }

        async function renderMeetingCards() {
            const upcomingEl = document.getElementById('mc-tab-upcoming');
            const pastEl     = document.getElementById('mc-tab-past');
            const pendingEl  = document.getElementById('mc-tab-pending');
            if (!upcomingEl || !pastEl || !pendingEl) return;

            const upcomingMtgs = meetings.filter(m => m.status !== 'completed').sort((a,b)=>new Date(a.start_time||a.date)-new Date(b.start_time||b.date));
            const pastMtgs     = meetings.filter(m => m.status === 'completed').sort((a,b)=>new Date(b.start_time||b.date)-new Date(a.start_time||a.date));
            const pendingMtgs  = meetings.filter(m => m.status === 'pending');

            upcomingEl.innerHTML = upcomingMtgs.length ? upcomingMtgs.map((m,i) => buildChatCard(m, 'upcoming', i===0)).join('') : emptyMcState('📅','No upcoming chats','Schedule your next coffee chat to get started.','upcoming');
            pastEl.innerHTML     = pastMtgs.length     ? pastMtgs.map(m => buildChatCard(m,'completed',false)).join('') : emptyMcState('☕','No past chats yet','Your completed chats will appear here.','');
            pendingEl.innerHTML  = pendingMtgs.length  ? pendingMtgs.map(m => buildChatCard(m,'pending',false)).join('') : emptyMcState('⏳','No pending requests','When you send or receive a chat request it will appear here.','pending');
        }

        function buildChatCard(m, status, featured) {
            // Resolve partner info
            const isOrganizer = m.organizer_id === currentUser?.id;
            const partnerId   = isOrganizer ? m.participant_id : m.organizer_id;
            const partner     = users.find(u => u.id === partnerId);
            const pFirst      = partner?.firstName || 'Unknown';
            const pLast       = partner?.lastName  || '';
            const initials    = (pFirst[0]||'') + (pLast[0]||'');
            const role        = partner?.role    || '';
            const company     = partner?.company || '';
            const topic       = m.description || m.topic || '';

            // Date / time
            const dtRaw = m.start_time || m.date;
            let dateStr = '—', timeStr = '';
            if (dtRaw) {
                const dt = new Date(dtRaw);
                const today = new Date();
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
                if (dt.toDateString() === today.toDateString())    dateStr = 'Today';
                else if (dt.toDateString() === tomorrow.toDateString()) dateStr = 'Tomorrow';
                else dateStr = dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
                timeStr = m.time || dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
            }

            const gradients = [
                'linear-gradient(135deg,#5c3317,#b5651d)',
                'linear-gradient(135deg,#2563eb,#5c9ef5)',
                'linear-gradient(135deg,#2d7a4f,#52c887)',
                'linear-gradient(135deg,#7c3aed,#a78bfa)',
                'linear-gradient(135deg,#be185d,#f472b6)',
            ];
            const gradIdx = (partnerId || '').split('').reduce((acc,c)=>acc+c.charCodeAt(0),0) % gradients.length;
            const gradient = gradients[gradIdx];

            const statusLabel = status === 'completed' ? '✓ Completed' : status === 'pending' ? '⏳ Pending' : 'Upcoming';
            const iceHTML = featured && status === 'upcoming' ? buildIcebreakers(partnerId) : '';
            const meetType = m.meeting_type || m.type || 'virtual';

            let actionsHTML = '';
            if (status === 'upcoming') {
                actionsHTML = `
                    <div class="mc-card-actions">
                        <button class="mc-btn-sm primary" onclick="startCall('${pFirst} ${pLast}','${initials}')">📹 Join Call</button>
                        <button class="mc-btn-sm secondary">📅 Reschedule</button>
                        <button class="mc-btn-sm secondary" onclick="event.stopPropagation();switchChatTab(document.querySelector('.mc-tabs-bar .mc-tab-btn:last-child'),'mc-tab-messages')">✉ Message</button>
                        <button class="mc-btn-sm danger" onclick="event.stopPropagation()">Cancel</button>
                    </div>`;
            } else if (status === 'completed') {
                actionsHTML = `
                    <div class="mc-card-actions">
                        <button class="mc-btn-sm secondary">⭐ Leave a Review</button>
                        <button class="mc-btn-sm secondary">🔄 Schedule Again</button>
                        <button class="mc-btn-sm secondary">✉ Message</button>
                    </div>`;
            } else {
                if (isOrganizer) {
                    actionsHTML = `
                        <div class="mc-card-actions">
                            <span style="font-size:12px;color:var(--muted);padding:4px 8px;flex:1;">⏳ Waiting for response…</span>
                            <button class="mc-btn-sm danger" onclick="event.stopPropagation();cancelMeetingRequest('${m.id}')">Cancel</button>
                        </div>`;
                } else {
                    actionsHTML = `
                        <div class="mc-card-actions">
                            <button class="mc-btn-sm primary" onclick="event.stopPropagation();acceptMeetingInvite('${m.id}')">✓ Accept</button>
                            <button class="mc-btn-sm danger" onclick="event.stopPropagation();declineMeetingInvite('${m.id}')">✗ Decline</button>
                        </div>`;
                }
            }

            return `
                <div class="mc-chat-card ${status}">
                    <div class="mc-card-top">
                        <div class="mc-avatar-wrap">
                            <div class="mc-avatar" style="background:${gradient}">${initials || '?'}</div>
                        </div>
                        <div>
                            <div class="mc-chat-name">${pFirst} ${pLast}</div>
                            <div class="mc-chat-meta">
                                ${role ? `<span>${role}</span>` : ''}
                                ${role && company ? '<span class="mc-meta-dot"></span>' : ''}
                                ${company ? `<span>${company}</span>` : ''}
                                ${(role||company) && meetType ? '<span class="mc-meta-dot"></span>' : ''}
                                ${meetType ? `<span>${meetType}</span>` : ''}
                            </div>
                            ${topic ? `<div class="mc-chat-topic">${topic}</div>` : ''}
                        </div>
                        <div class="mc-card-right">
                            <span class="mc-status-badge ${status}">${statusLabel}</span>
                            <div class="mc-chat-date">${dateStr}</div>
                            ${timeStr ? `<div class="mc-chat-time">${timeStr}</div>` : ''}
                        </div>
                    </div>
                    ${iceHTML}
                    ${actionsHTML}
                </div>`;
        }

        function buildIcebreakers(partnerId) {
            const starters = getConversationStarters(partnerId).slice(0, 3);
            if (!starters.length) return '';
            const items = starters.map(s => `<div class="mc-icebr-item">💬 "${s}"</div>`).join('');
            return `<div class="mc-icebreakers"><div class="mc-icebr-label">✨ Conversation Starters</div>${items}</div>`;
        }

        function emptyMcState(icon, title, desc, tab) {
            const btn = tab ? `<button class="mc-btn-sm primary" onclick="openScheduleChatModal()">☕ Schedule a Chat</button>` : '';
            return `<div class="mc-empty"><div class="mc-empty-icon">${icon}</div><div class="mc-empty-title">${title}</div><div class="mc-empty-desc">${desc}</div>${btn}</div>`;
        }

        // ── Mini Calendar ──
        function renderMiniCal() {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const monthEl = document.getElementById('miniCalMonth');
            const gridEl  = document.getElementById('miniCalGrid');
            if (!monthEl || !gridEl) return;

            monthEl.textContent = `${monthNames[miniCalDate.getMonth()]} ${miniCalDate.getFullYear()}`;

            const firstDay   = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth(), 1);
            const lastDay    = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth()+1, 0);
            const startDow   = firstDay.getDay();
            const today      = new Date();

            let html = ['Su','Mo','Tu','We','Th','Fr','Sa'].map(d=>`<div class="mc-cal-day-name">${d}</div>`).join('');
            for (let i=0; i<startDow; i++) {
                const prevDay = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth(), 0-startDow+i+1);
                html += `<div class="mc-cal-day other-month">${prevDay.getDate()}</div>`;
            }
            for (let day=1; day<=lastDay.getDate(); day++) {
                const date = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth(), day);
                const isToday   = today.toDateString() === date.toDateString();
                const hasEvent  = meetings.some(m => { const d=new Date(m.start_time||m.date); return d.toDateString()===date.toDateString(); });
                html += `<div class="mc-cal-day${isToday?' today':''}${hasEvent?' has-event':''}">${day}</div>`;
            }
            // Fill trailing cells
            const totalCells = startDow + lastDay.getDate();
            const remainder = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i=1; i<=remainder; i++) html += `<div class="mc-cal-day other-month">${i}</div>`;

            gridEl.innerHTML = html;
        }

        function miniCalPrev() { miniCalDate.setMonth(miniCalDate.getMonth()-1); renderMiniCal(); }
        function miniCalNext() { miniCalDate.setMonth(miniCalDate.getMonth()+1); renderMiniCal(); }

        // ── Next Up sidebar list ──
        function renderNextUp() {
            const el = document.getElementById('mcNextUpList');
            if (!el) return;
            const monthAbbr = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
            const upcoming = meetings
                .filter(m => m.status !== 'completed')
                .sort((a,b)=>new Date(a.start_time||a.date)-new Date(b.start_time||b.date))
                .slice(0,3);

            if (!upcoming.length) { el.innerHTML = '<div style="padding:12px 18px;font-size:13px;color:var(--muted);">No upcoming chats</div>'; return; }

            el.innerHTML = upcoming.map(m => {
                const isOrganizer = m.organizer_id === currentUser?.id;
                const partnerId   = isOrganizer ? m.participant_id : m.organizer_id;
                const partner     = users.find(u => u.id === partnerId);
                const name        = partner ? `${partner.firstName} ${partner.lastName}` : 'Unknown';
                const dtRaw       = m.start_time || m.date;
                let dayNum='—', monStr='', timeStr='';
                if (dtRaw) {
                    const dt = new Date(dtRaw);
                    dayNum  = dt.getDate();
                    monStr  = monthAbbr[dt.getMonth()];
                    timeStr = m.time || dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
                }
                const dur  = m.duration ? ` · ${m.duration}m` : '';
                const mode = m.meeting_type || m.type || 'Virtual';
                return `
                    <div class="mc-upcoming-item">
                        <div class="mc-udb">
                            <div class="mc-udb-month">${monStr}</div>
                            <div class="mc-udb-day">${dayNum}</div>
                        </div>
                        <div class="mc-upcoming-info">
                            <div class="mc-upcoming-name">${name}</div>
                            <div class="mc-upcoming-time">${timeStr}${dur}</div>
                        </div>
                        <span class="mc-upcoming-mode">${mode}</span>
                    </div>`;
            }).join('');
        }

        // ── Helper: open the schedule modal (routes to existing scheduleChatModal) ──
        function openScheduleChatModal() {
            openModal('scheduleChatModal');
        }

        // ─── renderMessages — loads inbox via the `inbox` view ───────
        async function renderMessages() {
            if (!currentUser) return;

            try {
                const { data: inboxData, error } = await supabaseClient
                    .from('inbox')
                    .select('*, other_profile:profiles!inner(first_name, last_name, profile_picture)');

                if (error) throw error;

                const list = document.getElementById('conversationList');

                if (!inboxData || inboxData.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">💬</div><p>No conversations yet</p></div>';
                    document.getElementById('chatWindow').innerHTML = '<div class="chat-header"><h3>Start a conversation</h3></div>';
                    return;
                }

                list.innerHTML = inboxData.map(conv => {
                    const profile = conv.other_profile;
                    const partnerName = profile ? `${profile.first_name} ${profile.last_name}` : 'User';
                    const fn = profile?.first_name?.[0] || '?';
                    const ln = profile?.last_name?.[0] || '?';
                    const avatarHTML = profile?.profile_picture
                        ? `<img src="${profile.profile_picture}" alt="${partnerName}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">`
                        : `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0;">${fn}${ln}</div>`;
                    const lastMessage = (conv.last_message || '').substring(0, 50);
                    const unreadBadge = (conv.unread_count > 0)
                        ? `<span style="background:var(--primary);color:white;border-radius:50%;min-width:20px;padding:2px 6px;font-size:11px;font-weight:700;text-align:center;">${conv.unread_count}</span>`
                        : '';

                    return `
                        <div class="conversation-item ${selectedConversation === conv.other_user_id ? 'active' : ''}" onclick="selectConversation('${conv.other_user_id}', '${conv.id}')" style="display: flex; align-items: center; gap: 0.75rem;">
                            ${avatarHTML}
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="margin: 0;" onclick="event.stopPropagation(); viewProfile('${conv.other_user_id}')" class="conversation-name-link">${partnerName}</h4>
                                <p style="font-size: 12px; color: #999; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage}${lastMessage.length >= 50 ? '...' : ''}</p>
                            </div>
                            ${unreadBadge}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error rendering messages:', error);
            }
        }

        async function selectConversation(userId, conversationId = null) {
            if (!currentUser) return;

            selectedConversation = userId;
            selectedConversationId = conversationId;

            try {
                let messagesData = [];
                let partnerName = 'User';

                // Look up conversation_id if not provided
                if (!selectedConversationId) {
                    const { data: convRow } = await supabaseClient
                        .from('conversations')
                        .select('id')
                        .or(`and(participant_a.eq.${currentUser.id},participant_b.eq.${userId}),and(participant_a.eq.${userId},participant_b.eq.${currentUser.id})`)
                        .maybeSingle();
                    selectedConversationId = convRow?.id || null;
                }

                if (selectedConversationId) {
                    const { data, error } = await supabaseClient
                        .from('messages')
                        .select('*')
                        .eq('conversation_id', selectedConversationId)
                        .order('created_at', { ascending: true });
                    if (error) throw error;
                    messagesData = data || [];
                }

                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('first_name, last_name')
                    .eq('id', userId)
                    .maybeSingle();

                partnerName = profile ? `${profile.first_name} ${profile.last_name}` : 'User';

                const icebreakers = getConversationStarters(userId);
                const icebreakerHTML = (!messagesData || messagesData.length === 0) ? `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="font-size: 14px; color: #999; margin-bottom: 1rem;">Start a conversation with ${partnerName}!</p>
                        <p style="font-size: 13px; color: var(--primary); font-weight: 600; margin-bottom: 0.75rem;">Try one of these icebreakers:</p>
                        ${icebreakers.map(starter => `
                            <button class="btn btn-secondary btn-sm"
                                onclick="useIcebreaker('${userId}', this.textContent.trim())"
                                style="margin: 0.25rem; font-size: 12px; text-align: left;">
                                ${starter}
                            </button>
                        `).join('')}
                    </div>
                ` : '';

                const chatWindow = document.getElementById('chatWindow');
                chatWindow.innerHTML = `
                    <div class="chat-header">
                        <div>
                            <h3 style="margin: 0;">${partnerName}</h3>
                        </div>
                        <button class="btn btn-accent btn-sm" onclick="scheduleWith('${userId}')">Schedule Chat</button>
                    </div>
                    <div class="chat-messages" id="chatMessagesContainer">
                        ${icebreakerHTML}
                        ${messagesData.map(m => `
                            <div class="message ${m.sender_id === currentUser.id ? 'sent' : 'received'}">
                                <div class="message-content">${m.content}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage('${userId}')">
                        <button class="btn btn-primary btn-sm" onclick="sendMessage('${userId}')">Send</button>
                    </div>
                `;

                // Scroll to bottom
                const container = document.getElementById('chatMessagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }

                // Mark messages as read
                if (selectedConversationId) {
                    await supabaseClient
                        .from('messages')
                        .update({ read: true })
                        .eq('conversation_id', selectedConversationId)
                        .eq('receiver_id', currentUser.id);
                } else {
                    await supabaseClient
                        .from('messages')
                        .update({ read: true })
                        .eq('receiver_id', currentUser.id)
                        .eq('sender_id', userId);
                }

            } catch (error) {
                console.error('Error selecting conversation:', error);
            }
        }

        async function sendMessage(userId) {
            if (!currentUser) return;

            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            try {
                // Step 1: upsert conversation to get/create the thread
                const { data: convData, error: convError } = await supabaseClient
                    .from('conversations')
                    .upsert(
                        { participant_a: currentUser.id, participant_b: userId },
                        { onConflict: 'least(participant_a::text,participant_b::text),greatest(participant_a::text,participant_b::text)' }
                    )
                    .select('id')
                    .single();

                if (convError) throw convError;
                const conversationId = convData.id;
                selectedConversationId = conversationId;

                // Step 2: insert message with conversation_id
                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: userId,
                        conversation_id: conversationId,
                        content: text,
                        message_type: 'text'
                    }]);

                if (error) throw error;

                sentMessageCount++;
                input.value = '';
                await selectConversation(userId, conversationId);
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message: ' + error.message, 'error');
            }
        }

        function getConversationStarters(userId) {
            const partner = users.find(u => u.id === userId);
            const starters = [];

            if (partner) {
                if (partner.industry) {
                    starters.push(`What got you interested in ${partner.industry}?`);
                }
                if (partner.role && partner.company) {
                    starters.push(`How's ${partner.role} year going at ${partner.company}?`);
                } else if (partner.company) {
                    starters.push(`How do you like it at ${partner.company}?`);
                }
                if (partner.interests && partner.interests.length > 0) {
                    starters.push(`I noticed we share an interest in ${partner.interests[0]}!`);
                }
                if (partner.goals) {
                    starters.push(`What's your game plan for breaking into the industry after graduation?`);
                }
            }

            const generic = [
                "What's been the highlight of your semester so far?",
                "Any good books, podcasts, or classes you'd recommend?",
                "What project or internship are you most excited about right now?"
            ];

            return [...starters, ...generic].slice(0, 4);
        }

        function useIcebreaker(userId, text) {
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = text;
                input.focus();
                localStorage.setItem('usedIcebreaker', 'true');
            }
        }

        // Groups
        function renderGroups() {
            const list = document.getElementById('groupsList');
            list.innerHTML = groups.map(group => {
                const joined = myGroupIds.has(group.id);
                return `
                <div class="group-card">
                    <div class="group-header">
                        <div>
                            <h3 style="margin-bottom: 0.25rem;">${group.name}</h3>
                            <span class="industry-pill">${group.industry || ''}</span>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: #666; margin: 0.5rem 0;">${group.description || ''}</p>
                    <div class="group-meta">
                        <span>&#128101; ${group.member_count || 0} members</span>
                    </div>
                    ${joined ?
                        `<button class="btn btn-accent" onclick="viewGroup('${group.id}')" style="width: 100%; margin-top: 0.75rem;">View Group</button>` :
                        `<button class="btn btn-primary" onclick="joinGroup('${group.id}')" style="width: 100%; margin-top: 0.75rem;">Join Group</button>`
                    }
                </div>`;
            }).join('') || '<div class="empty-state"><p>No groups available yet</p></div>';

            const myGroups = groups.filter(g => myGroupIds.has(g.id));
            const myList = document.getElementById('myGroupsList');
            if (myGroups.length === 0) {
                myList.innerHTML = '<div class="empty-state"><p>Join groups to connect with your community</p></div>';
            } else {
                myList.innerHTML = myGroups.map(group => `
                    <div class="group-card" onclick="viewGroup('${group.id}')" style="cursor: pointer; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: var(--primary); margin-bottom: 0.25rem;">&#10003; ${group.name}</h3>
                                <div class="group-meta" style="margin: 0;">
                                    <span>&#128101; ${group.member_count || 0} members</span>
                                </div>
                            </div>
                            <span style="color: var(--accent); font-size: 18px;">&rarr;</span>
                        </div>
                    </div>`
                ).join('');
            }
        }

        async function viewGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;

            switchView('groupDetailView');
            const content = document.getElementById('groupDetailContent');
            content.innerHTML = '<div class="empty-state"><p>Loading group...</p></div>';

            try {
                // Load group posts with author profiles
                const { data: postsData } = await supabaseClient
                    .from('posts')
                    .select('*, profiles!posts_author_id_fkey(first_name, last_name)')
                    .eq('group_id', groupId)
                    .order('created_at', { ascending: false });

                // Load group members with profiles
                const { data: membersData } = await supabaseClient
                    .from('group_members')
                    .select('user_id, profiles!group_members_user_id_fkey(id, first_name, last_name, industry, role, company)')
                    .eq('group_id', groupId);

                const memberCards = (membersData || []).map(m => {
                    const p = m.profiles;
                    if (!p) return '';
                    const isConnected = connections.find(c =>
                        (c.user_id === currentUser.id && c.connected_user_id === p.id) ||
                        (c.connected_user_id === currentUser.id && c.user_id === p.id)
                    );
                    return `
                        <div class="card compact" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <div class="person-avatar" style="width: 44px; height: 44px; font-size: 16px; flex-shrink: 0;">${p.first_name[0]}${p.last_name[0]}</div>
                            <div style="flex: 1; min-width: 0;">
                                <strong style="font-size: 14px;">${p.first_name} ${p.last_name}</strong>
                                <p style="font-size: 12px; color: #999; margin: 0;">${p.role || p.industry || ''}</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                                <button class="btn btn-secondary btn-sm" onclick="viewProfile('${p.id}')" style="font-size: 11px; padding: 4px 10px;">View</button>
                                ${p.id !== currentUser.id ? (isConnected ? `<span style="font-size: 11px; color: var(--success);">&#10003; Connected</span>` : `<button class="btn btn-primary btn-sm" onclick="connectUser('${p.id}')" style="font-size: 11px; padding: 4px 10px;">Connect</button>`) : ''}
                            </div>
                        </div>`;
                }).join('');

                const postsHTML = (postsData || []).map(post => {
                    const authorName = post.profiles ? `${post.profiles.first_name} ${post.profiles.last_name}` : 'Member';
                    const timeAgo = post.created_at ? getTimeAgo(post.created_at) : '';
                    return `
                        <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong>${authorName}</strong>
                                <span style="font-size: 11px; color: #999;">${timeAgo}</span>
                            </div>
                            <p style="color: #444; margin-bottom: 0.75rem;">${post.content}</p>
                            <div class="post-actions" style="padding-top: 0.5rem; border-top: 1px solid var(--border);">
                                <button class="post-action-btn" onclick="likeGroupPost('${post.id}', '${groupId}')">&#128077; ${post.likes_count || 0} Likes</button>
                                <button class="post-action-btn" onclick="toggleGroupDetailComments('${post.id}')">&#128172; Comment</button>
                            </div>
                            <div id="gd-comments-${post.id}" style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                                <div id="gd-comments-list-${post.id}" style="margin-bottom: 0.5rem;"></div>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <input type="text" id="gci-${post.id}" placeholder="Write a comment..." style="flex: 1; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 13px;" onkeypress="if(event.key==='Enter') submitGroupComment('${post.id}', '${groupId}')">
                                    <button class="btn btn-primary btn-sm" onclick="submitGroupComment('${post.id}', '${groupId}')" style="font-size: 12px; padding: 4px 10px;">Post</button>
                                </div>
                            </div>
                        </div>`;
                }).join('') || '<p style="color: #999;">No posts yet. Start the conversation!</p>';

                content.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
                        <h1 style="margin-bottom: 0.5rem;">${group.name}</h1>
                        <p style="color: #666; margin-bottom: 0.5rem;">${group.description || ''}</p>
                        <div class="group-meta">
                            <span>&#128101; ${group.member_count || 0} members</span>
                            <span class="industry-pill">${group.industry || ''}</span>
                        </div>
                    </div>

                    <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Group Discussion</h3>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <input type="text" id="groupPostInput" placeholder="Share something with the group..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border);" onkeypress="if(event.key==='Enter') postToGroup('${groupId}')">
                            <button class="btn btn-primary btn-sm" onclick="postToGroup('${groupId}')">Post</button>
                        </div>
                        <div id="groupPosts-${groupId}">${postsHTML}</div>
                    </div>

                    <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid var(--border);">
                        <h3 style="margin-bottom: 1rem;">Members (${(membersData || []).length})</h3>
                        ${memberCards || '<p style="color: #999;">No members yet</p>'}
                    </div>
                `;
            } catch (err) {
                console.error('Error loading group:', err);
                content.innerHTML = '<div class="empty-state"><p>Failed to load group. Please try again.</p></div>';
            }
        }

        function toggleGroupDetailComments(postId) {
            const el = document.getElementById(`gd-comments-${postId}`);
            if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function postToGroup(groupId) {
            const input = document.getElementById('groupPostInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            try {
                const { error } = await supabaseClient
                    .from('posts')
                    .insert([{
                        author_id: currentUser.id,
                        content: text,
                        group_id: groupId
                    }]);

                if (error) throw error;

                input.value = '';
                await viewGroup(groupId);
                showToast('Posted to group!', 'success');
            } catch (err) {
                console.error('Error posting to group:', err);
                showToast('Failed to post: ' + err.message, 'error');
            }
        }

        async function likeGroupPost(postId, groupId) {
            if (!currentUser) return;
            try {
                const { data: existing } = await supabaseClient
                    .from('post_likes')
                    .select('id')
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabaseClient.from('post_likes').delete().eq('id', existing.id);
                } else {
                    await supabaseClient.from('post_likes').insert([{ post_id: postId, user_id: currentUser.id }]);
                }
                await viewGroup(groupId);
            } catch (err) {
                console.error('Error liking post:', err);
            }
        }

        async function submitGroupComment(postId, groupId) {
            const input = document.getElementById(`gci-${postId}`);
            if (!input) return;
            const text = input.value.trim();
            if (!text || !currentUser) return;

            try {
                const { error } = await supabaseClient
                    .from('post_comments')
                    .insert([{ post_id: postId, user_id: currentUser.id, content: text }]);

                if (error) throw error;
                await viewGroup(groupId);
            } catch (err) {
                console.error('Error submitting comment:', err);
                showToast('Failed to submit comment', 'error');
            }
        }

        function shareGroupPost(postId, content) {
            if (navigator.share) {
                navigator.share({ title: 'First Sip Group Post', text: content });
            } else {
                navigator.clipboard.writeText(content).then(() => {
                    showToast('Post copied to clipboard!', 'info');
                });
            }
        }

        async function joinGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group || myGroupIds.has(groupId)) return;

            try {
                const { error } = await supabaseClient
                    .from('group_members')
                    .insert([{ group_id: groupId, user_id: currentUser.id }]);

                if (error) throw error;

                myGroupIds.add(groupId);
                group.member_count = (group.member_count || 0) + 1; // optimistic local update (DB trigger handles the real count)

                renderGroups();
                showToast(`Joined ${group.name}!`, 'success');
                checkBadgesWithCelebration();
            } catch (err) {
                console.error('Error joining group:', err);
                showToast('Failed to join group: ' + err.message, 'error');
            }
        }

        async function createGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            const industry = document.getElementById('newGroupIndustry').value;
            const description = document.getElementById('newGroupDescription').value.trim();
            const errEl = document.getElementById('createGroupError');
            const btn = document.getElementById('createGroupBtn');

            errEl.style.display = 'none';

            if (!name) { errEl.textContent = 'Please enter a group name.'; errEl.style.display = 'block'; return; }
            if (!industry) { errEl.textContent = 'Please select an industry/focus area.'; errEl.style.display = 'block'; return; }
            if (!description) { errEl.textContent = 'Please add a short description.'; errEl.style.display = 'block'; return; }

            btn.disabled = true;
            btn.textContent = 'Creating…';

            try {
                const { data: newGroup, error } = await supabaseClient
                    .from('groups')
                    .insert([{ name, industry, description, creator_id: currentUser.id, member_count: 1 }])
                    .select()
                    .single();

                if (error) throw error;

                // Auto-join the creator as admin
                await supabaseClient
                    .from('group_members')
                    .insert([{ group_id: newGroup.id, user_id: currentUser.id, role: 'admin' }]);

                groups.unshift(newGroup);
                myGroupIds.add(newGroup.id);

                // Reset form
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupIndustry').value = '';
                document.getElementById('newGroupDescription').value = '';
                document.getElementById('newGroupDescCount').textContent = '0 / 300';

                closeModal('createGroupModal');
                renderGroups();
                showToast(`"${newGroup.name}" created!`, 'success');
            } catch (err) {
                console.error('Error creating group:', err);
                errEl.textContent = 'Failed to create group: ' + err.message;
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Group';
            }
        }

        // Calendar
        function renderCalendar() {
            renderCalendarGrid();
        }

        function renderCalendarView() {
            renderCalendarGrid();
            renderMeetingsList();
        }

        function renderCalendarGrid() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const isToday = new Date().toDateString() === date.toDateString();
                const hasEvent = meetings.some(m => new Date(m.date).toDateString() === date.toDateString());
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}">${day}</div>`;
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        function renderMeetingsList() {
            const list = document.getElementById('meetingsList');
            const upcomingMeetings = meetings.filter(m => m.status !== 'completed').sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingMeetings.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No upcoming meetings</p></div>';
                return;
            }

            list.innerHTML = upcomingMeetings.map(meeting => `
                <div class="meeting-card">
                    <div class="meeting-header">
                        <div>
                            <p class="meeting-time">${new Date(meeting.date).toLocaleDateString()} at ${meeting.time}</p>
                            <h3 style="margin: 0.5rem 0 0.25rem;">${meeting.personName}</h3>
                            <p style="font-size: 13px; color: #999; margin: 0;">${meeting.topic}</p>
                            <p style="font-size: 12px; color: #666; margin-top: 0.25rem;">Type: ${meeting.type}</p>
                        </div>
                        <span class="meeting-status ${meeting.status}">${meeting.status.charAt(0).toUpperCase() + meeting.status.slice(1)}</span>
                    </div>
                    <div class="meeting-actions">
                        <button class="btn btn-primary btn-sm" onclick="startCall('${meeting.personName}', '${meeting.personName[0]}')">Start Call</button>
                        <button class="btn btn-secondary btn-sm">Reschedule</button>
                    </div>
                </div>
            `).join('');
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendarGrid();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendarGrid();
        }

        // Schedule Meeting
        function scheduleWith(userId) {
            const user = users.find(u => u.id === userId);
            selectedPerson = user;
            previousView = 'profileDetailView';

            document.getElementById('scheduleName').textContent = `${user.firstName} ${user.lastName}`;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];

            renderTimeSlots();
            document.getElementById('scheduleDate').onchange = renderTimeSlots;

            switchView('scheduleView');
        }

        function renderTimeSlots() {
            const times = [];
            for (let hour = 9; hour < 17; hour++) {
                for (let min of [0, 30]) {
                    const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                    times.push(time);
                }
            }

            const html = times.map(time => `
                <div class="time-slot" onclick="selectTime('${time}', this)">${time}</div>
            `).join('');

            document.getElementById('timeSlots').innerHTML = html;
        }

        function selectTime(time, element) {
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = time;
        }

        function updateMeetingDetails() {
            const type = document.getElementById('scheduleType').value;
            const label = document.getElementById('meetingDetailLabel');
            const input = document.getElementById('meetingDetailInput');
            const hint = document.getElementById('meetingDetailHint');

            switch (type) {
                case 'video':
                    label.textContent = 'Video Call Link';
                    input.placeholder = 'Paste your video call link here';
                    input.type = 'text';
                    hint.textContent = 'e.g., Google Meet, Teams, or other video call link';
                    break;
                case 'zoom':
                    label.textContent = 'Zoom Meeting Link';
                    input.placeholder = 'https://zoom.us/j/...';
                    input.type = 'text';
                    hint.textContent = 'Paste your Zoom meeting link or meeting ID';
                    break;
                case 'facetime':
                    label.textContent = 'FaceTime Number or Email';
                    input.placeholder = '+1 (555) 123-4567 or email@icloud.com';
                    input.type = 'text';
                    hint.textContent = 'Phone number or Apple ID for FaceTime';
                    break;
                case 'phone':
                    label.textContent = 'Phone Number';
                    input.placeholder = '+1 (555) 123-4567';
                    input.type = 'tel';
                    hint.textContent = 'Enter the phone number to call';
                    break;
                case 'coffee':
                    label.textContent = 'Meeting Location';
                    input.placeholder = 'e.g., Blue Bottle Coffee, 123 Main St';
                    input.type = 'text';
                    hint.textContent = 'Name and address of the coffee shop or meeting spot';
                    break;
            }
        }

        async function sendMeetingRequest() {
            const date = document.getElementById('scheduleDate').value;
            const time = selectedTime;
            const duration = parseInt(document.getElementById('scheduleDuration').value);
            const topic = document.getElementById('scheduleTopic').value.trim();
            const type = document.getElementById('scheduleType').value;
            const meetingDetail = document.getElementById('meetingDetailInput').value.trim();

            if (!date || !time || !topic) {
                alert('Please fill in all fields');
                return;
            }

            if (!meetingDetail) {
                const detailNames = { video: 'video call link', zoom: 'Zoom link', facetime: 'FaceTime contact', phone: 'phone number', coffee: 'meeting location' };
                alert(`Please enter the ${detailNames[type] || 'meeting details'}`);
                return;
            }

            if (!selectedPerson || !currentUser) return;

            try {
                const startTime = new Date(`${date}T${time}:00`);
                const endTime = new Date(startTime.getTime() + duration * 60000);

                const { data, error } = await supabaseClient
                    .from('meetings')
                    .insert([{
                        organizer_id: currentUser.id,
                        participant_id: selectedPerson.id,
                        title: topic,
                        note: meetingDetail,
                        meeting_type: type,
                        start_time: startTime.toISOString(),
                        end_time: endTime.toISOString(),
                        status: 'pending'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                meetings.push(data);
                showToast(`Meeting request sent to ${selectedPerson.firstName}! ☕`, 'success');
                switchView('dashboardView');
                updateDashboard();
            } catch (err) {
                console.error('sendMeetingRequest:', err);
                showToast('Failed to send request: ' + err.message, 'error');
            }
        }

        // Calling
        function startCall(personName, initials) {
            document.getElementById('callPersonName').textContent = personName;
            document.getElementById('remoteName').textContent = initials;
            document.getElementById('remotePerson').textContent = personName;
            
            callDuration = 0;
            callInterval = setInterval(() => {
                callDuration++;
                const mins = Math.floor(callDuration / 60);
                const secs = callDuration % 60;
                document.getElementById('callTimer').textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);

            switchView('callView');
        }

        function endCall() {
            if (callInterval) clearInterval(callInterval);
            switchView('messagesView');
        }

        function toggleMic() {
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('muted');
        }

        function toggleVideo() {
            const btn = document.getElementById('videoBtn');
            btn.classList.toggle('muted');
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Profile Management
        function editMyProfile() {
            document.getElementById('avatarInitials').textContent = currentUser.firstName[0] + currentUser.lastName[0];
            document.getElementById('editFirstName').value = currentUser.firstName;
            document.getElementById('editLastName').value = currentUser.lastName;
            document.getElementById('editRole').value = currentUser.role || '';
            document.getElementById('editCompany').value = currentUser.company || '';
            document.getElementById('editLocation').value = currentUser.location || '';
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editIndustry').value = currentUser.industry;
            document.getElementById('editInterests').value = (currentUser.interests || []).join(', ');
            document.getElementById('editHobbies').value = (currentUser.hobbies || []).join(', ');
            document.getElementById('editGoals').value = currentUser.goals || '';
            openModal('editProfileModal');
        }

        async function saveProfile() {
            if (!currentUser) return;

            // Get all form values
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const role = document.getElementById('editRole').value;
            const company = document.getElementById('editCompany').value;
            const location = document.getElementById('editLocation').value;
            const bio = document.getElementById('editBio').value;
            const industry = document.getElementById('editIndustry').value;
            const interests = document.getElementById('editInterests').value.split(',').map(i => i.trim()).filter(Boolean);
            const hobbies = document.getElementById('editHobbies').value.split(',').map(h => h.trim()).filter(Boolean);
            const goals = document.getElementById('editGoals').value;

            try {
                // Update profile in Supabase
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        first_name: firstName,
                        last_name: lastName,
                        role,
                        company,
                        location,
                        bio,
                        industry,
                        interests,
                        hobbies,
                        goals,
                        profile_picture: currentUser.profilePicture || null,
                        resume_url: currentUser.resume || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Update local currentUser object
                currentUser.firstName = firstName;
                currentUser.lastName = lastName;
                currentUser.role = role;
                currentUser.company = company;
                currentUser.location = location;
                currentUser.bio = bio;
                currentUser.industry = industry;
                currentUser.interests = interests;
                currentUser.hobbies = hobbies;
                currentUser.goals = goals;

                alert('Profile updated successfully!');
                closeModal('editProfileModal');
                await updateDashboard();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to update profile: ' + error.message);
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX = 300;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; } }
                    else       { if (h > MAX) { w = Math.round(w * MAX / h); h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    const compressed = canvas.toDataURL('image/jpeg', 0.82);
                    currentUser.profilePicture = compressed;
                    document.getElementById('avatarPreview').innerHTML = `<img src="${compressed}" alt="Profile Picture">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function openResume(urlOrPath) {
            if (!urlOrPath) return;
            if (urlOrPath.startsWith('data:')) {
                // Legacy base64 data URL
                try {
                    const parts = urlOrPath.split(',');
                    const mime = parts[0].split(':')[1].split(';')[0];
                    const binary = atob(parts[1]);
                    const arr = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    window.open(URL.createObjectURL(blob), '_blank');
                } catch (e) { alert('Could not open resume.'); }
            } else if (urlOrPath.startsWith('http')) {
                window.open(urlOrPath, '_blank');
            } else {
                // Storage path — generate 1-hour signed URL (resumes bucket is private)
                try {
                    const { data, error } = await supabaseClient.storage.from('resumes').createSignedUrl(urlOrPath, 3600);
                    if (error) throw error;
                    window.open(data.signedUrl, '_blank');
                } catch (e) { showToast('Could not open resume: ' + e.message, 'error'); }
            }
        }

        function handleResumeUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.resume = e.target.result;
                    document.getElementById('resumePreview').innerHTML = `
                        <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 8px; color: #155724; font-size: 14px;">
                            ✓ Resume uploaded successfully
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        // Posts
        function createPost() {
            openModal('createPostModal');
        }

        async function publishPost() {
            if (!currentUser) {
                alert('Please log in to create a post');
                return;
            }

            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                alert('Please write something!');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('posts')
                    .insert([{
                        author_id: currentUser.id,
                        content
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Add to local posts array
                posts.unshift({
                    ...data,
                    author: `${currentUser.firstName} ${currentUser.lastName}`,
                    date: 'Just now'
                });

                document.getElementById('postContent').value = '';
                closeModal('createPostModal');
                alert('Post published successfully!');

                // Refresh feed if we're on it
                if (document.getElementById('feedView').classList.contains('active')) {
                    await renderFeed();
                }
            } catch (error) {
                console.error('Error publishing post:', error);
                alert('Failed to publish post: ' + error.message);
            }
        }

        async function likePost(postId) {
            if (!currentUser) {
                alert('Please log in to like posts');
                return;
            }

            // Handle mock posts locally
            if (String(postId).startsWith('mock-')) {
                const post = posts.find(p => String(p.id) === String(postId));
                if (post) {
                    post.likes_count = (post.likes_count || 0) + 1;
                    await renderFeed();
                }
                return;
            }

            try {
                const { data: existing } = await supabaseClient
                    .from('post_likes')
                    .select('id')
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabaseClient
                        .from('post_likes')
                        .delete()
                        .eq('id', existing.id);
                } else {
                    await supabaseClient
                        .from('post_likes')
                        .insert([{
                            post_id: postId,
                            user_id: currentUser.id
                        }]);
                }

                await renderFeed();
            } catch (error) {
                console.error('Error liking post:', error);
                alert('Failed to like post: ' + error.message);
            }
        }

        function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (!section) return;
            if (section.style.display === 'none') {
                section.style.display = 'block';
                loadComments(postId);
            } else {
                section.style.display = 'none';
            }
        }

        // Store mock comments locally
        const mockComments = {};

        async function loadComments(postId) {
            const container = document.getElementById(`comments-list-${postId}`);
            if (!container) return;

            // Handle mock posts locally
            if (String(postId).startsWith('mock-')) {
                const comments = mockComments[postId] || [];
                container.innerHTML = comments.map(c => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 13px;">
                        <strong>${c.author}</strong>
                        <p style="margin: 0.25rem 0;">${c.content}</p>
                    </div>
                `).join('') || '<p style="font-size: 13px; color: #999;">No comments yet. Be the first!</p>';
                return;
            }

            try {
                const { data: comments, error } = await supabaseClient
                    .from('post_comments')
                    .select('*, profiles(first_name, last_name)')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                container.innerHTML = (comments || []).map(c => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 13px;">
                        <strong>${c.profiles.first_name} ${c.profiles.last_name}</strong>
                        <p style="margin: 0.25rem 0;">${c.content}</p>
                    </div>
                `).join('') || '<p style="font-size: 13px; color: #999;">No comments yet. Be the first!</p>';
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        async function submitComment(postId) {
            if (!currentUser) return;
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;

            // Handle mock posts locally
            if (String(postId).startsWith('mock-')) {
                if (!mockComments[postId]) mockComments[postId] = [];
                mockComments[postId].push({
                    author: `${currentUser.firstName} ${currentUser.lastName}`,
                    content: text
                });
                input.value = '';
                await loadComments(postId);
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('post_comments')
                    .insert([{ post_id: postId, user_id: currentUser.id, content: text }]);

                if (error) throw error;
                input.value = '';
                await loadComments(postId);
            } catch (error) {
                console.error('Error posting comment:', error);
                alert('Failed to post comment: ' + error.message);
            }
        }

        function sharePost(postId) {
            const post = posts.find(p => String(p.id) === String(postId));
            if (!post) return;

            if (navigator.share) {
                navigator.share({
                    title: 'First Sip Post',
                    text: post.content.substring(0, 100),
                    url: window.location.href
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(post.content).then(() => {
                    alert('Post content copied to clipboard!');
                }).catch(() => {
                    alert('Unable to share.');
                });
            }
        }

        // ===== FEED FUNCTIONS =====
        let activeFeedTab = 'connections';

        function switchFeedTab(tab) {
            activeFeedTab = tab;
            document.getElementById('feedTabConnections').classList.toggle('active', tab === 'connections');
            document.getElementById('feedTabGroups').classList.toggle('active', tab === 'groups');
            renderFeed();
        }

        async function renderFeed() {
            const feedPosts = document.getElementById('feedPosts');

            if (activeFeedTab === 'groups') {
                await renderGroupsFeedTab(feedPosts);
                return;
            }

            // --- Connections feed ---
            const connectedIds = new Set();
            connections.forEach(c => {
                if (c.user_id === currentUser.id) connectedIds.add(c.connected_user_id);
                if (c.connected_user_id === currentUser.id) connectedIds.add(c.user_id);
            });

            let allPosts = [...posts];
            users.forEach(u => {
                if (connectedIds.has(u.id) && u.posts && u.posts.length > 0) {
                    u.posts.forEach(p => {
                        if (!allPosts.find(ep => ep.id === p.id)) {
                            allPosts.push({ ...p, author_id: u.id, author: `${u.firstName} ${u.lastName}` });
                        }
                    });
                }
            });

            const feedItems = allPosts.filter(p => p.author_id !== currentUser.id && connectedIds.has(p.author_id));

            if (feedItems.length === 0) {
                feedPosts.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🤝</div>
                        <p>Connect with people to see their posts here!</p>
                        <button class="btn btn-primary" onclick="switchView('discoverView')" style="margin-top:1rem;">Discover People</button>
                    </div>`;
                return;
            }

            feedPosts.innerHTML = feedItems
                .sort((a, b) => new Date(b.created_at || b.date) - new Date(a.created_at || a.date))
                .map(post => {
                    const author = users.find(u => u.id === post.author_id) || currentUser;
                    const authorName = author ? `${author.firstName} ${author.lastName}` : post.author;
                    const avatarContent = author && author.profilePicture
                        ? `<img src="${author.profilePicture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                        : author ? `${author.firstName[0]}${author.lastName[0]}` : '?';
                    return `
                        <div class="post-card">
                            <div class="post-header">
                                <div style="display:flex;align-items:center;gap:1rem;cursor:pointer;" onclick="viewProfile('${post.author_id}')">
                                    <div class="person-avatar" style="width:48px;height:48px;font-size:20px;">${avatarContent}</div>
                                    <div><strong>${authorName}</strong><p class="post-meta">${post.date || 'Just now'}</p></div>
                                </div>
                            </div>
                            <div class="post-content">${post.content}</div>
                            <div class="post-actions">
                                <button class="post-action-btn" onclick="likePost('${post.id}')">👍 ${post.likes_count || 0} Likes</button>
                                <button class="post-action-btn" onclick="toggleComments('${post.id}')">💬 Comment</button>
                                <button class="post-action-btn" onclick="sharePost('${post.id}')">🔄 Share</button>
                            </div>
                            <div id="comments-${post.id}" style="display:none;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);">
                                <div id="comments-list-${post.id}" style="margin-bottom:0.75rem;"></div>
                                <div style="display:flex;gap:0.5rem;">
                                    <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);" onkeypress="if(event.key==='Enter') submitComment('${post.id}')">
                                    <button class="btn btn-primary btn-sm" onclick="submitComment('${post.id}')">Post</button>
                                </div>
                            </div>
                        </div>`;
                }).join('');
        }

        async function renderGroupsFeedTab(container) {
            if (myGroupIds.size === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <p>Join a group to see posts from your communities here!</p>
                        <button class="btn btn-primary" onclick="switchView('groupsView')" style="margin-top:1rem;">Browse Communities</button>
                    </div>`;
                return;
            }

            try {
                const groupIdsList = Array.from(myGroupIds);
                const { data: postsData, error } = await supabaseClient
                    .from('posts')
                    .select('*, profiles!posts_author_id_fkey(id, first_name, last_name), groups!posts_group_id_fkey(name)')
                    .in('group_id', groupIdsList)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                if (!postsData || postsData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">✍️</div>
                            <p>No posts in your groups yet — be the first to share something!</p>
                        </div>`;
                    return;
                }

                container.innerHTML = postsData.map(post => {
                    const authorName = post.profiles ? `${post.profiles.first_name} ${post.profiles.last_name}` : 'Member';
                    const groupName = post.groups ? post.groups.name : '';
                    const timeAgo = post.created_at ? getTimeAgo(post.created_at) : 'Recently';
                    const authorId = post.profiles ? post.profiles.id : null;
                    return `
                        <div class="post-card">
                            <div class="post-header">
                                <div style="display:flex;align-items:center;gap:1rem;" ${authorId ? `onclick="viewProfile('${authorId}')" style="cursor:pointer;"` : ''}>
                                    <div class="person-avatar" style="width:48px;height:48px;font-size:20px;">${authorName[0]}</div>
                                    <div>
                                        <strong>${authorName}</strong>
                                        <p class="post-meta">${timeAgo} · <span style="color:var(--primary);font-weight:600;">${groupName}</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="post-content">${post.content}</div>
                            <div class="post-actions">
                                <button class="post-action-btn" id="gflike-${post.id}" onclick="likeFeedGroupPost('${post.id}', this)">👍 <span id="gflikecount-${post.id}">${post.likes_count || 0}</span> Likes</button>
                                <button class="post-action-btn" onclick="toggleFeedGroupComments('${post.id}')">💬 Comment</button>
                            </div>
                            <div id="gfcomments-${post.id}" style="display:none;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);">
                                <div id="gfcomments-list-${post.id}" style="margin-bottom:0.75rem;"></div>
                                <div style="display:flex;gap:0.5rem;">
                                    <input type="text" id="gfcomment-input-${post.id}" placeholder="Write a comment..." style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);" onkeypress="if(event.key==='Enter') submitFeedGroupComment('${post.id}')">
                                    <button class="btn btn-primary btn-sm" onclick="submitFeedGroupComment('${post.id}')">Post</button>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            } catch (err) {
                console.error('Error loading group feed:', err);
                container.innerHTML = '<div class="empty-state"><p>Failed to load group posts.</p></div>';
            }
        }

        async function likeFeedGroupPost(postId, btn) {
            if (!currentUser) return;
            try {
                const { data: existing } = await supabaseClient
                    .from('post_likes')
                    .select('id')
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabaseClient.from('post_likes').delete().eq('id', existing.id);
                } else {
                    await supabaseClient.from('post_likes').insert([{ post_id: postId, user_id: currentUser.id }]);
                }

                const countEl = document.getElementById(`gflikecount-${postId}`);
                if (countEl) {
                    const cur = parseInt(countEl.textContent) || 0;
                    countEl.textContent = existing ? Math.max(0, cur - 1) : cur + 1;
                }
                if (btn) {
                    btn.style.color = existing ? '' : 'var(--primary)';
                    btn.style.fontWeight = existing ? '' : '700';
                }
            } catch (err) {
                console.error('Error liking post:', err);
            }
        }

        function toggleFeedGroupComments(postId) {
            const el = document.getElementById(`gfcomments-${postId}`);
            if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function submitFeedGroupComment(postId) {
            if (!currentUser) return;
            const input = document.getElementById(`gfcomment-input-${postId}`);
            if (!input || !input.value.trim()) return;
            const text = input.value.trim();

            try {
                const { error } = await supabaseClient
                    .from('post_comments')
                    .insert([{ post_id: postId, user_id: currentUser.id, content: text }]);

                if (error) throw error;

                const listEl = document.getElementById(`gfcomments-list-${postId}`);
                if (listEl) {
                    listEl.innerHTML += `
                        <div style="background:var(--bg-light);border-radius:8px;padding:8px 12px;margin-bottom:6px;font-size:13px;">
                            <strong>${currentUser.firstName}:</strong> ${text}
                        </div>`;
                }
                input.value = '';
            } catch (err) {
                console.error('Error posting comment:', err);
            }
        }

        // ===== SMART RECOMMENDATIONS =====
        function getSmartRecommendations() {
            if (!currentUser) return [];

            const userInterests = currentUser.interests || [];
            const userHobbies = currentUser.hobbies || [];
            const userIndustry = currentUser.industry;

            return users.filter(u => {
                if (u.id === currentUser.id) return false;
                const isConnected = connections.find(c =>
                    (c.user_id === currentUser.id && c.connected_user_id === u.id) ||
                    (c.connected_user_id === currentUser.id && c.user_id === u.id));
                return !isConnected;
            }).map(user => {
                let score = 0;
                const reasons = [];

                // Field of study match (highest priority)
                if (user.industry === userIndustry) {
                    score += 50;
                    reasons.push(`Same field: ${userIndustry}`);
                }

                // Interests match
                const commonInterests = userInterests.filter(interest =>
                    user.interests && user.interests.includes(interest)
                );
                if (commonInterests.length > 0) {
                    score += commonInterests.length * 20;
                    reasons.push(`Shared interests: ${commonInterests.join(', ')}`);
                }

                // Hobbies match
                if (user.hobbies && userHobbies.length > 0) {
                    const commonHobbies = userHobbies.filter(hobby =>
                        user.hobbies.includes(hobby)
                    );
                    if (commonHobbies.length > 0) {
                        score += commonHobbies.length * 15;
                        reasons.push(`Shared hobbies: ${commonHobbies.join(', ')}`);
                    }
                }

                // Graduation year match
                if (user.location && currentUser.location && user.location === currentUser.location) {
                    score += 10;
                    reasons.push(`Same class: ${user.location}`);
                }

                // School match
                if (user.company && currentUser.company && user.company.toLowerCase() === currentUser.company.toLowerCase()) {
                    score += 25;
                    reasons.push(`Same school: ${user.company}`);
                }

                // Career goals keyword match
                if (user.goals && currentUser.goals) {
                    const userGoalWords = currentUser.goals.toLowerCase().split(/\s+/).filter(w => w.length > 3);
                    const theirGoalWords = user.goals.toLowerCase().split(/\s+/).filter(w => w.length > 3);
                    const commonGoalWords = userGoalWords.filter(word => theirGoalWords.includes(word));
                    if (commonGoalWords.length > 0) {
                        score += Math.min(commonGoalWords.length * 10, 30);
                        reasons.push('Aligned career goals');
                    }
                }

                // Mentorship potential (upperclassmen/alumni mentoring underclassmen)
                if (user.role && currentUser.role && user.industry === userIndustry) {
                    const seniorKeywords = ['senior', 'recent grad', 'junior', 'lead', 'head', 'director', 'vp', 'chief', 'principal', 'staff', 'manager'];
                    const userIsSenior = seniorKeywords.some(k => currentUser.role.toLowerCase().includes(k));
                    const theyAreSenior = seniorKeywords.some(k => user.role.toLowerCase().includes(k));
                    if (userIsSenior !== theyAreSenior) {
                        score += 15;
                        reasons.push('Mentorship potential');
                    }
                }

                return {
                    user,
                    score,
                    reasons
                };
            })
            .sort((a, b) => b.score - a.score); // Sort by score descending; show all
        }

        function renderRecommendations() {
            const recommendations = getSmartRecommendations();

            if (recommendations.length === 0) return '';

            return `
                <div style="margin-bottom: 2rem;">
                    <h2 style="margin-bottom: 1rem;">✨ Recommended For You</h2>
                    <div class="grid">
                        ${recommendations.slice(0, 3).map(item => {
                            const user = item.user;
                            const fn = user.firstName || '?';
                            const ln = user.lastName || '?';
                            const isConnected = connections.find(c =>
                                (c.user_id === currentUser.id && c.connected_user_id === user.id) ||
                                (c.connected_user_id === currentUser.id && c.user_id === user.id));
                            const isPending = sentRequests.find(c => c.connected_user_id === user.id);
                            const hasRequestedMe = pendingRequests.find(c => (c.sender_id || c.user_id) === user.id);
                            const avatarContent = user.profilePicture
                                ? `<img src="${user.profilePicture}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                                : `${fn[0]}${ln[0]}`;

                            let recActionBtn;
                            if (isConnected) {
                                recActionBtn = `<button class="btn btn-secondary btn-sm" onclick="startMessage('${user.id}')" style="flex: 1;">Message</button>`;
                            } else if (hasRequestedMe) {
                                recActionBtn = `<button class="btn btn-accent btn-sm" onclick="acceptConnection('${hasRequestedMe.id}')" style="flex: 1;">Accept Request</button>`;
                            } else if (isPending) {
                                recActionBtn = `<button class="btn btn-secondary btn-sm" disabled style="flex: 1; opacity: 0.6;">Request Sent</button>`;
                            } else {
                                recActionBtn = `<button class="btn btn-accent btn-sm" onclick="connectUser('${user.id}')" style="flex: 1;">Connect</button>`;
                            }

                            return `
                                <div class="card person-card">
                                    <div style="background: linear-gradient(135deg, var(--accent), var(--primary)); padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <p style="font-size: 11px; color: white; margin: 0; text-align: center;">${item.score > 0 ? `⭐ ${item.score}% Match` : '👋 New Member'}</p>
                                    </div>
                                    <div class="person-avatar" style="width: 70px; height: 70px; font-size: 28px; margin: 0 auto 1rem;">${avatarContent}</div>
                                    <h3>${fn} ${ln}</h3>
                                    <p class="role">${user.role || user.industry || ''}</p>
                                    <div style="text-align: left; margin: 1rem 0; padding: 0.75rem; background: var(--bg-light); border-radius: 8px;">
                                        <p style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 0.5rem;">Why we suggest ${fn}:</p>
                                        ${item.reasons.map(reason => `<p style="font-size: 11px; color: #666; margin: 0.25rem 0;">• ${reason}</p>`).join('')}
                                    </div>
                                    <div class="profile-actions">
                                        <button class="btn btn-primary btn-sm" onclick="viewProfile('${user.id}')" style="flex: 1;">View Profile</button>
                                        ${recActionBtn}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // (Recommendations and hobbies integrated into original functions above)

        // ===== AVAILABILITY FUNCTIONS =====
        async function renderAvailability() {
            if (!currentUser) return;

            try {
                const { data: availability, error } = await supabaseClient
                    .from('availability')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('day_of_week', { ascending: true })
                    .order('start_time', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('availabilitySlots');

                if (!availability || availability.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No availability set. Add your available times below.</p>
                        </div>
                    `;
                    return;
                }

                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                container.innerHTML = availability.map(slot => `
                    <div class="meeting-card" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <strong>${days[slot.day_of_week]}</strong>
                            <p style="font-size: 14px; color: #666; margin: 0.25rem 0;">
                                ${slot.start_time} - ${slot.end_time}
                            </p>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteAvailabilitySlot('${slot.id}')">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error rendering availability:', error);
            }
        }

        async function addAvailabilitySlot() {
            if (!currentUser) {
                alert('Please log in');
                return;
            }

            const day = document.getElementById('availabilityDay').value;
            const startTime = document.getElementById('availabilityStartTime').value;
            const endTime = document.getElementById('availabilityEndTime').value;

            if (!startTime || !endTime) {
                alert('Please select start and end times');
                return;
            }

            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('availability')
                    .insert([{
                        user_id: currentUser.id,
                        day_of_week: parseInt(day),
                        start_time: startTime,
                        end_time: endTime,
                        is_available: true
                    }]);

                if (error) throw error;

                await renderAvailability();
                alert('Availability added!');
            } catch (error) {
                console.error('Error adding availability:', error);
                alert('Failed to add availability: ' + error.message);
            }
        }

        async function deleteAvailabilitySlot(slotId) {
            if (!currentUser) return;

            if (!confirm('Delete this availability slot?')) return;

            try {
                const { error } = await supabaseClient
                    .from('availability')
                    .delete()
                    .eq('id', slotId);

                if (error) throw error;

                await renderAvailability();
                alert('Availability deleted');
            } catch (error) {
                console.error('Error deleting availability:', error);
                alert('Failed to delete availability: ' + error.message);
            }
        }

        // ============================================
        // MY PROFILE (LinkedIn-style)
        // ============================================

        async function renderMyProfile() {
            if (!currentUser) return;
            const container = document.getElementById('myProfileContent');
            if (!container) return;

            // Fetch fresh profile from Supabase
            let profile = { ...currentUser };
            try {
                const { data: profileData } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
                if (profileData) {
                    profile = {
                        ...currentUser,
                        firstName:      profileData.first_name    || currentUser.firstName,
                        lastName:       profileData.last_name     || currentUser.lastName,
                        headline:       profileData.headline      ?? currentUser.headline,
                        bio:            profileData.bio           ?? currentUser.bio,
                        interests:      Array.isArray(profileData.interests) ? profileData.interests : (currentUser.interests || []),
                        hobbies:        Array.isArray(profileData.hobbies)   ? profileData.hobbies   : (currentUser.hobbies   || []),
                        goals:          profileData.goals         ?? currentUser.goals,
                        location:       profileData.location      ?? currentUser.location,
                        linkedinUrl:    profileData.linkedin_url  ?? currentUser.linkedinUrl,
                        profilePicture: profileData.profile_picture ?? currentUser.profilePicture,
                        resume:         profileData.resume_url    ?? currentUser.resume,
                        avatarColor:    profileData.avatar_color  || null,
                        major:          profileData.major         ?? currentUser.major,
                        industry:       profileData.industry      ?? currentUser.industry,
                        role:           profileData.role          ?? currentUser.role,
                        company:        profileData.company       ?? currentUser.company,
                        gradYear:       profileData.grad_year     ?? currentUser.gradYear,
                        isOnline:       profileData.is_online,
                        chatOpen:       profileData.chat_open,
                    };
                }
            } catch(e) { console.error('renderMyProfile fetch profile:', e); }

            // Use profile_completeness RPC for accurate percentage
            let percentage = getProfileCompletion().percentage;
            try {
                const { data: pctData } = await supabaseClient.rpc('profile_completeness', { profile_id: currentUser.id });
                if (pctData !== null && pctData !== undefined) percentage = pctData;
            } catch(e) { console.error('profile_completeness RPC:', e); }

            const now = new Date();
            const chatsCompleted = meetings.filter(m => new Date(m.date || m.start_time) < now).length;
            const upcomingCount  = meetings.filter(m => new Date(m.date || m.start_time) >= now).length;

            const initials = `${(profile.firstName || '?')[0]}${(profile.lastName || '?')[0]}`.toUpperCase();
            const avatarBg = profile.profilePicture ? 'none'
                : (profile.avatarColor || 'linear-gradient(135deg,var(--caramel),var(--espresso))');
            const avatarInner = profile.profilePicture
                ? `<img src="${profile.profilePicture}" alt="${profile.firstName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
                : initials;

            // Fetch availability
            let availRows = [];
            try {
                const { data } = await supabaseClient
                    .from('availability')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('day_of_week');
                availRows = (data || []).filter(r => r.is_available);
            } catch(e) {}

            // Build availability rows HTML
            const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const fmt = t => {
                if (!t) return '';
                const [h, m] = t.split(':');
                const hr = parseInt(h);
                return `${hr > 12 ? hr - 12 : (hr === 0 ? 12 : hr)}:${m} ${hr >= 12 ? 'PM' : 'AM'}`;
            };
            const openDaysHtml = availRows.map(r => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--latte-soft);font-size:13px;">
                    <span style="font-weight:600;width:36px;color:var(--brown);">${dayNames[r.day_of_week]}</span>
                    <span style="color:var(--muted);font-size:12.5px;">${fmt(r.start_time)} – ${fmt(r.end_time)}</span>
                    <span style="font-size:11px;font-weight:700;padding:2px 8px;border-radius:99px;background:#eaf4ee;color:#2d6a4f;">Open</span>
                </div>`).join('');
            const openDayNums = new Set(availRows.map(r => r.day_of_week));
            const closedHtml  = [0,1,2,3,4,5,6].filter(d => !openDayNums.has(d)).slice(0, 2).map(d => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--latte-soft);font-size:13px;">
                    <span style="font-weight:600;width:36px;color:var(--brown);">${dayNames[d]}</span>
                    <span style="color:var(--muted);font-size:12.5px;">—</span>
                    <span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:99px;background:var(--latte-soft);color:var(--muted);">Closed</span>
                </div>`).join('');

            // Interests + hobbies tags
            const allTags = [...(profile.interests || []), ...(profile.hobbies || [])];
            const tagsHtml = allTags.length
                ? allTags.map(t => `<span style="background:var(--latte-soft);border:1px solid var(--latte);color:var(--brown);border-radius:8px;padding:5px 12px;font-size:12.5px;font-weight:500;">${t}</span>`).join('')
                : `<span style="font-size:13px;color:var(--muted);font-style:italic;">No interests added yet. <span onclick="editMyProfile()" style="color:var(--caramel);cursor:pointer;font-style:normal;font-weight:600;">Add some →</span></span>`;

            // Completion checklist
            const compItems = [
                { label: 'Photo uploaded',   done: !!profile.profilePicture },
                { label: 'Bio written',      done: !!(profile.bio && profile.bio.trim()) },
                { label: 'Interests added',  done: !!(profile.interests && profile.interests.length > 0) },
                { label: 'Availability set', done: availRows.length > 0 },
                { label: 'LinkedIn URL',     done: !!(profile.linkedinUrl && profile.linkedinUrl.trim()) },
                { label: 'Resume uploaded',  done: !!profile.resume },
                { label: 'Career goals',     done: !!(profile.goals && profile.goals.trim()) },
            ];

            // Hero chips
            const chips = [
                profile.company  ? `🎓 ${profile.company}`                         : null,
                profile.gradYear ? `📅 Class of ${profile.gradYear}`               : null,
                (profile.major || profile.industry) ? `💼 ${profile.major || profile.industry}` : null,
            ].filter(Boolean);

            // Cache data for preview modal
            _myProfilePreviewData = { profile, availRows, tagsHtml, chips };

            container.innerHTML = `
                <style>
                    @keyframes mpFillBar { from { width:0% } to { width:${percentage}%; } }
                    .mp2-btn  { transition: transform .18s, box-shadow .18s; }
                    .mp2-btn:hover  { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(28,18,8,.22) !important; }
                    .mp2-ghost { transition: border-color .15s, color .15s; }
                    .mp2-ghost:hover { border-color: var(--caramel) !important; color: var(--caramel) !important; }
                    .mp2-card  { transition: box-shadow .15s; }
                    .mp2-card:hover  { box-shadow: 0 6px 28px rgba(107,63,42,.14) !important; }
                    .mp2-stat:hover  { background: var(--latte-soft) !important; }
                    .mp2-resume:hover { border-color: var(--caramel) !important; background: #fef3e2 !important; }
                    @media (max-width: 720px) {
                        .mp2-lower { grid-template-columns: 1fr !important; }
                        .mp2-stats { flex-wrap: wrap; }
                        .mp2-stats > div { min-width: 33%; }
                    }
                </style>

                <!-- Page header -->
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
                    <div>
                        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--muted);margin-bottom:4px;">Your presence on First Sip</div>
                        <h1 style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--espresso);line-height:1.2;">My <em style="font-style:italic;color:var(--caramel);">Profile</em></h1>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="mp2-ghost" onclick="showProfilePreview()" style="background:transparent;border:1.5px solid var(--latte);border-radius:10px;padding:9px 16px;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;font-family:'DM Sans',sans-serif;">👁 Preview</button>
                        <button class="mp2-btn" onclick="editMyProfile()" style="padding:10px 20px;background:var(--espresso);color:var(--cream);border:none;border-radius:10px;font-size:13.5px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;box-shadow:0 3px 12px rgba(28,18,8,.2);">✏️ Edit Profile</button>
                    </div>
                </div>

                <!-- HERO CARD -->
                <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;margin-bottom:20px;">
                    <div style="height:96px;background:linear-gradient(135deg,var(--espresso) 0%,var(--caramel) 60%,#e8c49a 100%);position:relative;">
                        <div style="position:absolute;inset:0;opacity:.12;background-image:radial-gradient(circle at 20% 50%,#fff 1px,transparent 1px),radial-gradient(circle at 80% 30%,#fff 1px,transparent 1px),radial-gradient(circle at 50% 80%,#fff 1px,transparent 1px);background-size:40px 40px;"></div>
                    </div>
                    <div style="padding:0 28px 0;position:relative;">
                        <div style="display:inline-block;margin-top:-36px;margin-bottom:12px;position:relative;">
                            <div onclick="editMyProfile()" style="width:72px;height:72px;border-radius:50%;background:${avatarBg};display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:#fff;border:3px solid var(--card);box-shadow:0 2px 10px rgba(107,63,42,.22);cursor:pointer;overflow:hidden;position:relative;"
                                onmouseover="this.querySelector('.av-ov').style.opacity=1"
                                onmouseout="this.querySelector('.av-ov').style.opacity=0">
                                ${avatarInner}
                                <div class="av-ov" style="position:absolute;inset:0;border-radius:50%;background:rgba(107,63,42,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;font-size:18px;color:#fff;">📷</div>
                            </div>
                            <div style="width:14px;height:14px;background:#4caf50;border:2.5px solid var(--card);border-radius:50%;position:absolute;bottom:3px;right:3px;"></div>
                        </div>
                        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;padding-bottom:20px;">
                            <div>
                                <div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--espresso);line-height:1.2;margin-bottom:3px;">${profile.firstName} ${profile.lastName}</div>
                                <div style="font-size:13.5px;color:var(--brown);font-weight:500;margin-bottom:8px;">${profile.headline || [profile.role, profile.industry].filter(Boolean).join(' · ') || 'Add a headline in Settings'}</div>
                                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                    ${chips.map(c => `<span style="display:inline-flex;align-items:center;gap:4px;background:var(--latte-soft);border:1px solid var(--latte);border-radius:99px;padding:3px 10px;font-size:12px;color:var(--brown);font-weight:500;">${c}</span>`).join('')}
                                    <span style="display:inline-flex;align-items:center;gap:4px;background:#eaf4ee;border:1px solid #b7dfc9;border-radius:99px;padding:3px 10px;font-size:12px;color:#2d6a4f;font-weight:500;">🟢 Open to chats</span>
                                </div>
                                ${profile.linkedinUrl
                                    ? `<a href="${/^https?:\/\//i.test(profile.linkedinUrl) ? profile.linkedinUrl : 'https://' + profile.linkedinUrl}" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:7px;margin-top:10px;padding:6px 13px;background:#f0f4ff;border:1px solid #c0cff5;border-radius:8px;font-size:13px;font-weight:500;color:#2563eb;text-decoration:none;transition:background .15s;" onmouseover="this.style.background='#e0ebff'" onmouseout="this.style.background='#f0f4ff'"><svg width="14" height="14" viewBox="0 0 24 24" fill="#2563eb"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>LinkedIn Profile</a>`
                                    : `<span onclick="editMyProfile()" style="display:inline-flex;align-items:center;gap:6px;margin-top:10px;padding:6px 13px;background:var(--latte-soft);border:1px dashed var(--latte);border-radius:8px;font-size:12.5px;color:var(--muted);cursor:pointer;transition:border-color .15s,color .15s;" onmouseover="this.style.borderColor='var(--caramel)';this.style.color='var(--caramel)'" onmouseout="this.style.borderColor='var(--latte)';this.style.color='var(--muted)'">+ Add LinkedIn URL</span>`}
                            </div>
                            <button class="mp2-ghost" style="background:transparent;border:1.5px solid var(--latte);border-radius:10px;padding:8px 16px;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;font-family:'DM Sans',sans-serif;flex-shrink:0;margin-top:2px;" onclick="showToast('Share link copied!','success')">Share Profile</button>
                        </div>
                        <!-- Stats bar -->
                        <div class="mp2-stats" style="display:flex;border-top:1px solid var(--latte);margin:0 -28px;">
                            <div class="mp2-stat" onclick="switchView('networkView')" style="flex:1;text-align:center;padding:14px 8px;border-right:1px solid var(--latte);cursor:pointer;transition:background .15s;">
                                <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--caramel);line-height:1;margin-bottom:3px;">${connections.length}</div>
                                <div style="font-size:11.5px;color:var(--muted);font-weight:500;">Connections</div>
                            </div>
                            <div class="mp2-stat" style="flex:1;text-align:center;padding:14px 8px;border-right:1px solid var(--latte);transition:background .15s;">
                                <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--caramel);line-height:1;margin-bottom:3px;">${chatsCompleted}</div>
                                <div style="font-size:11.5px;color:var(--muted);font-weight:500;">Chats Done</div>
                            </div>
                            <div class="mp2-stat" style="flex:1;text-align:center;padding:14px 8px;border-right:1px solid var(--latte);transition:background .15s;">
                                <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--caramel);line-height:1;margin-bottom:3px;">${upcomingCount}</div>
                                <div style="font-size:11.5px;color:var(--muted);font-weight:500;">Upcoming</div>
                            </div>
                            <div class="mp2-stat" style="flex:1;text-align:center;padding:14px 8px;transition:background .15s;">
                                <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--caramel);line-height:1;margin-bottom:3px;">${percentage}%</div>
                                <div style="font-size:11.5px;color:var(--muted);font-weight:500;">Profile Complete</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOWER TWO-COLUMN -->
                <div class="mp2-lower" style="display:grid;grid-template-columns:1fr 300px;gap:20px;">

                    <!-- LEFT: About / Interests / Goals / Badges -->
                    <div style="display:flex;flex-direction:column;gap:20px;">

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);display:flex;align-items:center;justify-content:space-between;">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">About</h3>
                                <button onclick="editMyProfile()" style="background:none;border:none;color:var(--caramel);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">Edit</button>
                            </div>
                            <div style="padding:20px 22px;">
                                ${profile.bio
                                    ? `<p style="font-size:14px;color:var(--brown);line-height:1.7;margin:0;">${profile.bio}</p>`
                                    : `<p style="font-size:14px;color:var(--muted);font-style:italic;margin:0;">No bio added yet. <span onclick="editMyProfile()" style="color:var(--caramel);font-weight:600;cursor:pointer;font-style:normal;">Add one →</span></p>`}
                            </div>
                        </div>

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);display:flex;align-items:center;justify-content:space-between;">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">Interests &amp; Passions</h3>
                                <button onclick="editMyProfile()" style="background:none;border:none;color:var(--caramel);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">Edit</button>
                            </div>
                            <div style="padding:20px 22px;"><div style="display:flex;flex-wrap:wrap;gap:7px;">${tagsHtml}</div></div>
                        </div>

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);display:flex;align-items:center;justify-content:space-between;">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">Career Goals</h3>
                                <button onclick="editMyProfile()" style="background:none;border:none;color:var(--caramel);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">Edit</button>
                            </div>
                            <div style="padding:20px 22px;">
                                ${profile.goals
                                    ? `<p style="font-size:14px;color:var(--brown);line-height:1.7;margin:0;border-left:3px solid var(--caramel);padding-left:14px;">${profile.goals}</p>`
                                    : `<p style="font-size:14px;color:var(--muted);font-style:italic;margin:0;">No goals added yet. <span onclick="editMyProfile()" style="color:var(--caramel);font-weight:600;cursor:pointer;font-style:normal;">Add yours →</span></p>`}
                            </div>
                        </div>

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">🏅 Badges</h3>
                            </div>
                            <div style="padding:20px 22px;"><div class="badge-grid" id="myProfileBadgesView"></div></div>
                        </div>

                    </div>

                    <!-- RIGHT: Strength / Availability / Resume -->
                    <div style="display:flex;flex-direction:column;gap:20px;">

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">Profile Strength</h3>
                            </div>
                            <div style="padding:20px 22px;">
                                <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);">
                                    <span>Progress</span>
                                    <strong style="color:var(--caramel);font-weight:700;">${percentage}% complete</strong>
                                </div>
                                <div style="background:var(--latte-soft);border-radius:99px;height:8px;overflow:hidden;margin:10px 0 6px;">
                                    <div style="height:100%;width:${percentage}%;background:linear-gradient(90deg,var(--espresso),var(--caramel));border-radius:99px;animation:mpFillBar 1.2s cubic-bezier(0.22,1,0.36,1) forwards;"></div>
                                </div>
                                <div style="font-size:11px;color:var(--muted);margin-bottom:14px;">Complete profiles get 3× more requests</div>
                                <div style="display:flex;flex-direction:column;gap:8px;">
                                    ${compItems.map(item => `
                                        <div style="display:flex;align-items:center;gap:10px;font-size:13px;color:${item.done ? 'var(--brown)' : 'var(--muted)'};">
                                            <span style="width:7px;height:7px;border-radius:50%;flex-shrink:0;background:${item.done ? '#2d6a4f' : 'transparent'};border:${item.done ? 'none' : '1.5px solid var(--muted)'};display:inline-block;"></span>
                                            ${item.label}
                                        </div>`).join('')}
                                </div>
                                <button onclick="switchView('settingsView')" class="mp2-btn" style="width:100%;margin-top:16px;padding:10px;background:var(--espresso);color:var(--cream);border:none;border-radius:10px;font-size:13.5px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;text-align:center;box-shadow:0 3px 12px rgba(28,18,8,.2);">✏️ Complete Profile</button>
                            </div>
                        </div>

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);display:flex;align-items:center;justify-content:space-between;">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">Availability</h3>
                                <button onclick="switchView('settingsView')" style="background:none;border:none;color:var(--caramel);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">Edit</button>
                            </div>
                            <div style="padding:14px 22px 20px;">
                                ${availRows.length > 0
                                    ? openDaysHtml + closedHtml
                                    : `<p style="font-size:13px;color:var(--muted);font-style:italic;padding:6px 0;">No availability set. <span onclick="switchView('settingsView')" style="color:var(--caramel);font-weight:600;cursor:pointer;font-style:normal;">Set hours →</span></p>`}
                                ${availRows.length > 0 ? `
                                <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
                                    <span style="display:inline-flex;align-items:center;gap:4px;background:var(--latte-soft);border:1px solid var(--latte);border-radius:99px;padding:3px 10px;font-size:12px;color:var(--brown);font-weight:500;">💻 Virtual</span>
                                    <span style="display:inline-flex;align-items:center;gap:4px;background:var(--latte-soft);border:1px solid var(--latte);border-radius:99px;padding:3px 10px;font-size:12px;color:var(--brown);font-weight:500;">☕ In-person</span>
                                </div>` : ''}
                            </div>
                        </div>

                        <div class="mp2-card" style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                            <div style="padding:18px 22px 14px;border-bottom:1px solid var(--latte);display:flex;align-items:center;justify-content:space-between;">
                                <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--espresso);">Resume</h3>
                                ${profile.resume ? `<button onclick="editMyProfile()" style="background:none;border:none;color:var(--caramel);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">Replace</button>` : ''}
                            </div>
                            <div style="padding:20px 22px;">
                                ${profile.resume
                                    ? `<div class="mp2-resume" onclick="openResume('${profile.resume}')" style="display:flex;align-items:center;gap:12px;background:var(--latte-soft);border:1px solid var(--latte);border-radius:10px;padding:12px 16px;cursor:pointer;transition:all .15s;">
                                        <span style="font-size:22px;">📄</span>
                                        <div>
                                            <div style="font-size:13.5px;font-weight:600;color:var(--espresso);">${profile.firstName} ${profile.lastName} — Resume</div>
                                            <div style="font-size:11.5px;color:var(--muted);margin-top:1px;">Click to view</div>
                                        </div>
                                       </div>
                                       <p style="font-size:12px;color:var(--muted);margin-top:10px;">Only visible to connections you approve.</p>`
                                    : `<p style="font-size:13px;color:var(--muted);font-style:italic;">No resume uploaded. <span onclick="editMyProfile()" style="color:var(--caramel);font-weight:600;cursor:pointer;font-style:normal;">Upload one →</span></p>`}
                            </div>
                        </div>

                    </div>
                </div>
            `;

            setTimeout(() => renderBadges('myProfileBadgesView'), 50);
        }

        function showProfilePreview() {
            const modal = document.getElementById('profilePreviewModal');
            const body  = document.getElementById('profilePreviewBody');
            if (!modal || !body) return;
            if (!_myProfilePreviewData) { showToast('Profile not loaded yet.', 'info'); return; }

            const { profile, availRows, tagsHtml, chips } = _myProfilePreviewData;
            const initials   = `${(profile.firstName||'?')[0]}${(profile.lastName||'?')[0]}`.toUpperCase();
            const avatarBg   = profile.profilePicture ? 'none' : (profile.avatarColor || 'linear-gradient(135deg,var(--caramel),var(--espresso))');
            const avatarInner = profile.profilePicture
                ? `<img src="${profile.profilePicture}" alt="${profile.firstName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
                : initials;

            const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const fmt = t => { if (!t) return ''; const [h,m]=t.split(':'); const hr=parseInt(h); return `${hr>12?hr-12:(hr===0?12:hr)}:${m} ${hr>=12?'PM':'AM'}`; };
            const availHtml = availRows.map(r => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--latte-soft);font-size:13px;">
                    <span style="font-weight:600;width:36px;color:var(--brown);">${dayNames[r.day_of_week]}</span>
                    <span style="color:var(--muted);font-size:12.5px;">${fmt(r.start_time)} – ${fmt(r.end_time)}</span>
                    <span style="font-size:11px;font-weight:700;padding:2px 8px;border-radius:99px;background:#eaf4ee;color:#2d6a4f;">Open</span>
                </div>`).join('');

            body.innerHTML = `
                <div style="background:rgba(192,124,58,0.1);border:1px solid var(--latte);border-radius:12px;padding:12px 18px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:20px;">👁</span>
                    <div>
                        <div style="font-size:13px;font-weight:600;color:var(--espresso);">Preview Mode</div>
                        <div style="font-size:12px;color:var(--muted);">This is how your profile appears to other people on First Sip.</div>
                    </div>
                </div>

                <div style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;margin-bottom:16px;">
                    <div style="height:80px;background:linear-gradient(135deg,var(--espresso) 0%,var(--caramel) 60%,#e8c49a 100%);"></div>
                    <div style="padding:0 24px 22px;position:relative;">
                        <div style="display:inline-block;margin-top:-32px;margin-bottom:10px;">
                            <div style="width:64px;height:64px;border-radius:50%;background:${avatarBg};display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:#fff;border:3px solid var(--card);box-shadow:0 2px 10px rgba(107,63,42,.22);overflow:hidden;">${avatarInner}</div>
                        </div>
                        <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--espresso);line-height:1.2;margin-bottom:4px;">${profile.firstName} ${profile.lastName}</div>
                        <div style="font-size:13.5px;color:var(--brown);font-weight:500;margin-bottom:10px;">${profile.headline || [profile.role,profile.industry].filter(Boolean).join(' · ') || ''}</div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;">
                            ${chips.map(c => `<span style="display:inline-flex;align-items:center;gap:4px;background:var(--latte-soft);border:1px solid var(--latte);border-radius:99px;padding:3px 10px;font-size:12px;color:var(--brown);font-weight:500;">${c}</span>`).join('')}
                            <span style="display:inline-flex;align-items:center;gap:4px;background:#eaf4ee;border:1px solid #b7dfc9;border-radius:99px;padding:3px 10px;font-size:12px;color:#2d6a4f;font-weight:500;">🟢 Open to chats</span>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                            <button disabled style="padding:9px 20px;background:var(--espresso);color:var(--cream);border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:not-allowed;font-family:'DM Sans',sans-serif;opacity:.6;">Add Connection</button>
                            <button disabled style="padding:9px 20px;background:transparent;border:1.5px solid var(--latte);border-radius:10px;font-size:13px;font-weight:500;color:var(--muted);cursor:not-allowed;font-family:'DM Sans',sans-serif;opacity:.6;">Request Chat</button>
                        </div>
                    </div>
                </div>

                ${profile.bio ? `
                <div style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;margin-bottom:16px;">
                    <div style="padding:16px 22px 12px;border-bottom:1px solid var(--latte);"><h3 style="font-family:'Playfair Display',serif;font-size:15px;color:var(--espresso);margin:0;">About</h3></div>
                    <div style="padding:18px 22px;"><p style="font-size:14px;color:var(--brown);line-height:1.7;margin:0;">${profile.bio}</p></div>
                </div>` : ''}

                ${(profile.interests||[]).length || (profile.hobbies||[]).length ? `
                <div style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;margin-bottom:16px;">
                    <div style="padding:16px 22px 12px;border-bottom:1px solid var(--latte);"><h3 style="font-family:'Playfair Display',serif;font-size:15px;color:var(--espresso);margin:0;">Interests &amp; Passions</h3></div>
                    <div style="padding:18px 22px;"><div style="display:flex;flex-wrap:wrap;gap:7px;">${tagsHtml}</div></div>
                </div>` : ''}

                ${profile.goals ? `
                <div style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;margin-bottom:16px;">
                    <div style="padding:16px 22px 12px;border-bottom:1px solid var(--latte);"><h3 style="font-family:'Playfair Display',serif;font-size:15px;color:var(--espresso);margin:0;">Career Goals</h3></div>
                    <div style="padding:18px 22px;"><p style="font-size:14px;color:var(--brown);line-height:1.7;margin:0;border-left:3px solid var(--caramel);padding-left:14px;">${profile.goals}</p></div>
                </div>` : ''}

                ${availRows.length > 0 ? `
                <div style="background:var(--card);border:1px solid var(--latte);border-radius:14px;box-shadow:0 2px 12px rgba(107,63,42,.09);overflow:hidden;">
                    <div style="padding:16px 22px 12px;border-bottom:1px solid var(--latte);"><h3 style="font-family:'Playfair Display',serif;font-size:15px;color:var(--espresso);margin:0;">Availability</h3></div>
                    <div style="padding:14px 22px 18px;">${availHtml}</div>
                </div>` : ''}
            `;
            modal.classList.add('active');
        }

        // ============================================
        // MY NETWORK VIEW
        // ============================================

        function switchNwTab(btn, panelId) {
            document.querySelectorAll('.nw-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.nw-panel').forEach(p => p.classList.remove('active'));
            const panel = document.getElementById(panelId);
            if (panel) panel.classList.add('active');
        }

        // Generate a deterministic gradient color from a user ID or name
        function nwAvatarGradient(str) {
            const palettes = [
                'linear-gradient(135deg,#5c3317,#b5651d)',
                'linear-gradient(135deg,#2563eb,#5c9ef5)',
                'linear-gradient(135deg,#7e3ff2,#c084fc)',
                'linear-gradient(135deg,#2d7a4f,#52c887)',
                'linear-gradient(135deg,#c0392b,#e74c3c)',
                'linear-gradient(135deg,#d4894a,#b5651d)',
                'linear-gradient(135deg,#1a7fa0,#48c4e8)',
                'linear-gradient(135deg,#6d3a8e,#b97cd4)',
            ];
            let hash = 0;
            for (let i = 0; i < (str || '').length; i++) hash = (hash * 31 + str.charCodeAt(i)) & 0xffff;
            return palettes[hash % palettes.length];
        }

        function nwAvatarInner(user) {
            if (user.profilePicture) return `<img src="${user.profilePicture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
            const fn = user.firstName || user.first_name || '?';
            const ln = user.lastName  || user.last_name  || '?';
            return `${fn[0]}${ln[0]}`.toUpperCase();
        }

        function renderNetworkView() {
            // Count pending requests (connection type only)
            const incomingReqs = pendingRequests.filter(r => !r.type || r.type === 'connection');
            const reqCount = incomingReqs.length + sentRequests.length;

            // Build suggestion pool: users not connected, not pending, not self
            const connectedIds = new Set();
            connections.forEach(c => { connectedIds.add(c.user_id); connectedIds.add(c.connected_user_id); });
            sentRequests.forEach(r => connectedIds.add(r.connected_user_id));
            pendingRequests.forEach(r => connectedIds.add(r.sender_id || r.user_id));
            const suggestions = users.filter(u => u.id !== currentUser.id && !connectedIds.has(u.id));

            // Update hero stats
            const heroStats = document.getElementById('nwHeroStats');
            if (heroStats) {
                heroStats.innerHTML = `
                    <div class="nw-stat"><div class="nw-stat-val">${connections.length}</div><div class="nw-stat-lbl">Connections</div></div>
                    <div class="nw-stat"><div class="nw-stat-val">${reqCount}</div><div class="nw-stat-lbl">Requests</div></div>
                    <div class="nw-stat"><div class="nw-stat-val">${suggestions.length}</div><div class="nw-stat-lbl">Suggested</div></div>
                `;
            }

            // Update tab counts
            const el = id => document.getElementById(id);
            if (el('nwTabCountConn')) el('nwTabCountConn').textContent = connections.length;
            if (el('nwTabCountReq'))  el('nwTabCountReq').textContent  = reqCount;
            if (el('nwTabCountSug'))  el('nwTabCountSug').textContent  = suggestions.length;

            renderNwConnections();
            renderNwRequests(incomingReqs);
            renderNwSuggestions(suggestions);
        }

        function renderNwConnections() {
            const grid = document.getElementById('nwConnectionsGrid');
            if (!grid) return;

            const query = (document.getElementById('nwSearchInput')?.value || '').toLowerCase();

            // Resolve the other user for each accepted connection
            const connCards = connections.map(c => {
                const otherId = c.user_id === currentUser.id ? c.connected_user_id : c.user_id;
                return users.find(u => u.id === otherId);
            }).filter(Boolean);

            const filtered = query
                ? connCards.filter(u => {
                    const full = `${u.firstName || u.first_name || ''} ${u.lastName || u.last_name || ''}`.toLowerCase();
                    return full.includes(query) || (u.industry || '').toLowerCase().includes(query) || (u.role || '').toLowerCase().includes(query);
                  })
                : connCards;

            if (!filtered.length) {
                grid.innerHTML = `<div class="nw-empty" style="grid-column:1/-1;">
                    <div class="nw-empty-icon">🤝</div>
                    <div class="nw-empty-title">${query ? 'No matches found' : 'No connections yet'}</div>
                    <div class="nw-empty-desc">${query ? 'Try a different name or keyword.' : 'Head to Discover to start growing your network.'}</div>
                </div>`;
                return;
            }

            grid.innerHTML = filtered.map(u => {
                const fn = u.firstName || u.first_name || '?';
                const ln = u.lastName  || u.last_name  || '?';
                const grad = nwAvatarGradient(u.id);
                const inner = nwAvatarInner(u);
                const role = [u.role, u.industry].filter(Boolean).join(' · ') || 'Rowan University';
                const tags = [...(u.interests || []), ...(u.hobbies || [])].slice(0, 3);
                const isAlumni = u.gradYear && parseInt(u.gradYear) < new Date().getFullYear();
                return `
                <div class="nw-conn-card" onclick="viewProfile('${u.id}')">
                    <div class="nw-cc-top">
                        <div class="nw-cc-avatar-wrap">
                            <div class="nw-cc-avatar" style="background:${grad};">${inner}</div>
                            ${u.isOnline ? '<span class="nw-cc-online"></span>' : ''}
                        </div>
                    </div>
                    <div class="nw-cc-body">
                        ${isAlumni ? '<div class="nw-alumni-pill">🎓 Alumni</div>' : ''}
                        <div class="nw-cc-name">${fn} ${ln}</div>
                        <div class="nw-cc-role">${role}</div>
                        ${tags.length ? `<div class="nw-cc-tags">${tags.map((t,i) => `<span class="nw-cc-tag${i===0?' hi':''}">${t}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="nw-cc-footer" onclick="event.stopPropagation()">
                        <button class="nw-btn-chat" onclick="sendChatInvite('${u.id}')">☕ Chat</button>
                        <button class="nw-btn-msg" onclick="startMessage('${u.id}')">💬</button>
                    </div>
                </div>`;
            }).join('');
        }

        function filterNwConnections() { renderNwConnections(); }

        function renderNwRequests(incomingReqs) {
            const incomingEl = document.getElementById('nwIncomingList');
            const sentEl     = document.getElementById('nwSentList');
            const inCount    = document.getElementById('nwIncomingCount');
            const sCount     = document.getElementById('nwSentCount');

            if (inCount) inCount.textContent = incomingReqs.length ? `${incomingReqs.length} pending` : '';
            if (sCount)  sCount.textContent  = sentRequests.length  ? `${sentRequests.length} pending`  : '';

            if (incomingEl) {
                if (!incomingReqs.length) {
                    incomingEl.innerHTML = `<div class="nw-empty"><div class="nw-empty-icon">📬</div><div class="nw-empty-title">No incoming requests</div><div class="nw-empty-desc">When someone sends you a connection request, it will appear here.</div></div>`;
                } else {
                    incomingEl.innerHTML = incomingReqs.map(req => {
                        const senderId = req.sender_id || req.user_id;
                        const u = users.find(x => x.id === senderId);
                        const fn = u ? (u.firstName || u.first_name || '?') : '?';
                        const ln = u ? (u.lastName  || u.last_name  || '?') : '?';
                        const grad = nwAvatarGradient(senderId);
                        const inner = u ? nwAvatarInner(u) : `${fn[0]}${ln[0]}`;
                        const role = u ? ([u.role, u.industry].filter(Boolean).join(' · ') || 'Rowan University') : '';
                        const note = req.note || '';
                        return `
                        <div class="nw-req-card">
                            <div class="nw-req-avatar" style="background:${grad};">${inner}</div>
                            <div class="nw-req-info">
                                <div class="nw-req-name">${fn} ${ln}</div>
                                <div class="nw-req-role">${role}</div>
                                ${note ? `<div class="nw-req-note">"${note}"</div>` : ''}
                                <div class="nw-req-actions">
                                    <button class="nw-btn-accept" onclick="acceptNwRequest('${req.id}')">✓ Accept</button>
                                    <button class="nw-btn-decline" onclick="rejectNwRequest('${req.id}')">✕ Decline</button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
            }

            if (sentEl) {
                if (!sentRequests.length) {
                    sentEl.innerHTML = `<div class="nw-empty"><div class="nw-empty-icon">📤</div><div class="nw-empty-title">No sent requests</div><div class="nw-empty-desc">Head to Discover to find people to connect with.</div></div>`;
                } else {
                    sentEl.innerHTML = sentRequests.map(req => {
                        const u = users.find(x => x.id === req.connected_user_id);
                        const fn = u ? (u.firstName || u.first_name || '?') : '?';
                        const ln = u ? (u.lastName  || u.last_name  || '?') : '?';
                        const grad = nwAvatarGradient(req.connected_user_id);
                        const inner = u ? nwAvatarInner(u) : `${fn[0]}${ln[0]}`;
                        const role = u ? ([u.role, u.industry].filter(Boolean).join(' · ') || 'Rowan University') : '';
                        const note = req.note || '';
                        return `
                        <div class="nw-req-card">
                            <div class="nw-req-avatar" style="background:${grad};">${inner}</div>
                            <div class="nw-req-info">
                                <div class="nw-req-name">${fn} ${ln}</div>
                                <div class="nw-req-role">${role}</div>
                                ${note ? `<div class="nw-req-note">"${note}"</div>` : ''}
                                <div class="nw-req-actions">
                                    <button class="nw-btn-decline" onclick="cancelNwRequest('${req.id}')">✕ Cancel Request</button>
                                </div>
                                <div class="nw-req-time">Awaiting response</div>
                            </div>
                        </div>`;
                    }).join('');
                }
            }
        }

        function renderNwSuggestions(suggestions) {
            const el = document.getElementById('nwSuggestionsContent');
            if (!el) return;

            if (!suggestions.length) {
                el.innerHTML = `<div class="nw-empty"><div class="nw-empty-icon">✨</div><div class="nw-empty-title">You know everyone!</div><div class="nw-empty-desc">No suggestions right now. Check back after more students join.</div></div>`;
                return;
            }

            // Group by shared interest with currentUser
            const myInterests = new Set([...(currentUser.interests || []), ...(currentUser.hobbies || [])]);
            const myIndustry = currentUser.industry || '';

            const sameField = suggestions.filter(u => u.industry && u.industry === myIndustry);
            const others    = suggestions.filter(u => !u.industry || u.industry !== myIndustry);

            function renderSugCard(u) {
                const fn = u.firstName || u.first_name || '?';
                const ln = u.lastName  || u.last_name  || '?';
                const grad = nwAvatarGradient(u.id);
                const inner = nwAvatarInner(u);
                const role = [u.role, u.industry].filter(Boolean).join(' · ') || 'Rowan University';
                const shared = [...(u.interests || []), ...(u.hobbies || [])].filter(t => myInterests.has(t));
                const reason = shared.length
                    ? `Both interested in ${shared.slice(0,2).join(' & ')}.`
                    : u.industry === myIndustry
                    ? `Both in ${u.industry}.`
                    : `Student at Rowan University.`;
                const tags = [...(u.interests || [])].slice(0, 3);
                return `
                <div class="nw-sug-card">
                    <div class="nw-sug-banner" style="position:relative;">
                        <div class="nw-sug-avatar" style="background:${grad};">${inner}</div>
                    </div>
                    <div class="nw-sug-body">
                        <div class="nw-sug-name">${fn} ${ln}</div>
                        <div class="nw-sug-role">${role}</div>
                        <div class="nw-sug-reason"><span style="flex-shrink:0;">💡</span>${reason}</div>
                        ${tags.length ? `<div class="nw-sug-tags">${tags.map(t => `<span class="nw-sug-tag">${t}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="nw-sug-footer">
                        <button class="nw-btn-connect" onclick="connectUser('${u.id}')">🤝 Connect</button>
                        <button class="nw-btn-view" onclick="viewProfile('${u.id}')">View</button>
                    </div>
                </div>`;
            }

            let html = '';
            if (sameField.length) {
                html += `<div class="nw-suggest-section">
                    <h2 class="nw-suggest-title">People in <em>${myIndustry || 'your field'}</em></h2>
                    <div class="nw-suggest-grid">${sameField.map(renderSugCard).join('')}</div>
                </div>`;
            }
            if (others.length) {
                html += `<div class="nw-suggest-section">
                    <h2 class="nw-suggest-title">Others you might <em>know</em></h2>
                    <div class="nw-suggest-grid">${others.map(renderSugCard).join('')}</div>
                </div>`;
            }
            el.innerHTML = html;
        }

        async function acceptNwRequest(reqId) {
            await acceptConnection(reqId);
            renderNetworkView();
        }

        async function rejectNwRequest(reqId) {
            await rejectConnection(reqId);
            renderNetworkView();
        }

        async function cancelNwRequest(reqId) {
            try {
                const { error } = await supabaseClient.from('connections').delete().eq('id', reqId);
                if (error) throw error;
                sentRequests = sentRequests.filter(r => r.id !== reqId);
                showToast('Request cancelled.', 'info');
                renderNetworkView();
            } catch (e) { showToast('Failed to cancel: ' + e.message, 'error'); }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function getTimeAgo(date) {
            if (!date) return '';
            const now = Date.now();
            const diff = now - new Date(date).getTime();
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return `${Math.floor(days / 7)}w ago`;
        }

        function animateCounter(elementId, target) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const current = parseInt(el.textContent) || 0;
            if (current === target) { el.textContent = target; return; }
            const duration = 600;
            const start = performance.now();
            function tick(now) {
                const elapsed = now - start;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.round(current + (target - current) * eased);
                if (progress < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '&#10003;', info: '&#9749;', warning: '&#9888;', error: '&#10007;', celebration: '&#127881;' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${icons[type] || ''}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3200);
        }

        // ============================================
        // CONFETTI
        // ============================================

        function showConfetti() {
            const colors = ['#D4A574', '#6F4E37', '#FF9800', '#4CAF50', '#FF6B6B', '#8B6F47'];
            for (let i = 0; i < 30; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.top = `${Math.random() * 30}vh`;
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                piece.style.width = `${6 + Math.random() * 6}px`;
                piece.style.height = `${6 + Math.random() * 6}px`;
                piece.style.animationDuration = `${1 + Math.random() * 1.5}s`;
                piece.style.animationDelay = `${Math.random() * 0.5}s`;
                document.body.appendChild(piece);
                setTimeout(() => piece.remove(), 3000);
            }
        }

        // ============================================
        // PROFILE COMPLETION
        // ============================================

        function getProfileCompletion() {
            if (!currentUser) return { percentage: 0, missing: [], completed: [] };
            const fields = [
                { key: 'firstName', label: 'First Name' },
                { key: 'lastName', label: 'Last Name' },
                { key: 'bio', label: 'Bio' },
                { key: 'role', label: 'Status' },
                { key: 'company', label: 'School' },
                { key: 'location', label: 'Location' },
                { key: 'industry', label: 'Field of Study' },
                { key: 'interests', label: 'Interests', isArray: true },
                { key: 'hobbies', label: 'Hobbies', isArray: true },
                { key: 'goals', label: 'Career Goals' },
                { key: 'profilePicture', label: 'Profile Picture' },
                { key: 'resume', label: 'Resume' }
            ];
            const completed = [];
            const missing = [];
            fields.forEach(f => {
                const val = currentUser[f.key];
                const filled = f.isArray ? (val && val.length > 0) : (val && val.trim && val.trim() !== '');
                if (filled) completed.push(f.label);
                else missing.push(f.label);
            });
            return {
                percentage: Math.round((completed.length / fields.length) * 100),
                missing,
                completed
            };
        }

        function renderProfileCompletion() {
            const { percentage, missing } = getProfileCompletion();
            const ring = document.getElementById('progressRing');
            const text = document.getElementById('progressPercent');
            const msg = document.getElementById('completionMsg');
            const card = document.getElementById('completionCard');
            if (!ring || !text) return;

            const circumference = 2 * Math.PI * 34;
            const offset = circumference - (percentage / 100) * circumference;
            ring.style.strokeDasharray = circumference;
            setTimeout(() => { ring.style.strokeDashoffset = offset; }, 100);
            text.textContent = percentage + '%';

            if (percentage === 100) {
                if (card) card.style.display = 'none';
            } else {
                if (card) card.style.display = 'flex';
                msg.textContent = `Add: ${missing.slice(0, 3).join(', ')}${missing.length > 3 ? '...' : ''}`;
            }
        }

        // ============================================
        // GETTING STARTED CHECKLIST
        // ============================================

        function renderGettingStarted() {
            const container = document.getElementById('gettingStarted');
            const list = document.getElementById('checklistItems');
            if (!container || !list) return;

            if (localStorage.getItem('gettingStartedDismissed') === 'true') {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const { percentage } = getProfileCompletion();
            const hasConnections = connections.length > 0;
            const hasJoinedGroup = myGroupIds.size > 0;
            const hasSentMessage = sentMessageCount > 0;
            const hasMeeting = meetings.length > 0;

            const items = [
                { label: 'Complete your profile', done: percentage >= 80, action: 'editMyProfile()' },
                { label: 'Discover people to connect with', done: hasConnections, action: "switchView('discoverView')" },
                { label: 'Join a community', done: hasJoinedGroup, action: "switchView('groupsView')" },
                { label: 'Send your first message', done: hasSentMessage, action: "switchView('messagesView')" },
                { label: 'Schedule a coffee chat', done: hasMeeting, action: "switchView('messagesView')" }
            ];

            list.innerHTML = items.map(item => `
                <li class="checklist-item ${item.done ? 'done' : ''}" onclick="${item.action}">
                    <span class="check-icon">${item.done ? '&#10003;' : ''}</span>
                    <span class="check-label">${item.label}</span>
                </li>
            `).join('');
        }

        function dismissGettingStarted() {
            localStorage.setItem('gettingStartedDismissed', 'true');
            const el = document.getElementById('gettingStarted');
            if (el) el.style.display = 'none';
        }

        // ============================================
        // NOTIFICATIONS
        // ============================================

        let notifications = [];

        function generateNotifications() {
            // Keep DB-persisted notifications; rebuild the in-memory generated ones
            notifications = notifications.filter(n => n.dbId);
            const now = new Date();

            // Upcoming meeting reminders
            meetings.forEach(m => {
                const meetingTime = new Date(m.start_time || m.startTime);
                const hoursUntil = (meetingTime - now) / 3600000;
                if (hoursUntil > 0 && hoursUntil < 24) {
                    const partner = users.find(u => u.id === m.participant_id || u.id === m.participantId);
                    notifications.push({
                        id: 'meeting-' + m.id,
                        type: 'meeting',
                        icon: '&#128197;',
                        text: `Upcoming chat${partner ? ` with ${partner.firstName}` : ''} in ${Math.round(hoursUntil)}h`,
                        time: meetingTime,
                        unread: true
                    });
                }
            });

            // Pending connection requests
            if (pendingRequests.length > 0) {
                pendingRequests.forEach(req => {
                    const senderId = req.sender_id || req.user_id;
                    const requester = users.find(u => u.id === senderId);
                    const name = requester ? `${requester.firstName} ${requester.lastName}` : 'Someone';
                    notifications.unshift({
                        id: 'pending-' + req.id,
                        type: 'connection',
                        icon: '🤝',
                        text: `${name} wants to connect with you`,
                        time: new Date(req.created_at || now),
                        unread: true,
                        action: () => switchHubTab('network')
                    });
                });
            }

            // Pending chat invites
            if (chatInvites.length > 0) {
                chatInvites.forEach(invite => {
                    const requester = users.find(u => u.id === invite.sender_id);
                    const name = requester ? `${requester.firstName} ${requester.lastName}` : 'Someone';
                    notifications.unshift({
                        id: 'cinvite-' + invite.id,
                        type: 'chat_invite',
                        icon: '☕',
                        text: `${name} wants to have a coffee chat!`,
                        time: new Date(invite.created_at || now),
                        unread: true,
                        action: () => switchHubTab('network')
                    });
                });
            }

            // Connection notifications
            if (connections.length > 0) {
                notifications.push({
                    id: 'conn-welcome',
                    type: 'connection',
                    icon: '&#129309;',
                    text: `You have ${connections.length} connection${connections.length > 1 ? 's' : ''}. Keep growing your network!`,
                    time: new Date(now - 3600000),
                    unread: false
                });
            }

            // Welcome notification
            notifications.push({
                id: 'welcome',
                type: 'event',
                icon: '&#9749;',
                text: 'Welcome to First Sip! Start by completing your profile.',
                time: new Date(now - 86400000),
                unread: false
            });

            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notifList');
            if (!list) return;

            const unreadCount = notifications.filter(n => n.unread).length;

            // Update the dot indicator on the bell
            const dot = document.getElementById('notifDot');
            if (dot) dot.style.display = unreadCount > 0 ? 'block' : 'none';
            // Also update bellBadge if it exists
            const badge = document.getElementById('bellBadge');
            if (badge) { badge.textContent = unreadCount; badge.classList.toggle('hidden', unreadCount === 0); }

            // Shake bell if new notifications
            if (unreadCount > 0) {
                const bell = document.getElementById('notifBell');
                if (bell) {
                    bell.classList.add('has-new');
                    setTimeout(() => bell.classList.remove('has-new'), 700);
                }
            }

            if (notifications.length === 0) {
                list.innerHTML = '<div class="notification-empty"><p>&#9749; No notifications yet</p><p style="font-size: 12px;">You\'re all caught up!</p></div>';
                return;
            }

            list.innerHTML = notifications.map(n => {
                const hasAction = !!n.action;
                return `
                <div class="notification-item ${n.unread ? 'unread' : ''}${hasAction ? ' notif-clickable' : ''}" onclick="handleNotifClick('${n.id}')">
                    <div class="notification-icon ${n.type}">${n.icon}</div>
                    <div class="notification-text">
                        <p>${n.text}</p>
                        <span class="notif-time">${getTimeAgo(n.time)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleNotifications() {
            const panel = document.getElementById('notifPanel');
            const overlay = document.getElementById('notifOverlay');
            if (!panel || !overlay) return;
            const isOpen = panel.classList.contains('open');
            panel.classList.toggle('open');
            overlay.classList.toggle('open');
            // When opening: mark all as read locally and in DB
            if (!isOpen) {
                const unreadDbIds = notifications.filter(n => n.unread && n.dbId).map(n => n.dbId);
                notifications.forEach(n => { n.unread = false; });
                renderNotifications();
                if (unreadDbIds.length > 0 && currentUser) {
                    supabaseClient.from('notifications')
                        .update({ read: true })
                        .in('id', unreadDbIds)
                        .eq('user_id', currentUser.id)
                        .then(({ error }) => { if (error) console.error('mark notifs read:', error); });
                }
            }
        }

        function markNotificationRead(id) {
            const notif = notifications.find(n => n.id === id);
            if (notif) notif.unread = false;
            renderNotifications();
        }

        function handleNotifClick(id) {
            markNotificationRead(id);
            const notif = notifications.find(n => n.id === id);
            if (notif && notif.action) {
                notif.action();
                toggleNotifications();
            }
        }

        async function clearAllNotifications() {
            if (currentUser) {
                try {
                    await supabaseClient.from('notifications')
                        .delete().eq('user_id', currentUser.id).eq('read', true);
                } catch (e) { console.error('clearAllNotifications:', e); }
            }
            notifications = [];
            renderNotifications();
            showToast('Notifications cleared', 'info');
        }

        async function refreshBellBadge() {
            if (!currentUser) return;
            try {
                const { data } = await supabaseClient
                    .from('unread_notification_counts')
                    .select('unread_count')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();
                const count = data ? (data.unread_count || 0) : 0;
                const badge = document.getElementById('bellBadge');
                if (badge) { badge.textContent = count; badge.classList.toggle('hidden', count === 0); }
                const dot = document.getElementById('notifDot');
                if (dot) dot.style.display = count > 0 ? 'block' : 'none';
            } catch (e) { console.error('refreshBellBadge:', e); }
        }

        // ============================================
        // GAMIFICATION - BADGES & STREAKS
        // ============================================

        const BADGES = [
            { id: 'first-sip', name: 'First Sip', icon: '&#9749;', desc: 'Complete your profile', check: () => getProfileCompletion().percentage >= 50 },
            { id: 'regular', name: 'Regular', icon: '&#128260;', desc: '3-day login streak', check: () => getLoginStreak() >= 3 },
            { id: 'connoisseur', name: 'Connoisseur', icon: '&#127942;', desc: '10+ connections', check: () => connections.length >= 10 },
            { id: 'connector', name: 'Connector', icon: '&#129309;', desc: 'Send 5+ messages', check: () => sentMessageCount >= 5 },
            { id: 'butterfly', name: 'Social Butterfly', icon: '&#129419;', desc: 'Join 3+ groups', check: () => myGroupIds.size >= 3 },
            { id: 'icebreaker', name: 'Icebreaker', icon: '&#129482;', desc: 'Use conversation starter', check: () => localStorage.getItem('usedIcebreaker') === 'true' },
            { id: 'profile-pro', name: 'Profile Pro', icon: '&#11088;', desc: '100% profile completion', check: () => getProfileCompletion().percentage === 100 }
        ];

        function checkBadges() {
            return BADGES.map(badge => ({
                ...badge,
                earned: badge.check()
            }));
        }

        function checkBadgesWithCelebration() {
            const prev = JSON.parse(localStorage.getItem('earnedBadges') || '[]');
            const badges = checkBadges();
            const newlyEarned = badges.filter(b => b.earned && !prev.includes(b.id));

            localStorage.setItem('earnedBadges', JSON.stringify(badges.filter(b => b.earned).map(b => b.id)));

            if (newlyEarned.length > 0) {
                setTimeout(() => showBadgeEarned(newlyEarned[0]), 1000);
            }
        }

        function showBadgeEarned(badge) {
            showConfetti();
            const overlay = document.createElement('div');
            overlay.className = 'badge-toast-overlay';
            overlay.onclick = () => overlay.remove();
            overlay.innerHTML = `
                <div class="badge-toast-card">
                    <div class="big-badge">${badge.icon}</div>
                    <h2 style="color: var(--primary); margin-bottom: 0.5rem;">Badge Earned!</h2>
                    <h3 style="color: var(--accent); margin-bottom: 0.5rem;">${badge.name}</h3>
                    <p style="color: #999; font-size: 13px;">${badge.desc}</p>
                    <button class="btn btn-accent" onclick="this.closest('.badge-toast-overlay').remove()" style="margin-top: 1rem;">Awesome!</button>
                </div>
            `;
            document.body.appendChild(overlay);
            setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 5000);
        }

        function renderBadges(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const badges = checkBadges();
            container.innerHTML = badges.map(b => `
                <div class="badge-item ${b.earned ? '' : 'locked'}">
                    <div class="badge-tooltip">${b.desc}</div>
                    <div class="badge-icon">${b.icon}</div>
                    <span class="badge-name">${b.name}</span>
                </div>
            `).join('');
        }

        function renderDashboardBadges() {
            renderBadges('dashboardBadges');
        }

        function recordLogin() {
            const history = JSON.parse(localStorage.getItem('loginHistory') || '[]');
            const today = new Date().toDateString();
            if (!history.includes(today)) {
                history.push(today);
                // Keep last 90 days only
                if (history.length > 90) history.shift();
                localStorage.setItem('loginHistory', JSON.stringify(history));
            }
        }

        function getLoginStreak() {
            const history = JSON.parse(localStorage.getItem('loginHistory') || '[]');
            if (history.length === 0) return 0;
            let streak = 1;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Check if logged in today
            if (!history.includes(today.toDateString())) return 0;

            for (let i = 1; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                if (history.includes(checkDate.toDateString())) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        init();

        // ===================================================
        //  SETTINGS PAGE
        // ===================================================

        const stLoadedTabs = new Set();

        function setStBtnLoading(btn, loading) {
            if (!btn) return;
            if (loading) {
                btn.dataset.origText = btn.textContent;
                btn.textContent = 'Saving…';
                btn.disabled = true;
            } else {
                btn.textContent = btn.dataset.origText || 'Save';
                btn.disabled = false;
            }
        }

        function renderSettingsView() {
            if (!currentUser) return;
            stLoadedTabs.clear();

            // Avatar
            const avatarEl   = document.getElementById('stAvatarPreview');
            const initialsEl = document.getElementById('stAvatarInitials');
            if (currentUser.profilePicture) {
                if (initialsEl) initialsEl.style.display = 'none';
                let img = avatarEl ? avatarEl.querySelector('img') : null;
                if (!img) { img = document.createElement('img'); img.style.cssText = 'width:100%;height:100%;border-radius:50%;object-fit:cover;position:absolute;inset:0;'; if (avatarEl) avatarEl.insertBefore(img, avatarEl.firstChild); }
                img.src = currentUser.profilePicture;
            } else {
                if (initialsEl) { initialsEl.style.display = ''; initialsEl.textContent = ((currentUser.firstName||'?')[0]+(currentUser.lastName||'?')[0]).toUpperCase(); }
                if (avatarEl) { const img = avatarEl.querySelector('img'); if (img) img.remove(); }
            }
            const nameEl = document.getElementById('stAvatarName');
            const subEl  = document.getElementById('stAvatarSub');
            if (nameEl) nameEl.textContent = `${currentUser.firstName||''} ${currentUser.lastName||''}`.trim();
            if (subEl)  subEl.textContent  = [currentUser.role, currentUser.company].filter(Boolean).join(' · ') || 'Rowan University';

            // Account email
            const emailEl = document.getElementById('stCurrentEmail');
            if (emailEl) emailEl.value = currentUser.email || '';
            const verifiedEl = document.getElementById('stVerifiedEmail');
            if (verifiedEl) verifiedEl.textContent = currentUser.email || '—';

            // Handle URL hash tab
            const hash = location.hash.replace('#settings-','');
            const hashMap = { notifications:'st-notifications', privacy:'st-privacy', availability:'st-availability', account:'st-account', danger:'st-danger', appearance:'st-appearance' };
            const targetId = hashMap[hash] || 'st-profile';
            const targetBtn = document.querySelector(`.st-nav-item[onclick*="'${targetId}'"]`);
            switchStSection(targetBtn, targetId);

            loadStProfile();
        }

        async function loadStProfile() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
                if (error) throw error;
                const fv = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
                fv('stFirstName', data.first_name);
                fv('stLastName',  data.last_name);
                fv('stHeadline',  data.headline);
                fv('stBio',       data.bio);
                fv('stStatus',    data.status);
                fv('stGradYear',  data.grad_year);
                fv('stMajor',     data.major);
                fv('stIndustry',  data.industry);
                fv('stRole',      data.role);
                fv('stCompany',   data.company);
                fv('stLocation',  data.location);
                fv('stLinkedin',  data.linkedin_url);
                fv('stGoals',     data.goals);
                // Resume hint
                const resumeHint = document.getElementById('stResumeHint');
                if (resumeHint) resumeHint.textContent = data.resume_url ? 'Resume uploaded ✓' : '';
                // Interests tags
                renderStTagsWrap('stInterestTags', 'stInterestInput', data.interests || []);
                // Hobbies tags
                renderStTagsWrap('stHobbyTags', 'stHobbyInput', data.hobbies || []);
                // Update global cache
                currentUser.firstName     = data.first_name;
                currentUser.lastName      = data.last_name;
                currentUser.headline      = data.headline;
                currentUser.bio           = data.bio;
                currentUser.status        = data.status;
                currentUser.gradYear      = data.grad_year;
                currentUser.major         = data.major;
                currentUser.industry      = data.industry;
                currentUser.role          = data.role;
                currentUser.company       = data.company;
                currentUser.location      = data.location;
                currentUser.linkedinUrl   = data.linkedin_url;
                currentUser.goals         = data.goals;
                currentUser.interests     = data.interests || [];
                currentUser.hobbies       = data.hobbies   || [];
            } catch (e) { console.error('loadStProfile error:', e); }
        }

        function renderStTagsWrap(wrapperId, inputId, tags) {
            const wrap  = document.getElementById(wrapperId);
            const input = document.getElementById(inputId);
            if (!wrap || !input) return;
            wrap.innerHTML = '';
            tags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'st-tag-chip';
                chip.innerHTML = `${tag} <button onclick="removeStTag(this)" type="button">×</button>`;
                wrap.appendChild(chip);
            });
            wrap.appendChild(input);
        }

        function applyTheme(theme) {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = theme === 'dark' || (theme === 'system' && prefersDark);
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('app_theme', theme);
        }

        function selectThemeOption(el, value) {
            document.querySelectorAll('.st-theme-option').forEach(o => o.classList.remove('active'));
            el.classList.add('active');
            const radio = el.closest('label').querySelector('input[type=radio]');
            if (radio) radio.checked = true;
            applyTheme(value);
        }

        function loadStAppearance() {
            const theme = localStorage.getItem('app_theme') || 'light';
            document.querySelectorAll('input[name="st_theme"]').forEach(input => {
                const isMatch = input.value === theme;
                input.checked = isMatch;
                const optDiv = input.closest('label') && input.closest('label').querySelector('.st-theme-option');
                if (optDiv) optDiv.classList.toggle('active', isMatch);
            });
        }

        function switchStSection(btn, sectionId, navContainerId) {
            document.querySelectorAll('.st-nav-item').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.st-mobile-tab').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.querySelectorAll('.st-nav-item, .st-mobile-tab').forEach(b => {
                const oc = b.getAttribute('onclick') || '';
                if (oc.includes("'" + sectionId + "'")) b.classList.add('active');
            });
            document.querySelectorAll('.st-section').forEach(s => s.classList.remove('active'));
            const sec = document.getElementById(sectionId);
            if (sec) sec.classList.add('active');

            // Update URL hash
            const hashMap = {'st-notifications':'notifications','st-privacy':'privacy','st-availability':'availability','st-account':'account','st-danger':'danger','st-appearance':'appearance'};
            if (hashMap[sectionId]) history.replaceState(null, '', '#settings-' + hashMap[sectionId]);
            else history.replaceState(null, '', location.pathname);

            // Lazy load
            if (!stLoadedTabs.has(sectionId)) {
                stLoadedTabs.add(sectionId);
                if (sectionId === 'st-notifications') loadStNotifications();
                if (sectionId === 'st-privacy')       loadStPrivacy();
                if (sectionId === 'st-availability')  loadStAvailability();
                if (sectionId === 'st-danger')        loadStDanger();
                if (sectionId === 'st-appearance')    loadStAppearance();
            }
        }

        async function saveStProfile() {
            if (!currentUser) return;
            const btn = document.getElementById('stSaveBasicBtn');
            setStBtnLoading(btn, true);
            const firstName = document.getElementById('stFirstName').value.trim();
            const lastName  = document.getElementById('stLastName').value.trim();
            const headline  = document.getElementById('stHeadline').value.trim();
            const bio       = document.getElementById('stBio').value.trim();
            const status    = document.getElementById('stStatus').value;
            const gradYear  = document.getElementById('stGradYear').value;
            if (!firstName || !lastName) { showStToast('Please enter your name.', 'error'); setStBtnLoading(btn, false); return; }
            try {
                const { error } = await supabaseClient.from('profiles').update({
                    first_name: firstName, last_name: lastName, headline, bio, status, grad_year: gradYear
                }).eq('id', currentUser.id);
                if (error) throw error;
                currentUser.firstName = firstName; currentUser.lastName = lastName;
                currentUser.headline  = headline;  currentUser.bio      = bio;
                currentUser.status    = status;    currentUser.gradYear = gradYear;
                showStToast('Profile saved!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
            setStBtnLoading(btn, false);
        }

        async function saveStCareer() {
            if (!currentUser) return;
            const btn = document.getElementById('stSaveCareerBtn');
            setStBtnLoading(btn, true);
            const major    = document.getElementById('stMajor').value.trim();
            const industry = document.getElementById('stIndustry').value;
            const role     = document.getElementById('stRole').value.trim();
            const company  = document.getElementById('stCompany').value.trim();
            const location = document.getElementById('stLocation').value.trim();
            const linkedin = document.getElementById('stLinkedin').value.trim();
            const goals    = document.getElementById('stGoals').value.trim();
            const interests = Array.from(document.querySelectorAll('#stInterestTags .st-tag-chip')).map(c => c.firstChild.textContent.trim());
            const hobbies   = Array.from(document.querySelectorAll('#stHobbyTags .st-tag-chip')).map(c => c.firstChild.textContent.trim());
            try {
                const { error } = await supabaseClient.from('profiles').update({
                    major, industry, role, company, location, linkedin_url: linkedin, goals, interests, hobbies
                }).eq('id', currentUser.id);
                if (error) throw error;
                currentUser.major = major; currentUser.industry = industry; currentUser.role = role;
                currentUser.company = company; currentUser.location = location;
                currentUser.linkedinUrl = linkedin; currentUser.goals = goals;
                currentUser.interests = interests; currentUser.hobbies = hobbies;
                showStToast('Career info saved!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
            setStBtnLoading(btn, false);
        }

        async function saveStEmail() {
            const newEmail = document.getElementById('stNewEmail').value.trim();
            if (!newEmail) { showStToast('Please enter a new email.', 'error'); return; }
            try {
                const { error } = await supabaseClient.auth.updateUser({ email: newEmail });
                if (error) throw error;
                showStToast('Confirmation sent — check your inbox!');
                document.getElementById('stNewEmail').value = '';
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        async function saveStPassword() {
            const pw  = document.getElementById('stNewPassword').value;
            const pw2 = document.getElementById('stConfirmPassword').value;
            if (!pw || pw.length < 8) { showStToast('Password must be at least 8 characters.', 'error'); return; }
            if (pw !== pw2) { showStToast('Passwords do not match.', 'error'); return; }
            try {
                const { error } = await supabaseClient.auth.updateUser({ password: pw });
                if (error) throw error;
                document.getElementById('stNewPassword').value = '';
                document.getElementById('stConfirmPassword').value = '';
                showStToast('Password updated!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        // ── Notifications ──
        async function loadStNotifications() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabaseClient.from('user_preferences').select('*').eq('user_id', currentUser.id).maybeSingle();
                if (error) throw error;
                if (!data) return;
                const toggle = (id, val) => { const el = document.getElementById(id); if (el) el.checked = !!val; };
                toggle('notif_email_connections',     data.notif_email_connections);
                toggle('notif_email_chat_requests',   data.notif_email_chat_requests);
                toggle('notif_email_reminders',       data.notif_email_reminders);
                toggle('notif_email_messages',        data.notif_email_messages);
                toggle('notif_email_group_activity',  data.notif_email_group_activity);
                toggle('notif_email_weekly_digest',   data.notif_email_weekly_digest);
                toggle('notif_app_connection_accepted', data.notif_app_connection_accepted);
                toggle('notif_app_match_suggestions',   data.notif_app_match_suggestions);
                toggle('notif_app_chat_reviews',        data.notif_app_chat_reviews);
            } catch (e) { console.error('loadStNotifications error:', e); }
        }

        async function saveStNotifications() {
            if (!currentUser) return;
            const activeBtn = document.activeElement;
            const btn = document.getElementById('stSaveNotifBtn') || document.getElementById('stSaveInAppBtn');
            setStBtnLoading(activeBtn?.id?.startsWith('stSave') ? activeBtn : btn, true);
            const cv = id => { const el = document.getElementById(id); return el ? el.checked : false; };
            const payload = {
                notif_email_connections:      cv('notif_email_connections'),
                notif_email_chat_requests:    cv('notif_email_chat_requests'),
                notif_email_reminders:        cv('notif_email_reminders'),
                notif_email_messages:         cv('notif_email_messages'),
                notif_email_group_activity:   cv('notif_email_group_activity'),
                notif_email_weekly_digest:    cv('notif_email_weekly_digest'),
                notif_app_connection_accepted: cv('notif_app_connection_accepted'),
                notif_app_match_suggestions:   cv('notif_app_match_suggestions'),
                notif_app_chat_reviews:        cv('notif_app_chat_reviews'),
            };
            try {
                const { error } = await supabaseClient.from('user_preferences').update(payload).eq('user_id', currentUser.id);
                if (error) throw error;
                showStToast('Notification preferences saved!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
            setStBtnLoading(activeBtn?.id?.startsWith('stSave') ? activeBtn : btn, false);
        }

        // ── Privacy ──
        async function loadStPrivacy() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabaseClient.from('user_preferences').select('*').eq('user_id', currentUser.id).maybeSingle();
                if (error) throw error;
                if (!data) return;
                const sv = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
                const toggle = (id, val) => { const el = document.getElementById(id); if (el) el.checked = !!val; };
                sv('privacy_profile_visibility',  data.privacy_profile_visibility);
                sv('privacy_who_can_connect',     data.privacy_who_can_connect);
                sv('privacy_who_can_chat',        data.privacy_who_can_chat);
                sv('privacy_show_online_status',  data.privacy_show_online_status);
                toggle('privacy_appear_in_discover',    data.privacy_appear_in_discover);
                toggle('privacy_show_match_percent',    data.privacy_show_match_percent);
                toggle('privacy_alumni_recommendations', data.privacy_alumni_recommendations);
            } catch (e) { console.error('loadStPrivacy error:', e); }
        }

        async function saveStPrivacy() {
            if (!currentUser) return;
            const activeBtn = document.activeElement;
            setStBtnLoading(activeBtn, true);
            const sv = id => { const el = document.getElementById(id); return el ? el.value : null; };
            const cv = id => { const el = document.getElementById(id); return el ? el.checked : false; };
            const payload = {
                privacy_profile_visibility:    sv('privacy_profile_visibility'),
                privacy_who_can_connect:       sv('privacy_who_can_connect'),
                privacy_who_can_chat:          sv('privacy_who_can_chat'),
                privacy_show_online_status:    sv('privacy_show_online_status'),
                privacy_appear_in_discover:    cv('privacy_appear_in_discover'),
                privacy_show_match_percent:    cv('privacy_show_match_percent'),
                privacy_alumni_recommendations: cv('privacy_alumni_recommendations'),
            };
            try {
                const { error } = await supabaseClient.from('user_preferences').update(payload).eq('user_id', currentUser.id);
                if (error) throw error;
                showStToast('Privacy settings saved!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
            setStBtnLoading(activeBtn, false);
        }

        // ── Availability ──
        function toggleAvailDay(dayNum) {
            const on    = document.getElementById(`avail-on-${dayNum}`);
            const start = document.getElementById(`avail-start-${dayNum}`);
            const end   = document.getElementById(`avail-end-${dayNum}`);
            if (!on || !start || !end) return;
            start.disabled = !on.checked;
            end.disabled   = !on.checked;
        }

        async function loadStAvailability() {
            if (!currentUser) return;
            try {
                const [availRes, prefsRes] = await Promise.all([
                    supabaseClient.from('availability').select('*').eq('user_id', currentUser.id),
                    supabaseClient.from('user_preferences').select('pref_open_virtual,pref_open_inperson,pref_weekly_chat_limit').eq('user_id', currentUser.id).maybeSingle()
                ]);
                if (availRes.error) throw availRes.error;
                // Reset all days
                for (let d = 0; d < 7; d++) {
                    const on    = document.getElementById(`avail-on-${d}`);
                    const start = document.getElementById(`avail-start-${d}`);
                    const end   = document.getElementById(`avail-end-${d}`);
                    if (on)    on.checked    = false;
                    if (start) { start.value = '09:00'; start.disabled = true; }
                    if (end)   { end.value   = '17:00'; end.disabled   = true; }
                }
                // Apply saved data
                (availRes.data || []).forEach(slot => {
                    const d = slot.day_of_week;
                    const on    = document.getElementById(`avail-on-${d}`);
                    const start = document.getElementById(`avail-start-${d}`);
                    const end   = document.getElementById(`avail-end-${d}`);
                    if (on && slot.is_available) { on.checked = true; }
                    if (start) { start.value = (slot.start_time || '09:00').substring(0,5); start.disabled = !on?.checked; }
                    if (end)   { end.value   = (slot.end_time   || '17:00').substring(0,5); end.disabled   = !on?.checked; }
                });
                // Chat prefs
                if (prefsRes.data) {
                    const p = prefsRes.data;
                    const tv = (id, val) => { const el = document.getElementById(id); if (el) el.checked = !!val; };
                    tv('pref_open_virtual',     p.pref_open_virtual);
                    tv('pref_open_inperson',    p.pref_open_inperson);
                    tv('pref_weekly_chat_limit', p.pref_weekly_chat_limit);
                }
            } catch (e) { console.error('loadStAvailability error:', e); }
        }

        async function saveStAvailability() {
            if (!currentUser) return;
            const btn = document.getElementById('stSaveAvailBtn');
            setStBtnLoading(btn, true);
            try {
                const rows = [];
                for (let d = 0; d < 7; d++) {
                    const on    = document.getElementById(`avail-on-${d}`);
                    const start = document.getElementById(`avail-start-${d}`);
                    const end   = document.getElementById(`avail-end-${d}`);
                    if (!on) continue;
                    rows.push({
                        user_id:     currentUser.id,
                        day_of_week: d,
                        is_available: on.checked,
                        start_time:  start ? start.value : '09:00',
                        end_time:    end   ? end.value   : '17:00'
                    });
                }
                const { error } = await supabaseClient.from('availability').upsert(rows, { onConflict: 'user_id,day_of_week' });
                if (error) throw error;
                showStToast('Availability saved!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
            setStBtnLoading(btn, false);
        }

        async function saveStChatPrefs() {
            if (!currentUser) return;
            const btn = document.getElementById('stSaveChatPrefsBtn');
            setStBtnLoading(btn, true);
            const cv = id => { const el = document.getElementById(id); return el ? el.checked : false; };
            try {
                const { error } = await supabaseClient.from('user_preferences').update({
                    pref_open_virtual:      cv('pref_open_virtual'),
                    pref_open_inperson:     cv('pref_open_inperson'),
                    pref_weekly_chat_limit: cv('pref_weekly_chat_limit')
                }).eq('user_id', currentUser.id);
                if (error) throw error;
                showStToast('Chat preferences saved!');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
            setStBtnLoading(btn, false);
        }

        // ── Avatar / Resume upload ──
        async function uploadStAvatar(input) {
            if (!input.files || !input.files[0] || !currentUser) return;
            const file = input.files[0];
            if (file.size > 5 * 1024 * 1024) { showStToast('Image must be under 5 MB.', 'error'); return; }
            try {
                const ext  = file.name.split('.').pop().toLowerCase();
                const path = `${currentUser.id}/avatar.${ext}`;
                const { error: upErr } = await supabaseClient.storage.from('avatars').upload(path, file, { upsert: true });
                if (upErr) throw upErr;
                const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(path);
                const publicUrl = urlData.publicUrl + '?t=' + Date.now();
                await supabaseClient.from('profiles').update({ profile_picture: urlData.publicUrl }).eq('id', currentUser.id);
                currentUser.profilePicture = publicUrl;
                // Update preview
                const avatarEl   = document.getElementById('stAvatarPreview');
                const initialsEl = document.getElementById('stAvatarInitials');
                if (initialsEl) initialsEl.style.display = 'none';
                let img = avatarEl ? avatarEl.querySelector('img') : null;
                if (!img) { img = document.createElement('img'); img.style.cssText = 'width:100%;height:100%;border-radius:50%;object-fit:cover;position:absolute;inset:0;'; if (avatarEl) avatarEl.insertBefore(img, avatarEl.firstChild); }
                img.src = publicUrl;
                showStToast('Photo updated!');
            } catch (e) { showStToast('Upload failed: ' + e.message, 'error'); }
        }

        async function uploadStResume(input) {
            if (!input.files || !input.files[0] || !currentUser) return;
            const file = input.files[0];
            if (file.size > 10 * 1024 * 1024) { showStToast('Resume must be under 10 MB.', 'error'); return; }
            try {
                const path = `${currentUser.id}/resume.pdf`;
                const { error: upErr } = await supabaseClient.storage.from('resumes').upload(path, file, { upsert: true, contentType: 'application/pdf' });
                if (upErr) throw upErr;
                await supabaseClient.from('profiles').update({ resume_url: path }).eq('id', currentUser.id);
                currentUser.resume = path;
                const hint = document.getElementById('stResumeHint');
                if (hint) hint.textContent = 'Resume uploaded ✓';
                showStToast('Resume uploaded!');
            } catch (e) { showStToast('Upload failed: ' + e.message, 'error'); }
        }

        // ── Tag inputs ──
        function handleStTag(event, wrapperId, inputId) {
            if (event.key !== 'Enter' && event.key !== ',') return;
            event.preventDefault();
            const input = document.getElementById(inputId);
            const val   = input.value.replace(',','').trim();
            if (!val) return;
            const wrap = document.getElementById(wrapperId);
            const chip = document.createElement('span');
            chip.className = 'st-tag-chip';
            chip.innerHTML = `${val} <button onclick="removeStTag(this)" type="button">×</button>`;
            wrap.insertBefore(chip, input);
            input.value = '';
        }

        function removeStTag(btn) {
            btn.closest('.st-tag-chip').remove();
        }

        // ── Danger Zone ──
        function exportStData() {
            showStToast('Data export coming soon — we\'ll email you a download link!');
        }

        async function loadStDanger() {
            if (!currentUser) return;
            try {
                const { data } = await supabaseClient.from('user_preferences')
                    .select('privacy_appear_in_discover').eq('user_id', currentUser.id).maybeSingle();
                const isPaused = data && data.privacy_appear_in_discover === false;
                const btn = document.getElementById('stPauseBtn');
                if (btn) {
                    btn.textContent = isPaused ? 'Resume Account' : 'Pause Account';
                    btn.onclick = isPaused ? resumeStAccount : pauseStAccount;
                }
            } catch (e) { console.error('loadStDanger:', e); }
        }

        async function pauseStAccount() {
            if (!currentUser) return;
            try {
                const { error } = await supabaseClient.from('user_preferences').update({ privacy_appear_in_discover: false }).eq('user_id', currentUser.id);
                if (error) throw error;
                showStToast('Your profile is now hidden from Discover.');
                const btn = document.getElementById('stPauseBtn');
                if (btn) { btn.textContent = 'Resume Account'; btn.onclick = resumeStAccount; }
                const el = document.getElementById('privacy_appear_in_discover');
                if (el) el.checked = false;
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        async function resumeStAccount() {
            if (!currentUser) return;
            try {
                const { error } = await supabaseClient.from('user_preferences').update({ privacy_appear_in_discover: true }).eq('user_id', currentUser.id);
                if (error) throw error;
                showStToast('Account resumed — your profile is visible in Discover.');
                const btn = document.getElementById('stPauseBtn');
                if (btn) { btn.textContent = 'Pause Account'; btn.onclick = pauseStAccount; }
                const el = document.getElementById('privacy_appear_in_discover');
                if (el) el.checked = true;
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        async function clearAllNotifsDanger() {
            if (!currentUser) return;
            if (!confirm('Delete all notifications? This cannot be undone.')) return;
            try {
                const { error } = await supabaseClient.from('notifications').delete().eq('user_id', currentUser.id);
                if (error) throw error;
                notifications = notifications.filter(n => !n.dbId);
                renderNotifications();
                showStToast('All notifications cleared.');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        async function signOutOtherDevices() {
            try {
                const { error } = await supabaseClient.auth.signOut({ scope: 'others' });
                if (error) throw error;
                showStToast('Signed out of all other devices.');
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        async function signOutAllDevices() {
            try {
                const { error } = await supabaseClient.auth.signOut({ scope: 'global' });
                if (error) throw error;
                location.reload();
            } catch (e) { showStToast('Error: ' + e.message, 'error'); }
        }

        function checkDeleteInput() {
            const input = document.getElementById('stDeleteConfirmInput');
            const btn   = document.getElementById('stDeleteAccountBtn');
            if (!input || !btn) return;
            const ready = input.value === 'DELETE';
            btn.disabled = !ready;
            btn.style.opacity = ready ? '1' : '0.4';
        }

        function confirmDeleteAccount() {
            showStToast('To delete your account, email Sal.FirstSip@Outlook.com — we\'ll process it within 24 hours.');
        }

        let stToastTimer = null;
        function showStToast(msg, type) {
            const toast = document.getElementById('stToast');
            if (!toast) return;
            toast.textContent = (type === 'error' ? '✕ ' : '✓ ') + msg;
            toast.classList.toggle('error', type === 'error');
            toast.classList.add('show');
            if (stToastTimer) clearTimeout(stToastTimer);
            stToastTimer = setTimeout(() => toast.classList.remove('show'), 3500);
        }

    </script>

    <!-- Notification Panel -->
    <div class="notification-panel-overlay" id="notifOverlay" onclick="toggleNotifications()"></div>
    <div class="notification-panel" id="notifPanel">
        <div class="notification-panel-header">
            <h3>Notifications</h3>
            <button class="btn btn-sm" onclick="clearAllNotifications()" style="font-size: 12px;">Clear All</button>
        </div>
        <div class="notification-list" id="notifList"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
</body>
</html>
