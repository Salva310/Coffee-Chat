<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Chat - Professional Networking</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6F4E37;
            --primary-light: #8B6F47;
            --primary-dark: #3E2723;
            --accent: #D4A574;
            --success: #4CAF50;
            --danger: #FF6B6B;
            --bg-dark: #2C1A0E;
            --bg-light: #FFF8F0;
            --text-dark: #3E2723;
            --text-light: #FFF8F0;
            --border: #E8D5C4;
            --shadow: 0 8px 24px rgba(62, 39, 35, 0.12);
        }

        body {
            font-family: 'Sora', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            background: var(--primary);
            color: var(--text-light);
            padding: 2rem 1.5rem;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            margin-bottom: 2rem;
            color: var(--accent);
            letter-spacing: -1px;
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            border: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-item.active {
            background: var(--accent);
            color: var(--text-dark);
        }

        .sidebar-spacer {
            flex: 1;
        }

        .logout-btn {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Headers */
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        h2 {
            font-size: 24px;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        h3 {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-4px);
        }

        .card.compact {
            padding: 1rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(111, 78, 55, 0.1);
            background: #fafaf8;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(111, 78, 55, 0.3);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-accent {
            background: var(--accent);
            color: var(--text-dark);
        }

        .btn-accent:hover {
            background: #c89b68;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e55555;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 10px 12px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Auth Screens */
        .auth-container {
            max-width: 500px;
            margin: 4rem auto;
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .auth-container h1 {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 2rem;
            font-size: 14px;
        }

        .toggle-auth {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 14px;
        }

        .toggle-auth button {
            background: none;
            border: none;
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .grid.two-col {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 28px;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Person Card */
        .person-card {
            text-align: center;
        }

        .person-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            margin: 0 auto 1rem;
        }

        .person-card h3 {
            text-align: center;
            margin-bottom: 0.25rem;
        }

        .person-card .role {
            font-size: 12px;
            color: #999;
            margin-bottom: 0.5rem;
        }

        .person-card .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .tag {
            background: var(--bg-light);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Calendar */
        .calendar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-header button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
            padding: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-light);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-day.today {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .calendar-day.has-event {
            border: 2px solid var(--accent);
            font-weight: 600;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* Time Slots */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .time-slot {
            padding: 0.75rem;
            background: var(--bg-light);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .time-slot:hover {
            border-color: var(--primary);
            background: white;
        }

        .time-slot.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Video Call */
        .call-container {
            background: black;
            border-radius: 16px;
            padding: 2rem;
            color: white;
            text-align: center;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .video-box {
            background: #333;
            border-radius: 12px;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .video-box.local {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            aspect-ratio: 9 / 16;
        }

        .video-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .avatar-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
        }

        .call-info {
            margin-bottom: 2rem;
        }

        .call-info h2 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .call-duration {
            font-size: 14px;
            color: #aaa;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn.mic {
            background: var(--primary);
            color: white;
        }

        .control-btn.mic:hover {
            background: var(--primary-dark);
        }

        .control-btn.video {
            background: var(--primary);
            color: white;
        }

        .control-btn.video:hover {
            background: var(--primary-dark);
        }

        .control-btn.end {
            background: var(--danger);
            color: white;
        }

        .control-btn.end:hover {
            background: #e55555;
        }

        .control-btn.muted {
            background: #555;
            color: #aaa;
        }

        /* Messages */
        .messages-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: 600px;
        }

        .conversation-list {
            background: white;
            border-radius: 12px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .conversation-item:hover {
            background: var(--bg-light);
        }

        .conversation-item.active {
            background: linear-gradient(135deg, rgba(111, 78, 55, 0.1), rgba(212, 165, 116, 0.1));
        }

        .chat-window {
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: var(--bg-light);
            color: var(--text-dark);
            font-size: 14px;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: var(--primary);
            color: white;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        .chat-input input {
            flex: 1;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .search-bar input {
            flex: 1;
        }

        .search-bar select {
            min-width: 180px;
        }

        /* Meeting Card */
        .meeting-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            margin-bottom: 1rem;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .meeting-time {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
        }

        .meeting-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .meeting-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .meeting-status.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .meeting-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }

        /* Profile Detail */
        .profile-detail {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .profile-header .person-avatar {
            width: 120px;
            height: 120px;
            font-size: 48px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .profile-header .person-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-header .edit-profile-btn {
            position: absolute;
            top: 0;
            right: 0;
        }

        .profile-info {
            margin-bottom: 1.5rem;
        }

        .profile-info-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 14px;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .profile-actions button {
            flex: 1;
        }

        .profile-posts {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .post-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .post-meta {
            font-size: 12px;
            color: #999;
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .post-action-btn:hover {
            background: rgba(111, 78, 55, 0.1);
        }

        .resume-section {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .resume-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-decoration: none;
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .resume-link:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .resume-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-light);
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: white;
        }

        .file-upload-area.drag-over {
            border-color: var(--accent);
            background: rgba(212, 165, 116, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .avatar-upload-preview {
            width: 150px;
            height: 150px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 60px;
            font-weight: 700;
        }

        .avatar-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .messages-wrapper {
                grid-template-columns: 250px 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .grid.two-col {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .sidebar nav {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .messages-wrapper {
                grid-template-columns: 1fr;
                height: auto;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-bar select {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo" style="font-size: 22px; letter-spacing: -0.5px;">
                <span style="display: inline-block; font-size: 28px; margin-right: 4px;">&#9749;</span>
                <span style="font-weight: 800; color: var(--accent);">Coffee</span><span style="font-weight: 300; color: var(--text-light);">Chat</span>
            </div>
            <nav id="navMenu"></nav>
            <div class="sidebar-spacer"></div>
            <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Auth Screens -->
            <div id="loginView" class="content-view active">
                <div class="auth-container">
                    <h1>Welcome Back</h1>
                    <p class="auth-subtitle">Connect and grow with professionals in your industry</p>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button class="btn btn-primary" onclick="handleLogin()" style="width: 100%;">Sign In</button>
                    
                    <div class="toggle-auth">
                        New to Coffee Chat? <button onclick="switchView('signupView')">Create Account</button>
                    </div>
                </div>
            </div>

            <div id="signupView" class="content-view">
                <div class="auth-container">
                    <h1>Join Coffee Chat</h1>
                    <p class="auth-subtitle">Start building genuine professional connections</p>
                    
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="signupFirstName" placeholder="Jane">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="signupLastName" placeholder="Smith">
                    </div>
                    <div class="form-group">
                        <label>Industry</label>
                        <select id="signupIndustry">
                            <option value="">Select your industry</option>
                            <option value="Technology">Technology</option>
                            <option value="Finance">Finance</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Design">Design</option>
                            <option value="Education">Education</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Interests & Passions</label>
                        <textarea id="signupInterests" placeholder="AI, Product Management, Startups..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Career Goals</label>
                        <textarea id="signupGoals" placeholder="What are you looking to achieve?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button class="btn btn-primary" onclick="handleSignup()" style="width: 100%;">Create Account</button>
                    
                    <div class="toggle-auth">
                        Already have an account? <button onclick="switchView('loginView')">Sign In</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardView" class="content-view">
                <h1>Welcome, <span id="userName"></span>!</h1>
                <p style="color: #999; margin-bottom: 2rem;">Build genuine connections over real conversations</p>

                <div class="stats">
                    <div class="stat-card">
                        <h3 id="statConnections">0</h3>
                        <p>Connections</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statGroups">0</h3>
                        <p>Groups Joined</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statMeetings">0</h3>
                        <p>Meetings Scheduled</p>
                    </div>
                </div>

                <h2>Quick Actions</h2>
                <div class="grid">
                    <div class="card person-card" onclick="editMyProfile()" style="cursor: pointer;">
                        <div class="person-avatar">üë§</div>
                        <h3>Edit Profile</h3>
                        <p style="font-size: 13px; color: #999;">Update your information</p>
                    </div>
                    <div class="card person-card" onclick="switchView('discoverView')" style="cursor: pointer;">
                        <div class="person-avatar">üîç</div>
                        <h3>Discover People</h3>
                        <p style="font-size: 13px; color: #999;">Find genuine connections</p>
                    </div>
                    <div class="card person-card" onclick="switchView('groupsView')" style="cursor: pointer;">
                        <div class="person-avatar">üë•</div>
                        <h3>Communities</h3>
                        <p style="font-size: 13px; color: #999;">Join interest groups</p>
                    </div>
                    <div class="card person-card" onclick="switchView('calendarView')" style="cursor: pointer;">
                        <div class="person-avatar">üìÖ</div>
                        <h3>Calendar</h3>
                        <p style="font-size: 13px; color: #999;">View your schedule</p>
                    </div>
                    <div class="card person-card" onclick="switchView('messagesView')" style="cursor: pointer;">
                        <div class="person-avatar">üí¨</div>
                        <h3>Messages</h3>
                        <p style="font-size: 13px; color: #999;">Chat with connections</p>
                    </div>
                    <div class="card person-card" onclick="createPost()" style="cursor: pointer;">
                        <div class="person-avatar">‚úçÔ∏è</div>
                        <h3>Create Post</h3>
                        <p style="font-size: 13px; color: #999;">Share your thoughts</p>
                    </div>
                    <div class="card person-card" onclick="switchView('availabilityView')" style="cursor: pointer;">
                        <div class="person-avatar">üïí</div>
                        <h3>Set Availability</h3>
                        <p style="font-size: 13px; color: #999;">Manage your schedule</p>
                    </div>
                </div>
            </div>

            <!-- Discover View -->
            <div id="discoverView" class="content-view">
                <h1>Discover People</h1>
                <p style="color: #999; margin-bottom: 1.5rem;">Find professionals in your industry</p>

                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1rem; font-size: 16px;">Advanced Search</h3>
                    <div class="search-bar">
                        <input type="text" id="searchName" placeholder="Search by name..." onkeyup="filterDiscovery()">
                        <select id="filterIndustry" onchange="filterDiscovery()">
                            <option value="">All Industries</option>
                            <option value="Technology">Technology</option>
                            <option value="Finance">Finance</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Design">Design</option>
                        </select>
                    </div>
                    <div class="search-bar" style="margin-top: 1rem;">
                        <input type="text" id="searchLocation" placeholder="Filter by location..." onkeyup="filterDiscovery()">
                        <input type="text" id="searchInterests" placeholder="Filter by interests (e.g., AI, Startups)..." onkeyup="filterDiscovery()">
                        <input type="text" id="searchCompany" placeholder="Filter by company..." onkeyup="filterDiscovery()">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-primary btn-sm" onclick="filterDiscovery()">Search</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Clear All Filters</button>
                    </div>
                </div>

                <div id="recommendationsSection"></div>
                <div id="discoverGrid" class="grid"></div>
            </div>

            <!-- Profile Detail View -->
            <div id="profileDetailView" class="content-view">
                <button class="btn btn-secondary btn-sm" onclick="switchView('discoverView')" style="margin-bottom: 1.5rem;">‚Üê Back</button>
                <div id="profileDetailContent" class="profile-detail"></div>
            </div>

            <!-- Modals moved to end of body -->

            <!-- Groups View -->
            <div id="groupsView" class="content-view">
                <h1>Communities & Groups</h1>
                <p style="color: #999; margin-bottom: 2rem;">Join groups aligned with your industry and interests</p>

                <h2 style="margin-top: 2rem;">Featured Groups</h2>
                <div id="groupsList" class="grid"></div>

                <h2 style="margin-top: 2rem;">Your Groups</h2>
                <div id="myGroupsList"></div>
            </div>

            <!-- Group Detail View -->
            <div id="groupDetailView" class="content-view">
                <button class="btn btn-secondary btn-sm" onclick="switchView('groupsView')" style="margin-bottom: 1.5rem;">&larr; Back to Groups</button>
                <div id="groupDetailContent"></div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="content-view">
                <h1>Your Schedule</h1>
                <p style="color: #999; margin-bottom: 2rem;">View and manage your coffee chats</p>

                <div class="grid two-col">
                    <div>
                        <h2 style="margin-bottom: 1rem;">Calendar</h2>
                        <div class="calendar">
                            <div class="calendar-header">
                                <button onclick="previousMonth()">‚Üê</button>
                                <h3 style="margin: 0;" id="currentMonth"></h3>
                                <button onclick="nextMonth()">‚Üí</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                    </div>

                    <div>
                        <h2 style="margin-bottom: 1rem;">Upcoming Meetings</h2>
                        <div id="meetingsList"></div>
                    </div>
                </div>
            </div>

            <!-- Messages View -->
            <div id="messagesView" class="content-view">
                <h1>Messages</h1>
                <p style="color: #999; margin-bottom: 1.5rem;">Connect with your network</p>
                <div class="messages-wrapper">
                    <div id="conversationList" class="conversation-list"></div>
                    <div id="chatWindow" class="chat-window">
                        <div class="chat-header">
                            <h3>Select a conversation</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Call View -->
            <div id="callView" class="content-view">
                <button class="btn btn-secondary btn-sm" onclick="endCall()" style="margin-bottom: 1.5rem;">‚Üê End Call</button>
                <div class="call-container">
                    <div class="video-box local">
                        <div class="video-placeholder">
                            <div class="avatar-large">üë§</div>
                        </div>
                    </div>
                    <div class="video-grid">
                        <div class="video-box">
                            <div class="video-placeholder">
                                <div class="avatar-large" id="remoteName"></div>
                                <p id="remotePerson"></p>
                            </div>
                        </div>
                    </div>
                    <div class="call-info">
                        <h2 id="callPersonName"></h2>
                        <p class="call-duration"><span id="callTimer">00:00</span></p>
                    </div>
                    <div class="call-controls">
                        <button class="control-btn mic" id="micBtn" onclick="toggleMic()">üé§</button>
                        <button class="control-btn video" id="videoBtn" onclick="toggleVideo()">üìπ</button>
                        <button class="control-btn end" onclick="endCall()">‚òéÔ∏è</button>
                    </div>
                </div>
            </div>

            <!-- Schedule Meeting View -->
            <div id="scheduleView" class="content-view">
                <button class="btn btn-secondary btn-sm" onclick="goBack()" style="margin-bottom: 1.5rem;">‚Üê Back</button>
                <div class="profile-detail">
                    <h1 style="text-align: center; margin-bottom: 2rem;">Schedule a Coffee Chat</h1>
                    
                    <div class="form-group">
                        <label>With: <strong id="scheduleName"></strong></label>
                    </div>

                    <div class="form-group">
                        <label>Select Date</label>
                        <input type="date" id="scheduleDate">
                    </div>

                    <div class="form-group">
                        <label>Select Time</label>
                        <div class="time-slots" id="timeSlots"></div>
                    </div>

                    <div class="form-group">
                        <label>Duration</label>
                        <select id="scheduleDuration">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Topic/Purpose</label>
                        <textarea id="scheduleTopic" placeholder="What would you like to discuss?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Meeting Type</label>
                        <select id="scheduleType">
                            <option value="video">Video Call</option>
                            <option value="zoom">Zoom Meeting</option>
                            <option value="facetime">FaceTime</option>
                            <option value="phone">Phone Call</option>
                            <option value="coffee">Coffee Chat (In-person)</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="sendMeetingRequest()" style="width: 100%;">Send Meeting Request</button>
                </div>
            </div>

            <!-- Feed View -->
            <div id="feedView" class="content-view">
                <h1>Feed</h1>
                <p style="color: #999; margin-bottom: 1.5rem;">See what's happening in your network</p>

                <button class="btn btn-primary" onclick="createPost()" style="margin-bottom: 2rem;">‚úçÔ∏è Create Post</button>

                <div id="feedPosts"></div>
            </div>

            <!-- Events View -->
            <div id="eventsView" class="content-view">
                <h1>Events</h1>
                <p style="color: #999; margin-bottom: 1.5rem;">Discover and create networking events</p>

                <button class="btn btn-primary" onclick="createEvent()" style="margin-bottom: 2rem;">üéâ Create Event</button>

                <div class="search-bar">
                    <input type="text" id="searchEvents" placeholder="Search events..." onkeyup="filterEvents()">
                    <select id="filterEventType" onchange="filterEvents()">
                        <option value="">All Types</option>
                        <option value="virtual">Virtual</option>
                        <option value="in-person">In-Person</option>
                        <option value="hybrid">Hybrid</option>
                    </select>
                </div>

                <div id="eventsList" class="grid"></div>
            </div>

            <!-- Availability View -->
            <div id="availabilityView" class="content-view">
                <h1>Set Your Availability</h1>
                <p style="color: #999; margin-bottom: 2rem;">Let people know when you're available for coffee chats</p>

                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <h3 style="margin-bottom: 1.5rem;">Weekly Availability</h3>

                    <div id="availabilitySlots">
                        <!-- Availability slots will be rendered here -->
                    </div>

                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <h3 style="margin-bottom: 1rem;">Add Time Slot</h3>
                        <div class="form-group">
                            <label>Day of Week</label>
                            <select id="availabilityDay">
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Start Time</label>
                                <input type="time" id="availabilityStartTime" value="09:00">
                            </div>
                            <div class="form-group">
                                <label>End Time</label>
                                <input type="time" id="availabilityEndTime" value="17:00">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addAvailabilitySlot()">Add Availability</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (outside main-content to avoid overflow clipping) -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Edit Profile</h2>
                <button class="modal-close" onclick="closeModal('editProfileModal')">√ó</button>
            </div>

            <div class="avatar-upload-preview" id="avatarPreview">
                <span id="avatarInitials"></span>
            </div>

            <div class="form-group">
                <label>Profile Picture</label>
                <div class="file-upload-area" onclick="document.getElementById('avatarInput').click()">
                    <p>Click or drag to upload profile picture</p>
                    <p style="font-size: 12px; color: #999;">JPG, PNG (Max 5MB)</p>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
            </div>

            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="editFirstName">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="editLastName">
            </div>
            <div class="form-group">
                <label>Job Title</label>
                <input type="text" id="editRole" placeholder="e.g., Senior Product Manager">
            </div>
            <div class="form-group">
                <label>Company</label>
                <input type="text" id="editCompany" placeholder="e.g., TechCorp">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="editLocation" placeholder="e.g., San Francisco, CA">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <textarea id="editBio" placeholder="Tell others about yourself..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>Industry</label>
                <select id="editIndustry">
                    <option value="Technology">Technology</option>
                    <option value="Finance">Finance</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Sales">Sales</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Design">Design</option>
                    <option value="Education">Education</option>
                </select>
            </div>
            <div class="form-group">
                <label>Interests & Passions (comma-separated)</label>
                <input type="text" id="editInterests" placeholder="AI, Product Management, Startups">
            </div>
            <div class="form-group">
                <label>Hobbies (comma-separated)</label>
                <input type="text" id="editHobbies" placeholder="Working out, Reading, Hiking, Photography">
            </div>
            <div class="form-group">
                <label>Career Goals</label>
                <textarea id="editGoals" placeholder="What are you looking to achieve?" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Resume</label>
                <div class="file-upload-area" onclick="document.getElementById('resumeInput').click()">
                    <p>Click or drag to upload resume</p>
                    <p style="font-size: 12px; color: #999;">PDF (Max 10MB)</p>
                </div>
                <input type="file" id="resumeInput" accept=".pdf" style="display: none;" onchange="handleResumeUpload(event)">
                <div id="resumePreview"></div>
            </div>

            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('editProfileModal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()" style="flex: 1;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Create Post</h2>
                <button class="modal-close" onclick="closeModal('createPostModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>What's on your mind?</label>
                <textarea id="postContent" placeholder="Share your thoughts, insights, or experiences..." rows="6"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('createPostModal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="publishPost()" style="flex: 1;">Publish</button>
            </div>
        </div>
    </div>

    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Create Event</h2>
                <button class="modal-close" onclick="closeModal('createEventModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>Event Title</label>
                <input type="text" id="eventTitle" placeholder="e.g., Coffee Chat Networking Mixer">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="eventDescription" placeholder="Tell people what this event is about..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>Event Type</label>
                <select id="eventType">
                    <option value="virtual">Virtual</option>
                    <option value="in-person">In-Person</option>
                    <option value="hybrid">Hybrid</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location / Meeting Link</label>
                <input type="text" id="eventLocation" placeholder="Address or Zoom link">
            </div>
            <div class="form-group">
                <label>Start Date & Time</label>
                <input type="datetime-local" id="eventStartTime">
            </div>
            <div class="form-group">
                <label>End Date & Time</label>
                <input type="datetime-local" id="eventEndTime">
            </div>
            <div class="form-group">
                <label>Max Attendees (optional)</label>
                <input type="number" id="eventMaxAttendees" placeholder="Leave blank for unlimited">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('createEventModal')" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="publishEvent()" style="flex: 1;">Create Event</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vmrmkkngjlicuvrpejxx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_UZ6aNCU1qZ5TfGCHXdPz4w_ferczbVL';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let currentUser = null;
        let users = [];
        let groups = [];
        let messages = [];
        let meetings = [];
        let connections = [];
        let posts = [];
        let events = [];
        let selectedConversation = null;
        let selectedPerson = null;
        let previousView = 'dashboardView';
        let callDuration = 0;
        let callInterval = null;
        let currentMonth = new Date();
        let selectedTime = null;

        const mockUsers = [
            {
                id: '00000000-0000-0000-0000-000000000002',
                firstName: 'Sarah',
                lastName: 'Chen',
                industry: 'Technology',
                interests: ['AI', 'Product Management', 'Startups'],
                hobbies: ['Working out', 'Reading', 'Hiking'],
                goals: 'Lead a high-impact product team',
                email: 'sarah@example.com',
                bio: 'Product leader with 8 years building AI-powered solutions. Previously at Google and two successful startups. Passionate about mentoring and building products that scale.',
                role: 'Senior Product Manager',
                company: 'TechCorp',
                location: 'San Francisco, CA',
                profilePicture: null,
                resume: null,
                posts: [
                    { id: 'mock-post-001', content: 'Just launched our new AI feature! Excited to share what we learned about user onboarding.', date: '2 days ago', likes_count: 24 }
                ]
            },
            {
                id: '00000000-0000-0000-0000-000000000003',
                firstName: 'Marcus',
                lastName: 'Johnson',
                industry: 'Finance',
                interests: ['Fintech', 'Blockchain', 'Investing'],
                hobbies: ['Working out', 'Tennis', 'Traveling'],
                goals: 'Build financial products for underserved markets',
                email: 'marcus@example.com',
                bio: 'Fintech entrepreneur focused on financial inclusion. Built two successful ventures in mobile payments. Looking to connect with fellow innovators.',
                role: 'Founder & CEO',
                company: 'FinanceForAll',
                location: 'New York, NY',
                profilePicture: null,
                resume: null,
                posts: [
                    { id: 'mock-post-002', content: 'The future of banking is decentralized. Here\'s why traditional banks need to adapt...', date: '1 week ago', likes_count: 42 }
                ]
            },
            {
                id: '00000000-0000-0000-0000-000000000004',
                firstName: 'Elena',
                lastName: 'Rodriguez',
                industry: 'Healthcare',
                interests: ['Medical Tech', 'Startups', 'Research'],
                goals: 'Innovate in patient care technology',
                email: 'elena@example.com',
                bio: 'Healthcare technologist bridging the gap between medicine and innovation. MD turned entrepreneur. Building tools that improve patient outcomes.',
                role: 'Chief Medical Officer',
                company: 'HealthTech Innovations',
                location: 'Boston, MA',
                profilePicture: null,
                resume: null,
                posts: []
            },
            {
                id: '00000000-0000-0000-0000-000000000005',
                firstName: 'David',
                lastName: 'Kim',
                industry: 'Technology',
                interests: ['Backend Engineering', 'Scaling', 'Open Source'],
                goals: 'Become a technical leader at scale',
                email: 'david@example.com',
                bio: 'Staff Engineer specializing in distributed systems. Love solving complex scaling challenges. Active open source contributor and technical writer.',
                role: 'Staff Software Engineer',
                company: 'CloudScale Inc',
                location: 'Seattle, WA',
                profilePicture: null,
                resume: null,
                posts: [
                    { id: 'mock-post-003', content: 'Wrote a deep dive on database sharding strategies. Check it out if you\'re dealing with scaling challenges!', date: '3 days ago', likes_count: 67 }
                ]
            },
            {
                id: '00000000-0000-0000-0000-000000000006',
                firstName: 'Priya',
                lastName: 'Patel',
                industry: 'Marketing',
                interests: ['Growth Marketing', 'Content', 'Brand Strategy'],
                goals: 'Lead marketing at a growth-stage startup',
                email: 'priya@example.com',
                bio: 'Growth marketer who loves data and creativity in equal measure. Scaled three startups from 0 to 1M users. Always excited to talk growth strategies.',
                role: 'Head of Growth',
                company: 'GrowthLabs',
                location: 'Austin, TX',
                profilePicture: null,
                resume: null,
                posts: []
            }
        ];

        const mockGroups = [
            {
                id: 1,
                name: 'Tech Leaders Collective',
                industry: 'Technology',
                description: 'For technology professionals looking to grow and mentor others',
                members: 234,
                posts: [
                    { author: 'Sarah Chen', content: 'Anyone working on AI products? Would love to connect!' },
                    { author: 'David Kim', content: 'Best practices for scaling backends - let\'s discuss!' }
                ]
            },
            {
                id: 2,
                name: 'Fintech Innovators',
                industry: 'Finance',
                description: 'Building the future of financial services',
                members: 189,
                posts: [
                    { author: 'Marcus Johnson', content: 'New regulatory landscape - what\'s your take?' }
                ]
            },
            {
                id: 3,
                name: 'Healthcare Tech Forum',
                industry: 'Healthcare',
                description: 'Healthcare professionals and technologists',
                members: 156,
                posts: [
                    { author: 'Elena Rodriguez', content: 'Patient data privacy - best solutions?' }
                ]
            },
            {
                id: 4,
                name: 'Marketing Masters',
                industry: 'Marketing',
                description: 'Growth, strategy, and brand discussions',
                members: 201,
                posts: [
                    { author: 'Priya Patel', content: 'Growth hacking strategies for B2B startups' }
                ]
            }
        ];

        // Initialize
        async function init() {
            users = [...mockUsers];
            groups = [...mockGroups];

            // Check for existing Supabase session
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                // User is logged in, load their profile
                await loadUserProfile(session.user.id);
                renderNav();
                switchView('dashboardView');
                await updateDashboard();
            } else {
                // No session, show login
                renderNav();
                switchView('loginView');
            }

            renderCalendar();
        }

        async function loadUserProfile(userId) {
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                currentUser = {
                    id: profile.id,
                    firstName: profile.first_name,
                    lastName: profile.last_name,
                    email: profile.email,
                    industry: profile.industry,
                    interests: profile.interests || [],
                    hobbies: profile.hobbies || [],
                    goals: profile.goals,
                    bio: profile.bio,
                    role: profile.role,
                    company: profile.company,
                    location: profile.location,
                    profilePicture: profile.profile_picture,
                    resume: profile.resume_url ? { url: profile.resume_url, name: 'Resume.pdf' } : null
                };

                // Load user's data
                await loadUserData();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Load connections
                const { data: connectionsData } = await supabaseClient
                    .from('connections')
                    .select('*')
                    .or(`user_id.eq.${currentUser.id},connected_user_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted');

                connections = connectionsData || [];

                // Load posts for feed
                const { data: postsData } = await supabaseClient
                    .from('posts')
                    .select('*')
                    .order('created_at', { ascending: false });

                posts = postsData || [];

                // Load events
                const { data: eventsData } = await supabaseClient
                    .from('events')
                    .select('*, event_rsvps(user_id)')
                    .order('start_time', { ascending: true });

                events = (eventsData || []).map(event => ({
                    ...event,
                    attendees: event.event_rsvps ? event.event_rsvps.map(r => r.user_id) : [],
                    creator_name: event.creator_id // Will be populated from profiles
                }));

                // Load meetings
                const { data: meetingsData } = await supabaseClient
                    .from('meetings')
                    .select('*')
                    .or(`organizer_id.eq.${currentUser.id},participant_id.eq.${currentUser.id}`)
                    .order('start_time', { ascending: true});

                meetings = meetingsData || [];

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function saveToStorage() {
            // Deprecated - keeping for backwards compatibility
            // Data is now saved directly to Supabase
        }

        // Auth
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                // Sign in with Supabase
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                // Fetch user profile from database
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .maybeSingle();

                if (profileError) throw profileError;

                if (!profile) {
                    alert('No profile found for this account. Please sign up first.');
                    await supabaseClient.auth.signOut();
                    return;
                }

                currentUser = {
                    id: profile.id,
                    firstName: profile.first_name,
                    lastName: profile.last_name,
                    email: profile.email,
                    industry: profile.industry,
                    interests: profile.interests || [],
                    hobbies: profile.hobbies || [],
                    goals: profile.goals,
                    bio: profile.bio,
                    role: profile.role,
                    company: profile.company,
                    location: profile.location,
                    profilePicture: profile.profile_picture,
                    resume: profile.resume_url ? { url: profile.resume_url, name: 'Resume.pdf' } : null
                };

                renderNav();
                switchView('dashboardView');
                await updateDashboard();
                alert('Welcome back!');
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        async function handleSignup() {
            const firstName = document.getElementById('signupFirstName').value;
            const lastName = document.getElementById('signupLastName').value;
            const industry = document.getElementById('signupIndustry').value;
            const interests = document.getElementById('signupInterests').value.split(',').map(i => i.trim()).filter(Boolean);
            const goals = document.getElementById('signupGoals').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!firstName || !lastName || !industry || !email || !password || !goals) {
                alert('Please fill in all required fields');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            try {
                // Sign up with Supabase (profile is auto-created by database trigger)
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            industry: industry,
                            interests: interests,
                            hobbies: [],
                            goals: goals
                        }
                    }
                });

                if (error) throw error;

                currentUser = {
                    id: data.user.id,
                    firstName,
                    lastName,
                    email,
                    industry,
                    interests,
                    hobbies: [],
                    goals,
                    bio: '',
                    role: '',
                    company: '',
                    location: '',
                    profilePicture: null,
                    resume: null
                };

                renderNav();
                switchView('dashboardView');
                await updateDashboard();
                alert('Account created successfully! Please check your email to verify your account.');
            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;

                currentUser = null;
                connections = [];
                messages = [];
                meetings = [];
                posts = [];
                events = [];
                switchView('loginView');
                renderNav();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }

        // Navigation
        function renderNav() {
            const navMenu = document.getElementById('navMenu');
            navMenu.innerHTML = '';

            if (currentUser) {
                const items = [
                    { id: 'dashboardView', label: 'üè† Dashboard' },
                    { id: 'feedView', label: 'üì∞ Feed' },
                    { id: 'discoverView', label: 'üîç Discover' },
                    { id: 'eventsView', label: 'üéâ Events' },
                    { id: 'groupsView', label: 'üë• Communities' },
                    { id: 'calendarView', label: 'üìÖ Calendar' },
                    { id: 'messagesView', label: 'üí¨ Messages' }
                ];

                items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'nav-item';
                    btn.textContent = item.label;
                    btn.onclick = () => switchView(item.id);
                    navMenu.appendChild(btn);
                });
            }
        }

        function switchView(viewId) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            if (viewId === 'discoverView') renderDiscovery();
            if (viewId === 'feedView') renderFeed();
            if (viewId === 'eventsView') renderEvents();
            if (viewId === 'groupsView') renderGroups();
            if (viewId === 'messagesView') renderMessages();
            if (viewId === 'dashboardView') updateDashboard();
            if (viewId === 'calendarView') renderCalendarView();
            if (viewId === 'availabilityView') renderAvailability();

            if (viewId !== 'scheduleView' && viewId !== 'profileDetailView' && viewId !== 'callView' && viewId !== 'groupDetailView') {
                previousView = viewId;
            }
        }

        function goBack() {
            switchView(previousView);
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('userName').textContent = currentUser.firstName;
            document.getElementById('statConnections').textContent = connections.length;
            document.getElementById('statGroups').textContent = groups.filter(g => g.userJoined).length;
            document.getElementById('statMeetings').textContent = meetings.filter(m => m.status !== 'completed').length;
        }

        // Discovery
        function renderDiscovery() {
            // Render smart recommendations
            const recSection = document.getElementById('recommendationsSection');
            if (recSection) {
                recSection.innerHTML = renderRecommendations();
            }

            const searchName = document.getElementById('searchName')?.value.toLowerCase() || '';
            const filterIndustry = document.getElementById('filterIndustry')?.value || '';
            const searchLocation = document.getElementById('searchLocation')?.value.toLowerCase() || '';
            const searchInterests = document.getElementById('searchInterests')?.value.toLowerCase() || '';
            const searchCompany = document.getElementById('searchCompany')?.value.toLowerCase() || '';

            let filtered = users.filter(u => {
                // Name match
                const matchName = !searchName ||
                    u.firstName.toLowerCase().includes(searchName) ||
                    u.lastName.toLowerCase().includes(searchName);

                // Industry match
                const matchIndustry = !filterIndustry || u.industry === filterIndustry;

                // Location match
                const matchLocation = !searchLocation ||
                    (u.location && u.location.toLowerCase().includes(searchLocation));

                // Interests match
                const matchInterests = !searchInterests ||
                    (u.interests && u.interests.some(interest =>
                        interest.toLowerCase().includes(searchInterests)
                    )) ||
                    (u.hobbies && u.hobbies.some(hobby =>
                        hobby.toLowerCase().includes(searchInterests)
                    ));

                // Company match
                const matchCompany = !searchCompany ||
                    (u.company && u.company.toLowerCase().includes(searchCompany));

                return matchName && matchIndustry && matchLocation && matchInterests && matchCompany;
            });

            const grid = document.getElementById('discoverGrid');
            grid.innerHTML = filtered.map(user => {
                const isConnected = connections.find(c => c.user_id === currentUser.id && c.connected_user_id === user.id || c.connected_user_id === currentUser.id && c.user_id === user.id);
                const avatarHTML = user.profilePicture ? 
                    `<div class="person-avatar" style="width: 70px; height: 70px; font-size: 28px; margin: 0 auto 1rem;"><img src="${user.profilePicture}" alt="${user.firstName}"></div>` :
                    `<div class="person-avatar" style="width: 70px; height: 70px; font-size: 28px; margin: 0 auto 1rem;">${user.firstName[0]}${user.lastName[0]}</div>`;
                
                return `
                    <div class="card person-card">
                        ${avatarHTML}
                        <h3>${user.firstName} ${user.lastName}</h3>
                        ${user.role ? `<p class="role">${user.role}</p>` : `<p class="role">${user.industry}</p>`}
                        ${user.company ? `<p style="font-size: 12px; color: #999; margin-top: -0.25rem;">${user.company}</p>` : ''}
                        <div class="tags">
                            ${user.interests.slice(0, 3).map(i => `<span class="tag">${i}</span>`).join('')}
                        </div>
                        <div class="profile-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewProfile('${user.id}')" style="flex: 1; justify-content: center;">View Profile</button>
                            ${isConnected ? 
                                `<button class="btn btn-secondary btn-sm" onclick="startMessage('${user.id}')" style="flex: 1; justify-content: center;">Message</button>` :
                                `<button class="btn btn-accent btn-sm" onclick="connectUser('${user.id}')" style="flex: 1; justify-content: center;">Connect</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterDiscovery() {
            renderDiscovery();
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('filterIndustry').value = '';
            document.getElementById('searchLocation').value = '';
            document.getElementById('searchInterests').value = '';
            document.getElementById('searchCompany').value = '';
            renderDiscovery();
        }

        function viewProfile(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            selectedPerson = user;
            previousView = 'discoverView';

            const isConnected = connections.find(c => c.user_id === currentUser.id && c.connected_user_id === userId || c.connected_user_id === currentUser.id && c.user_id === userId);
            const isOwnProfile = currentUser && currentUser.id === userId;

            const avatarHTML = user.profilePicture ? 
                `<div class="person-avatar" style="width: 120px; height: 120px; font-size: 48px;"><img src="${user.profilePicture}" alt="${user.firstName}"></div>` :
                `<div class="person-avatar" style="width: 120px; height: 120px; font-size: 48px;">${user.firstName[0]}${user.lastName[0]}</div>`;

            const content = document.getElementById('profileDetailContent');
            content.innerHTML = `
                <div class="profile-header">
                    ${avatarHTML}
                    ${isOwnProfile ? '<button class="btn btn-secondary btn-sm edit-profile-btn" onclick="editMyProfile()">‚úèÔ∏è Edit Profile</button>' : ''}
                    <h1 style="margin-bottom: 0.5rem;">${user.firstName} ${user.lastName}</h1>
                    ${user.role ? `<p style="font-weight: 600; color: var(--primary); margin-bottom: 0.25rem;">${user.role}</p>` : ''}
                    ${user.company ? `<p style="color: #666; font-size: 14px; margin-bottom: 0.25rem;">${user.company}</p>` : ''}
                    ${user.location ? `<p style="color: #999; font-size: 13px;">üìç ${user.location}</p>` : ''}
                    <p class="role" style="margin-top: 0.5rem;">${user.industry}</p>
                </div>

                ${user.bio ? `
                    <div class="profile-info">
                        <h3>About</h3>
                        <p style="line-height: 1.6;">${user.bio}</p>
                    </div>
                ` : ''}

                ${user.resume ? `
                    <div class="resume-section">
                        <h3 style="margin-bottom: 1rem;">Resume</h3>
                        <a href="${user.resume}" class="resume-link" download>
                            <div class="resume-icon">üìÑ</div>
                            <div>
                                <p style="font-weight: 600; margin: 0;">${user.firstName}'s Resume</p>
                                <p style="font-size: 12px; color: #999; margin: 0;">Click to download PDF</p>
                            </div>
                        </a>
                    </div>
                ` : ''}

                <div class="profile-info">
                    <h3>Career Goals</h3>
                    <p>${user.goals}</p>
                </div>

                <div class="profile-info">
                    <h3>Interests & Passions</h3>
                    <div class="profile-tags">
                        ${user.interests.map(i => `<span class="tag">${i}</span>`).join('')}
                    </div>
                </div>

                ${!isOwnProfile ? `
                    <div class="profile-actions">
                        ${isConnected ? `
                            <button class="btn btn-primary" onclick="startMessage('${user.id}')">üí¨ Send Message</button>
                            <button class="btn btn-accent" onclick="scheduleWith('${user.id}')">üìÖ Schedule Chat</button>
                        ` : `
                            <button class="btn btn-primary" onclick="connectUser('${user.id}')">Add Connection</button>
                            <button class="btn btn-secondary" onclick="switchView('discoverView')">Back</button>
                        `}
                    </div>
                ` : ''}

                ${user.posts && user.posts.length > 0 ? `
                    <div class="profile-posts">
                        <h3 style="margin-bottom: 1rem;">Recent Posts</h3>
                        ${user.posts.map(post => `
                            <div class="post-card">
                                <div class="post-header">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        ${user.profilePicture ? 
                                            `<div class="person-avatar" style="width: 40px; height: 40px; font-size: 16px;"><img src="${user.profilePicture}"></div>` :
                                            `<div class="person-avatar" style="width: 40px; height: 40px; font-size: 16px;">${user.firstName[0]}${user.lastName[0]}</div>`
                                        }
                                        <div>
                                            <h4 style="margin: 0; font-size: 14px;">${user.firstName} ${user.lastName}</h4>
                                            <p class="post-meta">${post.date}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="post-content">${post.content}</div>
                                <div class="post-actions">
                                    <button class="post-action-btn" onclick="likePost(${post.id})">üëç ${post.likes} Likes</button>
                                    <button class="post-action-btn">üí¨ Comment</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            switchView('profileDetailView');
        }

        async function connectUser(userId) {
            if (!currentUser) {
                alert('Please log in to connect with users');
                return;
            }

            const user = users.find(u => u.id === userId);

            // Check if already connected
            const existing = connections.find(c =>
                (c.user_id === currentUser.id && c.connected_user_id === userId) ||
                (c.user_id === userId && c.connected_user_id === currentUser.id)
            );

            if (existing) {
                alert('Already connected!');
                return;
            }

            // Handle mock users locally (mock UUIDs start with 00000000-)
            if (String(userId).startsWith('00000000-')) {
                connections.push({
                    id: 'local-' + Date.now(),
                    user_id: currentUser.id,
                    connected_user_id: userId,
                    status: 'accepted'
                });
                alert(`Connected with ${user.firstName}!`);
                if (document.getElementById('profileDetailView').classList.contains('active')) {
                    viewProfile(userId);
                } else {
                    renderDiscovery();
                }
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('connections')
                    .insert([{
                        user_id: currentUser.id,
                        connected_user_id: userId,
                        status: 'accepted'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                connections.push(data);
                alert(`Connected with ${user.firstName}!`);

                if (document.getElementById('profileDetailView').classList.contains('active')) {
                    viewProfile(userId);
                } else {
                    renderDiscovery();
                }
            } catch (error) {
                console.error('Error connecting:', error);
                alert('Failed to connect: ' + error.message);
            }
        }

        // Messages
        async function startMessage(userId) {
            switchView('messagesView');
            await renderMessages();
            await selectConversation(userId);
        }

        async function renderMessages() {
            if (!currentUser) return;

            try {
                // Get all conversations (messages where user is sender or receiver)
                const { data: messagesData, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Group messages by conversation partner
                const conversations = {};
                messagesData.forEach(msg => {
                    const partnerId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    if (!conversations[partnerId]) {
                        conversations[partnerId] = [];
                    }
                    conversations[partnerId].push(msg);
                });

                const list = document.getElementById('conversationList');

                if (Object.keys(conversations).length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No conversations yet</p></div>';
                    document.getElementById('chatWindow').innerHTML = '<div class="chat-header"><h3>Start a conversation</h3></div>';
                    return;
                }

                // Render conversation list
                const conversationHTML = await Promise.all(
                    Object.entries(conversations).map(async ([partnerId, msgs]) => {
                        // Get partner profile
                        const { data: profile } = await supabaseClient
                            .from('profiles')
                            .select('first_name, last_name')
                            .eq('id', partnerId)
                            .single();

                        const partnerName = profile ? `${profile.first_name} ${profile.last_name}` : 'User';
                        const lastMessage = msgs[0].content.substring(0, 50);

                        return `
                            <div class="conversation-item ${selectedConversation === partnerId ? 'active' : ''}" onclick="selectConversation('${partnerId}')">
                                <h4>${partnerName}</h4>
                                <p style="font-size: 12px; color: #999;">${lastMessage}${msgs[0].content.length > 50 ? '...' : ''}</p>
                            </div>
                        `;
                    })
                );

                list.innerHTML = conversationHTML.join('');
            } catch (error) {
                console.error('Error rendering messages:', error);
            }
        }

        async function selectConversation(userId) {
            if (!currentUser) return;

            selectedConversation = userId;

            try {
                let messagesData = [];
                let partnerName = 'User';

                // Handle mock users locally
                if (String(userId).startsWith('00000000-')) {
                    messagesData = localMessages[userId] || [];
                    const partner = users.find(u => u.id === userId);
                    partnerName = partner ? `${partner.firstName} ${partner.lastName}` : 'User';
                } else {
                    const { data, error } = await supabaseClient
                        .from('messages')
                        .select('*')
                        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`)
                        .order('created_at', { ascending: true });

                    if (error) throw error;
                    messagesData = data || [];

                    const { data: profile } = await supabaseClient
                        .from('profiles')
                        .select('first_name, last_name')
                        .eq('id', userId)
                        .maybeSingle();

                    partnerName = profile ? `${profile.first_name} ${profile.last_name}` : 'User';
                }

                const icebreakers = getConversationStarters(userId);
                const icebreakerHTML = (!messagesData || messagesData.length === 0) ? `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="font-size: 14px; color: #999; margin-bottom: 1rem;">Start a conversation with ${partnerName}!</p>
                        <p style="font-size: 13px; color: var(--primary); font-weight: 600; margin-bottom: 0.75rem;">Try one of these icebreakers:</p>
                        ${icebreakers.map(starter => `
                            <button class="btn btn-secondary btn-sm"
                                onclick="useIcebreaker('${userId}', this.textContent.trim())"
                                style="margin: 0.25rem; font-size: 12px; text-align: left;">
                                ${starter}
                            </button>
                        `).join('')}
                    </div>
                ` : '';

                const chatWindow = document.getElementById('chatWindow');
                chatWindow.innerHTML = `
                    <div class="chat-header">
                        <div>
                            <h3 style="margin: 0;">${partnerName}</h3>
                        </div>
                        <button class="btn btn-accent btn-sm" onclick="scheduleWith('${userId}')">Schedule Chat</button>
                    </div>
                    <div class="chat-messages" id="chatMessagesContainer">
                        ${icebreakerHTML}
                        ${messagesData.map(m => `
                            <div class="message ${m.sender_id === currentUser.id ? 'sent' : 'received'}">
                                <div class="message-content">${m.content}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage('${userId}')">
                        <button class="btn btn-primary btn-sm" onclick="sendMessage('${userId}')">Send</button>
                    </div>
                `;

                // Scroll to bottom
                const container = document.getElementById('chatMessagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }

                // Mark messages as read (only for real users)
                if (!String(userId).startsWith('00000000-')) {
                    await supabaseClient
                        .from('messages')
                        .update({ read: true })
                        .eq('receiver_id', currentUser.id)
                        .eq('sender_id', userId);
                }

            } catch (error) {
                console.error('Error selecting conversation:', error);
            }
        }

        // Local storage for messages with mock users
        const localMessages = {};

        async function sendMessage(userId) {
            if (!currentUser) return;

            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            // Handle mock users locally (they don't exist in Supabase profiles table)
            if (String(userId).startsWith('00000000-')) {
                if (!localMessages[userId]) localMessages[userId] = [];
                localMessages[userId].push({
                    id: 'local-' + Date.now(),
                    sender_id: currentUser.id,
                    receiver_id: userId,
                    content: text,
                    created_at: new Date().toISOString()
                });
                input.value = '';
                await selectConversation(userId);
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        sender_id: currentUser.id,
                        receiver_id: userId,
                        content: text
                    }]);

                if (error) throw error;

                input.value = '';
                await selectConversation(userId);
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
            }
        }

        function getConversationStarters(userId) {
            const partner = users.find(u => u.id === userId);
            const starters = [];

            if (partner) {
                if (partner.industry) {
                    starters.push(`What's the most exciting trend in ${partner.industry} right now?`);
                }
                if (partner.role) {
                    starters.push(`How did you get into your role as ${partner.role}?`);
                }
                if (partner.interests && partner.interests.length > 0) {
                    starters.push(`I noticed we share an interest in ${partner.interests[0]}!`);
                }
                if (partner.company) {
                    starters.push(`What's it like working at ${partner.company}?`);
                }
            }

            const generic = [
                "What's been the highlight of your week?",
                "Any good books or podcasts you'd recommend?",
                "What project are you most excited about right now?"
            ];

            return [...starters, ...generic].slice(0, 4);
        }

        function useIcebreaker(userId, text) {
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = text;
                input.focus();
            }
        }

        // Groups
        function renderGroups() {
            const list = document.getElementById('groupsList');
            list.innerHTML = mockGroups.map(group => `
                <div class="card">
                    <h3>${group.name}</h3>
                    <p>${group.description}</p>
                    <p style="font-size: 12px; color: #999; margin: 0.5rem 0;">${group.members} members &bull; ${group.industry}</p>
                    ${group.userJoined ?
                        `<button class="btn btn-accent" onclick="viewGroup(${group.id})" style="width: 100%; margin-top: 1rem;">View Group</button>` :
                        `<button class="btn btn-primary" onclick="joinGroup(${group.id})" style="width: 100%; margin-top: 1rem;">Join Group</button>`
                    }
                </div>
            `).join('');

            const myGroups = mockGroups.filter(g => g.userJoined);
            const myList = document.getElementById('myGroupsList');
            if (myGroups.length === 0) {
                myList.innerHTML = '<div class="empty-state"><p>Join groups to connect with your community</p></div>';
            } else {
                myList.innerHTML = myGroups.map(group => `
                    <div class="card compact" onclick="viewGroup(${group.id})" style="cursor: pointer;">
                        <h3 style="color: var(--primary);">&#10003; ${group.name}</h3>
                        <p style="font-size: 13px; color: #999;">${group.members} members</p>
                        <p style="font-size: 12px; color: var(--accent); margin-top: 0.5rem;">Click to view group &rarr;</p>
                    </div>
                `).join('');
            }
        }

        function viewGroup(groupId) {
            const group = mockGroups.find(g => g.id === groupId);
            if (!group) return;

            const content = document.getElementById('groupDetailContent');
            content.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
                    <h1 style="margin-bottom: 0.5rem;">${group.name}</h1>
                    <p style="color: #666; margin-bottom: 0.5rem;">${group.description}</p>
                    <p style="font-size: 13px; color: #999;">${group.members} members &bull; ${group.industry}</p>
                </div>

                <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Group Discussion</h3>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="text" id="groupPostInput" placeholder="Share something with the group..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <button class="btn btn-primary btn-sm" onclick="postToGroup(${group.id})">Post</button>
                    </div>
                    <div id="groupPosts-${group.id}">
                        ${(group.posts || []).map(post => `
                            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                                <strong>${post.author}</strong>
                                <p style="margin: 0.5rem 0; color: #444;">${post.content}</p>
                            </div>
                        `).join('') || '<p style="color: #999;">No posts yet. Start the conversation!</p>'}
                    </div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1rem;">Members</h3>
                    <p style="font-size: 14px; color: #666;">${group.members} active members in this community</p>
                </div>
            `;

            switchView('groupDetailView');
        }

        function postToGroup(groupId) {
            const input = document.getElementById('groupPostInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            const group = mockGroups.find(g => g.id === groupId);
            if (!group) return;
            if (!group.posts) group.posts = [];

            group.posts.unshift({
                author: `${currentUser.firstName} ${currentUser.lastName}`,
                content: text
            });

            input.value = '';
            viewGroup(groupId);
        }

        function joinGroup(groupId) {
            const group = mockGroups.find(g => g.id === groupId);
            if (!group.userJoined) {
                group.userJoined = true;
                group.members++;
                renderGroups();
            }
        }

        // Calendar
        function renderCalendar() {
            renderCalendarGrid();
        }

        function renderCalendarView() {
            renderCalendarGrid();
            renderMeetingsList();
        }

        function renderCalendarGrid() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const isToday = new Date().toDateString() === date.toDateString();
                const hasEvent = meetings.some(m => new Date(m.date).toDateString() === date.toDateString());
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}">${day}</div>`;
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        function renderMeetingsList() {
            const list = document.getElementById('meetingsList');
            const upcomingMeetings = meetings.filter(m => m.status !== 'completed').sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingMeetings.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No upcoming meetings</p></div>';
                return;
            }

            list.innerHTML = upcomingMeetings.map(meeting => `
                <div class="meeting-card">
                    <div class="meeting-header">
                        <div>
                            <p class="meeting-time">${new Date(meeting.date).toLocaleDateString()} at ${meeting.time}</p>
                            <h3 style="margin: 0.5rem 0 0.25rem;">${meeting.personName}</h3>
                            <p style="font-size: 13px; color: #999; margin: 0;">${meeting.topic}</p>
                            <p style="font-size: 12px; color: #666; margin-top: 0.25rem;">Type: ${meeting.type}</p>
                        </div>
                        <span class="meeting-status ${meeting.status}">${meeting.status.charAt(0).toUpperCase() + meeting.status.slice(1)}</span>
                    </div>
                    <div class="meeting-actions">
                        <button class="btn btn-primary btn-sm" onclick="startCall('${meeting.personName}', '${meeting.personName[0]}')">Start Call</button>
                        <button class="btn btn-secondary btn-sm">Reschedule</button>
                    </div>
                </div>
            `).join('');
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendarGrid();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendarGrid();
        }

        // Schedule Meeting
        function scheduleWith(userId) {
            const user = users.find(u => u.id === userId);
            selectedPerson = user;
            previousView = 'profileDetailView';

            document.getElementById('scheduleName').textContent = `${user.firstName} ${user.lastName}`;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];

            renderTimeSlots();
            document.getElementById('scheduleDate').onchange = renderTimeSlots;

            switchView('scheduleView');
        }

        function renderTimeSlots() {
            const times = [];
            for (let hour = 9; hour < 17; hour++) {
                for (let min of [0, 30]) {
                    const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                    times.push(time);
                }
            }

            const html = times.map(time => `
                <div class="time-slot" onclick="selectTime('${time}', this)">${time}</div>
            `).join('');

            document.getElementById('timeSlots').innerHTML = html;
        }

        function selectTime(time, element) {
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = time;
        }

        function sendMeetingRequest() {
            const date = document.getElementById('scheduleDate').value;
            const time = selectedTime;
            const duration = document.getElementById('scheduleDuration').value;
            const topic = document.getElementById('scheduleTopic').value;
            const type = document.getElementById('scheduleType').value;

            if (!date || !time || !topic) {
                alert('Please fill in all fields');
                return;
            }

            const meeting = {
                id: meetings.length + 1,
                personId: selectedPerson.id,
                personName: `${selectedPerson.firstName} ${selectedPerson.lastName}`,
                date,
                time,
                duration,
                topic,
                type,
                status: 'pending',
                createdAt: new Date()
            };

            meetings.push(meeting);
            saveToStorage();
            alert('Meeting request sent!');
            switchView('dashboardView');
            updateDashboard();
        }

        // Calling
        function startCall(personName, initials) {
            document.getElementById('callPersonName').textContent = personName;
            document.getElementById('remoteName').textContent = initials;
            document.getElementById('remotePerson').textContent = personName;
            
            callDuration = 0;
            callInterval = setInterval(() => {
                callDuration++;
                const mins = Math.floor(callDuration / 60);
                const secs = callDuration % 60;
                document.getElementById('callTimer').textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);

            switchView('callView');
        }

        function endCall() {
            if (callInterval) clearInterval(callInterval);
            switchView('calendarView');
            renderMeetingsList();
        }

        function toggleMic() {
            const btn = document.getElementById('micBtn');
            btn.classList.toggle('muted');
        }

        function toggleVideo() {
            const btn = document.getElementById('videoBtn');
            btn.classList.toggle('muted');
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Profile Management
        function editMyProfile() {
            document.getElementById('avatarInitials').textContent = currentUser.firstName[0] + currentUser.lastName[0];
            document.getElementById('editFirstName').value = currentUser.firstName;
            document.getElementById('editLastName').value = currentUser.lastName;
            document.getElementById('editRole').value = currentUser.role || '';
            document.getElementById('editCompany').value = currentUser.company || '';
            document.getElementById('editLocation').value = currentUser.location || '';
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editIndustry').value = currentUser.industry;
            document.getElementById('editInterests').value = (currentUser.interests || []).join(', ');
            document.getElementById('editHobbies').value = (currentUser.hobbies || []).join(', ');
            document.getElementById('editGoals').value = currentUser.goals || '';
            openModal('editProfileModal');
        }

        async function saveProfile() {
            if (!currentUser) return;

            // Get all form values
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const role = document.getElementById('editRole').value;
            const company = document.getElementById('editCompany').value;
            const location = document.getElementById('editLocation').value;
            const bio = document.getElementById('editBio').value;
            const industry = document.getElementById('editIndustry').value;
            const interests = document.getElementById('editInterests').value.split(',').map(i => i.trim()).filter(Boolean);
            const hobbies = document.getElementById('editHobbies').value.split(',').map(h => h.trim()).filter(Boolean);
            const goals = document.getElementById('editGoals').value;

            try {
                // Update profile in Supabase
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        first_name: firstName,
                        last_name: lastName,
                        role,
                        company,
                        location,
                        bio,
                        industry,
                        interests,
                        hobbies,
                        goals,
                        profile_picture: currentUser.profilePicture || null,
                        resume_url: currentUser.resume || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Update local currentUser object
                currentUser.firstName = firstName;
                currentUser.lastName = lastName;
                currentUser.role = role;
                currentUser.company = company;
                currentUser.location = location;
                currentUser.bio = bio;
                currentUser.industry = industry;
                currentUser.interests = interests;
                currentUser.hobbies = hobbies;
                currentUser.goals = goals;

                alert('Profile updated successfully!');
                closeModal('editProfileModal');
                await updateDashboard();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to update profile: ' + error.message);
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.profilePicture = e.target.result;
                    document.getElementById('avatarPreview').innerHTML = `<img src="${e.target.result}" alt="Profile Picture">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleResumeUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.resume = e.target.result;
                    document.getElementById('resumePreview').innerHTML = `
                        <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 8px; color: #155724; font-size: 14px;">
                            ‚úì Resume uploaded successfully
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        // Posts
        function createPost() {
            openModal('createPostModal');
        }

        async function publishPost() {
            if (!currentUser) {
                alert('Please log in to create a post');
                return;
            }

            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                alert('Please write something!');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('posts')
                    .insert([{
                        author_id: currentUser.id,
                        content
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Add to local posts array
                posts.unshift({
                    ...data,
                    author: `${currentUser.firstName} ${currentUser.lastName}`,
                    date: 'Just now'
                });

                document.getElementById('postContent').value = '';
                closeModal('createPostModal');
                alert('Post published successfully!');

                // Refresh feed if we're on it
                if (document.getElementById('feedView').classList.contains('active')) {
                    await renderFeed();
                }
            } catch (error) {
                console.error('Error publishing post:', error);
                alert('Failed to publish post: ' + error.message);
            }
        }

        async function likePost(postId) {
            if (!currentUser) {
                alert('Please log in to like posts');
                return;
            }

            // Handle mock posts locally
            if (String(postId).startsWith('mock-')) {
                const post = posts.find(p => String(p.id) === String(postId));
                if (post) {
                    post.likes_count = (post.likes_count || 0) + 1;
                    await renderFeed();
                }
                return;
            }

            try {
                const { data: existing } = await supabaseClient
                    .from('post_likes')
                    .select('id')
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    await supabaseClient
                        .from('post_likes')
                        .delete()
                        .eq('id', existing.id);
                } else {
                    await supabaseClient
                        .from('post_likes')
                        .insert([{
                            post_id: postId,
                            user_id: currentUser.id
                        }]);
                }

                await renderFeed();
            } catch (error) {
                console.error('Error liking post:', error);
                alert('Failed to like post: ' + error.message);
            }
        }

        function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (!section) return;
            if (section.style.display === 'none') {
                section.style.display = 'block';
                loadComments(postId);
            } else {
                section.style.display = 'none';
            }
        }

        // Store mock comments locally
        const mockComments = {};

        async function loadComments(postId) {
            const container = document.getElementById(`comments-list-${postId}`);
            if (!container) return;

            // Handle mock posts locally
            if (String(postId).startsWith('mock-')) {
                const comments = mockComments[postId] || [];
                container.innerHTML = comments.map(c => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 13px;">
                        <strong>${c.author}</strong>
                        <p style="margin: 0.25rem 0;">${c.content}</p>
                    </div>
                `).join('') || '<p style="font-size: 13px; color: #999;">No comments yet. Be the first!</p>';
                return;
            }

            try {
                const { data: comments, error } = await supabaseClient
                    .from('post_comments')
                    .select('*, profiles(first_name, last_name)')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                container.innerHTML = (comments || []).map(c => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 13px;">
                        <strong>${c.profiles.first_name} ${c.profiles.last_name}</strong>
                        <p style="margin: 0.25rem 0;">${c.content}</p>
                    </div>
                `).join('') || '<p style="font-size: 13px; color: #999;">No comments yet. Be the first!</p>';
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        async function submitComment(postId) {
            if (!currentUser) return;
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;

            // Handle mock posts locally
            if (String(postId).startsWith('mock-')) {
                if (!mockComments[postId]) mockComments[postId] = [];
                mockComments[postId].push({
                    author: `${currentUser.firstName} ${currentUser.lastName}`,
                    content: text
                });
                input.value = '';
                await loadComments(postId);
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('post_comments')
                    .insert([{ post_id: postId, user_id: currentUser.id, content: text }]);

                if (error) throw error;
                input.value = '';
                await loadComments(postId);
            } catch (error) {
                console.error('Error posting comment:', error);
                alert('Failed to post comment: ' + error.message);
            }
        }

        function sharePost(postId) {
            const post = posts.find(p => String(p.id) === String(postId));
            if (!post) return;

            if (navigator.share) {
                navigator.share({
                    title: 'Coffee Chat Post',
                    text: post.content.substring(0, 100),
                    url: window.location.href
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(post.content).then(() => {
                    alert('Post content copied to clipboard!');
                }).catch(() => {
                    alert('Unable to share.');
                });
            }
        }

        // ===== FEED FUNCTIONS =====
        async function renderFeed() {
            const feedPosts = document.getElementById('feedPosts');

            if (posts.length === 0) {
                feedPosts.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì∞</div>
                        <p>No posts yet. Be the first to share something!</p>
                    </div>
                `;
                return;
            }

            feedPosts.innerHTML = posts.sort((a, b) => new Date(b.created_at || b.date) - new Date(a.created_at || a.date))
                .map(post => {
                    const author = users.find(u => u.id === post.author_id) || currentUser;
                    const authorName = author ? `${author.firstName} ${author.lastName}` : post.author;
                    const avatarContent = author && author.profilePicture
                        ? `<img src="${author.profilePicture}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                        : author ? `${author.firstName[0]}${author.lastName[0]}` : '?';

                    return `
                        <div class="post-card">
                            <div class="post-header">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="person-avatar" style="width: 48px; height: 48px; font-size: 20px;">${avatarContent}</div>
                                    <div>
                                        <strong>${authorName}</strong>
                                        <p class="post-meta">${post.date || 'Just now'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="post-content">${post.content}</div>
                            <div class="post-actions">
                                <button class="post-action-btn" onclick="likePost('${post.id}')">üëç ${post.likes_count || 0} Likes</button>
                                <button class="post-action-btn" onclick="toggleComments('${post.id}')">üí¨ Comment</button>
                                <button class="post-action-btn" onclick="sharePost('${post.id}')">üîÑ Share</button>
                            </div>
                            <div id="comments-${post.id}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <div id="comments-list-${post.id}" style="margin-bottom: 0.75rem;"></div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border);" onkeypress="if(event.key==='Enter') submitComment('${post.id}')">
                                    <button class="btn btn-primary btn-sm" onclick="submitComment('${post.id}')">Post</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // ===== EVENTS FUNCTIONS =====
        function createEvent() {
            openModal('createEventModal');
        }

        async function publishEvent() {
            if (!currentUser) {
                alert('Please log in to create an event');
                return;
            }

            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const eventType = document.getElementById('eventType').value;
            const location = document.getElementById('eventLocation').value.trim();
            const startTime = document.getElementById('eventStartTime').value;
            const endTime = document.getElementById('eventEndTime').value;
            const maxAttendees = document.getElementById('eventMaxAttendees').value;

            if (!title || !description || !startTime || !endTime) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('events')
                    .insert([{
                        creator_id: currentUser.id,
                        title,
                        description,
                        event_type: eventType,
                        location,
                        start_time: startTime,
                        end_time: endTime,
                        max_attendees: maxAttendees || null
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Add to local events array
                events.push({
                    ...data,
                    creator_name: `${currentUser.firstName} ${currentUser.lastName}`,
                    attendees: []
                });

                // Clear form
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDescription').value = '';
                document.getElementById('eventLocation').value = '';
                document.getElementById('eventStartTime').value = '';
                document.getElementById('eventEndTime').value = '';
                document.getElementById('eventMaxAttendees').value = '';

                closeModal('createEventModal');
                await renderEvents();
                alert('Event created successfully!');
            } catch (error) {
                console.error('Error creating event:', error);
                alert('Failed to create event: ' + error.message);
            }
        }

        async function renderEvents() {
            const eventsList = document.getElementById('eventsList');

            if (events.length === 0) {
                eventsList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üéâ</div>
                        <p>No events yet. Create one to get started!</p>
                    </div>
                `;
                return;
            }

            const searchTerm = document.getElementById('searchEvents')?.value.toLowerCase() || '';
            const filterType = document.getElementById('filterEventType')?.value || '';

            const filteredEvents = events.filter(event => {
                const matchesSearch = event.title.toLowerCase().includes(searchTerm) ||
                                    event.description.toLowerCase().includes(searchTerm);
                const matchesType = !filterType || event.event_type === filterType;
                return matchesSearch && matchesType;
            });

            eventsList.innerHTML = filteredEvents.map(event => {
                const startDate = new Date(event.start_time);
                const isUserAttending = event.attendees && event.attendees.includes(currentUser.id);
                const isFull = event.max_attendees && event.attendees && event.attendees.length >= event.max_attendees;

                return `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <span class="tag">${event.event_type}</span>
                            <span style="font-size: 12px; color: #999;">${event.attendees ? event.attendees.length : 0} attending</span>
                        </div>
                        <h3>${event.title}</h3>
                        <p style="font-size: 13px; color: #666; margin: 0.5rem 0;">üìÖ ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        <p style="font-size: 13px; color: #666; margin: 0.5rem 0;">üìç ${event.location || 'TBD'}</p>
                        <p style="font-size: 13px; color: #666; margin: 1rem 0;">${event.description}</p>
                        <p style="font-size: 12px; color: #999; margin-bottom: 1rem;">Hosted by ${event.creator_name}</p>
                        ${isUserAttending ?
                            `<button class="btn btn-secondary btn-sm" onclick="unRSVPEvent('${event.id}')" style="width: 100%;">Cancel RSVP</button>` :
                            isFull ?
                            `<button class="btn btn-sm" disabled style="width: 100%; background: #ccc;">Event Full</button>` :
                            `<button class="btn btn-primary btn-sm" onclick="rsvpEvent('${event.id}')" style="width: 100%;">RSVP</button>`
                        }
                    </div>
                `;
            }).join('');
        }

        function filterEvents() {
            renderEvents();
        }

        async function rsvpEvent(eventId) {
            if (!currentUser) {
                alert('Please log in to RSVP');
                return;
            }

            try {
                const event = events.find(e => e.id === eventId);
                if (event.max_attendees && event.attendees && event.attendees.length >= event.max_attendees) {
                    alert('Event is full!');
                    return;
                }

                const { error } = await supabaseClient
                    .from('event_rsvps')
                    .insert([{
                        event_id: eventId,
                        user_id: currentUser.id,
                        status: 'going'
                    }]);

                if (error) throw error;

                // Update local events array
                const localEvent = events.find(e => e.id === eventId);
                if (localEvent) {
                    if (!localEvent.attendees) localEvent.attendees = [];
                    localEvent.attendees.push(currentUser.id);
                }

                await renderEvents();
                alert('RSVP confirmed!');
            } catch (error) {
                console.error('Error RSVPing to event:', error);
                alert('Failed to RSVP: ' + error.message);
            }
        }

        async function unRSVPEvent(eventId) {
            if (!currentUser) return;

            try {
                const { error } = await supabaseClient
                    .from('event_rsvps')
                    .delete()
                    .eq('event_id', eventId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                // Update local events array
                const event = events.find(e => e.id === eventId);
                if (event && event.attendees) {
                    event.attendees = event.attendees.filter(id => id !== currentUser.id);
                }

                await renderEvents();
                alert('RSVP cancelled');
            } catch (error) {
                console.error('Error cancelling RSVP:', error);
                alert('Failed to cancel RSVP: ' + error.message);
            }
        }

        // ===== SMART RECOMMENDATIONS =====
        function getSmartRecommendations() {
            if (!currentUser) return [];

            const userInterests = currentUser.interests || [];
            const userHobbies = currentUser.hobbies || [];
            const userIndustry = currentUser.industry;

            return users.map(user => {
                let score = 0;
                const reasons = [];

                // Industry match (highest priority)
                if (user.industry === userIndustry) {
                    score += 50;
                    reasons.push(`Same industry: ${userIndustry}`);
                }

                // Interests match
                const commonInterests = userInterests.filter(interest =>
                    user.interests && user.interests.includes(interest)
                );
                if (commonInterests.length > 0) {
                    score += commonInterests.length * 20;
                    reasons.push(`Shared interests: ${commonInterests.join(', ')}`);
                }

                // Hobbies match
                if (user.hobbies && userHobbies.length > 0) {
                    const commonHobbies = userHobbies.filter(hobby =>
                        user.hobbies.includes(hobby)
                    );
                    if (commonHobbies.length > 0) {
                        score += commonHobbies.length * 15;
                        reasons.push(`Shared hobbies: ${commonHobbies.join(', ')}`);
                    }
                }

                // Location match
                if (user.location && currentUser.location && user.location === currentUser.location) {
                    score += 10;
                    reasons.push(`Same location: ${user.location}`);
                }

                // Career goals keyword match
                if (user.goals && currentUser.goals) {
                    const userGoalWords = currentUser.goals.toLowerCase().split(/\s+/).filter(w => w.length > 3);
                    const theirGoalWords = user.goals.toLowerCase().split(/\s+/).filter(w => w.length > 3);
                    const commonGoalWords = userGoalWords.filter(word => theirGoalWords.includes(word));
                    if (commonGoalWords.length > 0) {
                        score += Math.min(commonGoalWords.length * 10, 30);
                        reasons.push('Aligned career goals');
                    }
                }

                // Mentorship potential
                if (user.role && currentUser.role && user.industry === userIndustry) {
                    const seniorKeywords = ['senior', 'lead', 'head', 'director', 'vp', 'chief', 'principal', 'staff', 'manager'];
                    const userIsSenior = seniorKeywords.some(k => currentUser.role.toLowerCase().includes(k));
                    const theyAreSenior = seniorKeywords.some(k => user.role.toLowerCase().includes(k));
                    if (userIsSenior !== theyAreSenior) {
                        score += 15;
                        reasons.push('Mentorship potential');
                    }
                }

                return {
                    user,
                    score,
                    reasons
                };
            })
            .filter(item => item.score > 0) // Only show users with some match
            .sort((a, b) => b.score - a.score); // Sort by score
        }

        function renderRecommendations() {
            const recommendations = getSmartRecommendations();

            if (recommendations.length === 0) return '';

            return `
                <div style="margin-bottom: 2rem;">
                    <h2 style="margin-bottom: 1rem;">‚ú® Recommended For You</h2>
                    <div class="grid">
                        ${recommendations.slice(0, 3).map(item => {
                            const user = item.user;
                            const isConnected = connections.find(c => c.user_id === currentUser.id && c.connected_user_id === user.id || c.connected_user_id === currentUser.id && c.user_id === user.id);
                            const avatarContent = user.profilePicture
                                ? `<img src="${user.profilePicture}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                                : `${user.firstName[0]}${user.lastName[0]}`;

                            return `
                                <div class="card person-card">
                                    <div style="background: linear-gradient(135deg, var(--accent), var(--primary)); padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <p style="font-size: 11px; color: white; margin: 0; text-align: center;">‚≠ê ${item.score}% Match</p>
                                    </div>
                                    <div class="person-avatar" style="width: 70px; height: 70px; font-size: 28px; margin: 0 auto 1rem;">${avatarContent}</div>
                                    <h3>${user.firstName} ${user.lastName}</h3>
                                    <p class="role">${user.role || user.industry}</p>
                                    <div style="text-align: left; margin: 1rem 0; padding: 0.75rem; background: var(--bg-light); border-radius: 8px;">
                                        <p style="font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 0.5rem;">Why we suggest ${user.firstName}:</p>
                                        ${item.reasons.map(reason => `<p style="font-size: 11px; color: #666; margin: 0.25rem 0;">‚Ä¢ ${reason}</p>`).join('')}
                                    </div>
                                    <div class="profile-actions">
                                        <button class="btn btn-primary btn-sm" onclick="viewProfile('${user.id}')" style="flex: 1;">View Profile</button>
                                        ${isConnected ?
                                            `<button class="btn btn-secondary btn-sm" onclick="startMessage('${user.id}')" style="flex: 1;">Message</button>` :
                                            `<button class="btn btn-accent btn-sm" onclick="connectUser('${user.id}')" style="flex: 1;">Connect</button>`
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // (Recommendations and hobbies integrated into original functions above)

        // ===== AVAILABILITY FUNCTIONS =====
        async function renderAvailability() {
            if (!currentUser) return;

            try {
                const { data: availability, error } = await supabaseClient
                    .from('availability')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('day_of_week', { ascending: true })
                    .order('start_time', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('availabilitySlots');

                if (!availability || availability.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No availability set. Add your available times below.</p>
                        </div>
                    `;
                    return;
                }

                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                container.innerHTML = availability.map(slot => `
                    <div class="meeting-card" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <strong>${days[slot.day_of_week]}</strong>
                            <p style="font-size: 14px; color: #666; margin: 0.25rem 0;">
                                ${slot.start_time} - ${slot.end_time}
                            </p>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteAvailabilitySlot('${slot.id}')">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error rendering availability:', error);
            }
        }

        async function addAvailabilitySlot() {
            if (!currentUser) {
                alert('Please log in');
                return;
            }

            const day = document.getElementById('availabilityDay').value;
            const startTime = document.getElementById('availabilityStartTime').value;
            const endTime = document.getElementById('availabilityEndTime').value;

            if (!startTime || !endTime) {
                alert('Please select start and end times');
                return;
            }

            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('availability')
                    .insert([{
                        user_id: currentUser.id,
                        day_of_week: parseInt(day),
                        start_time: startTime,
                        end_time: endTime,
                        is_available: true
                    }]);

                if (error) throw error;

                await renderAvailability();
                alert('Availability added!');
            } catch (error) {
                console.error('Error adding availability:', error);
                alert('Failed to add availability: ' + error.message);
            }
        }

        async function deleteAvailabilitySlot(slotId) {
            if (!currentUser) return;

            if (!confirm('Delete this availability slot?')) return;

            try {
                const { error } = await supabaseClient
                    .from('availability')
                    .delete()
                    .eq('id', slotId);

                if (error) throw error;

                await renderAvailability();
                alert('Availability deleted');
            } catch (error) {
                console.error('Error deleting availability:', error);
                alert('Failed to delete availability: ' + error.message);
            }
        }

        init();
    </script>
</body>
</html>
